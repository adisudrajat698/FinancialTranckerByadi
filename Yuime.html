<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catat Keuangan Pribadi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom CSS untuk font dan warna */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Warna latar belakang umum */
            color: #333;
        }
        .sidebar {
            background-color: #2c3e50; /* Warna sidebar gelap */
            color: #ecf0f1; /* Warna teks sidebar */
            width: 250px;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 20;
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .sidebar-item {
            display: block;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem; /* rounded-md */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            transition: background-color 0.2s;
        }
        .sidebar-item:hover {
            background-color: #34495e; /* Warna hover untuk item sidebar */
        }
        .sidebar-item.active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            font-weight: 600; /* font-semibold */
        }
        .header {
            background-color: #ffffff; /* Warna header putih */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .main-content {
            background-color: #f9f9f9; /* Warna latar belakang konten utama */
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        input[type="text"],
        input[type="password"],
        input[type="number"],
        input[type="date"],
        select {
            border-color: #d1d5db; /* gray-300 */
            border-width: 1px;
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.75rem 1rem;
            width: 100%;
            outline: none;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus {
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); /* blue-500 with opacity */
        }
        .btn-primary {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* blue-600 */
        }
        .btn-danger {
            background-color: #ef4444; /* red-500 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.2s;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* red-600 */
        }
        .btn-secondary {
            background-color: #6b7280; /* gray-500 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #4b5563; /* gray-600 */
        }
        .text-income {
            color: #22c55e; /* green-500 */
        }
        .text-expense {
            color: #ef4444; /* red-500 */
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            width: 500px;
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }

        /* Chart Styles */
        .chart-bar-container {
            display: flex;
            align-items: flex-end;
            height: 150px; /* Fixed height for the chart area */
            background-color: #f0f2f5;
            border-radius: 0.5rem;
            overflow: hidden;
            position: relative;
        }
        .chart-bar {
            width: 50%;
            height: 0; /* Initial height */
            transition: height 0.5s ease-out;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.875rem; /* text-sm */
            position: relative;
        }
        .chart-bar span {
            position: absolute;
            bottom: -1.5rem; /* Label below the bar */
            color: #333;
            font-weight: normal;
            font-size: 0.75rem; /* text-xs */
        }
        .chart-bar-income {
            background-color: #22c55e; /* green-500 */
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        .chart-bar-expense {
            background-color: #ef4444; /* red-500 */
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }

        /* Responsive table for reports */
        .responsive-table {
            width: 100%;
            border-collapse: collapse;
        }
        .responsive-table th, .responsive-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb; /* gray-200 */
            text-align: left;
        }
        .responsive-table th {
            background-color: #f3f4f6; /* gray-100 */
            font-weight: 600;
            color: #4b5563;
        }
        @media (max-width: 767px) {
            .responsive-table, .responsive-table thead, .responsive-table tbody, .responsive-table th, .responsive-table td, .responsive-table tr {
                display: block;
            }
            .responsive-table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            .responsive-table tr {
                margin-bottom: 1rem;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                overflow: hidden;
            }
            .responsive-table td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 50%;
                text-align: right;
            }
            .responsive-table td:before {
                position: absolute;
                top: 0;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: 600;
                color: #4b5563;
            }
            /* Label the data */
            .responsive-table td:nth-of-type(1):before { content: "Deskripsi"; }
            .responsive-table td:nth-of-type(2):before { content: "Tanggal"; }
            .responsive-table td:nth-of-type(3):before { content: "Jumlah"; }
            .responsive-table td:nth-of-type(4):before { content: "Tipe"; }
            .responsive-table td:nth-of-type(5):before { content: "Kategori"; }
        }

        /* Responsiveness */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0); /* Sidebar selalu terlihat di desktop */
            }
            .content-wrapper {
                margin-left: 250px; /* Memberi ruang untuk sidebar */
            }
            .menu-button {
                display: none; /* Sembunyikan tombol menu di desktop */
            }
        }

        /* Notification Styles */
        #notificationContainer {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            pointer-events: none; /* Allow clicks to pass through */
        }
        .notification {
            background-color: #333;
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(-20px);
            animation: fadeInOut 3s forwards;
            min-width: 200px;
            text-align: center;
            pointer-events: all; /* Re-enable pointer events for the notification itself */
        }
        .notification.success {
            background-color: #22c55e; /* green-500 */
        }
        .notification.error {
            background-color: #ef4444; /* red-500 */
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <aside id="sidebar" class="sidebar fixed top-0 left-0 h-full p-4 flex flex-col md:relative md:flex-shrink-0">
        <div class="text-2xl font-bold mb-8 text-center">KeuanganKu</div>
        <nav class="flex-grow">
            <ul class="space-y-2">
                <li id="dashboardSidebarItem"><a href="#" class="sidebar-item" data-section="dashboard">Dashboard</a></li>
                <li id="transactionsSidebarItem"><a href="#" class="sidebar-item" data-section="transactions">Transaksi</a></li>
                <li id="reportsSidebarItem"><a href="#" class="sidebar-item" data-section="reports">Laporan</a></li>
                <li id="settingsSidebarItem"><a href="#" class="sidebar-item" data-section="settings">Pengaturan</a></li>
                <li id="adminSidebarItem" class="hidden"><a href="#" class="sidebar-item" data-section="admin">Admin</a></li>
            </ul>
        </nav>
        <div class="mt-auto">
            <button id="logoutBtn" class="w-full btn-primary text-sm font-medium py-2 px-4 rounded-md">Logout</button>
        </div>
    </aside>

    <div class="flex-grow flex flex-col content-wrapper md:ml-0">
        <header class="header p-4 flex items-center justify-between sticky top-0 md:hidden">
            <button id="menuBtn" class="menu-button text-gray-600 focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <h1 class="text-xl font-semibold">Keuangan Pribadi</h1>
            <div class="w-6 h-6"></div> </header>

        <main class="flex-grow p-4 md:p-8 overflow-y-auto">
            <section id="authSection" class="flex items-center justify-center min-h-screen-minus-header">
                <div class="card p-8 w-full max-w-md">
                    <h2 class="text-2xl font-bold text-center mb-6" id="authTitle">Login</h2>
                    <form id="authForm" class="space-y-4">
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                            <input type="text" id="username" name="username" required class="block">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="password" name="password" required class="block">
                        </div>
                        <p id="authMessage" class="text-red-500 text-sm hidden"></p>
                        <button type="submit" id="authSubmitBtn" class="w-full btn-primary font-semibold">Login</button>
                    </form>
                    <p class="text-center text-sm mt-4">
                        Belum punya akun? <a href="#" id="toggleAuthMode" class="text-blue-500 hover:underline">Daftar di sini</a>
                    </p>
                </div>
            </section>

            <section id="dashboardSection" class="hidden">
                <h2 class="text-3xl font-bold mb-6">Dashboard</h2>
                <p class="text-xl text-gray-700 mb-6">Selamat datang, <span id="dashboardUsername" class="font-semibold text-blue-600"></span>!</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="card p-6 text-center">
                        <h3 class="text-lg font-medium text-gray-600">Saldo Saat Ini</h3>
                        <p id="currentBalance" class="text-4xl font-bold mt-2">Rp 0</p>
                    </div>
                    <div class="card p-6 text-center">
                        <h3 class="text-lg font-medium text-gray-600">Total Pemasukan</h3>
                        <p id="totalIncome" class="text-3xl font-bold text-income mt-2">Rp 0</p>
                    </div>
                    <div class="card p-6 text-center">
                        <h3 class="text-lg font-medium text-gray-600">Total Pengeluaran</h3>
                        <p id="totalExpense" class="text-3xl font-bold text-expense mt-2">Rp 0</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold mb-4">Ringkasan Pemasukan & Pengeluaran</h3>
                        <div id="incomeExpenseChart" class="chart-bar-container">
                            </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold mb-4">Pengeluaran Berdasarkan Kategori</h3>
                        <div id="expenseByCategorySummary" class="space-y-3">
                            <p class="text-gray-500 text-center">Belum ada pengeluaran berdasarkan kategori.</p>
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-4">Transaksi Terbaru</h3>
                    <div id="latestTransactions" class="space-y-4">
                        <p class="text-gray-500 text-center">Belum ada transaksi.</p>
                    </div>
                </div>
            </section>

            <section id="transactionsSection" class="hidden">
                <h2 class="text-3xl font-bold mb-6">Transaksi</h2>
                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-4">Tambah Transaksi Baru</h3>
                    <form id="transactionForm" class="space-y-4">
                        <div>
                            <label for="transactionDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                            <input type="date" id="transactionDate" required class="block">
                        </div>
                        <div>
                            <label for="transactionDescription" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi</label>
                            <input type="text" id="transactionDescription" placeholder="Contoh: Beli Kopi" required class="block">
                        </div>
                        <div>
                            <label for="transactionAmount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah (Rp)</label>
                            <input type="number" id="transactionAmount" placeholder="Contoh: 25000" required min="1" class="block">
                        </div>
                        <div>
                            <label for="transactionType" class="block text-sm font-medium text-gray-700 mb-1">Tipe</label>
                            <select id="transactionType" required class="block">
                                <option value="income">Pemasukan</option>
                                <option value="expense">Pengeluaran</option>
                            </select>
                        </div>
                        <div>
                            <label for="transactionCategory" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                            <select id="transactionCategory" required class="block">
                                </select>
                        </div>
                        <button type="submit" class="w-full btn-primary font-semibold">Tambah Transaksi</button>
                    </form>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-4">Daftar Semua Transaksi</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div class="col-span-full lg:col-span-1">
                            <label for="transactionSearchInput" class="block text-sm font-medium text-gray-700 mb-1">Cari Deskripsi</label>
                            <input type="text" id="transactionSearchInput" placeholder="Cari transaksi..." class="block">
                        </div>
                        <div>
                            <label for="filterType" class="block text-sm font-medium text-gray-700 mb-1">Filter Tipe</label>
                            <select id="filterType" class="block">
                                <option value="all">Semua</option>
                                <option value="income">Pemasukan</option>
                                <option value="expense">Pengeluaran</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterStartDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Mulai</label>
                            <input type="date" id="filterStartDate" class="block">
                        </div>
                        <div>
                            <label for="filterEndDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Akhir</label>
                            <input type="date" id="filterEndDate" class="block">
                        </div>
                        <div class="col-span-full sm:col-span-2 lg:col-span-1">
                            <label for="sortBy" class="block text-sm font-medium text-gray-700 mb-1">Urutkan Berdasarkan</label>
                            <select id="sortBy" class="block">
                                <option value="dateDesc">Tanggal (Terbaru)</option>
                                <option value="dateAsc">Tanggal (Terlama)</option>
                                <option value="amountDesc">Jumlah (Terbesar)</option>
                                <option value="amountAsc">Jumlah (Terkecil)</option>
                            </select>
                        </div>
                    </div>
                    <div id="allTransactionsList" class="space-y-4">
                        <p class="text-gray-500 text-center">Belum ada transaksi.</p>
                    </div>
                    <div id="paginationControls" class="flex justify-center items-center gap-4 mt-6">
                        <button id="prevPageBtn" class="btn-secondary px-4 py-2 rounded-md" disabled>Sebelumnya</button>
                        <span id="pageInfo" class="text-gray-700">Halaman 1 dari 1</span>
                        <button id="nextPageBtn" class="btn-secondary px-4 py-2 rounded-md" disabled>Berikutnya</button>
                    </div>
                </div>
            </section>

            <section id="reportsSection" class="hidden">
                <h2 class="text-3xl font-bold mb-6">Laporan Keuangan</h2>
                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-4">Ringkasan Laporan</h3>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <div class="flex-1">
                            <label for="reportMonthSelect" class="block text-sm font-medium text-gray-700 mb-1">Bulan</label>
                            <select id="reportMonthSelect" class="block">
                                <option value="all">Semua Bulan</option>
                                <option value="01">Januari</option>
                                <option value="02">Februari</option>
                                <option value="03">Maret</option>
                                <option value="04">April</option>
                                <option value="05">Mei</option>
                                <option value="06">Juni</option>
                                <option value="07">Juli</option>
                                <option value="08">Agustus</option>
                                <option value="09">September</option>
                                <option value="10">Oktober</option>
                                <option value="11">November</option>
                                <option value="12">Desember</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label for="reportYearSelect" class="block text-sm font-medium text-gray-700 mb-1">Tahun</label>
                            <select id="reportYearSelect" class="block">
                                </select>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <p class="text-lg">Total Pemasukan: <span id="reportTotalIncome" class="font-semibold text-income">Rp 0</span></p>
                        <p class="text-lg">Total Pengeluaran: <span id="reportTotalExpense" class="font-semibold text-expense">Rp 0</span></p>
                        <p class="text-lg">Saldo Bersih: <span id="reportNetBalance" class="font-semibold">Rp 0</span></p>
                    </div>

                    <h4 class="text-xl font-bold mt-8 mb-4">Grafik Pemasukan dan Pengeluaran Bulanan</h4>
                    <div class="relative h-64">
                        <canvas id="monthlySummaryChart"></canvas>
                    </div>

                    <h4 class="text-xl font-bold mt-8 mb-4">Pengeluaran per Kategori (Grafik Lingkaran)</h4>
                    <div class="relative h-64">
                        <canvas id="expenseByCategoryChart"></canvas>
                    </div>

                    <h4 class="text-xl font-bold mt-8 mb-4">Pemasukan per Kategori (Grafik Lingkaran)</h4>
                    <div class="relative h-64">
                        <canvas id="incomeByCategoryChart"></canvas>
                    </div>

                    <h4 class="text-xl font-bold mt-8 mb-4">Pengeluaran per Kategori</h4>
                    <div id="reportExpenseByCategory" class="space-y-3">
                        <p class="text-gray-500 text-center">Belum ada data pengeluaran per kategori.</p>
                    </div>
                    <h4 class="text-xl font-bold mt-8 mb-4">Pemasukan per Kategori</h4>
                    <div id="reportIncomeByCategory" class="space-y-3">
                        <p class="text-gray-500 text-center">Belum ada data pemasukan per kategori.</p>
                    </div>
                    <h4 class="text-xl font-bold mt-8 mb-4">Detail Transaksi</h4>
                    <div id="reportTransactionsList" class="overflow-x-auto">
                        <p class="text-gray-500 text-center">Belum ada transaksi untuk laporan.</p>
                    </div>
                </div>
            </section>

            <section id="settingsSection" class="hidden">
                <h2 class="text-3xl font-bold mb-6">Pengaturan</h2>
                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-4">Ubah Kata Sandi</h3>
                    <form id="changePasswordForm" class="space-y-4">
                        <div>
                            <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-1">Kata Sandi Saat Ini</label>
                            <input type="password" id="currentPassword" required class="block">
                        </div>
                        <div>
                            <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1">Kata Sandi Baru</label>
                            <input type="password" id="newPassword" required class="block">
                        </div>
                        <div>
                            <label for="confirmNewPassword" class="block text-sm font-medium text-gray-700 mb-1">Konfirmasi Kata Sandi Baru</label>
                            <input type="password" id="confirmNewPassword" required class="block">
                        </div>
                        <p id="passwordMessage" class="text-red-500 text-sm hidden"></p>
                        <button type="submit" class="w-full btn-primary font-semibold">Ubah Kata Sandi</button>
                    </form>
                </div>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-4">Kelola Kategori</h3>
                    <form id="addCategoryForm" class="flex flex-col sm:flex-row gap-4 mb-4">
                        <input type="text" id="newCategoryName" placeholder="Nama Kategori Baru" required class="flex-grow">
                        <button type="submit" class="btn-primary font-semibold">Tambah Kategori</button>
                    </form>
                    <div id="categoryList" class="space-y-2">
                        <p class="text-gray-500 text-center">Belum ada kategori.</p>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-4">Ekspor Data</h3>
                    <p class="text-gray-700 mb-4">Unduh semua transaksi Anda dalam format CSV.</p>
                    <button id="exportDataBtn" class="btn-primary font-semibold">Ekspor Transaksi ke CSV</button>
                </div>
            </section>

            <section id="adminSection" class="hidden">
                <h2 class="text-3xl font-bold mb-6">Panel Admin</h2>
                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-4">Kelola Pengguna</h3>
                    <div id="userList" class="space-y-2">
                        <p class="text-gray-500 text-center">Tidak ada pengguna lain.</p>
                    </div>
                </div>
            </section>
            </main>

        <footer class="bg-gray-800 text-white text-center p-4 text-sm mt-auto">
            &copy; 2025 by Adi Sudrajat. All rights reserved.
        </footer>
    </div>

    <div id="confirmationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideConfirmationModal()">&times;</button>
            <h3 class="text-xl font-bold mb-4" id="confirmationModalTitle">Konfirmasi</h3>
            <p id="confirmationModalMessage" class="mb-6">Apakah Anda yakin?</p>
            <div class="flex justify-end gap-4">
                <button id="confirmNoBtn" class="btn-secondary">Tidak</button>
                <button id="confirmYesBtn" class="btn-danger">Ya</button>
            </div>
        </div>
    </div>

    <div id="editTransactionModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideEditTransactionModal()">&times;</button>
            <h3 class="text-xl font-bold mb-4">Edit Transaksi</h3>
            <form id="editTransactionForm" class="space-y-4">
                <input type="hidden" id="editTransactionId">
                <div>
                    <label for="editTransactionDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                    <input type="date" id="editTransactionDate" required class="block">
                </div>
                <div>
                    <label for="editTransactionDescription" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi</label>
                    <input type="text" id="editTransactionDescription" required class="block">
                </div>
                <div>
                    <label for="editTransactionAmount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah (Rp)</label>
                    <input type="number" id="editTransactionAmount" required min="1" class="block">
                </div>
                <div>
                    <label for="editTransactionType" class="block text-sm font-medium text-gray-700 mb-1">Tipe</label>
                    <select id="editTransactionType" required class="block">
                        <option value="income">Pemasukan</option>
                        <option value="expense">Pengeluaran</option>
                    </select>
                </div>
                <div>
                    <label for="editTransactionCategory" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                    <select id="editTransactionCategory" required class="block">
                        </select>
                </div>
                <button type="submit" class="w-full btn-primary font-semibold">Simpan Perubahan</button>
            </form>
        </div>
    </div>

    <div id="notificationContainer"></div>

    <script>
        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const menuBtn = document.getElementById('menuBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const authSection = document.getElementById('authSection');
        const authTitle = document.getElementById('authTitle');
        const authForm = document.getElementById('authForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const authSubmitBtn = document.getElementById('authSubmitBtn');
        const authMessage = document.getElementById('authMessage');
        const toggleAuthModeBtn = document.getElementById('toggleAuthMode');

        const dashboardSection = document.getElementById('dashboardSection');
        const dashboardUsernameEl = document.getElementById('dashboardUsername'); // New element for username
        const currentBalanceEl = document.getElementById('currentBalance');
        const totalIncomeEl = document.getElementById('totalIncome');
        const totalExpenseEl = document.getElementById('totalExpense');
        const latestTransactionsEl = document.getElementById('latestTransactions');
        const incomeExpenseChart = document.getElementById('incomeExpenseChart');
        const expenseByCategorySummary = document.getElementById('expenseByCategorySummary');

        const transactionsSection = document.getElementById('transactionsSection');
        const transactionForm = document.getElementById('transactionForm');
        const transactionDateInput = document.getElementById('transactionDate');
        const transactionDescriptionInput = document.getElementById('transactionDescription');
        const transactionAmountInput = document.getElementById('transactionAmount');
        const transactionTypeInput = document.getElementById('transactionType');
        const transactionCategoryInput = document.getElementById('transactionCategory');
        const allTransactionsListEl = document.getElementById('allTransactionsList');
        const transactionSearchInput = document.getElementById('transactionSearchInput');
        const filterTypeSelect = document.getElementById('filterType');
        const filterStartDate = document.getElementById('filterStartDate');
        const filterEndDate = document.getElementById('filterEndDate');
        const sortBySelect = document.getElementById('sortBy');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const pageInfo = document.getElementById('pageInfo');

        const reportsSection = document.getElementById('reportsSection');
        const reportMonthSelect = document.getElementById('reportMonthSelect');
        const reportYearSelect = document.getElementById('reportYearSelect');
        const reportTotalIncomeEl = document.getElementById('reportTotalIncome');
        const reportTotalExpenseEl = document.getElementById('reportTotalExpense');
        const reportNetBalanceEl = document.getElementById('reportNetBalance');
        const reportExpenseByCategory = document.getElementById('reportExpenseByCategory');
        const reportIncomeByCategory = document.getElementById('reportIncomeByCategory');
        const reportTransactionsListEl = document.getElementById('reportTransactionsList');

        // New Chart.js canvas elements
        const monthlySummaryChartCanvas = document.getElementById('monthlySummaryChart');
        const expenseByCategoryChartCanvas = document.getElementById('expenseByCategoryChart');
        const incomeByCategoryChartCanvas = document.getElementById('incomeByCategoryChart');

        let monthlySummaryChartInstance = null; // To store Chart.js instance for monthly summary
        let expenseByCategoryChartInstance = null; // To store Chart.js instance for expense by category
        let incomeByCategoryChartInstance = null; // To store Chart.js instance for income by category

        const settingsSection = document.getElementById('settingsSection');
        const changePasswordForm = document.getElementById('changePasswordForm');
        const currentPasswordInput = document.getElementById('currentPassword');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
        const passwordMessageEl = document.getElementById('passwordMessage');
        const addCategoryForm = document.getElementById('addCategoryForm');
        const newCategoryNameInput = document.getElementById('newCategoryName');
        const categoryListEl = document.getElementById('categoryList');
        const exportDataBtn = document.getElementById('exportDataBtn');

        // Admin section elements
        const adminSidebarItem = document.getElementById('adminSidebarItem');
        const adminSection = document.getElementById('adminSection');
        const userListEl = document.getElementById('userList');

        // Specific sidebar items to hide/show
        const dashboardSidebarItem = document.getElementById('dashboardSidebarItem');
        const transactionsSidebarItem = document.getElementById('transactionsSidebarItem');
        const reportsSidebarItem = document.getElementById('reportsSidebarItem');
        const settingsSidebarItem = document.getElementById('settingsSidebarItem');

        const sidebarItems = document.querySelectorAll('.sidebar-item');

        // Modal Elements
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationModalTitle = document.getElementById('confirmationModalTitle');
        const confirmationModalMessage = document.getElementById('confirmationModalMessage');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmNoBtn = document.getElementById('confirmNoBtn');

        const editTransactionModal = document.getElementById('editTransactionModal');
        const editTransactionForm = document.getElementById('editTransactionForm');
        const editTransactionIdInput = document.getElementById('editTransactionId');
        const editTransactionDateInput = document.getElementById('editTransactionDate');
        const editTransactionDescriptionInput = document.getElementById('editTransactionDescription');
        const editTransactionAmountInput = document.getElementById('editTransactionAmount');
        const editTransactionTypeInput = document.getElementById('editTransactionType');
        const editTransactionCategoryInput = document.getElementById('editTransactionCategory');

        // Notification Container
        const notificationContainer = document.getElementById('notificationContainer');

        // State Variables
        let isLoggedIn = false;
        let authMode = 'login'; // 'login' or 'register'
        let currentUser = null; // Stores the username of the logged-in user
        let currentConfirmationCallback = null; // Used for confirmation modal

        // Pagination variables
        const transactionsPerPage = 10;
        let currentPage = 1;
        let filteredTransactions = []; // To store transactions after search/filter for pagination

        // Super Admin Credentials (for demonstration purposes)
        const ADMIN_USERNAME = 'admin';
        const ADMIN_PASSWORD = 'admin123';

        // --- Utility Functions ---

        // Function to format number as Rupiah
        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Function to show a message (e.g., error, success)
        function showMessage(element, message, isError = true) {
            element.textContent = message;
            element.classList.remove('hidden');
            element.classList.toggle('text-red-500', isError);
            element.classList.toggle('text-green-500', !isError);
            // Removed setTimeout here to keep messages visible until next action/switch
        }

        // Function to show a notification
        function showNotification(message, type = 'success', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notificationContainer.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, duration);
        }

        // Function to get data from localStorage
        function getLocalStorage(key) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : null;
        }

        // Function to set data to localStorage
        function setLocalStorage(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        // --- Authentication Functions ---

        function checkAuthStatus() {
            const users = getLocalStorage('users') || {};
            const loggedInUser = getLocalStorage('loggedInUser');

            if (loggedInUser && users[loggedInUser]) {
                isLoggedIn = true;
                currentUser = loggedInUser;
                // If admin, show admin section, otherwise dashboard
                showSection(currentUser === ADMIN_USERNAME ? 'adminSection' : 'dashboardSection');
            } else {
                isLoggedIn = false;
                currentUser = null;
                showSection('authSection');
            }
            updateUIBasedOnAuth();
        }

        function updateUIBasedOnAuth() {
            if (isLoggedIn) {
                authSection.classList.add('hidden');
                sidebar.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                // Ensure sidebar is open on desktop, hidden on mobile initially
                if (window.innerWidth < 768) {
                    sidebar.classList.remove('open');
                } else {
                    sidebar.classList.add('open');
                }

                // Show/hide sidebar items based on user role
                if (currentUser === ADMIN_USERNAME) {
                    dashboardSidebarItem.classList.add('hidden');
                    transactionsSidebarItem.classList.add('hidden');
                    reportsSidebarItem.classList.add('hidden');
                    settingsSidebarItem.classList.add('hidden');
                    adminSidebarItem.classList.remove('hidden');
                } else {
                    dashboardSidebarItem.classList.remove('hidden');
                    transactionsSidebarItem.classList.remove('hidden');
                    reportsSidebarItem.classList.remove('hidden');
                    settingsSidebarItem.classList.remove('hidden');
                    adminSidebarItem.classList.add('hidden');
                }

            } else {
                authSection.classList.remove('hidden');
                sidebar.classList.add('hidden');
                logoutBtn.classList.add('hidden');
                // Hide all sidebar items on logout
                dashboardSidebarItem.classList.add('hidden');
                transactionsSidebarItem.classList.add('hidden');
                reportsSidebarItem.classList.add('hidden');
                settingsSidebarItem.classList.add('hidden');
                adminSidebarItem.classList.add('hidden');
                
                // Hide all other sections
                document.querySelectorAll('main > section:not(#authSection)').forEach(section => {
                    section.classList.add('hidden');
                });
            }
        }

        function handleAuth(event) {
            event.preventDefault();
            authMessage.classList.add('hidden'); // Hide previous message immediately
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            let users = getLocalStorage('users') || {};

            if (!username || !password) {
                showMessage(authMessage, 'Username dan password tidak boleh kosong.', true);
                showNotification('Username dan password tidak boleh kosong.', 'error');
                return;
            }

            // Check for super admin login
            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                setLocalStorage('loggedInUser', ADMIN_USERNAME);
                isLoggedIn = true;
                currentUser = ADMIN_USERNAME;
                showMessage(authMessage, 'Login admin berhasil!', false);
                showNotification('Login admin berhasil!', 'success');
                showSection('adminSection'); // Redirect to admin panel
                updateUIBasedOnAuth();
                return;
            }

            if (authMode === 'register') {
                if (users[username]) {
                    showMessage(authMessage, 'Username sudah terdaftar. Silakan gunakan username lain.', true);
                    showNotification('Username sudah terdaftar. Silakan gunakan username lain.', 'error');
                } else {
                    users[username] = { password: password, transactions: [], categories: ['Makanan', 'Transportasi', 'Gaji', 'Hiburan', 'Tagihan', 'Lain-lain'] }; // Default categories
                    setLocalStorage('users', users);
                    showMessage(authMessage, 'Registrasi berhasil! Silakan login.', false);
                    showNotification('Registrasi berhasil! Silakan login.', 'success');
                    // Switch to login mode after successful registration
                    authMode = 'login';
                    authTitle.textContent = 'Login';
                    authSubmitBtn.textContent = 'Login';
                    toggleAuthModeBtn.textContent = 'Daftar di sini';
                    usernameInput.value = ''; // Clear fields after successful registration
                    passwordInput.value = ''; // Clear fields after successful registration
                }
            } else { // Login mode
                if (users[username] && users[username].password === password) {
                    setLocalStorage('loggedInUser', username);
                    isLoggedIn = true;
                    currentUser = username;
                    showMessage(authMessage, 'Login berhasil!', false);
                    showNotification('Login berhasil!', 'success');
                    showSection('dashboardSection');
                    updateUIBasedOnAuth();
                } else {
                    showMessage(authMessage, 'Username atau password salah.', true);
                    showNotification('Username atau password salah.', 'error');
                }
            }
        }

        function handleLogout() {
            setLocalStorage('loggedInUser', null);
            isLoggedIn = false;
            currentUser = null;
            showMessage(authMessage, 'Anda telah logout.', false);
            showNotification('Anda telah logout.', 'success');
            showSection('authSection');
            updateUIBasedOnAuth();
            // Reset form fields
            usernameInput.value = '';
            passwordInput.value = '';
        }

        // --- Section Management ---

        function showSection(sectionId) {
            // Prevent non-admin sections for admin user
            if (currentUser === ADMIN_USERNAME && sectionId !== 'adminSection' && sectionId !== 'authSection') {
                showNotification('Akses ditolak. Admin hanya dapat mengakses panel admin.', 'error');
                return;
            }

            document.querySelectorAll('main > section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            // Update active sidebar item
            sidebarItems.forEach(item => {
                item.classList.remove('active');
                if (item.dataset.section + 'Section' === sectionId) {
                    item.classList.add('active');
                }
            });

            // Close sidebar on mobile after navigating
            if (window.innerWidth < 768) {
                sidebar.classList.remove('open');
            }

            // Update data for the displayed section
            if (sectionId === 'dashboardSection') {
                renderDashboard();
            } else if (sectionId === 'transactionsSection') {
                renderCategoryOptions(transactionCategoryInput); // Populate categories for new transaction form
                currentPage = 1; // Reset pagination
                renderTransactions();
            } else if (sectionId === 'reportsSection') {
                populateReportYears();
                renderReports();
            } else if (sectionId === 'settingsSection') {
                renderManageCategories();
            } else if (sectionId === 'adminSection') {
                renderAdminPanel();
            }
        }

        // --- Transaction Management ---

        function getUserData() {
            const users = getLocalStorage('users') || {};
            // Return empty data if currentUser is admin, as admin doesn't have personal transactions
            if (currentUser === ADMIN_USERNAME) {
                return { transactions: [], categories: [] };
            }
            return users[currentUser] || { transactions: [], categories: [] };
        }

        function saveUserData(data) {
            let users = getLocalStorage('users') || {};
            if (users[currentUser]) {
                users[currentUser] = data;
                setLocalStorage('users', users);
            }
        }

        function getUserTransactions() {
            // Admin user does not have personal transactions
            if (currentUser === ADMIN_USERNAME) return [];
            return getUserData().transactions;
        }

        function saveUserTransactions(transactions) {
            // Admin user does not save personal transactions
            if (currentUser === ADMIN_USERNAME) return;
            let userData = getUserData();
            userData.transactions = transactions;
            saveUserData(userData);
        }

        function addTransaction(event) {
            event.preventDefault();
            const date = transactionDateInput.value;
            const description = transactionDescriptionInput.value.trim();
            const amount = parseFloat(transactionAmountInput.value);
            const type = transactionTypeInput.value;
            const category = transactionCategoryInput.value;

            if (!date || !description || isNaN(amount) || amount <= 0 || !category) {
                showMessage(authMessage, 'Semua field harus diisi dengan benar.');
                showNotification('Semua field harus diisi dengan benar.', 'error');
                return;
            }

            const newTransaction = {
                id: Date.now(), // Unique ID for each transaction
                date: date,
                description: description,
                amount: amount,
                type: type,
                category: category
            };

            const transactions = getUserTransactions();
            transactions.push(newTransaction);
            saveUserTransactions(transactions);

            showMessage(authMessage, 'Transaksi berhasil ditambahkan!', false);
            showNotification('Transaksi berhasil ditambahkan!', 'success');
            transactionForm.reset(); // Clear form
            const today = new Date().toISOString().split('T')[0];
            transactionDateInput.value = today; // Reset date to today
            renderDashboard();
            currentPage = 1; // Reset pagination on new transaction
            renderTransactions();
            renderReports();
        }

        function deleteTransaction(id) {
            confirmAction('Apakah Anda yakin ingin menghapus transaksi ini?', () => {
                let transactions = getUserTransactions();
                transactions = transactions.filter(t => t.id !== id);
                saveUserTransactions(transactions);
                showMessage(authMessage, 'Transaksi berhasil dihapus!', false);
                showNotification('Transaksi berhasil dihapus!', 'success');
                renderDashboard();
                currentPage = 1; // Reset pagination on delete
                renderTransactions();
                renderReports();
            });
        }

        function editTransaction(id) {
            const transactions = getUserTransactions();
            const transactionToEdit = transactions.find(t => t.id === id);

            if (transactionToEdit) {
                editTransactionIdInput.value = transactionToEdit.id;
                editTransactionDateInput.value = transactionToEdit.date;
                editTransactionDescriptionInput.value = transactionToEdit.description;
                editTransactionAmountInput.value = transactionToEdit.amount;
                editTransactionTypeInput.value = transactionToEdit.type;
                renderCategoryOptions(editTransactionCategoryInput); // Populate categories for edit form
                editTransactionCategoryInput.value = transactionToEdit.category;

                showEditTransactionModal();
            }
        }

        function updateTransaction(event) {
            event.preventDefault();
            const id = parseInt(editTransactionIdInput.value);
            const date = editTransactionDateInput.value;
            const description = editTransactionDescriptionInput.value.trim();
            const amount = parseFloat(editTransactionAmountInput.value);
            const type = editTransactionTypeInput.value;
            const category = editTransactionCategoryInput.value;

            if (!date || !description || isNaN(amount) || amount <= 0 || !category) {
                showMessage(authMessage, 'Semua field harus diisi dengan benar.');
                showNotification('Semua field harus diisi dengan benar.', 'error');
                return;
            }

            let transactions = getUserTransactions();
            const index = transactions.findIndex(t => t.id === id);

            if (index !== -1) {
                transactions[index] = { id, date, description, amount, type, category };
                saveUserTransactions(transactions);
                showMessage(authMessage, 'Transaksi berhasil diperbarui!', false);
                showNotification('Transaksi berhasil diperbarui!', 'success');
                hideEditTransactionModal();
                renderDashboard();
                renderTransactions();
                renderReports();
            }
        }

        // --- Category Management ---

        function getUserCategories() {
            // Admin user does not have personal categories
            if (currentUser === ADMIN_USERNAME) return [];
            return getUserData().categories;
        }

        function saveUserCategories(categories) {
            // Admin user does not save personal categories
            if (currentUser === ADMIN_USERNAME) return;
            let userData = getUserData();
            userData.categories = categories;
            saveUserData(userData);
        }

        function renderCategoryOptions(selectElement) {
            const categories = getUserCategories();
            selectElement.innerHTML = ''; // Clear existing options
            if (categories.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Tidak ada kategori';
                selectElement.appendChild(option);
                selectElement.disabled = true;
                return;
            }
            selectElement.disabled = false;
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                selectElement.appendChild(option);
            });
        }

        function addCategory(event) {
            event.preventDefault();
            const newCategory = newCategoryNameInput.value.trim();
            if (!newCategory) {
                showMessage(passwordMessageEl, 'Nama kategori tidak boleh kosong.', true);
                showNotification('Nama kategori tidak boleh kosong.', 'error');
                return;
            }

            let categories = getUserCategories();
            if (categories.includes(newCategory)) {
                showMessage(passwordMessageEl, 'Kategori ini sudah ada.', true);
                showNotification('Kategori ini sudah ada.', 'error');
                return;
            }

            categories.push(newCategory);
            saveUserCategories(categories);
            showMessage(passwordMessageEl, 'Kategori berhasil ditambahkan!', false);
            showNotification('Kategori berhasil ditambahkan!', 'success');
            newCategoryNameInput.value = '';
            renderManageCategories(); // Re-render category list in settings
            renderCategoryOptions(transactionCategoryInput); // Update transaction form categories
            renderCategoryOptions(editTransactionCategoryInput); // Update edit form categories
        }

        function deleteCategory(categoryToDelete) {
            confirmAction(`Apakah Anda yakin ingin menghapus kategori "${categoryToDelete}"? Transaksi yang terkait tidak akan terhapus, tetapi kategorinya akan dialihkan ke 'Lain-lain'.`, () => {
                let categories = getUserCategories();
                categories = categories.filter(cat => cat !== categoryToDelete);
                saveUserCategories(categories);

                // Update transactions that used this category
                let transactions = getUserTransactions();
                transactions.forEach(t => {
                    if (t.category === categoryToDelete) {
                        t.category = 'Lain-lain'; // Assign to a default or 'Uncategorized'
                    }
                });
                saveUserTransactions(transactions);

                showMessage(passwordMessageEl, 'Kategori berhasil dihapus!', false);
                showNotification('Kategori berhasil dihapus!', 'success');
                renderManageCategories();
                renderCategoryOptions(transactionCategoryInput);
                renderCategoryOptions(editTransactionCategoryInput);
                renderTransactions(); // Re-render to reflect category changes
                renderReports();
                renderDashboard(); // Re-render dashboard for category summary
            });
        }

        function renderManageCategories() {
            const categories = getUserCategories();
            categoryListEl.innerHTML = '';
            if (categories.length === 0) {
                categoryListEl.innerHTML = '<p class="text-gray-500 text-center">Belum ada kategori.</p>';
            } else {
                categories.forEach(cat => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'flex items-center justify-between p-2 rounded-md bg-gray-50 border border-gray-200';
                    categoryDiv.innerHTML = `
                        <span class="font-medium">${cat}</span>
                        <button class="btn-danger text-xs px-2 py-1" onclick="deleteCategory('${cat}')">Hapus</button>
                    `;
                    categoryListEl.appendChild(categoryDiv);
                });
            }
        }

        // --- Password Change ---

        function handleChangePassword(event) {
            event.preventDefault();
            const currentPass = currentPasswordInput.value;
            const newPass = newPasswordInput.value;
            const confirmNewPass = confirmNewPasswordInput.value;

            let users = getLocalStorage('users') || {};
            const userData = users[currentUser];

            if (!currentPass || !newPass || !confirmNewPass) {
                showMessage(passwordMessageEl, 'Semua field harus diisi.', true);
                showNotification('Semua field harus diisi.', 'error');
                return;
            }

            if (userData.password !== currentPass) {
                showMessage(passwordMessageEl, 'Kata sandi saat ini salah.', true);
                showNotification('Kata sandi saat ini salah.', 'error');
                return;
            }

            if (newPass !== confirmNewPass) {
                showMessage(passwordMessageEl, 'Kata sandi baru tidak cocok dengan konfirmasi.', true);
                showNotification('Kata sandi baru tidak cocok dengan konfirmasi.', 'error');
                return;
            }

            if (newPass.length < 6) {
                showMessage(passwordMessageEl, 'Kata sandi baru minimal 6 karakter.', true);
                showNotification('Kata sandi baru minimal 6 karakter.', 'error');
                return;
            }

            userData.password = newPass;
            setLocalStorage('users', users);
            showMessage(passwordMessageEl, 'Kata sandi berhasil diubah!', false);
            showNotification('Kata sandi berhasil diubah!', 'success');
            changePasswordForm.reset();
        }

        // --- Data Export ---
        function exportTransactionsToCSV() {
            const transactions = getUserTransactions();
            if (transactions.length === 0) {
                showMessage(passwordMessageEl, 'Tidak ada transaksi untuk diekspor.', true);
                showNotification('Tidak ada transaksi untuk diekspor.', 'error');
                return;
            }

            const headers = ["ID", "Tanggal", "Deskripsi", "Jumlah", "Tipe", "Kategori"];
            const csvRows = [];
            csvRows.push(headers.join(','));

            transactions.forEach(t => {
                const row = [
                    t.id,
                    t.date,
                    `"${t.description.replace(/"/g, '""')}"`, // Handle commas and quotes in description
                    t.amount,
                    t.type,
                    `"${t.category.replace(/"/g, '""')}"`
                ];
                csvRows.push(row.join(','));
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `transaksi_keuanganku_${currentUser}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage(passwordMessageEl, 'Data berhasil diekspor!', false);
            showNotification('Data berhasil diekspor!', 'success');
        }

        // --- Render Functions ---

        function renderDashboard() {
            // Display current username
            if (currentUser) {
                dashboardUsernameEl.textContent = currentUser;
            } else {
                dashboardUsernameEl.textContent = 'Tamu'; // Fallback if no user is logged in (shouldn't happen here)
            }

            const transactions = getUserTransactions();
            let totalIncome = 0;
            let totalExpense = 0;
            const expenseCategories = {};
            const incomeCategories = {};

            transactions.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                    incomeCategories[t.category] = (incomeCategories[t.category] || 0) + t.amount;
                } else {
                    totalExpense += t.amount;
                    expenseCategories[t.category] = (expenseCategories[t.category] || 0) + t.amount;
                }
            });

            const currentBalance = totalIncome - totalExpense;

            currentBalanceEl.textContent = formatRupiah(currentBalance);
            totalIncomeEl.textContent = formatRupiah(totalIncome);
            totalExpenseEl.textContent = formatRupiah(totalExpense);

            // Render Income/Expense Chart
            renderIncomeExpenseChart(totalIncome, totalExpense);

            // Render Expense by Category Summary
            renderCategorySummary(expenseByCategorySummary, expenseCategories, 'expense');

            // Display latest 5 transactions
            const latest = transactions.slice().sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5); // Sort by date, get newest 5
            latestTransactionsEl.innerHTML = '';
            if (latest.length === 0) {
                latestTransactionsEl.innerHTML = '<p class="text-gray-500 text-center">Belum ada transaksi.</p>';
            } else {
                latest.forEach(t => {
                    const transactionDiv = document.createElement('div');
                    transactionDiv.className = `flex items-center justify-between p-3 rounded-lg ${t.type === 'income' ? 'bg-green-50' : 'bg-red-50'}`;
                    transactionDiv.innerHTML = `
                        <div>
                            <p class="font-medium">${t.description}</p>
                            <p class="text-xs text-gray-500">${t.date} - ${t.category}</p>
                        </div>
                        <p class="font-semibold ${t.type === 'income' ? 'text-income' : 'text-expense'}">${formatRupiah(t.amount)}</p>
                    `;
                    latestTransactionsEl.appendChild(transactionDiv);
                });
            }
        }

        function renderIncomeExpenseChart(income, expense) {
            incomeExpenseChart.innerHTML = ''; // Clear previous chart
            const total = income + expense;
            let incomeHeight = 0;
            let expenseHeight = 0;

            if (total > 0) {
                incomeHeight = (income / total) * 100;
                expenseHeight = (expense / total) * 100;
            }

            const incomeBar = document.createElement('div');
            incomeBar.className = 'chart-bar chart-bar-income';
            incomeBar.style.height = `${incomeHeight}%`;
            incomeBar.innerHTML = `<span>Pemasukan</span>`;

            const expenseBar = document.createElement('div');
            expenseBar.className = 'chart-bar chart-bar-expense';
            expenseBar.style.height = `${expenseHeight}%`;
            expenseBar.innerHTML = `<span>Pengeluaran</span>`;

            incomeExpenseChart.appendChild(incomeBar);
            incomeExpenseChart.appendChild(expenseBar);
        }

        function renderCategorySummary(element, categoryData, type) {
            element.innerHTML = '';
            const sortedCategories = Object.entries(categoryData).sort(([, a], [, b]) => b - a);

            if (sortedCategories.length === 0) {
                element.innerHTML = `<p class="text-gray-500 text-center">Belum ada ${type === 'expense' ? 'pengeluaran' : 'pemasukan'} berdasarkan kategori.</p>`;
                return;
            }

            sortedCategories.forEach(([category, amount]) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center text-sm';
                div.innerHTML = `
                    <span>${category}</span>
                    <span class="font-semibold ${type === 'income' ? 'text-income' : 'text-expense'}">${formatRupiah(amount)}</span>
                `;
                element.appendChild(div);
            });
        }

        function renderTransactions() {
            let transactions = getUserTransactions();

            // Apply search filter
            const searchTerm = transactionSearchInput.value.toLowerCase();
            if (searchTerm) {
                transactions = transactions.filter(t => t.description.toLowerCase().includes(searchTerm));
            }

            // Apply type filter
            const filterType = filterTypeSelect.value;
            if (filterType !== 'all') {
                transactions = transactions.filter(t => t.type === filterType);
            }

            // Apply date range filter
            const start = filterStartDate.value;
            const end = filterEndDate.value;
            if (start && end) {
                transactions = transactions.filter(t => t.date >= start && t.date <= end);
            } else if (start) {
                transactions = transactions.filter(t => t.date >= start);
            } else if (end) {
                transactions = transactions.filter(t => t.date <= end);
            }

            // Apply sort
            const sortBy = sortBySelect.value;
            transactions.sort((a, b) => {
                if (sortBy === 'dateDesc') return new Date(b.date) - new Date(a.date);
                if (sortBy === 'dateAsc') return new Date(a.date) - new Date(b.date);
                if (sortBy === 'amountDesc') return b.amount - a.amount;
                if (sortBy === 'amountAsc') return a.amount - b.amount;
                return 0;
            });

            filteredTransactions = transactions; // Store filtered transactions for pagination
            updatePaginationControls();
            const startIndex = (currentPage - 1) * transactionsPerPage;
            const endIndex = startIndex + transactionsPerPage;
            const transactionsToDisplay = filteredTransactions.slice(startIndex, endIndex);

            allTransactionsListEl.innerHTML = '';

            if (transactionsToDisplay.length === 0) {
                allTransactionsListEl.innerHTML = '<p class="text-gray-500 text-center">Belum ada transaksi.</p>';
            } else {
                transactionsToDisplay.forEach(t => {
                    const transactionDiv = document.createElement('div');
                    transactionDiv.className = `flex flex-col sm:flex-row items-start sm:items-center justify-between p-3 rounded-lg border border-gray-200 bg-white`;
                    transactionDiv.innerHTML = `
                        <div class="flex-grow mb-2 sm:mb-0">
                            <p class="font-medium">${t.description}</p>
                            <p class="text-sm text-gray-500">${t.date} - ${t.category}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <p class="font-semibold ${t.type === 'income' ? 'text-income' : 'text-expense'} mr-2">${formatRupiah(t.amount)}</p>
                            <button class="btn-secondary text-xs px-2 py-1" onclick="editTransaction(${t.id})">Edit</button>
                            <button class="btn-danger text-xs px-2 py-1" onclick="deleteTransaction(${t.id})">Hapus</button>
                        </div>
                    `;
                    allTransactionsListEl.appendChild(transactionDiv);
                });
            }
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredTransactions.length / transactionsPerPage);
            pageInfo.textContent = `Halaman ${currentPage} dari ${totalPages || 1}`;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
        }

        function goToPage(page) {
            currentPage = page;
            renderTransactions();
        }

        function nextPage() {
            if (currentPage * transactionsPerPage < filteredTransactions.length) {
                currentPage++;
                renderTransactions();
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTransactions();
            }
        }

        function populateReportYears() {
            const transactions = getUserTransactions();
            const years = new Set();
            transactions.forEach(t => years.add(new Date(t.date).getFullYear()));
            const sortedYears = Array.from(years).sort((a, b) => b - a);

            reportYearSelect.innerHTML = '<option value="all">Semua Tahun</option>';
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                reportYearSelect.appendChild(option);
            });
        }

        function renderReports() {
            let transactions = getUserTransactions();

            const selectedMonth = reportMonthSelect.value;
            const selectedYear = reportYearSelect.value;

            // Filter by month and year
            transactions = transactions.filter(t => {
                const date = new Date(t.date);
                const transactionMonth = (date.getMonth() + 1).toString().padStart(2, '0');
                const transactionYear = date.getFullYear().toString();

                const matchMonth = selectedMonth === 'all' || transactionMonth === selectedMonth;
                const matchYear = selectedYear === 'all' || transactionYear === selectedYear;

                return matchMonth && matchYear;
            });

            let totalIncome = 0;
            let totalExpense = 0;
            const expenseCategories = {};
            const incomeCategories = {};
            const monthlyData = {}; // For monthly summary chart

            transactions.forEach(t => {
                const date = new Date(t.date);
                const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;

                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = { income: 0, expense: 0 };
                }

                if (t.type === 'income') {
                    totalIncome += t.amount;
                    incomeCategories[t.category] = (incomeCategories[t.category] || 0) + t.amount;
                    monthlyData[monthYear].income += t.amount;
                } else {
                    totalExpense += t.amount;
                    expenseCategories[t.category] = (expenseCategories[t.category] || 0) + t.amount;
                    monthlyData[monthYear].expense += t.amount;
                }
            });

            const netBalance = totalIncome - totalExpense;

            reportTotalIncomeEl.textContent = formatRupiah(totalIncome);
            reportTotalExpenseEl.textContent = formatRupiah(totalExpense);
            reportNetBalanceEl.textContent = formatRupiah(netBalance);

            // Render category breakdown for reports
            renderCategorySummary(reportExpenseByCategory, expenseCategories, 'expense');
            renderCategorySummary(reportIncomeByCategory, incomeCategories, 'income');

            // Render Chart.js graphs
            renderMonthlySummaryChart(monthlyData);
            renderPieChart(expenseByCategoryChartCanvas, expenseCategories, 'Pengeluaran per Kategori', 'rgba(239, 68, 68, 0.8)'); // red-500
            renderPieChart(incomeByCategoryChartCanvas, incomeCategories, 'Pemasukan per Kategori', 'rgba(34, 197, 94, 0.8)'); // green-500

            reportTransactionsListEl.innerHTML = '';
            if (transactions.length === 0) {
                reportTransactionsListEl.innerHTML = '<p class="text-gray-500 text-center">Belum ada transaksi untuk laporan.</p>';
            } else {
                const table = document.createElement('table');
                table.className = 'responsive-table w-full text-sm';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Deskripsi</th>
                            <th>Tanggal</th>
                            <th>Jumlah</th>
                            <th>Tipe</th>
                            <th>Kategori</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = table.querySelector('tbody');

                transactions.forEach(t => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${t.description}</td>
                        <td>${t.date}</td>
                        <td class="${t.type === 'income' ? 'text-income' : 'text-expense'}">${formatRupiah(t.amount)}</td>
                        <td>${t.type === 'income' ? 'Pemasukan' : 'Pengeluaran'}</td>
                        <td>${t.category}</td>
                    `;
                    tbody.appendChild(row);
                });
                reportTransactionsListEl.appendChild(table);
            }
        }

        function renderMonthlySummaryChart(monthlyData) {
            // Destroy existing chart instance if it exists
            if (monthlySummaryChartInstance) {
                monthlySummaryChartInstance.destroy();
            }

            const labels = Object.keys(monthlyData).sort();
            const incomeData = labels.map(month => monthlyData[month].income);
            const expenseData = labels.map(month => monthlyData[month].expense);

            monthlySummaryChartInstance = new Chart(monthlySummaryChartCanvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Pemasukan',
                            data: incomeData,
                            backgroundColor: 'rgba(34, 197, 94, 0.6)', // green-500
                            borderColor: 'rgba(34, 197, 94, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Pengeluaran',
                            data: expenseData,
                            backgroundColor: 'rgba(239, 68, 68, 0.6)', // red-500
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: false,
                            title: {
                                display: true,
                                text: 'Bulan'
                            }
                        },
                        y: {
                            stacked: false,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Jumlah (Rp)'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    return formatRupiah(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatRupiah(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderPieChart(canvasElement, categoryData, title, colorBase) {
            // Destroy existing chart instance if it exists
            let chartInstance;
            if (canvasElement === expenseByCategoryChartCanvas) {
                if (expenseByCategoryChartInstance) expenseByCategoryChartInstance.destroy();
                chartInstance = expenseByCategoryChartInstance;
            } else if (canvasElement === incomeByCategoryChartCanvas) {
                if (incomeByCategoryChartInstance) incomeByCategoryChartInstance.destroy();
                chartInstance = incomeByCategoryChartInstance;
            }

            const labels = Object.keys(categoryData);
            const data = Object.values(categoryData);

            // Generate dynamic colors
            const backgroundColors = labels.map((_, i) => {
                const hue = (i * 137.508) % 360; // Use golden angle approximation for distinct colors
                return `hsla(${hue}, 70%, 60%, 0.8)`;
            });
            const borderColors = labels.map((_, i) => {
                const hue = (i * 137.508) % 360;
                return `hsla(${hue}, 70%, 50%, 1)`;
            });

            const chartConfig = {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: title,
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: false, // Title is handled in HTML
                            text: title
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += formatRupiah(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            };

            if (canvasElement === expenseByCategoryChartCanvas) {
                expenseByCategoryChartInstance = new Chart(canvasElement, chartConfig);
            } else if (canvasElement === incomeByCategoryChartCanvas) {
                incomeByCategoryChartInstance = new Chart(canvasElement, chartConfig);
            }
        }

        // --- Admin Panel Functions ---
        function renderAdminPanel() {
            userListEl.innerHTML = '';
            const users = getLocalStorage('users') || {};
            const userUsernames = Object.keys(users).filter(username => username !== ADMIN_USERNAME); // Exclude admin from list

            if (userUsernames.length === 0) {
                userListEl.innerHTML = '<p class="text-gray-500 text-center">Tidak ada pengguna lain yang terdaftar.</p>';
                return;
            }

            userUsernames.forEach(username => {
                const userData = users[username];
                const password = userData.password; // Get the password

                const userDiv = document.createElement('div');
                userDiv.className = 'flex flex-col sm:flex-row items-start sm:items-center justify-between p-3 rounded-lg border border-gray-200 bg-white';
                userDiv.innerHTML = `
                    <div class="flex-grow mb-2 sm:mb-0">
                        <p class="font-medium">Username: ${username}</p>
                        <p class="text-sm text-gray-500">Password: ${password}</p>
                    </div>
                    <button class="btn-danger text-xs px-2 py-1" onclick="deleteUser('${username}')">Hapus Pengguna</button>
                `;
                userListEl.appendChild(userDiv);
            });
        }

        function deleteUser(usernameToDelete) {
            confirmAction(`Apakah Anda yakin ingin menghapus pengguna "${usernameToDelete}"? Semua data pengguna ini akan hilang.`, () => {
                let users = getLocalStorage('users') || {};
                if (users[usernameToDelete]) {
                    delete users[usernameToDelete];
                    setLocalStorage('users', users);
                    showNotification(`Pengguna "${usernameToDelete}" berhasil dihapus.`, 'success');
                    renderAdminPanel(); // Refresh the list
                } else {
                    showNotification(`Pengguna "${usernameToDelete}" tidak ditemukan.`, 'error');
                }
            });
        }

        // --- Modal Functions ---
        function showConfirmationModal(message, callback) {
            confirmationModalMessage.textContent = message;
            currentConfirmationCallback = callback;
            confirmationModal.classList.remove('hidden');
        }

        function hideConfirmationModal() {
            confirmationModal.classList.add('hidden');
            currentConfirmationCallback = null;
        }

        function showEditTransactionModal() {
            editTransactionModal.classList.remove('hidden');
        }

        function hideEditTransactionModal() {
            editTransactionModal.classList.add('hidden');
        }

        // --- Event Listeners ---

        // Toggle sidebar on mobile
        menuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        // Close sidebar when clicking outside on mobile (optional, but good UX)
        document.addEventListener('click', (event) => {
            if (window.innerWidth < 768 && sidebar.classList.contains('open') && !sidebar.contains(event.target) && !menuBtn.contains(event.target)) {
                sidebar.classList.remove('open');
            }
        });

        // Authentication form submission
        authForm.addEventListener('submit', handleAuth);

        // Toggle between login and register modes
        toggleAuthModeBtn.addEventListener('click', (event) => {
            event.preventDefault();
            if (authMode === 'login') {
                authMode = 'register';
                authTitle.textContent = 'Daftar';
                authSubmitBtn.textContent = 'Daftar';
                toggleAuthModeBtn.textContent = 'Login di sini';
            } else {
                authMode = 'login';
                authTitle.textContent = 'Login';
                authSubmitBtn.textContent = 'Login';
                toggleAuthModeBtn.textContent = 'Daftar di sini';
            }
            authMessage.classList.add('hidden'); // Clear message on mode switch
            usernameInput.value = ''; // Clear fields
            passwordInput.value = ''; // Clear fields
        });

        // Logout button
        logoutBtn.addEventListener('click', handleLogout);

        // Sidebar navigation
        sidebarItems.forEach(item => {
            item.addEventListener('click', (event) => {
                event.preventDefault();
                const sectionId = event.target.dataset.section + 'Section';
                if (isLoggedIn) {
                    showSection(sectionId);
                } else {
                    showMessage(authMessage, 'Anda harus login terlebih dahulu.', true);
                    showNotification('Anda harus login terlebih dahulu.', 'error');
                }
            });
        });

        // Transaction form submission
        transactionForm.addEventListener('submit', addTransaction);

        // Filter, Sort, Search, and Pagination listeners
        transactionSearchInput.addEventListener('input', () => { currentPage = 1; renderTransactions(); });
        filterTypeSelect.addEventListener('change', () => { currentPage = 1; renderTransactions(); });
        filterStartDate.addEventListener('change', () => { currentPage = 1; renderTransactions(); });
        filterEndDate.addEventListener('change', () => { currentPage = 1; renderTransactions(); });
        sortBySelect.addEventListener('change', () => { currentPage = 1; renderTransactions(); });
        prevPageBtn.addEventListener('click', prevPage);
        nextPageBtn.addEventListener('click', nextPage);

        // Confirmation Modal Buttons
        confirmYesBtn.addEventListener('click', () => {
            if (currentConfirmationCallback) {
                currentConfirmationCallback();
            }
            hideConfirmationModal();
        });
        confirmNoBtn.addEventListener('click', hideConfirmationModal);

        // Edit Transaction Form Submission
        editTransactionForm.addEventListener('submit', updateTransaction);

        // Change Password Form Submission
        changePasswordForm.addEventListener('submit', handleChangePassword);

        // Add Category Form Submission
        addCategoryForm.addEventListener('submit', addCategory);

        // Export Data Button
        exportDataBtn.addEventListener('click', exportTransactionsToCSV);

        // Report Filters
        reportMonthSelect.addEventListener('change', renderReports);
        reportYearSelect.addEventListener('change', renderReports);

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthStatus();
            // Set default date for transaction form to today
            const today = new Date().toISOString().split('T')[0];
            transactionDateInput.value = today;
            editTransactionDateInput.value = today; // Also for edit form
        });

        // Make functions globally accessible for onclick in HTML
        window.deleteTransaction = deleteTransaction;
        window.editTransaction = editTransaction;
        window.deleteCategory = deleteCategory;
        window.hideConfirmationModal = hideConfirmationModal; // For modal close button
        window.hideEditTransactionModal = hideEditTransactionModal; // For modal close button
        window.confirmAction = showConfirmationModal; // Expose for internal use
        window.deleteUser = deleteUser; // Expose for admin panel
    </script>
</body>
</html>