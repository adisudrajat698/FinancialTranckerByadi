<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Catat Keuangan Pribadi</title>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Custom CSS untuk font dan warna */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8FAFC; /* Warna latar belakang umum yang lebih cerah dan soft */
            color: #1F2937; /* Warna teks umum lebih gelap */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .sidebar {
            background: linear-gradient(150deg, #1A73E8, #0C5CC6); /* Gradien biru yang lebih cerah dan dinamis */
            color: #ecf0f1; /* Warna teks sidebar */
            width: 280px; /* Lebar sidebar tetap */
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out, background-color 0.3s ease, color 0.3s ease;
            z-index: 20;
            box-shadow: 6px 0 15px rgba(0,0,0,0.15); /* Shadow lebih menonjol */
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .sidebar-item {
            display: flex; /* Menggunakan flexbox untuk ikon dan teks */
            align-items: center;
            padding: 0.9rem 1.35rem; /* Padding lebih besar */
            border-radius: 0.85rem; /* rounded-xl */
            font-size: 1rem; /* text-base */
            font-weight: 500; /* font-medium */
            transition: background-color 0.2s, transform 0.2s ease-in-out;
            margin-bottom: 0.5rem; /* Jarak antar item */
        }
        .sidebar-item:hover {
            background-color: rgba(255, 255, 255, 0.2); /* Warna hover transparan lebih kuat */
            transform: translateX(8px); /* Efek slide saat hover lebih jauh */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .sidebar-item.active {
            background-color: rgba(255, 255, 255, 0.35); /* Latar belakang aktif lebih kontras */
            color: white;
            font-weight: 600; /* font-semibold */
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); /* Shadow untuk item aktif */
            transform: translateX(0); /* Pastikan tidak bergeser */
            position: relative; /* Untuk efek "shine" */
            overflow: hidden;
        }
        .sidebar-item.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: all 0.7s ease-in-out;
        }
        .sidebar-item.active:hover::before {
            left: 100%;
        }
        .header {
            background-color: #ffffff; /* Warna header putih */
            box-shadow: 0 5px 15px rgba(0,0,0,0.08); /* Shadow lebih halus */
            z-index: 10;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            border-bottom-left-radius: 2rem; /* Rounded bottom corners lebih besar */
            border-bottom-right-radius: 2rem;
            padding: 1.25rem 1.5rem; /* Padding lebih besar */
        }
        .main-content {
            background-color: #F8FAFC; /* Warna latar belakang konten utama */
            transition: background-color 0.3s ease;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1.5rem; /* rounded-3xl */
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); /* Shadow yang lebih dalam */
            transition: all 0.3s ease;
            border: 1px solid #E5E7EB; /* Border halus */
            position: relative;
            overflow: hidden;
        }
        .card:hover {
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            transform: translateY(-3px);
        }
        input[type="text"],
        input[type="password"],
        input[type="number"],
        input[type="date"],
        select {
            border-color: #D1D8DF; /* Warna border yang lebih soft */
            border-width: 1px;
            border-radius: 0.85rem; /* rounded-xl */
            padding: 1rem 1.25rem;
            width: 100%;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s ease, color 0.3s ease;
            font-size: 1rem;
        }
        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus {
            border-color: #1A73E8; /* Warna border fokus biru cerah Google */
            box-shadow: 0 0 0 4px rgba(26, 115, 232, 0.25); /* Shadow fokus yang lebih menyebar */
            background-color: #FDFEFE;
        }
        .btn-primary {
            background: linear-gradient(90deg, #1A73E8, #0C5CC6); /* Gradien biru Google untuk tombol utama */
            color: white;
            padding: 1rem 2rem;
            border-radius: 1rem; /* rounded-2xl */
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(26, 115, 232, 0.3);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary:hover {
            background: linear-gradient(90deg, #0C5CC6, #0A4FA8);
            box-shadow: 0 8px 20px rgba(26, 115, 232, 0.4);
            transform: translateY(-2px);
        }
        .btn-danger {
            background-color: #EF4444; /* red-500 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.85rem; /* rounded-xl */
            transition: background-color 0.2s, transform 0.2s;
            box-shadow: 0 3px 8px rgba(239, 68, 68, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-danger:hover {
            background-color: #DC2626; /* red-600 */
            box-shadow: 0 5px 12px rgba(239, 68, 68, 0.3);
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: #6B7280; /* gray-500 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.85rem; /* rounded-xl */
            transition: background-color 0.2s, transform 0.2s;
            box-shadow: 0 3px 8px rgba(107, 114, 128, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-secondary:hover {
            background-color: #4B5563; /* gray-600 */
            box-shadow: 0 5px 12px rgba(107, 114, 128, 0.3);
            transform: translateY(-1px);
        }
        .text-income {
            color: #10B981; /* green-500 yang lebih jelas */
        }
        .text-expense {
            color: #EF4444; /* red-500 */
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Lebih gelap */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            backdrop-filter: blur(5px); /* Efek blur pada background */
        }
        .modal-content {
            background-color: white;
            padding: 3rem; /* Padding lebih besar */
            border-radius: 1.5rem; /* rounded-3xl */
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); /* Shadow lebih dramatis */
            max-width: 95%;
            width: 550px; /* Lebar modal sedikit lebih besar */
            position: relative;
            transition: all 0.3s ease;
        }
        .modal-close-btn {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: none;
            border: none;
            font-size: 2rem; /* Ukuran ikon close lebih besar */
            cursor: pointer;
            color: #6B7280;
            transition: color 0.2s;
        }
        .modal-close-btn:hover {
            color: #1F2937;
            transform: rotate(90deg); /* Rotasi saat hover */
        }

        /* Chart Styles (Keep original Chart.js styling as it's functional) */
        .chart-bar-container {
            display: flex;
            align-items: flex-end;
            height: 160px; /* Fixed height for the chart area */
            background-color: #F8FAFC;
            border-radius: 1rem;
            overflow: hidden;
            position: relative;
            transition: background-color 0.3s ease;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.05); /* Inner shadow for depth */
            padding: 1rem;
        }
        .chart-bar {
            width: 50%;
            height: 0; /* Initial height */
            transition: height 0.6s ease-out;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9rem; /* text-sm */
            position: relative;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
            opacity: 0.9;
        }
        .chart-bar span {
            position: absolute;
            bottom: -1.8rem; /* Label below the bar */
            color: #555;
            font-weight: normal;
            font-size: 0.8rem; /* text-xs */
        }
        .chart-bar-income {
            background-color: #10B981; /* green-500 yang lebih jelas */
        }
        .chart-bar-expense {
            background-color: #EF4444; /* red-500 */
        }

        /* Responsive table for reports */
        .responsive-table {
            width: 100%;
            border-collapse: separate; /* Use separate to allow border-radius on cells */
            border-spacing: 0 10px; /* Space between rows lebih besar */
        }
        .responsive-table th, .responsive-table td {
            padding: 1.15rem; /* Padding lebih besar */
            text-align: left;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .responsive-table th {
            background-color: #EBF2F7; /* gray-100 for header */
            font-weight: 600;
            color: #4B5563;
            border-bottom: none; /* No bottom border for th */
        }
        .responsive-table th:first-child { border-top-left-radius: 1rem; }
        .responsive-table th:last-child { border-top-right-radius: 1rem; }

        .responsive-table td {
            background-color: #ffffff; /* White background for table cells */
            border-bottom: 1px solid #F3F6F9; /* Lighter border between rows */
        }
        .responsive-table tr {
            box-shadow: 0 3px 8px rgba(0,0,0,0.05); /* Subtle shadow for each row */
            border-radius: 1rem; /* Rounded corners for rows */
            overflow: hidden; /* Ensure rounded corners are applied */
        }
        .responsive-table tbody tr:last-child td {
            border-bottom: none; /* No border for the last row's cells */
        }
        .responsive-table td:first-child { border-bottom-left-radius: 1rem; border-top-left-radius: 1rem;}
        .responsive-table td:last-child { border-bottom-right-radius: 1rem; border-top-right-radius: 1rem;}

        @media (max-width: 767px) {
            .responsive-table, .responsive-table thead, .responsive-table tbody, .responsive-table th, .responsive-table td, .responsive-table tr {
                display: block;
            }
            .responsive-table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            .responsive-table tr {
                margin-bottom: 1.25rem; /* Margin lebih besar */
                border: 1px solid #E2E8F0; /* Border for mobile rows */
                border-radius: 1rem;
                overflow: hidden;
            }
            .responsive-table td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 50%;
                text-align: right;
            }
            .responsive-table td:before {
                position: absolute;
                top: 0;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: 600;
                color: #4B5563;
            }
            /* Label the data */
            .responsive-table td:nth-of-type(1):before { content: "Deskripsi"; }
            .responsive-table td:nth-of-type(2):before { content: "Tanggal"; }
            .responsive-table td:nth-of-type(3):before { content: "Jumlah"; }
            .responsive-table td:nth-of-type(4):before { content: "Tipe"; }
            .responsive-table td:nth-of-type(5):before { content: "Kategori"; }
        }

        /* Responsiveness */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0); /* Sidebar always visible on desktop */
            }
            .content-wrapper {
                margin-left: 280px; /* Make space for sidebar */
            }
            .menu-button {
                display: none; /* Hide menu button on desktop */
            }
        }

        /* Notification Styles */
        #notificationContainer {
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 1rem; /* Jarak antar notifikasi lebih besar */
            pointer-events: none; /* Allow clicks to pass through */
        }
        .notification {
            background-color: #333;
            color: white;
            padding: 1.25rem 1.75rem; /* Padding lebih besar */
            border-radius: 1rem; /* rounded-2xl */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: translateY(-30px);
            animation: fadeInOut 3.5s forwards; /* Durasi sedikit lebih lama */
            min-width: 280px;
            text-align: center;
            pointer-events: all; /* Re-enable pointer events for the notification itself */
            font-weight: 500;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .notification.success {
            background-color: #10B981; /* green-500 yang lebih jelas */
        }
        .notification.error {
            background-color: #EF4444; /* red-500 */
        }
        .notification.info {
            background-color: #1A73E8; /* blue Google */
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-30px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-30px); }
        }

        /* New styles for JSON display modal */
        #jsonDisplayModal .modal-content {
            width: 90%;
            max-width: 700px;
        }
        #jsonOutput {
            width: 100%;
            height: 300px;
            background-color: #F8FAFC;
            border: 1px solid #E2E8F0;
            padding: 1.25rem;
            font-family: monospace;
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            word-wrap: break-word; /* Break long words */
            overflow-y: scroll;
            resize: vertical; /* Allow vertical resizing */
            border-radius: 1rem;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
            font-size: 0.95rem;
        }
        #copyJsonBtn {
            margin-top: 1.75rem;
            width: 100%;
        }

        /* Chatbot styles */
        #chatbotModal .modal-content {
            width: 90%;
            max-width: 650px; /* Lebar lebih besar */
            height: 85vh; /* Tinggi lebih besar */
            display: flex;
            flex-direction: column;
        }
        #chatDisplay {
            flex-grow: 1;
            border: 1px solid #E2E8F0;
            border-radius: 1rem;
            padding: 1.5rem;
            overflow-y: auto;
            margin-bottom: 1.75rem;
            background-color: #FDFEFE;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .chat-message {
            margin-bottom: 1rem;
            padding: 0.8rem 1.2rem;
            border-radius: 1rem;
            max-width: 85%;
            line-height: 1.6;
            font-size: 0.95rem;
        }
        .chat-message.user {
            background-color: #E0EFFF; /* Light blue for user message */
            align-self: flex-end;
            margin-left: auto;
            text-align: right;
            color: #0047b3;
        }
        .chat-message.bot {
            background-color: #EBF2F7; /* Light gray-blue for bot message */
            align-self: flex-start;
            margin-right: auto;
            text-align: left;
            color: #333;
        }
        .chat-options button {
            background-color: #1A73E8; /* Blue for chat options */
            color: white;
            padding: 0.7rem 1.4rem;
            border-radius: 0.85rem;
            margin: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 3px 8px rgba(26, 115, 232, 0.2);
            font-weight: 500;
        }
        .chat-options button:hover {
            background-color: #0C5CC6; /* Darker blue on hover */
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(26, 115, 232, 0.3);
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #0F172A; /* dark slate */
            color: #E2E8F0; /* light gray */
        }
        body.dark-mode .sidebar {
            background: linear-gradient(150deg, #1A202C, #2D3748); /* darker gradient */
            color: #EDF2F7; /* lighter text */
        }
        body.dark-mode .sidebar-item:hover {
            background-color: rgba(255, 255, 255, 0.1); /* darker hover */
        }
        body.dark-mode .sidebar-item.active {
            background-color: rgba(255, 255, 255, 0.18); /* lighter blue for active */
            color: white;
        }
        body.dark-mode .header {
            background-color: #1F2937; /* Darker header */
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        body.dark-mode .main-content {
            background-color: #0F172A;
        }
        body.dark-mode .card {
            background-color: #1F2937; /* Darker card background */
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border-color: #334155;
        }
        body.dark-mode input[type="text"],
        body.dark-mode input[type="password"],
        body.dark-mode input[type="number"],
        body.dark-mode input[type="date"],
        body.dark-mode select {
            background-color: #334155;
            border-color: #334155;
            color: #E2E8F0;
        }
        body.dark-mode input::placeholder {
            color: #94A3B8; /* Soft gray placeholder */
        }
        body.dark-mode .btn-secondary {
            background-color: #64748B;
            color: #E2E8F0;
        }
        body.dark-mode .btn-secondary:hover {
            background-color: #94A3B8;
        }
        body.dark-mode .text-gray-700 {
            color: #CBD5E0;
        }
        body.dark-mode .text-gray-600 {
            color: #94A3B8;
        }
        body.dark-mode .text-gray-500 {
            color: #64748B;
        }
        body.dark-mode .text-blue-500 {
            color: #60A5FA; /* Lighter blue for contrast */
        }
        body.dark-mode .text-blue-600 {
            color: #3B82F6;
        }
        body.dark-mode .text-red-600 {
            color: #F87171;
        }
        body.dark-mode .modal-content {
            background-color: #1F2937;
            color: #E2E8F0;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }
        body.dark-mode .modal-close-btn {
            color: #94A3B8;
        }
        body.dark-mode .chart-bar-container {
            background-color: #1F2937;
        }
        body.dark-mode .chart-bar span {
            color: #E2E8F0;
        }
        body.dark-mode .responsive-table th {
            background-color: #334155;
            color: #E2E8F0;
            border-bottom-color: #1F2937;
        }
        body.dark-mode .responsive-table td {
            background-color: #1F2937; /* Darker cell background */
            border-bottom-color: #334155;
        }
        body.dark-mode .responsive-table tr {
            border-color: #334155;
        }
        body.dark-mode .responsive-table td:before {
            color: #94A3B8;
        }
        body.dark-mode .jsonDisplayModal #jsonOutput {
            background-color: #334155;
            border-color: #334155;
            color: #E2E8F0;
        }
        body.dark-mode #chatDisplay {
            background-color: #334155;
            border-color: #60A5FA;
            color: #E2E8F0;
        }
        body.dark-mode .chat-message.user {
            background-color: #3B82F6;
            color: white;
        }
        body.dark-mode .chat-message.bot {
            background-color: #64748B;
            color: #1F2937;
        }
        body.dark-mode .chat-options button {
            background-color: #60A5FA;
            color: #0F172A;
        }
        body.dark-mode .chat-options button:hover {
            background-color: #3B82F6;
        }
        body.dark-mode .text-income {
            color: #34D399; /* lighter green for dark mode */
        }
        body.dark-mode .text-expense {
            color: #FCA5A5; /* lighter red for dark mode */
        }
        body.dark-mode .bg-green-50 {
            background-color: #1F2937; /* Adjust for dark mode background */
            border-color: #34D399;
        }
        body.dark-mode .bg-red-50 {
            background-color: #1F2937; /* Adjust for dark mode background */
            border-color: #FCA5A5;
        }
        body.dark-mode .border-gray-200 {
            border-color: #334155;
        }
        body.dark-mode .bg-white {
            background-color: #1F2937;
        }
        body.dark-mode .toggle:checked {
            background-color: #60A5FA; /* primary color for dark mode toggle */
        }
        body.dark-mode .toggle:checked:before {
            background-color: #0F172A; /* thumb color for dark mode toggle */
        }
        /* Toggle switch styling */
        .toggle {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 28px;
            background-color: #ccc;
            border-radius: 20px;
            transition: background-color 0.3s;
            cursor: pointer;
            vertical-align: middle;
        }

        .toggle:before {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .toggle:checked {
            background-color: #1A73E8; /* Warna tombol aktif (biru Google) */
        }

        .toggle:checked:before {
            transform: translateX(20px);
        }

        /* Generic Feather Icon Styling */
        .feather-icon {
            width: 1.25rem; /* Ukuran default untuk ikon */
            height: 1.25rem;
            color: inherit; /* Menggunakan warna teks parent */
            vertical-align: middle;
            margin-right: 0.5rem; /* Margin kanan default */
        }
        /* Override specific icon sizes if needed */
        .sidebar-item .feather-icon {
            width: 1.35rem;
            height: 1.35rem;
            margin-right: 0.75rem;
        }
        .dashboard-icon {
            width: 2.25rem;
            height: 2.25rem;
        }
        .card-icon {
            width: 2.5rem;
            height: 2.5rem;
            margin-bottom: 0.5rem;
        }
        .no-records-message {
            background-color: #FFFBEB; /* yellow-50 */
            border: 1px solid #FCD34D; /* yellow-300 */
            color: #92400E; /* yellow-800 */
        }
        body.dark-mode .no-records-message {
            background-color: #33230A; /* Darker yellow for dark mode */
            border-color: #92400E;
            color: #FCD34D;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <!-- Sidebar / Navigation -->
    <aside id="sidebar" class="sidebar fixed top-0 left-0 h-full p-6 flex flex-col md:relative md:flex-shrink-0">
       <div class="mb-8 text-center">
            <img src="https://placehold.co/80x80/1A73E8/ffffff?text=AW" alt="Logo Aplikasi" class="mx-auto w-24 h-24 mb-4 rounded-full border-4 border-white shadow-lg">
            <div class="text-3xl font-extrabold text-white">AdiWallet</div>
            <p id="sidebarUsername" class="text-base font-semibold text-white opacity-80 mt-2">Pengguna</p>
        </div>

        <nav class="flex-grow">
            <ul class="space-y-2">
              <li id="dashboardSidebarItem"><a href="#" class="sidebar-item active" data-section="dashboard"><i data-feather="home" class="feather-icon"></i> Dashboard </a></li>
              <li id="transactionsSidebarItem"><a href="#" class="sidebar-item" data-section="transactions"><i data-feather="file-text" class="feather-icon"></i> Transaksi </a></li>
              <li id="budgetingSidebarItem"><a href="#" class="sidebar-item" data-section="budgeting"><i data-feather="dollar-sign" class="feather-icon"></i> Rencana Anggaran </a></li>
              <li id="reportsSidebarItem"><a href="#" class="sidebar-item" data-section="reports"><i data-feather="bar-chart-2" class="feather-icon"></i> Laporan </a></li>
              <li id="analysisSidebarItem"><a href="#" class="sidebar-item" data-section="analysis"><i data-feather="pie-chart" class="feather-icon"></i> Analisis Keuangan </a></li>
              <!-- New sidebar item for Exchange Rate -->
              <li id="exchangeRateSidebarItem"><a href="#" class="sidebar-item" data-section="exchangeRate"><i data-feather="repeat" class="feather-icon"></i> Nilai Tukar Mata Uang </a></li>
              <li id="settingsSidebarItem"><a href="#" class="sidebar-item" data-section="settings"><i data-feather="settings" class="feather-icon"></i> Pengaturan </a></li>
              <li id="helpSidebarItem"><a href="#" class="sidebar-item" data-section="help"><i data-feather="help-circle" class="feather-icon"></i> Bantuan </a></li>
            </ul>
        </nav>
        <div class="mt-auto pt-6">
            <button id="logoutBtn" class="w-full btn-primary text-base font-semibold py-3 px-4 rounded-xl shadow-lg"><i data-feather="log-out" class="feather-icon"></i> Logout</button>
        </div>
    </aside>

    <!-- Main Content Area -->
    <div class="flex-grow flex flex-col content-wrapper md:ml-0">
        <!-- Header for Mobile -->
        <header class="header p-5 flex items-center justify-between sticky top-0 md:hidden">
            <button id="menuBtn" class="menu-button text-gray-600 focus:outline-none p-3 rounded-lg hover:bg-gray-100 transition duration-200">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <h1 class="text-2xl font-bold text-gray-800">Keuangan Pribadi</h1>
            <div class="w-8 h-8"></div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-grow p-4 md:p-8 overflow-y-auto">
            <!-- Authentication Section -->
            <section id="authSection" class="flex items-center justify-center min-h-screen-minus-header">
                <div class="card p-8 w-full max-w-md">
                   <div class="flex flex-col items-center mb-8">
                        <img src="https://placehold.co/100x100/1A73E8/ffffff?text=AW" alt="Logo Aplikasi" class="w-28 h-28 mb-4 rounded-full border-4 border-blue-200 shadow-md transform transition-transform duration-300 hover:scale-105">
                        <h2 class="text-3xl font-extrabold text-gray-800 text-center mb-2" id="authTitle">Login</h2>
                        <p class="text-gray-500 text-center text-lg">Kelola keuangan Anda dengan mudah.</p>
                    </div>
                    <form id="authForm" class="space-y-6">
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="username" name="username" required class="block w-full" placeholder="Masukkan email Anda">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Kata Sandi</label>
                            <input type="password" id="password" name="password" required class="block w-full" placeholder="Masukkan kata sandi Anda">
                        </div>
                        <p id="authMessage" class="text-red-500 text-sm hidden font-medium text-center"></p>
                        <button type="submit" id="authSubmitBtn" class="w-full btn-primary font-semibold text-lg py-3"><i data-feather="log-in" class="feather-icon"></i> Login</button>
                    </form>
                    <p class="text-center text-sm mt-6 text-gray-600">
                        <a href="#" id="forgotPasswordLink" class="text-blue-600 hover:underline font-medium">Lupa Kata Sandi?</a>
                        <span class="mx-2 text-gray-400">|</span>
                        Belum punya akun? <a href="#" id="toggleAuthMode" class="text-blue-600 hover:underline font-medium">Daftar di sini</a>
                    </p>
                </div>
            </section>

            <!-- Dashboard Section -->
            <section id="dashboardSection" class="hidden">
                <h2 class="text-3xl font-bold mb-8 text-gray-800">Dashboard</h2>
                <div class="flex items-center gap-4 mb-6 p-5 bg-white rounded-2xl shadow-md border border-gray-200">
                    <img src="https://placehold.co/60x60/6366F1/ffffff?text=JP" alt="User Avatar" class="w-16 h-16 rounded-full border-2 border-blue-300 shadow-sm">
                    <p class="text-xl text-gray-700">Selamat datang, <span id="dashboardUsername" class="font-bold text-blue-700"></span>!</p>
                </div>
                <div id="noRecordsMessage" class="card p-4 mb-6 text-center text-gray-700 text-base hidden no-records-message">
                    <!-- Message will be inserted here by JavaScript -->
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="card p-6 text-center flex flex-col items-center">
                        <i data-feather="dollar-sign" class="card-icon text-blue-600 mb-3"></i>
                        <h3 class="text-lg font-medium text-gray-600">Saldo Saat Ini</h3>
                        <p id="currentBalance" class="text-4xl font-extrabold mt-2 text-gray-800">Rp 0</p>
                    </div>
                    <div class="card p-6 text-center flex flex-col items-center">
                        <i data-feather="arrow-down-left" class="card-icon text-green-600 mb-3"></i>
                        <h3 class="text-lg font-medium text-gray-600">Total Pemasukan</h3>
                        <p id="totalIncome" class="text-3xl font-bold text-income mt-2">Rp 0</p>
                    </div>
                    <div class="card p-6 text-center flex flex-col items-center">
                        <i data-feather="arrow-up-right" class="card-icon text-red-600 mb-3"></i>
                        <h3 class="text-lg font-medium text-gray-600">Total Pengeluaran</h3>
                        <p id="totalExpense" class="text-3xl font-bold text-expense mt-2">Rp 0</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold mb-5 text-gray-800">Ringkasan Pemasukan & Pengeluaran</h3>
                        <div id="incomeExpenseChart" class="chart-bar-container">
                            </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold mb-5 text-gray-800">Pengeluaran Berdasarkan Kategori</h3>
                        <div id="expenseByCategorySummary" class="space-y-4">
                            <p class="text-gray-500 text-center text-base">Belum ada pengeluaran berdasarkan kategori.</p>
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-5 text-gray-800">Transaksi Terbaru</h3>
                    <div id="latestTransactions" class="space-y-4">
                        <p class="text-gray-500 text-center text-base">Belum ada transaksi.</p>
                    </div>
                </div>
            </section>

            <!-- Transactions Section -->
            <section id="transactionsSection" class="hidden">
                <h2 class="text-3xl font-bold mb-8 text-gray-800">Transaksi</h2>
                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800">Tambah Transaksi Baru</h3>
                    <form id="transactionForm" class="space-y-6">
                        <div>
                            <label for="transactionDate" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                            <input type="date" id="transactionDate" required class="block">
                        </div>
                        <div>
                            <label for="transactionDescription" class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                            <input type="text" id="transactionDescription" placeholder="Contoh: Beli Kopi" required class="block">
                        </div>
                        <div>
                            <label for="transactionAmount" class="block text-sm font-medium text-gray-700 mb-2">Jumlah (Rp)</label>
                            <input type="number" id="transactionAmount" placeholder="Contoh: 25000" required min="1" class="block">
                        </div>
                        <div>
                            <label for="transactionType" class="block text-sm font-medium text-gray-700 mb-2">Tipe</label>
                            <select id="transactionType" required class="block">
                                <option value="income">Pemasukan</option>
                                <option value="expense">Pengeluaran</option>
                            </select>
                        </div>
                        <div>
                            <label for="transactionCategory" class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                            <select id="transactionCategory" required class="block">
                                </select>
                        </div>
                        <button type="submit" class="w-full btn-primary font-semibold text-lg py-3"><i data-feather="plus-circle" class="feather-icon"></i> Tambah Transaksi</button>
                    </form>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800">Daftar Semua Transaksi</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-5">
                        <div class="col-span-full lg:col-span-1">
                            <label for="transactionSearchInput" class="block text-sm font-medium text-gray-700 mb-2">Cari Deskripsi</label>
                            <input type="text" id="transactionSearchInput" placeholder="Cari transaksi..." class="block">
                        </div>
                        <div>
                            <label for="filterType" class="block text-sm font-medium text-gray-700 mb-2">Filter Tipe</label>
                            <select id="filterType" class="block">
                                <option value="all">Semua</option>
                                <option value="income">Pemasukan</option>
                                <option value="expense">Pengeluaran</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterStartDate" class="block text-sm font-medium text-gray-700 mb-2">Tanggal Mulai</label>
                            <input type="date" id="filterStartDate" class="block">
                        </div>
                        <div>
                            <label for="filterEndDate" class="block text-sm font-medium text-gray-700 mb-2">Tanggal Akhir</label>
                            <input type="date" id="filterEndDate" class="block">
                        </div>
                        <div class="col-span-full sm:col-span-2 lg:col-span-1">
                            <label for="sortBy" class="block text-sm font-medium text-gray-700 mb-2">Urutkan Berdasarkan</label>
                            <select id="sortBy" class="block">
                                <option value="dateDesc">Tanggal (Terbaru)</option>
                                <option value="dateAsc">Tanggal (Terlama)</option>
                                <option value="amountDesc">Jumlah (Terbesar)</option>
                                <option value="amountAsc">Jumlah (Terkecil)</option>
                            </select>
                        </div>
                    </div>
                    <div id="allTransactionsList" class="space-y-4">
                        <p class="text-gray-500 text-center text-base">Belum ada transaksi.</p>
                    </div>
                    <div id="paginationControls" class="flex justify-center items-center gap-4 mt-6">
                        <button id="prevPageBtn" class="btn-secondary px-5 py-2.5 rounded-xl"><i data-feather="arrow-left" class="feather-icon"></i> Sebelumnya</button>
                        <span id="pageInfo" class="text-gray-700 font-medium text-base">Halaman 1 dari 1</span>
                        <button id="nextPageBtn" class="btn-secondary px-5 py-2.5 rounded-xl">Berikutnya <i data-feather="arrow-right" class="feather-icon"></i></button>
                    </div>
                </div>
            </section>

            <!-- New Budgeting Section -->
            <section id="budgetingSection" class="hidden">
                <h2 class="text-3xl font-bold mb-8 text-gray-800">Rencana Anggaran</h2>
                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800">Tetapkan Anggaran Baru</h3>
                    <form id="budgetForm" class="space-y-6">
                        <div>
                            <label for="budgetItemCategory" class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                            <select id="budgetItemCategory" required class="block">
                                <!-- Categories will be loaded here -->
                            </select>
                        </div>
                        <div>
                            <label for="budgetAmount" class="block text-sm font-medium text-gray-700 mb-2">Jumlah Anggaran (Rp)</label>
                            <input type="number" id="budgetAmount" placeholder="Contoh: 500000" required min="1" class="block">
                        </div>
                        <div>
                            <label for="budgetStartDate" class="block text-sm font-medium text-gray-700 mb-2">Tanggal Mulai</label>
                            <input type="date" id="budgetStartDate" required class="block">
                        </div>
                        <div>
                            <label for="budgetEndDate" class="block text-sm font-medium text-gray-700 mb-2">Tanggal Akhir</label>
                            <input type="date" id="budgetEndDate" required class="block">
                        </div>
                        <button type="submit" class="w-full btn-primary font-semibold text-lg py-3"><i data-feather="save" class="feather-icon"></i> Simpan Anggaran</button>
                    </form>
                    <p id="budgetMessage" class="text-red-500 text-sm hidden mt-4 font-medium text-center"></p>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800">Daftar Anggaran Anda</h3>
                    <div id="budgetList" class="space-y-5">
                        <p class="text-gray-500 text-center text-base">Belum ada anggaran yang ditetapkan.</p>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="reportsSection" class="hidden">
                <h2 class="text-3xl font-bold mb-8 text-gray-800">Laporan Keuangan</h2>
                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800">Ringkasan Laporan</h3>
                    <div class="flex flex-col sm:flex-row gap-4 mb-5">
                        <div class="flex-1">
                            <label for="reportMonthSelect" class="block text-sm font-medium text-gray-700 mb-2">Bulan</label>
                            <select id="reportMonthSelect" class="block">
                                <option value="all">Semua Bulan</option>
                                <option value="01">Januari</option>
                                <option value="02">Februari</option>
                                <option value="03">Maret</option>
                                <option value="04">April</option>
                                <option value="05">Mei</option>
                                <option value="06">Juni</option>
                                <option value="07">Juli</option>
                                <option value="08">Agustus</option>
                                <option value="09">September</option>
                                <option value="10">Oktober</option>
                                <option value="11">November</option>
                                <option value="12">Desember</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label for="reportYearSelect" class="block text-sm font-medium text-gray-700 mb-2">Tahun</label>
                            <select id="reportYearSelect" class="block">
                                </select>
                        </div>
                    </div>
                    <div class="space-y-4 mb-6">
                        <p class="text-lg text-gray-700">Total Pemasukan: <span id="reportTotalIncome" class="font-semibold text-income">Rp 0</span></p>
                        <p class="text-lg text-gray-700">Total Pengeluaran: <span id="reportTotalExpense" class="font-semibold text-expense">Rp 0</span></p>
                        <p class="text-xl text-gray-800 font-bold">Saldo Bersih: <span id="reportNetBalance" class="font-extrabold text-blue-700">Rp 0</span></p>
                    </div>

                    <h4 class="text-xl font-bold mt-8 mb-4 text-gray-800">Grafik Pemasukan dan Pengeluaran Bulanan</h4>
                    <div class="relative h-64 bg-gray-50 p-4 rounded-xl shadow-inner">
                        <canvas id="monthlySummaryChart"></canvas>
                    </div>

                    <h4 class="text-xl font-bold mt-8 mb-4 text-gray-800">Pengeluaran per Kategori (Grafik Lingkaran)</h4>
                    <div class="relative h-64 bg-gray-50 p-4 rounded-xl shadow-inner">
                        <canvas id="expenseByCategoryChart"></canvas>
                    </div>

                    <h4 class="text-xl font-bold mt-8 mb-4 text-gray-800">Pemasukan per Kategori (Grafik Lingkaran)</h4>
                    <div class="relative h-64 bg-gray-50 p-4 rounded-xl shadow-inner">
                        <canvas id="incomeByCategoryChart"></canvas>
                    </div>

                    <h4 class="text-xl font-bold mt-8 mb-4 text-gray-800">Pengeluaran per Kategori</h4>
                    <div id="reportExpenseByCategory" class="space-y-4">
                        <p class="text-gray-500 text-center text-base">Belum ada data pengeluaran per kategori.</p>
                    </div>
                    <h4 class="text-xl font-bold mt-8 mb-4 text-gray-800">Pemasukan per Kategori</h4>
                    <div id="reportIncomeByCategory" class="space-y-4">
                        <p class="text-gray-500 text-center text-base">Belum ada data pemasukan per kategori.</p>
                    </div>
                    <h4 class="text-xl font-bold mt-8 mb-4 text-gray-800">Detail Transaksi</h4>
                    <div id="reportTransactionsList" class="overflow-x-auto">
                        <p class="text-gray-500 text-center text-base">Belum ada transaksi untuk laporan.</p>
                    </div>
                    <button id="generatePdfReportBtn" class="w-full btn-primary font-semibold mt-6 text-lg py-3"><i data-feather="download" class="feather-icon"></i> Generate Laporan PDF</button>
                </div>
            </section>

            <!-- Analysis Section -->
            <section id="analysisSection" class="hidden">
                <h2 class="text-3xl font-bold mb-8 text-gray-800">Analisis Keuangan</h2>
                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-4 text-gray-800">Tren Keuangan Bulanan</h3>
                    <p class="text-gray-700 mb-4 text-base">Lihat bagaimana pemasukan, pengeluaran, dan saldo Anda berkembang dari waktu ke waktu.</p>
                    <div class="relative h-80 bg-gray-50 p-4 rounded-xl shadow-inner">
                        <canvas id="financialTrendsChart"></canvas>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">5 Kategori Pengeluaran Teratas</h3>
                        <div class="relative h-64 bg-gray-50 p-4 rounded-xl shadow-inner">
                            <canvas id="topExpenseCategoriesChart"></canvas>
                        </div>
                        <div id="topExpenseCategoriesSummary" class="space-y-4 mt-4">
                            <p class="text-gray-500 text-center text-base">Belum ada data pengeluaran.</p>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">5 Kategori Pemasukan Teratas</h3>
                        <div class="relative h-64 bg-gray-50 p-4 rounded-xl shadow-inner">
                            <canvas id="topIncomeCategoriesChart"></canvas>
                        </div>
                        <div id="topIncomeCategoriesSummary" class="space-y-4 mt-4">
                            <p class="text-gray-500 text-center text-base">Belum ada data pemasukan.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Exchange Rate Section -->
            <section id="exchangeRateSection" class="hidden">
                <h2 class="text-3xl font-bold mb-8 text-gray-800">Nilai Tukar Mata Uang</h2>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800">Konverter Mata Uang</h3>
                    <form id="currencyConverterForm" class="space-y-6">
                        <div>
                            <label for="amountToConvert" class="block text-sm font-medium text-gray-700 mb-2">Jumlah</label>
                            <input type="number" id="amountToConvert" placeholder="Masukkan jumlah" required min="0" step="any" class="block">
                        </div>
                        <div>
                            <label for="fromCurrency" class="block text-sm font-medium text-gray-700 mb-2">Dari Mata Uang</label>
                            <select id="fromCurrency" required class="block"></select>
                        </div>
                        <div>
                            <label for="toCurrency" class="block text-sm font-medium text-gray-700 mb-2">Ke Mata Uang</label>
                            <select id="toCurrency" required class="block"></select>
                        </div>
                        <button type="submit" class="w-full btn-primary font-semibold text-lg py-3"><i data-feather="repeat" class="feather-icon"></i> Konversi</button>
                    </form>
                    <p id="conversionResult" class="text-center mt-5 text-lg font-semibold text-blue-600 hidden"></p>
                    <p id="exchangeRateLastUpdated" class="text-sm text-gray-500 text-center mt-3"></p>
                </div>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800">Nilai Tukar Favorit</h3>
                    <div id="favoriteRatesList" class="space-y-3">
                        <p class="text-gray-500 text-center text-base">Belum ada nilai tukar favorit.</p>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800">Semua Nilai Tukar (IDR sebagai basis)</h3>
                    <div class="overflow-x-auto">
                        <table class="responsive-table w-full text-base">
                            <thead>
                                <tr>
                                    <th>Mata Uang</th>
                                    <th>Nilai Tukar ke IDR</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="allRatesTableBody">
                                <tr><td colspan="3" class="text-center text-gray-500">Memuat nilai tukar...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>


            <!-- Settings Section -->
            <section id="settingsSection" class="hidden">
                <h2 class="text-3xl font-bold mb-8 text-gray-800">Pengaturan</h2>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-4 text-gray-800">Mode Tampilan</h3>
                    <div class="flex items-center space-x-3">
                        <label for="darkModeToggle" class="block text-base font-medium text-gray-700">Mode Gelap</label>
                        <input type="checkbox" id="darkModeToggle" class="toggle">
                    </div>
                </div>

                <div class="card p-6 mt-8 mb-8">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800">Kalkulator Tabungan</h3>
                    <form id="savingsCalculatorForm" class="space-y-6">
                        <div>
                            <label for="targetAmount" class="block text-sm font-medium text-gray-700 mb-2">Target Tabungan (Rp)</label>
                            <input type="number" id="targetAmount" required placeholder="Contoh: 1000000">
                        </div>
                        <div>
                            <label for="savingAmount" class="block text-sm font-medium text-gray-700 mb-2">Jumlah Sekali Nabung (Rp)</label>
                            <input type="number" id="savingAmount" required placeholder="Contoh: 10000">
                        </div>
                        <div>
                            <label for="savingFrequency" class="block text-sm font-medium text-gray-700 mb-2">Frekuensi Menabung</label>
                            <select id="savingFrequency" required class="block">
                                <option value="daily">Harian</option>
                                <option value="monthly">Bulanan</option>
                                <option value="yearly">Tahunan</option>
                            </select>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button type="submit" class="w-full btn-primary font-semibold text-lg py-3"><i data-feather="calculator" class="feather-icon"></i> Hitung</button>
                            <button type="reset" class="w-full btn-secondary font-semibold text-lg py-3"><i data-feather="refresh-cw" class="feather-icon"></i> Reset</button>
                        </div>
                    </form>
                    <p id="savingsResult" class="text-center mt-5 text-lg font-semibold text-blue-600 hidden"></p>
                </div>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800">Ubah Kata Sandi</h3>
                    <form id="changePasswordForm" class="space-y-6">
                        <div>
                            <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-2">Kata Sandi Saat Ini</label>
                            <input type="password" id="currentPassword" required class="block">
                        </div>
                        <div>
                            <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-2">Kata Sandi Baru</label>
                            <input type="password" id="newPassword" required class="block">
                        </div>
                        <div>
                            <label for="confirmNewPassword" class="block text-sm font-medium text-gray-700 mb-2">Konfirmasi Kata Sandi Baru</label>
                            <input type="password" id="confirmNewPassword" required class="block">
                        </div>
                        <p id="passwordMessage" class="text-red-500 text-sm hidden font-medium text-center"></p>
                        <button type="submit" class="w-full btn-primary font-semibold text-lg py-3"><i data-feather="lock" class="feather-icon"></i> Ubah Kata Sandi</button>
                    </form>
                </div>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800">Kelola Kategori</h3>
                    <form id="addCategoryForm" class="flex flex-col sm:flex-row gap-4 mb-4">
                        <input type="text" id="newCategoryName" placeholder="Nama Kategori Baru" required class="flex-grow">
                        <button type="submit" class="btn-primary font-semibold px-5 py-2.5"><i data-feather="tag" class="feather-icon"></i> Tambah Kategori</button>
                    </form>
                    <div id="categoryList" class="space-y-3">
                        <p class="text-gray-500 text-center text-base">Belum ada kategori.</p>
                    </div>
                </div>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800">Backup & Pulihkan Data (Lokal)</h3>
                    <p class="text-gray-700 mb-4 text-base">Ekspor semua data Anda ke file atau impor dari file yang sudah ada.</p>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="exportAllDataBtn" class="w-full sm:w-1/2 btn-primary font-semibold text-lg py-3"><i data-feather="upload-cloud" class="feather-icon"></i> Ekspor Semua Data</button>
                        <input type="file" id="importAllDataInput" accept=".json" class="hidden">
                        <label for="importAllDataInput" class="w-full sm:w-1/2 btn-secondary cursor-pointer text-center font-semibold text-lg py-3"><i data-feather="download-cloud" class="feather-icon"></i> Impor Semua Data</label>
                    </div>
                </div>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800">Kirim Semua Transaksi ke WhatsApp</h3>
                    <p class="text-gray-700 mb-4 text-base">Klik tombol di bawah untuk mengirim semua detail transaksi Anda ke nomor WhatsApp yang ditentukan.</p>
                    <button id="sendWhatsappSummaryBtn" class="w-full btn-primary font-semibold text-lg py-3"><i data-feather="send" class="feather-icon"></i> Kirim Semua Transaksi ke WhatsApp</button>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800">Ekspor Data Transaksi (CSV)</h3>
                    <p class="text-gray-700 mb-4 text-base">Unduh semua transaksi Anda dalam format CSV.</p>
                    <button id="exportDataBtn" class="btn-primary font-semibold text-lg py-3"><i data-feather="file-text" class="feather-icon"></i> Ekspor Transaksi ke CSV</button>
                </div>

                <div class="card p-6 mt-8">
                    <h3 class="text-2xl font-bold mb-6 text-red-600">Hapus Akun</h3>
                    <p class="text-gray-700 mb-4 text-base">Menghapus akun Anda akan menghapus semua data Anda secara permanen. Tindakan ini tidak dapat dibatalkan.</p>
                    <button id="deleteAccountBtn" class="w-full btn-danger font-semibold text-lg py-3"><i data-feather="trash-2" class="feather-icon"></i> Hapus Akun Saya</button>
                </div>
            </section>

            <!-- Help Section (Chatbot) -->
            <section id="helpSection" class="hidden">
                <h2 class="text-3xl font-bold mb-8 text-gray-800">Bantuan</h2>
                <div class="card p-6 h-[70vh] flex flex-col">
                    <h3 class="text-2xl font-bold mb-4 text-gray-800">Asisten Bantuan</h3>
                    <div id="chatDisplay" class="flex flex-col flex-grow mb-4">
                        <!-- Chat messages will be displayed here -->
                    </div>
                    <div id="chatOptions" class="flex flex-wrap justify-center gap-3 mt-auto">
                        <!-- Chat options will be dynamically generated here -->
                    </div>
                </div>
            </section>
            </main>

        <!-- Footer -->
        <footer class="bg-gray-900 text-white text-center p-5 text-sm mt-auto shadow-inner-up">
            &copy; 2025 by Adi Sudrajat. All rights reserved.
        </footer>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideConfirmationModal()">&times;</button>
            <h3 class="text-2xl font-bold mb-4 text-gray-800" id="confirmationModalTitle">Konfirmasi</h3>
            <p id="confirmationModalMessage" class="mb-6 text-gray-700 text-base">Apakah Anda yakin?</p>
            <div class="flex justify-end gap-4">
                <button id="confirmNoBtn" class="btn-secondary px-5 py-2.5"><i data-feather="x" class="feather-icon"></i> Tidak</button>
                <button id="confirmYesBtn" class="btn-danger px-5 py-2.5"><i data-feather="check" class="feather-icon"></i> Ya</button>
            </div>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="editTransactionModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideEditTransactionModal()">&times;</button>
            <h3 class="text-2xl font-bold mb-4 text-gray-800">Edit Transaksi</h3>
            <form id="editTransactionForm" class="space-y-5">
                <input type="hidden" id="editTransactionId">
                <div>
                    <label for="editTransactionDate" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                    <input type="date" id="editTransactionDate" required class="block">
                </div>
                <div>
                    <label for="editTransactionDescription" class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                    <input type="text" id="editTransactionDescription" required class="block">
                </div>
                <div>
                    <label for="editTransactionAmount" class="block text-sm font-medium text-gray-700 mb-2">Jumlah (Rp)</label>
                    <input type="number" id="editTransactionAmount" required min="1" class="block">
                </div>
                <div>
                    <label for="editTransactionType" class="block text-sm font-medium text-gray-700 mb-2">Tipe</label>
                    <select id="editTransactionType" required class="block">
                        <option value="income">Pemasukan</option>
                        <option value="expense">Pengeluaran</option>
                    </select>
                </div>
                <div>
                    <label for="editTransactionCategory" class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                    <select id="editTransactionCategory" required class="block">
                        </select>
                </div>
                <button type="submit" class="w-full btn-primary font-semibold text-lg py-3"><i data-feather="save" class="feather-icon"></i> Simpan Perubahan</button>
            </form>
        </div>
    </div>

    <!-- JSON Display Modal -->
    <div id="jsonDisplayModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideJsonDisplayModal()">&times;</button>
            <h3 class="text-2xl font-bold mb-4 text-gray-800">Ekspor Data JSON</h3>
            <p class="text-gray-700 mb-4 text-base">Salin teks di bawah ini dan tempelkan ke editor teks di perangkat Anda, lalu simpan sebagai file `.json`.</p>
            <textarea id="jsonOutput" readonly></textarea>
            <button id="copyJsonBtn" class="btn-primary font-semibold text-lg py-3"><i data-feather="copy" class="feather-icon"></i> Salin ke Clipboard</button>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgotPasswordModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideForgotPasswordModal()">&times;</button>
            <h3 class="text-2xl font-bold mb-4 text-gray-800">Lupa Kata Sandi</h3>
            <form id="forgotPasswordForm" class="space-y-5">
                <div>
                    <label for="forgotPasswordEmail" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="forgotPasswordEmail" placeholder="Masukkan email Anda" required class="block">
                </div>
                <p id="forgotPasswordMessage" class="text-red-500 text-sm hidden font-medium text-center"></p>
                <button type="submit" class="w-full btn-primary font-semibold text-lg py-3"><i data-feather="mail" class="feather-icon"></i> Kirim Link Reset Kata Sandi</button>
            </form>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updatePassword,
            deleteUser as deleteFirebaseAuthUser,
            reauthenticateWithCredential,
            EmailAuthProvider,
            sendPasswordResetEmail,
            sendEmailVerification // Added for email verification
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            addDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            getDocs,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (provided by the environment)
        const firebaseConfig = {
            apiKey: "AIzaSyDvf_Rg89uX9ODamiUjTCZ-ZTIYA2C7a7w",
            authDomain: "keuanganadi.firebaseapp.com",
            projectId: "keuanganadi",
            storageBucket: "keuanganadi.firebasestorage.app",
            messagingSenderId: "829317955644",
            appId: "1:829317955644:web:ecd350db338c02ab0fc339",
            measurementId: "G-WDNBRP6DB5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables for Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        console.log("Using appId for Firestore paths:", appId);
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // API Key for Exchange Rate
        const EXCHANGE_RATE_API_KEY = "66a672118f9b21a247ab9d4a"; // Your provided API key

        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const menuBtn = document.getElementById('menuBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const authSection = document.getElementById('authSection');
        const authTitle = document.getElementById('authTitle');
        const authForm = document.getElementById('authForm');
        const usernameInput = document.getElementById('username'); // Now email input
        const passwordInput = document.getElementById('password');
        const authSubmitBtn = document.getElementById('authSubmitBtn');
        const authMessage = document.getElementById('authMessage');
        const toggleAuthModeBtn = document.getElementById('toggleAuthMode');
        const forgotPasswordLink = document.getElementById('forgotPasswordLink'); // New: Forgot Password Link

        const dashboardSection = document.getElementById('dashboardSection');
        const dashboardUsernameEl = document.getElementById('dashboardUsername');
        const currentBalanceEl = document.getElementById('currentBalance');
        const totalIncomeEl = document.getElementById('totalIncome');
        const totalExpenseEl = document.getElementById('totalExpense');
        const latestTransactionsEl = document.getElementById('latestTransactions');
        const incomeExpenseChart = document.getElementById('incomeExpenseChart');
        const expenseByCategorySummary = document.getElementById('expenseByCategorySummary');

        const transactionsSection = document.getElementById('transactionsSection');
        const transactionForm = document.getElementById('transactionForm');
        const transactionDateInput = document.getElementById('transactionDate');
        const transactionDescriptionInput = document.getElementById('transactionDescription');
        const transactionAmountInput = document.getElementById('transactionAmount');
        const transactionTypeInput = document.getElementById('transactionType');
        const transactionCategoryInput = document.getElementById('transactionCategory');
        const allTransactionsListEl = document.getElementById('allTransactionsList');
        const transactionSearchInput = document.getElementById('transactionSearchInput');
        const filterTypeSelect = document.getElementById('filterType');
        const filterStartDate = document.getElementById('filterStartDate');
        const filterEndDate = document.getElementById('filterEndDate');
        const sortBySelect = document.getElementById('sortBy');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const pageInfo = document.getElementById('pageInfo');

        // New Budgeting Section Elements
        const budgetingSidebarItem = document.getElementById('budgetingSidebarItem');
        const budgetingSection = document.getElementById('budgetingSection');
        const budgetForm = document.getElementById('budgetForm');
        const budgetItemCategorySelect = document.getElementById('budgetItemCategory');
        const budgetAmountInput = document.getElementById('budgetAmount');
        const budgetStartDateInput = document.getElementById('budgetStartDate');
        const budgetEndDateInput = document.getElementById('budgetEndDate');
        const budgetListEl = document.getElementById('budgetList');
        const budgetMessageEl = document.getElementById('budgetMessage');

        const reportsSection = document.getElementById('reportsSection');
        const reportMonthSelect = document.getElementById('reportMonthSelect');
        const reportYearSelect = document.getElementById('reportYearSelect');
        const reportTotalIncomeEl = document.getElementById('reportTotalIncome');
        const reportTotalExpenseEl = document.getElementById('reportTotalExpense');
        const reportNetBalanceEl = document.getElementById('reportNetBalance');
        const reportExpenseByCategory = document.getElementById('reportExpenseByCategory');
        const reportIncomeByCategory = document.getElementById('reportIncomeByCategory');
        const reportTransactionsListEl = document.getElementById('reportTransactionsList');
        const generatePdfReportBtn = document.getElementById('generatePdfReportBtn'); // New PDF button

        // New Chart.js canvas elements
        const monthlySummaryChartCanvas = document.getElementById('monthlySummaryChart');
        const expenseByCategoryChartCanvas = document.getElementById('expenseByCategoryChart');
        const incomeByCategoryChartCanvas = document.getElementById('incomeByCategoryChart');

        let monthlySummaryChartInstance = null; // To store Chart.js instance for monthly summary
        let expenseByCategoryChartInstance = null; // To store Chart.js instance for expense by category
        let incomeByCategoryChartInstance = null; // To store Chart.js instance for income by category

        // Analysis Section Elements
        const analysisSidebarItem = document.getElementById('analysisSidebarItem');
        const analysisSection = document.getElementById('analysisSection');
        const financialTrendsChartCanvas = document.getElementById('financialTrendsChart');
        const topExpenseCategoriesChartCanvas = document.getElementById('topExpenseCategoriesChart');
        const topIncomeCategoriesChartCanvas = document.getElementById('topIncomeCategoriesChart');
        const topExpenseCategoriesSummary = document.getElementById('topExpenseCategoriesSummary');
        const topIncomeCategoriesSummary = document.getElementById('topIncomeCategoriesSummary');

        let financialTrendsChartInstance = null;
        let topExpenseCategoriesChartInstance = null;
        let topIncomeCategoriesChartInstance = null;

        const settingsSection = document.getElementById('settingsSection');
        const changePasswordForm = document.getElementById('changePasswordForm');
        const currentPasswordInput = document.getElementById('currentPassword');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
        const passwordMessageEl = document.getElementById('passwordMessage');
        const addCategoryForm = document.getElementById('addCategoryForm');
        const newCategoryNameInput = document.getElementById('newCategoryName');
        const categoryListEl = document.getElementById('categoryList');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const deleteAccountBtn = document.getElementById('deleteAccountBtn'); // New delete account button
        const darkModeToggle = document.getElementById('darkModeToggle'); // New dark mode toggle

        // WhatsApp Send Button
        const sendWhatsappSummaryBtn = document.getElementById('sendWhatsappSummaryBtn');

        // Specific sidebar items to hide/show
        const dashboardSidebarItem = document.getElementById('dashboardSidebarItem');
        const transactionsSidebarItem = document.getElementById('transactionsSidebarItem');
        const reportsSidebarItem = document.getElementById('reportsSidebarItem');
        const settingsSidebarItem = document.getElementById('settingsSidebarItem');
        const helpSidebarItem = document.getElementById('helpSidebarItem'); // New help sidebar item
        const exchangeRateSidebarItem = document.getElementById('exchangeRateSidebarItem'); // New Exchange Rate sidebar item

        const sidebarItems = document.querySelectorAll('.sidebar-item');

        // Modal Elements
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationModalTitle = document.getElementById('confirmationModalTitle');
        const confirmationModalMessage = document.getElementById('confirmationModalMessage');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmNoBtn = document.getElementById('confirmNoBtn');

        const editTransactionModal = document.getElementById('editTransactionModal');
        const editTransactionForm = document.getElementById('editTransactionForm');
        const editTransactionIdInput = document.getElementById('editTransactionId');
        const editTransactionDateInput = document.getElementById('editTransactionDate');
        const editTransactionDescriptionInput = document.getElementById('editTransactionDescription');
        const editTransactionAmountInput = document.getElementById('editTransactionAmount');
        const editTransactionTypeInput = document.getElementById('editTransactionType');
        const editTransactionCategoryInput = document.getElementById('editTransactionCategory');

        // New JSON Display Modal Elements
        const jsonDisplayModal = document.getElementById('jsonDisplayModal');
        const jsonOutput = document.getElementById('jsonOutput');
        const copyJsonBtn = document.getElementById('copyJsonBtn');

        // New Forgot Password Modal Elements
        const forgotPasswordModal = document.getElementById('forgotPasswordModal');
        const forgotPasswordEmailInput = document.getElementById('forgotPasswordEmail');
        const forgotPasswordMessageEl = document.getElementById('forgotPasswordMessage');
        const forgotPasswordForm = document.getElementById('forgotPasswordForm');

        // Notification Container
        const notificationContainer = document.getElementById('notificationContainer');

        // New Import/Export Buttons
        const exportAllDataBtn = document.getElementById('exportAllDataBtn');
        const importAllDataInput = document.getElementById('importAllDataInput');

        // Chatbot Elements
        const helpSection = document.getElementById('helpSection');
        const chatDisplay = document.getElementById('chatDisplay');
        const chatOptions = document.getElementById('chatOptions');

        // Exchange Rate Section Elements
        const exchangeRateSection = document.getElementById('exchangeRateSection');
        const currencyConverterForm = document.getElementById('currencyConverterForm');
        const amountToConvertInput = document.getElementById('amountToConvert');
        const fromCurrencySelect = document.getElementById('fromCurrency');
        const toCurrencySelect = document.getElementById('toCurrency');
        const conversionResultEl = document.getElementById('conversionResult');
        const exchangeRateLastUpdatedEl = document.getElementById('exchangeRateLastUpdated');
        const favoriteRatesListEl = document.getElementById('favoriteRatesList');
        const allRatesTableBody = document.getElementById('allRatesTableBody');

        // State Variables
        let isLoggedIn = false;
        let currentFirebaseUser = null; // Stores the Firebase User object (auth.currentUser)
        let authMode = 'login'; // 'login' or 'register'
        let availableCurrencies = {}; // Store fetched currencies
        let currentExchangeRates = {}; // Store fetched rates with IDR as base

        // Pagination variables
        const transactionsPerPage = 10;
        let currentPage = 1;
        let filteredTransactions = []; // To store transactions after search/filter for pagination

        // Listeners for Firestore data (unsubscribing when user logs out)
        let unsubscribeTransactions = null;
        let unsubscribeCategories = null;
        let unsubscribeBudgets = null;
        let unsubscribeFavoriteCurrencies = null; // New: Favorite Currencies Listener

        // --- Utility Functions ---

        // Function to format number as Rupiah
        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Function to show a message (e.g., error, success)
        function showMessage(element, message, isError = true) {
            element.textContent = message;
            element.classList.remove('hidden');
            element.classList.toggle('text-red-500', isError);
            element.classList.toggle('text-green-500', !isError);
        }

        // Function to show a notification
        function showNotification(message, type = 'success', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notificationContainer.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, duration);
        }

        // --- Dark Mode Functionality ---
        function enableDarkMode() {
            document.body.classList.add('dark-mode');
            localStorage.setItem('darkMode', 'enabled');
        }

        function disableDarkMode() {
            document.body.classList.remove('dark-mode');
            localStorage.setItem('darkMode', 'disabled');
        }

        function toggleDarkMode() {
            if (document.body.classList.contains('dark-mode')) {
                disableDarkMode();
            } else {
                enableDarkMode();
            }
        }

        // Initialize dark mode based on local storage
        if (localStorage.getItem('darkMode') === 'enabled') {
            enableDarkMode();
            darkModeToggle.checked = true;
        } else {
            disableDarkMode();
            darkModeToggle.checked = false;
        }

        // --- Authentication Functions ---

        // Firebase Auth State Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Check if email is verified
                if (user.emailVerified) {
                    isLoggedIn = true;
                    currentFirebaseUser = user;
                    showSection('dashboardSection');
                    dashboardUsernameEl.textContent = user.email; // Display email as username
                    sidebarUsername.textContent = user.email; // Display email as username
                    setupFirestoreListeners(user.uid); // Setup listeners for regular users
                } else {
                    // If email is not verified, sign out and show message
                    await signOut(auth);
                    isLoggedIn = false;
                    currentFirebaseUser = null;
                    showSection('authSection');
                    unsubscribeAllFirestoreListeners();
                    showMessage(authMessage, 'Email Anda belum diverifikasi. Silakan cek kotak masuk Anda untuk tautan verifikasi.', true);
                    showNotification('Email Anda belum diverifikasi. Silakan cek kotak masuk Anda untuk tautan verifikasi.', 'error', 5000);
                }
            } else {
                isLoggedIn = false;
                currentFirebaseUser = null;
                showSection('authSection');
                unsubscribeAllFirestoreListeners(); // Unsubscribe on logout
            }
            updateUIBasedOnAuth();
        });

        async function handleAuth(event) {
            event.preventDefault();
            authMessage.classList.add('hidden'); // Hide previous message immediately
            const email = usernameInput.value.trim(); // Now email
            const password = passwordInput.value.trim();

            if (!email || !password) {
                showMessage(authMessage, 'Email dan kata sandi tidak boleh kosong.', true);
                showNotification('Email dan kata sandi tidak boleh kosong.', 'error');
                return;
            }

            try {
                if (authMode === 'register') {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    // Send email verification
                    await sendEmailVerification(userCredential.user);

                    // Initialize user data in Firestore
                    await setDoc(doc(db, `artifacts/${appId}/users/${userCredential.user.uid}/metadata`, 'categories'), {
                        list: ['Makanan', 'Transportasi', 'Gaji', 'Hiburan', 'Tagihan', 'Lain-lain']
                    });
                    await setDoc(doc(db, `artifacts/${appId}/users/${userCredential.user.uid}/metadata`, 'budgets'), {
                        list: []
                    });
                     await setDoc(doc(db, `artifacts/${appId}/users/${userCredential.user.uid}/metadata`, 'favoriteCurrencies'), {
                        list: [] // Initialize empty array for favorite currencies
                    });

                    showMessage(authMessage, 'Registrasi berhasil! Link verifikasi telah dikirim ke email Anda. Silakan cek kotak masuk Anda untuk tautan verifikasi.', false);
                    showNotification('Registrasi berhasil! Link verifikasi telah dikirim ke email Anda. Silakan verifikasi email Anda sebelum login.', 'success', 5000);
                    // Switch to login mode after successful registration
                    authMode = 'login';
                    authTitle.textContent = 'Login';
                    authSubmitBtn.textContent = 'Login';
                    toggleAuthModeBtn.textContent = 'Daftar di sini';
                    usernameInput.value = ''; // Clear fields after successful registration
                    passwordInput.value = ''; // Clear fields after successful registration

                } else { // Login mode
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    // Check email verification status after successful login
                    if (!userCredential.user.emailVerified) {
                        await signOut(auth); // Sign out unverified user
                        showMessage(authMessage, 'Email Anda belum diverifikasi. Silakan cek kotak masuk Anda untuk tautan verifikasi.', true);
                        showNotification('Email Anda belum diverifikasi. Silakan cek kotak masuk Anda untuk tautan verifikasi.', 'error', 5000);
                        return; // Stop further execution
                    }
                    showMessage(authMessage, 'Login berhasil!', false);
                    showNotification('Login berhasil!', 'success');
                    // onAuthStateChanged will handle showing the correct section
                }
            } catch (error) {
                console.error("Authentication error:", error);
                let errorMessage = 'Terjadi kesalahan otentikasi.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Email sudah terdaftar. Silakan gunakan email lain atau login.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Format email tidak valid.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Kata sandi terlalu lemah (minimal 6 karakter).';
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = 'Email atau kata sandi salah.';
                }
                showMessage(authMessage, errorMessage, true);
                showNotification(errorMessage, 'error');
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                showNotification('Anda telah logout.', 'success');
                // onAuthStateChanged will handle showing the auth section
            } catch (error) {
                console.error("Logout error:", error);
                showNotification('Gagal logout. Silakan coba lagi.', 'error');
            }
            // Reset form fields
            usernameInput.value = '';
            passwordInput.value = '';
        }

        function updateUIBasedOnAuth() {
            if (isLoggedIn) {
                authSection.classList.add('hidden');
                sidebar.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                // Ensure sidebar is open on desktop, hidden on mobile initially
                if (window.innerWidth < 768) {
                    sidebar.classList.remove('open');
                } else {
                    sidebar.classList.add('open');
                }

                dashboardSidebarItem.classList.remove('hidden');
                transactionsSidebarItem.classList.remove('hidden');
                budgetingSidebarItem.classList.remove('hidden');
                reportsSidebarItem.classList.remove('hidden');
                analysisSidebarItem.classList.remove('hidden');
                exchangeRateSidebarItem.classList.remove('hidden'); // Show exchange rate sidebar item
                settingsSidebarItem.classList.remove('hidden');
                helpSidebarItem.classList.remove('hidden');
            } else {
                authSection.classList.remove('hidden');
                sidebar.classList.add('hidden');
                logoutBtn.classList.add('hidden');
                // Hide all sidebar items on logout
                dashboardSidebarItem.classList.add('hidden');
                transactionsSidebarItem.classList.add('hidden');
                budgetingSidebarItem.classList.add('hidden');
                reportsSidebarItem.classList.add('hidden');
                analysisSidebarItem.classList.add('hidden');
                exchangeRateSidebarItem.classList.add('hidden'); // Hide exchange rate sidebar item
                settingsSidebarItem.classList.add('hidden');
                helpSidebarItem.classList.add('hidden');

                // Hide all other sections
                document.querySelectorAll('main > section:not(#authSection)').forEach(section => {
                    section.classList.add('hidden');
                });
                sidebarUsername.textContent = ''; // Clear username in sidebar
            }
        }

        // --- Firestore Data Management ---

        // Setup real-time listeners for current user's data
        function setupFirestoreListeners(uid) {
            console.log("Setting up Firestore listeners for UID:", uid); // Log when listeners are set up
            // Unsubscribe existing listeners first
            unsubscribeAllFirestoreListeners();

            // Transactions listener
            const transactionsRef = collection(db, `artifacts/${appId}/users/${uid}/transactions`);
            unsubscribeTransactions = onSnapshot(transactionsRef, (snapshot) => {
                const transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Firestore Transactions updated:", transactions); // Log fetched transactions
                window._userTransactions = transactions; // Make it accessible globally for other functions
                renderDashboard();
                renderTransactions();
                renderReports();
                renderAnalysis();
                renderBudgets(); // Re-render budgets as they depend on transactions
            }, (error) => {
                console.error("Error fetching transactions:", error);
                showNotification('Gagal memuat transaksi. Silakan coba lagi.', 'error');
            });

            // Categories listener
            const categoriesDocRef = doc(db, `artifacts/${appId}/users/${uid}/metadata`, 'categories');
            unsubscribeCategories = onSnapshot(categoriesDocRef, (docSnap) => {
                const categories = docSnap.exists() ? docSnap.data().list : ['Makanan', 'Transportasi', 'Gaji', 'Hiburan', 'Tagihan', 'Lain-lain'];
                console.log("Firestore Categories updated:", categories); // Log fetched categories
                window._userCategories = categories;
                renderCategoryOptions(transactionCategoryInput);
                renderCategoryOptions(editTransactionCategoryInput);
                renderCategoryOptions(budgetItemCategorySelect);
                renderManageCategories();
            }, (error) => {
                console.error("Error fetching categories:", error);
                showNotification('Gagal memuat kategori. Silakan coba lagi.', 'error');
            });

            // Budgets listener
            const budgetsDocRef = doc(db, `artifacts/${appId}/users/${uid}/metadata`, 'budgets');
            unsubscribeBudgets = onSnapshot(budgetsDocRef, (docSnap) => {
                const budgets = docSnap.exists() ? docSnap.data().list : [];
                console.log("Firestore Budgets updated:", budgets); // Log fetched budgets
                window._userBudgets = budgets;
                renderBudgets();
            }, (error) => {
                console.error("Error fetching budgets:", error);
                showNotification('Gagal memuat anggaran. Silakan coba lagi.', 'error');
            });

            // Favorite Currencies listener
            const favoriteCurrenciesDocRef = doc(db, `artifacts/${appId}/users/${uid}/metadata`, 'favoriteCurrencies');
            unsubscribeFavoriteCurrencies = onSnapshot(favoriteCurrenciesDocRef, (docSnap) => {
                const favoriteCurrencies = docSnap.exists() ? docSnap.data().list : [];
                console.log("Firestore Favorite Currencies updated:", favoriteCurrencies);
                window._favoriteCurrencies = favoriteCurrencies;
                renderFavoriteRates();
            }, (error) => {
                console.error("Error fetching favorite currencies:", error);
                showNotification('Gagal memuat mata uang favorit. Silakan coba lagi.', 'error');
            });
        }

        // Unsubscribe all listeners (on logout)
        function unsubscribeAllFirestoreListeners() {
            if (unsubscribeTransactions) unsubscribeTransactions();
            if (unsubscribeCategories) unsubscribeCategories();
            if (unsubscribeBudgets) unsubscribeBudgets();
            if (unsubscribeFavoriteCurrencies) unsubscribeFavoriteCurrencies(); // Unsubscribe favorite currencies
            window._userTransactions = [];
            window._userCategories = [];
            window._userBudgets = [];
            window._favoriteCurrencies = []; // Clear favorite currencies
            console.log("All Firestore listeners unsubscribed.");
        }

        // Helper to get current user's UID
        function getCurrentUserId() {
            return currentFirebaseUser ? currentFirebaseUser.uid : null;
        }

        // Functions to interact with Firestore data
        function getUserTransactions() {
            return window._userTransactions || [];
        }

        async function addTransactionToFirestore(transaction) {
            const userId = getCurrentUserId();
            if (!userId) {
                showNotification('Anda harus login untuk menambahkan transaksi.', 'error');
                return;
            }
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/transactions`), transaction);
                console.log("Transaction added to Firestore:", transaction);
            } catch (error) {
                console.error("Error adding transaction:", error);
                showNotification('Gagal menambahkan transaksi. Silakan coba lagi.', 'error');
            }
        }

        async function updateTransactionInFirestore(id, updatedTransaction) {
            const userId = getCurrentUserId();
            if (!userId) {
                showNotification('Anda harus login untuk memperbarui transaksi.', 'error');
                return;
            }
            try {
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/transactions`, id), updatedTransaction);
                console.log("Transaction updated in Firestore:", id, updatedTransaction);
            } catch (error) {
                console.error("Error updating transaction:", error);
                showNotification('Gagal memperbarui transaksi. Silakan coba lagi.', 'error');
            }
        }

        async function deleteTransactionFromFirestore(id) {
            const userId = getCurrentUserId();
            if (!userId) {
                showNotification('Anda harus login untuk menghapus transaksi.', 'error');
                return;
            }
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/transactions`, id));
                console.log("Transaction deleted from Firestore:", id);
            } catch (error) {
                console.error("Error deleting transaction:", error);
                showNotification('Gagal menghapus transaksi. Silakan coba lagi.', 'error');
            }
        }

        function getUserCategories() {
            return window._userCategories || [];
        }

        async function saveUserCategoriesToFirestore(categories) {
            const userId = getCurrentUserId();
            if (!userId) {
                showNotification('Anda harus login untuk menyimpan kategori.', 'error');
                return;
            }
            try {
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'categories'), { list: categories });
                console.log("Categories saved to Firestore:", categories);
            } catch (error) {
                console.error("Error saving categories:", error);
                showNotification('Gagal menyimpan kategori. Silakan coba lagi.', 'error');
            }
        }

        function getUserBudgets() {
            return window._userBudgets || [];
        }

        async function saveUserBudgetsToFirestore(budgets) {
            const userId = getCurrentUserId();
            if (!userId) {
                showNotification('Anda harus login untuk menyimpan anggaran.', 'error');
                return;
            }
            try {
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'budgets'), { list: budgets });
                console.log("Budgets saved to Firestore:", budgets);
            } catch (error) {
                console.error("Error saving budgets:", error);
                showNotification('Gagal menyimpan anggaran. Silakan coba lagi.', 'error');
            }
        }

        function getFavoriteCurrencies() {
            return window._favoriteCurrencies || [];
        }

        async function saveFavoriteCurrenciesToFirestore(favoriteCurrencies) {
            const userId = getCurrentUserId();
            if (!userId) {
                showNotification('Anda harus login untuk menyimpan mata uang favorit.', 'error');
                return;
            }
            try {
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'favoriteCurrencies'), { list: favoriteCurrencies });
                console.log("Favorite currencies saved to Firestore:", favoriteCurrencies);
            } catch (error) {
                console.error("Error saving favorite currencies:", error);
                showNotification('Gagal menyimpan mata uang favorit. Silakan coba lagi.', 'error');
            }
        }

        // --- Section Management ---

        function showSection(sectionId) {
            document.querySelectorAll('main > section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            // Update active sidebar item
            sidebarItems.forEach(item => {
                item.classList.remove('active');
                if (item.dataset.section + 'Section' === sectionId) {
                    item.classList.add('active');
                }
            });

            // Close sidebar on mobile after navigating
            if (window.innerWidth < 768) {
                sidebar.classList.remove('open');
            }

            // Update data for the displayed section
            if (sectionId === 'dashboardSection') {
                renderDashboard();
            } else if (sectionId === 'transactionsSection') {
                renderCategoryOptions(transactionCategoryInput);
                currentPage = 1; // Reset pagination
                renderTransactions();
            } else if (sectionId === 'budgetingSection') {
                renderCategoryOptions(budgetItemCategorySelect);
                renderBudgets();
            }
            else if (sectionId === 'reportsSection') {
                populateReportYears();
                renderReports();
            } else if (sectionId === 'analysisSection') {
                renderAnalysis();
            } else if (sectionId === 'exchangeRateSection') { // New: Handle exchange rate section
                fetchCurrenciesAndRates();
            }
            else if (sectionId === 'settingsSection') {
                renderManageCategories();
            } else if (sectionId === 'helpSection') {
                startChatbot();
            }
        }

        // --- Transaction Management ---

        async function addTransaction(event) {
            event.preventDefault();
            const date = transactionDateInput.value;
            const description = transactionDescriptionInput.value.trim();
            const amount = parseFloat(transactionAmountInput.value);
            const type = transactionTypeInput.value;
            const category = transactionCategoryInput.value;

            if (!date || !description || isNaN(amount) || amount <= 0 || !category) {
                showMessage(authMessage, 'Semua field harus diisi dengan benar.');
                showNotification('Semua field harus diisi dengan benar.', 'error');
                return;
            }

            // Budgeting check for expense transactions
            if (type === 'expense') {
                const budgets = getUserBudgets();
                const activeBudgets = budgets.filter(b => {
                    const budgetStart = new Date(b.startDate);
                    const budgetEnd = new Date(b.endDate);
                    const transactionDate = new Date(date);
                    return b.category === category && transactionDate >= budgetStart && transactionDate <= budgetEnd;
                });

                if (activeBudgets.length > 0) {
                    const currentExpensesForCategory = getUserTransactions().filter(t =>
                        t.type === 'expense' &&
                        t.category === category &&
                        new Date(t.date) >= new Date(activeBudgets[0].startDate) &&
                        new Date(t.date) <= new Date(activeBudgets[0].endDate)
                    ).reduce((sum, t) => sum + t.amount, 0);

                    const budgetLimit = activeBudgets[0].amount;
                    const remainingBudget = budgetLimit - currentExpensesForCategory;

                    if (amount > remainingBudget) {
                        const confirm = await new Promise(resolve => {
                            showConfirmationModal(`Transaksi ini (${formatRupiah(amount)}) akan melebihi anggaran Anda untuk kategori '${category}' (Sisa anggaran: ${formatRupiah(remainingBudget)}). Lanjutkan?`, () => resolve(true), () => resolve(false));
                        });
                        if (!confirm) {
                            showNotification('Transaksi dibatalkan karena melebihi anggaran.', 'info');
                            return;
                        }
                    }
                }
            }

            const newTransaction = {
                date: date,
                description: description,
                amount: amount,
                type: type,
                category: category
            };

            await addTransactionToFirestore(newTransaction);

            showMessage(authMessage, 'Transaksi berhasil ditambahkan!', false);
            showNotification('Transaksi berhasil ditambahkan!', 'success');
            transactionForm.reset(); // Clear form
            const today = new Date().toISOString().split('T')[0];
            transactionDateInput.value = today; // Reset date to today
            // UI will update via Firestore listener (onSnapshot)
        }

        async function deleteTransaction(id) {
            confirmAction('Apakah Anda yakin ingin menghapus transaksi ini?', async () => {
                await deleteTransactionFromFirestore(id);
                showMessage(authMessage, 'Transaksi berhasil dihapus!', false);
                showNotification('Transaksi berhasil dihapus!', 'success');
                // UI will update via Firestore listener (onSnapshot)
            });
        }

        async function editTransaction(id) {
            const transactions = getUserTransactions();
            const transactionToEdit = transactions.find(t => t.id === id);

            if (transactionToEdit) {
                editTransactionIdInput.value = transactionToEdit.id;
                editTransactionDateInput.value = transactionToEdit.date;
                editTransactionDescriptionInput.value = transactionToEdit.description;
                editTransactionAmountInput.value = transactionToEdit.amount;
                editTransactionTypeInput.value = transactionToEdit.type;
                renderCategoryOptions(editTransactionCategoryInput); // Populate categories for edit form
                editTransactionCategoryInput.value = transactionToEdit.category;

                showEditTransactionModal();
            }
        }

        async function updateTransaction(event) {
            event.preventDefault();
            const id = editTransactionIdInput.value; // ID is string from Firestore
            const date = editTransactionDateInput.value;
            const description = editTransactionDescriptionInput.value.trim();
            const amount = parseFloat(editTransactionAmountInput.value);
            const type = editTransactionTypeInput.value;
            const category = editTransactionCategoryInput.value;

            if (!date || !description || isNaN(amount) || amount <= 0 || !category) {
                showMessage(authMessage, 'Semua field harus diisi dengan benar.');
                showNotification('Semua field harus diisi dengan benar.', 'error');
                return;
            }

            const updatedTransaction = { date, description, amount, type, category };

            await updateTransactionInFirestore(id, updatedTransaction);

            showMessage(authMessage, 'Transaksi berhasil diperbarui!', false);
            showNotification('Transaksi berhasil diperbarui!', 'success');
            hideEditTransactionModal();
            // UI will update via Firestore listener (onSnapshot)
        }

        // --- Category Management ---

        function renderCategoryOptions(selectElement) {
            const categories = getUserCategories();
            selectElement.innerHTML = ''; // Clear existing options
            if (categories.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Tidak ada kategori';
                selectElement.appendChild(option);
                selectElement.disabled = true;
                return;
            }
            selectElement.disabled = false;
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                selectElement.appendChild(option);
            });
        }

        async function addCategory(event) {
            event.preventDefault();
            const newCategory = newCategoryNameInput.value.trim();
            if (!newCategory) {
                showMessage(passwordMessageEl, 'Nama kategori tidak boleh kosong.', true);
                showNotification('Nama kategori tidak boleh kosong.', 'error');
                return;
            }

            let categories = getUserCategories();
            if (categories.includes(newCategory)) {
                showMessage(passwordMessageEl, 'Kategori ini sudah ada.', true);
                showNotification('Kategori ini sudah ada.', 'error');
                return;
            }

            categories.push(newCategory);
            await saveUserCategoriesToFirestore(categories);
            showMessage(passwordMessageEl, 'Kategori berhasil ditambahkan!', false);
            showNotification('Kategori berhasil ditambahkan!', 'success');
            newCategoryNameInput.value = '';
            // UI will update via Firestore listener (onSnapshot)
        }

        async function deleteCategory(categoryToDelete) {
            confirmAction(`Apakah Anda yakin ingin menghapus kategori "${categoryToDelete}"? Transaksi dan anggaran yang terkait tidak akan terhapus, tetapi kategorinya akan dialihkan ke 'Lain-lain'.`, async () => {
                let categories = getUserCategories();
                categories = categories.filter(cat => cat !== categoryToDelete);

                // Update transactions that used this category
                let transactions = getUserTransactions();
                const transactionUpdates = transactions.filter(t => t.category === categoryToDelete).map(t => {
                    const updatedT = { ...t, category: 'Lain-lain' };
                    return updateTransactionInFirestore(t.id, updatedT);
                });
                await Promise.all(transactionUpdates);

                // Update budgets that used this category
                let budgets = getUserBudgets();
                budgets.forEach(b => {
                    if (b.category === categoryToDelete) {
                        b.category = 'Lain-lain'; // Assign to a default or 'Uncategorized'
                    }
                });
                await saveUserBudgetsToFirestore(budgets);

                await saveUserCategoriesToFirestore(categories); // Save updated categories last

                showMessage(passwordMessageEl, 'Kategori berhasil dihapus!', false);
                showNotification('Kategori berhasil dihapus!', 'success');
                // UI will update via Firestore listener (onSnapshot)
            });
        }

        function renderManageCategories() {
            const categories = getUserCategories();
            categoryListEl.innerHTML = '';
            if (categories.length === 0) {
                categoryListEl.innerHTML = '<p class="text-gray-500 text-center text-base">Belum ada kategori.</p>';
            } else {
                categories.forEach(cat => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'flex items-center justify-between p-3.5 rounded-lg bg-gray-50 border border-gray-200 shadow-sm';
                    categoryDiv.innerHTML = `
                        <span class="font-medium text-gray-700 text-base">${cat}</span>
                        <button class="btn-danger text-xs px-3 py-1.5" onclick="deleteCategory('${cat}')"><i data-feather="trash" class="feather-icon"></i> Hapus</button>
                    `;
                    categoryListEl.appendChild(categoryDiv);
                });
            }
        }

        // --- Budgeting Functions ---

        async function addBudget(event) {
            event.preventDefault();
            const category = budgetItemCategorySelect.value;
            const amount = parseFloat(budgetAmountInput.value);
            const startDate = budgetStartDateInput.value;
            const endDate = budgetEndDateInput.value;

            if (!category || isNaN(amount) || amount <= 0 || !startDate || !endDate) {
                showMessage(budgetMessageEl, 'Semua field harus diisi dengan benar.', true);
                showNotification('Semua field harus diisi dengan benar.', 'error');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showMessage(budgetMessageEl, 'Tanggal mulai tidak boleh lebih lambat dari tanggal akhir.', true);
                showNotification('Tanggal mulai tidak boleh lebih lambat dari tanggal akhir.', 'error');
                return;
            }

            let budgets = getUserBudgets();

            // Check for overlapping budgets for the same category
            const overlappingBudget = budgets.find(b =>
                b.category === category &&
                ((new Date(startDate) <= new Date(b.endDate) && new Date(endDate) >= new Date(b.startDate)))
            );

            if (overlappingBudget) {
                showMessage(budgetMessageEl, `Sudah ada anggaran untuk kategori '${category}' yang tumpang tindih dengan periode ini.`, true);
                showNotification(`Anggaran untuk '${category}' tumpang tindih.`, 'error');
                return;
            }

            const newBudget = {
                id: Date.now(), // Use timestamp as ID for local uniqueness before saving
                category,
                amount,
                startDate,
                endDate
            };

            budgets.push(newBudget);
            await saveUserBudgetsToFirestore(budgets);
            showMessage(budgetMessageEl, 'Anggaran berhasil ditambahkan!', false);
            showNotification('Anggaran berhasil ditambahkan!', 'success');
            budgetForm.reset();
            // UI will update via Firestore listener (onSnapshot)
        }

        async function deleteBudget(id) {
            confirmAction('Apakah Anda yakin ingin menghapus anggaran ini?', async () => {
                let budgets = getUserBudgets();
                budgets = budgets.filter(b => b.id !== id);
                await saveUserBudgetsToFirestore(budgets);
                showNotification('Anggaran berhasil dihapus!', 'success');
                // UI will update via Firestore listener (onSnapshot)
            });
        }

        function renderBudgets() {
            const budgets = getUserBudgets();
            const transactions = getUserTransactions();
            budgetListEl.innerHTML = '';

            if (budgets.length === 0) {
                budgetListEl.innerHTML = '<p class="text-gray-500 text-center text-base">Belum ada anggaran yang ditetapkan.</p>';
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize today's date to start of day

            budgets.sort((a, b) => new Date(a.startDate) - new Date(b.startDate)); // Sort by start date

            budgets.forEach(budget => {
                const budgetStart = new Date(budget.startDate);
                const budgetEnd = new Date(budget.endDate);
                budgetEnd.setHours(23, 59, 59, 999); // Normalize end date to end of day

                const expensesForBudget = transactions.filter(t =>
                    t.type === 'expense' &&
                    t.category === budget.category &&
                    new Date(t.date) >= budgetStart &&
                    new Date(t.date) <= budgetEnd
                ).reduce((sum, t) => sum + t.amount, 0);

                const remainingAmount = budget.amount - expensesForBudget;
                const percentageUsed = (expensesForBudget / budget.amount) * 100;

                let statusText = '';
                let statusColor = 'text-gray-600';
                let progressBarColor = 'bg-blue-400';

                if (today > budgetEnd) {
                    statusText = 'Berakhir';
                    statusColor = 'text-gray-500';
                    progressBarColor = 'bg-gray-400';
                } else if (today < budgetStart) {
                    statusText = 'Mendatang';
                    statusColor = 'text-blue-500';
                    progressBarColor = 'bg-blue-200';
                } else if (remainingAmount <= 0) {
                    statusText = 'Anggaran Habis!';
                    statusColor = 'text-red-500 font-bold';
                    progressBarColor = 'bg-red-500';
                } else if (percentageUsed >= 75) {
                    statusText = 'Hampir Habis!';
                    statusColor = 'text-orange-500 font-bold';
                    progressBarColor = 'bg-orange-400';
                } else {
                    statusText = 'Aktif';
                    statusColor = 'text-green-500';
                    progressBarColor = 'bg-green-400';
                }

                const budgetDiv = document.createElement('div');
                budgetDiv.className = 'card p-5 mb-4';
                budgetDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-xl font-semibold text-gray-800">${budget.category}</h4>
                        <button class="btn-danger text-xs px-3 py-1.5" onclick="deleteBudget(${budget.id})"><i data-feather="trash" class="feather-icon"></i> Hapus</button>
                    </div>
                    <p class="text-gray-700 text-sm mb-1">Periode: ${budget.startDate} s/d ${budget.endDate}</p>
                    <p class="text-lg font-medium text-gray-800">Anggaran: ${formatRupiah(budget.amount)}</p>
                    <p class="text-lg font-medium">Terpakai: <span class="text-expense">${formatRupiah(expensesForBudget)}</span></p>
                    <p class="text-lg font-medium">Sisa: <span class="${remainingAmount <= 0 ? 'text-red-500' : 'text-green-500'}">${formatRupiah(remainingAmount)}</span></p>
                    <p class="text-sm mt-2 ${statusColor}">Status: ${statusText}</p>
                    <div class="w-full bg-gray-200 rounded-full h-3 mt-3">
                        <div class="${progressBarColor} h-3 rounded-full" style="width: ${Math.min(100, percentageUsed)}%;"></div>
                    </div>
                    <p class="text-xs text-gray-500 text-right mt-1">${percentageUsed.toFixed(2)}% Terpakai</p>
                `;
                budgetListEl.appendChild(budgetDiv);
            });
        }


        // --- Password Change ---

        async function handleChangePassword(event) {
            event.preventDefault();
            const currentPass = currentPasswordInput.value;
            const newPass = newPasswordInput.value;
            const confirmNewPass = confirmNewPasswordInput.value;

            if (!currentFirebaseUser) {
                showMessage(passwordMessageEl, 'Anda harus login untuk mengubah kata sandi.', true);
                showNotification('Anda harus login untuk mengubah kata sandi.', 'error');
                return;
            }

            if (!currentPass || !newPass || !confirmNewPass) {
                showMessage(passwordMessageEl, 'Semua field harus diisi.', true);
                showNotification('Semua field harus diisi.', 'error');
                return;
            }

            if (newPass !== confirmNewPass) {
                showMessage(passwordMessageEl, 'Kata sandi baru tidak cocok dengan konfirmasi.', true);
                showNotification('Kata sandi baru tidak cocok dengan konfirmasi.', 'error');
                return;
            }

            if (newPass.length < 6) {
                showMessage(passwordMessageEl, 'Kata sandi baru minimal 6 karakter.', true);
                showNotification('Kata sandi baru minimal 6 karakter.', 'error');
                return;
            }

            try {
                // Re-authenticate user before updating password
                const credential = EmailAuthProvider.credential(currentFirebaseUser.email, currentPass);
                await reauthenticateWithCredential(currentFirebaseUser, credential);
                await updatePassword(currentFirebaseUser, newPass);
                showMessage(passwordMessageEl, 'Kata sandi berhasil diubah!', false);
                showNotification('Kata sandi berhasil diubah!', 'success');
                changePasswordForm.reset();
            } catch (error) {
                console.error("Error changing password:", error);
                let errorMessage = 'Gagal mengubah kata sandi.';
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Kata sandi saat ini salah.';
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'Untuk alasan keamanan, silakan login ulang dan coba lagi.';
                } else if (error.code === 'auth/invalid-credential') {
                    errorMessage = 'Kredensial saat ini tidak valid. Silakan login ulang.';
                }
                showMessage(passwordMessageEl, errorMessage, true);
                showNotification(errorMessage, 'error');
            }
        }

        // --- Local Data Import/Export ---

        async function exportAllData() {
            if (!currentFirebaseUser) {
                showNotification('Anda harus login untuk mengekspor data.', 'error');
                return;
            }

            const userId = currentFirebaseUser.uid;
            try {
                const transactionsSnapshot = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/transactions`));
                const transactions = transactionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const categoriesDoc = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'categories'));
                const categories = categoriesDoc.exists() ? categoriesDoc.data().list : [];

                const budgetsDoc = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'budgets'));
                const budgets = budgetsDoc.exists() ? budgetsDoc.data().list : [];

                const favoriteCurrenciesDoc = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'favoriteCurrencies'));
                const favoriteCurrencies = favoriteCurrenciesDoc.exists() ? favoriteCurrenciesDoc.data().list : [];

                const dataToExport = {
                    transactions,
                    categories,
                    budgets,
                    favoriteCurrencies // Include favorite currencies
                };

                const dataStr = JSON.stringify(dataToExport, null, 2); // Pretty print JSON

                jsonOutput.value = dataStr;
                showJsonDisplayModal();
                showNotification('Salin data JSON dari jendela yang muncul dan simpan secara manual.', 'info', 5000);

            } catch (error) {
                console.error("Error exporting data:", error);
                showNotification('Gagal mengekspor data. Silakan coba lagi.', 'error');
            }
        }

        async function importAllData(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            if (!currentFirebaseUser) {
                showNotification('Anda harus login untuk mengimpor data.', 'error');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.json')) {
                showNotification('Hanya file JSON yang diizinkan.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);

                    if (!importedData || !Array.isArray(importedData.transactions) || !Array.isArray(importedData.categories)) {
                        showNotification('Format file JSON tidak valid. Data transaksi atau kategori tidak ditemukan.', 'error');
                        return;
                    }

                    const confirmImport = await new Promise(resolve => {
                        showConfirmationModal('Apakah Anda yakin ingin mengimpor data ini? Ini akan menimpa semua data Anda saat ini.', () => resolve(true), () => resolve(false));
                    });

                    if (!confirmImport) {
                        showNotification('Impor data dibatalkan.', 'info');
                        return;
                    }

                    const userId = currentFirebaseUser.uid;
                    const batch = writeBatch(db);

                    // Delete existing transactions in a batch
                    const existingTransactionsSnapshot = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/transactions`));
                    existingTransactionsSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    // Add new transactions in a batch
                    for (const t of importedData.transactions) {
                        const newDocRef = doc(collection(db, `artifacts/${appId}/users/${userId}/transactions`)); // Let Firestore generate ID
                        batch.set(newDocRef, {
                            date: t.date,
                            description: t.description,
                            amount: t.amount,
                            type: t.type,
                            category: t.category
                        });
                    }

                    // Import categories
                    batch.set(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'categories'), {
                        list: importedData.categories || ['Makanan', 'Transportasi', 'Gaji', 'Hiburan', 'Tagihan', 'Lain-lain']
                    });

                    // Import budgets
                    batch.set(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'budgets'), {
                        list: importedData.budgets || []
                    });

                    // Import favorite currencies
                    batch.set(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'favoriteCurrencies'), {
                        list: importedData.favoriteCurrencies || []
                    });


                    await batch.commit(); // Commit all batch operations

                    showNotification('Data berhasil diimpor dan dipulihkan!', 'success');
                    // UI will update automatically via Firestore listeners
                } catch (error) {
                    console.error("Error parsing or importing JSON:", error);
                    showNotification('Gagal membaca atau mengurai file JSON. Pastikan formatnya benar dan tidak rusak.', 'error');
                }
            };
            reader.onerror = function() {
                showNotification('Gagal membaca file.', 'error');
            };
            reader.readAsText(file);
            event.target.value = ''; // Clear the file input value to allow selecting the same file again if needed
        }

        // --- Send All Data to WhatsApp (Click-to-Chat) ---
      // --- Send All Data to WhatsApp (Click-to-Chat) ---
        async function sendTransactionsToWhatsApp() { // Tambahkan 'async' di sini
            const targetPhoneNumber = '6282124064576';
            const callmebotApiKey = '1133504'; // API Key CallMeBot Anda

            const transactions = getUserTransactions();
            let totalIncome = 0;
            let totalExpense = 0;

            transactions.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                } else {
                    totalExpense += t.amount;
                }
            });

            const currentBalance = totalIncome - totalExpense;

            let message = `Ringkasan Keuangan Anda:\n`;
            message += `Saldo Saat Ini: ${formatRupiah(currentBalance)}\n`;
            message += `Total Pemasukan: ${formatRupiah(totalIncome)}\n`;
            message += `Total Pengeluaran: ${formatRupiah(totalExpense)}\n\n`;

            if (transactions.length > 0) {
                message += `Detail Semua Transaksi:\n`;
                transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                transactions.forEach(t => {
                    const typeLabel = t.type === 'income' ? 'Pemasukan' : 'Pengeluaran';
                    message += `- ${t.date} | ${typeLabel} | ${t.category} | ${formatRupiah(t.amount)} | ${t.description}\n`;
                });
            } else {
                message += `Belum ada transaksi tercatat.\n`;
            }

            try {
                const encodedMessage = encodeURIComponent(message);
                const callmebotUrl = `https://api.callmebot.com/whatsapp.php?phone=${targetPhoneNumber}&apikey=${callmebotApiKey}&text=${encodedMessage}`;

                const response = await fetch(callmebotUrl); // Mengirim permintaan ke CallMeBot
                const textResponse = await response.text(); // Mendapatkan respons teks dari CallMeBot

                // Memeriksa apakah respons berhasil
                if (response.ok && textResponse.includes("Message sent to")) {
                    showNotification('Ringkasan transaksi berhasil dikirim ke WhatsApp!', 'success');
                } else {
                    console.error("CallMeBot API Error:", textResponse);
                    showNotification('Gagal mengirim ringkasan transaksi ke WhatsApp. Pastikan nomor dan API Key benar, dan layanan CallMeBot aktif.', 'error');
                }
            } catch (error) {
                console.error("Network or CallMeBot API call failed:", error);
                showNotification('Terjadi kesalahan saat mencoba mengirim ke WhatsApp. Periksa koneksi internet Anda.', 'error');
            }
        }
        // --- Data Export (CSV) ---
        function exportTransactionsToCSV() {
            const transactions = getUserTransactions();
            if (transactions.length === 0) {
                showNotification('Tidak ada transaksi untuk diekspor.', 'error');
                return;
            }

            const headers = ["ID", "Tanggal", "Deskripsi", "Jumlah", "Tipe", "Kategori"];
            const csvRows = [];
            csvRows.push(headers.join(','));

            transactions.forEach(t => {
                const row = [
                    t.id,
                    t.date,
                    `"${t.description.replace(/"/g, '""')}"`, // Handle commas and quotes in description
                    t.amount,
                    t.type,
                    `"${t.category.replace(/"/g, '""')}"`
                ];
                csvRows.push(row.join(','));
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `transaksi_keuanganku_${currentFirebaseUser ? currentFirebaseUser.email : 'guest'}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('Data berhasil diekspor!', 'success');
        }

        // --- Render Functions ---

        function renderDashboard() {
            // Display current username/email
            if (currentFirebaseUser) {
                dashboardUsernameEl.textContent = currentFirebaseUser.email;
                sidebarUsername.textContent = currentFirebaseUser.email;
            } else {
                dashboardUsernameEl.textContent = 'Tamu';
                sidebarUsername.textContent = 'Tamu';
            }

            const transactions = getUserTransactions();

            let totalIncome = 0;
            let totalExpense = 0;
            const expenseCategories = {};
            const incomeCategories = {};

            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth(); // 0-indexed

            let hasDailyTransactions = false;
            let hasMonthlyTransactions = false;

            transactions.forEach(t => {
                const transactionDate = new Date(t.date);
                if (
                    transactionDate.getDate() === today.getDate() &&
                    transactionDate.getMonth() === currentMonth &&
                    transactionDate.getFullYear() === currentYear
                ) {
                    hasDailyTransactions = true;
                }
                if (
                    transactionDate.getMonth() === currentMonth &&
                    transactionDate.getFullYear() === currentYear
                ) {
                    hasMonthlyTransactions = true;
                }
            });

            const noRecordsMessageEl = document.getElementById('noRecordsMessage');
            let message = '';
            let showMessageDiv = false;

            if (!hasDailyTransactions) {
                message += 'Anda belum mencatat transaksi apapun hari ini. ';
                showMessageDiv = true;
            }
            if (!hasMonthlyTransactions) {
                if (showMessageDiv && message.length > 0) { // if there's already a daily message
                    message += '<br>'; // New line if both conditions are true
                }
                message += 'Anda belum mencatat transaksi apapun bulan ini.';
                showMessageDiv = true;
            }

            if (showMessageDiv) {
                noRecordsMessageEl.innerHTML = `
                    <i data-feather="alert-triangle" class="feather-icon text-yellow-500 w-8 h-8 mx-auto mb-2"></i>
                    <p>${message}</p>
                    <p class="text-sm text-gray-500 mt-2">Segera catat pemasukan atau pengeluaran Anda!</p>
                `;
                noRecordsMessageEl.classList.remove('hidden');
                feather.replace(); // Re-render feather icons
            } else {
                noRecordsMessageEl.classList.add('hidden');
            }


            transactions.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                    incomeCategories[t.category] = (incomeCategories[t.category] || 0) + t.amount;
                } else {
                    totalExpense += t.amount;
                    expenseCategories[t.category] = (expenseCategories[t.category] || 0) + t.amount;
                }
            });

            const currentBalance = totalIncome - totalExpense;

            currentBalanceEl.textContent = formatRupiah(currentBalance);
            totalIncomeEl.textContent = formatRupiah(totalIncome);
            totalExpenseEl.textContent = formatRupiah(totalExpense);

            // Render Income/Expense Chart
            renderIncomeExpenseChart(totalIncome, totalExpense);

            // Render Expense by Category Summary
            renderCategorySummary(expenseByCategorySummary, expenseCategories, 'expense');

            // Display latest 5 transactions
            // Sort transactions by date (newest first). If dates are identical, their relative order is maintained.
            const latest = transactions.slice().sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateB - dateA; // Sort by date descending (newest first)
            }).slice(0, 5); // Take only the top 5

            latestTransactionsEl.innerHTML = '';
            if (latest.length === 0) {
                latestTransactionsEl.innerHTML = '<p class="text-gray-500 text-center text-base">Belum ada transaksi.</p>';
            } else {
                latest.forEach(t => {
                    const transactionDiv = document.createElement('div');
                    transactionDiv.className = `flex items-center justify-between p-4 rounded-xl ${t.type === 'income' ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'} shadow-sm`;
                    transactionDiv.innerHTML = `
                        <div>
                            <p class="font-medium text-gray-800 text-base">${t.description}</p>
                            <p class="text-xs text-gray-500">${t.date} - ${t.category}</p>
                        </div>
                        <p class="font-bold ${t.type === 'income' ? 'text-income' : 'text-expense'} text-lg">${formatRupiah(t.amount)}</p>
                    `;
                    latestTransactionsEl.appendChild(transactionDiv);
                });
            }
        }

        function renderIncomeExpenseChart(income, expense) {
            incomeExpenseChart.innerHTML = ''; // Clear previous chart
            const total = income + expense;
            let incomeHeight = 0;
            let expenseHeight = 0;

            if (total > 0) {
                incomeHeight = (income / total) * 100;
                expenseHeight = (expense / total) * 100;
            }

            const incomeBar = document.createElement('div');
            incomeBar.className = 'chart-bar chart-bar-income';
            incomeBar.style.height = `${incomeHeight}%`;
            incomeBar.innerHTML = `<span>Pemasukan</span>`;

            const expenseBar = document.createElement('div');
            expenseBar.className = 'chart-bar chart-bar-expense';
            expenseBar.style.height = `${expenseHeight}%`;
            expenseBar.innerHTML = `<span>Pengeluaran</span>`;

            incomeExpenseChart.appendChild(incomeBar);
            incomeExpenseChart.appendChild(expenseBar);
        }

        function renderCategorySummary(element, categoryData, type) {
            element.innerHTML = '';
            const sortedCategories = Object.entries(categoryData).sort(([, a], [, b]) => b - a);

            if (sortedCategories.length === 0) {
                element.innerHTML = `<p class="text-gray-500 text-center text-base">Belum ada ${type === 'expense' ? 'pengeluaran' : 'pemasukan'} berdasarkan kategori.</p>`;
                return;
            }

            sortedCategories.forEach(([category, amount]) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center text-base p-3 rounded-lg bg-gray-50 border border-gray-200 shadow-sm';
                div.innerHTML = `
                    <span class="text-gray-700">${category}</span>
                    <span class="font-semibold ${type === 'income' ? 'text-income' : 'text-expense'}">${formatRupiah(amount)}</span>
                `;
                element.appendChild(div);
            });
        }

        function renderTransactions() {
            let transactions = getUserTransactions();

            // Apply search filter
            const searchTerm = transactionSearchInput.value.toLowerCase();
            if (searchTerm) {
                transactions = transactions.filter(t => t.description.toLowerCase().includes(searchTerm));
            }

            // Apply type filter
            const filterType = filterTypeSelect.value;
            if (filterType !== 'all') {
                transactions = transactions.filter(t => t.type === filterType);
            }

            // Apply date range filter
            const start = filterStartDate.value;
            const end = filterEndDate.value;
            if (start && end) {
                transactions = transactions.filter(t => t.date >= start && t.date <= end);
            } else if (start) {
                transactions = transactions.filter(t => t.date >= start);
            } else if (end) {
                transactions = transactions.filter(t => t.date <= end);
            }

            // Apply sort
            const sortBy = sortBySelect.value;
            transactions.sort((a, b) => {
                if (sortBy === 'dateDesc') return new Date(b.date) - new Date(a.date);
                if (sortBy === 'dateAsc') return new Date(a.date) - new Date(b.date);
                if (sortBy === 'amountDesc') return b.amount - a.amount;
                if (sortBy === 'amountAsc') return a.amount - b.amount;
                return 0;
            });

            filteredTransactions = transactions; // Store filtered transactions for pagination
            updatePaginationControls();
            const startIndex = (currentPage - 1) * transactionsPerPage;
            const endIndex = startIndex + transactionsPerPage;
            const transactionsToDisplay = filteredTransactions.slice(startIndex, endIndex);

            allTransactionsListEl.innerHTML = '';

            if (transactionsToDisplay.length === 0) {
                allTransactionsListEl.innerHTML = '<p class="text-gray-500 text-center text-base">Belum ada transaksi.</p>';
            } else {
                transactionsToDisplay.forEach(t => {
                    const transactionDiv = document.createElement('div');
                    transactionDiv.className = `flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 rounded-xl border border-gray-200 bg-white shadow-sm`;
                    transactionDiv.innerHTML = `
                        <div class="flex-grow mb-2 sm:mb-0">
                            <p class="font-medium text-gray-800 text-base">${t.description}</p>
                            <p class="text-sm text-gray-500">${t.date} - ${t.category}</p>
                        </div>
                        <div class="flex items-center gap-2 mt-2 sm:mt-0">
                            <p class="font-bold ${t.type === 'income' ? 'text-income' : 'text-expense'} text-lg mr-2">${formatRupiah(t.amount)}</p>
                            <button class="btn-secondary text-xs px-3 py-1.5" onclick="editTransaction('${t.id}')"><i data-feather="edit-2" class="feather-icon"></i> Edit</button>
                            <button class="btn-danger text-xs px-3 py-1.5" onclick="deleteTransaction('${t.id}')"><i data-feather="trash-2" class="feather-icon"></i> Hapus</button>
                        </div>
                    `;
                    allTransactionsListEl.appendChild(transactionDiv);
                });
            }
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredTransactions.length / transactionsPerPage);
            pageInfo.textContent = `Halaman ${currentPage} dari ${totalPages || 1}`;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
        }

        function goToPage(page) {
            currentPage = page;
            renderTransactions();
        }

        function nextPage() {
            if (currentPage * transactionsPerPage < filteredTransactions.length) {
                currentPage++;
                renderTransactions();
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTransactions();
            }
        }

        function populateReportYears() {
            const transactions = getUserTransactions();
            const years = new Set();
            transactions.forEach(t => years.add(new Date(t.date).getFullYear()));
            const sortedYears = Array.from(years).sort((a, b) => b - a);

            reportYearSelect.innerHTML = '<option value="all">Semua Tahun</option>';
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                reportYearSelect.appendChild(option);
            });
        }

        function renderReports() {
            let transactions = getUserTransactions();

            const selectedMonth = reportMonthSelect.value;
            const selectedYear = reportYearSelect.value;

            // Filter by month and year
            transactions = transactions.filter(t => {
                const date = new Date(t.date);
                const transactionMonth = (date.getMonth() + 1).toString().padStart(2, '0');
                const transactionYear = date.getFullYear().toString();

                const matchMonth = selectedMonth === 'all' || transactionMonth === selectedMonth;
                const matchYear = selectedYear === 'all' || transactionYear === selectedYear;

                return matchMonth && matchYear;
            });

            let totalIncome = 0;
            let totalExpense = 0;
            const expenseCategories = {};
            const incomeCategories = {};
            const monthlyData = {}; // For monthly summary chart

            transactions.forEach(t => {
                const date = new Date(t.date);
                const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;

                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = { income: 0, expense: 0 };
                }

                if (t.type === 'income') {
                    totalIncome += t.amount;
                    incomeCategories[t.category] = (incomeCategories[t.category] || 0) + t.amount;
                    monthlyData[monthYear].income += t.amount;
                } else {
                    totalExpense += t.amount;
                    expenseCategories[t.category] = (expenseCategories[t.category] || 0) + t.amount;
                    monthlyData[monthYear].expense += t.amount;
                }
            });

            const netBalance = totalIncome - totalExpense;

            reportTotalIncomeEl.textContent = formatRupiah(totalIncome);
            reportTotalExpenseEl.textContent = formatRupiah(totalExpense);
            reportNetBalanceEl.textContent = formatRupiah(netBalance);

            // Store report data globally for PDF generation
            window._currentReportData = {
                transactions: transactions,
                totalIncome: totalIncome,
                totalExpense: totalExpense,
                netBalance: netBalance,
                expenseCategories: expenseCategories,
                incomeCategories: incomeCategories,
                selectedMonth: selectedMonth,
                selectedYear: selectedYear
            };

            // Render category breakdown for reports
            renderCategorySummary(reportExpenseByCategory, expenseCategories, 'expense');
            renderCategorySummary(reportIncomeByCategory, incomeCategories, 'income');

            // Render Chart.js graphs
            renderMonthlySummaryChart(monthlyData);
            renderPieChart(expenseByCategoryChartCanvas, expenseCategories, 'Pengeluaran per Kategori', 'rgba(239, 68, 68, 0.8)'); // red-500
            renderPieChart(incomeByCategoryChartCanvas, incomeCategories, 'Pemasukan per Kategori', 'rgba(34, 197, 94, 0.8)'); // green-500

            reportTransactionsListEl.innerHTML = '';
            if (transactions.length === 0) {
                reportTransactionsListEl.innerHTML = '<p class="text-gray-500 text-center text-base">Belum ada transaksi untuk laporan.</p>';
            } else {
                const table = document.createElement('table');
                table.className = 'responsive-table w-full text-base';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Deskripsi</th>
                            <th>Tanggal</th>
                            <th>Jumlah</th>
                            <th>Tipe</th>
                            <th>Kategori</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = table.querySelector('tbody');

                transactions.forEach(t => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${t.description}</td>
                        <td>${t.date}</td>
                        <td class="${t.type === 'income' ? 'text-income' : 'text-expense'} font-bold">${formatRupiah(t.amount)}</td>
                        <td>${t.type === 'income' ? 'Pemasukan' : 'Pengeluaran'}</td>
                        <td>${t.category}</td>
                    `;
                    tbody.appendChild(row);
                });
                reportTransactionsListEl.appendChild(table);
            }
        }

        function renderMonthlySummaryChart(monthlyData) {
            // Destroy existing chart instance if it exists
            if (monthlySummaryChartInstance) {
                monthlySummaryChartInstance.destroy();
            }

            const labels = Object.keys(monthlyData).sort();
            const incomeData = labels.map(month => monthlyData[month].income);
            const expenseData = labels.map(month => monthlyData[month].expense);

            monthlySummaryChartInstance = new Chart(monthlySummaryChartCanvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Pemasukan Bulanan',
                            data: incomeData,
                            backgroundColor: 'rgba(16, 185, 129, 0.7)', /* green-500 yang lebih jelas */
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1,
                            borderRadius: 8 /* Rounded bars lebih besar */
                        },
                        {
                            label: 'Pengeluaran Bulanan',
                            data: expenseData,
                            backgroundColor: 'rgba(239, 68, 68, 0.7)', /* red-500 */
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1,
                            borderRadius: 8 /* Rounded bars lebih besar */
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: false,
                            title: {
                                display: true,
                                text: 'Bulan',
                                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333'
                            },
                            ticks: {
                                color: document.body.classList.contains('dark-mode') ? '#a0aec0' : '#333'
                            },
                            grid: {
                                display: false /* Hide x-axis grid lines */
                            }
                        },
                        y: {
                            stacked: false,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Jumlah (Rp)',
                                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    return formatRupiah(value);
                                },
                                color: document.body.classList.contains('dark-mode') ? '#a0aec0' : '#333'
                            },
                            grid: {
                                color: document.body.classList.contains('dark-mode') ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatRupiah(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        },
                        legend: {
                            labels: {
                                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333'
                            }
                        }
                    }
                }
            });
        }

        function renderPieChart(canvasElement, categoryData, title, colorBase) {
            // Destroy existing chart instance if it exists
            let chartInstance;
            if (canvasElement === expenseByCategoryChartCanvas) {
                if (expenseByCategoryChartInstance) expenseByCategoryChartInstance.destroy();
                chartInstance = expenseByCategoryChartInstance;
            } else if (canvasElement === incomeByCategoryChartCanvas) {
                if (incomeByCategoryChartInstance) incomeByCategoryChartInstance.destroy();
                chartInstance = incomeByCategoryChartInstance;
            }

            const labels = Object.keys(categoryData);
            const data = Object.values(categoryData);

            // Generate dynamic colors
            const backgroundColors = labels.map((_, i) => {
                const hue = (i * 137.508) % 360;
                return `hsla(${hue}, 70%, 60%, 0.8)`;
            });
            const borderColors = labels.map((_, i) => {
                const hue = (i * 137.508) % 360;
                return `hsla(${hue}, 70%, 50%, 1)`;
            });

            const chartConfig = {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: title,
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: false, // Title is handled in HTML
                            text: title
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += formatRupiah(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        },
                        legend: {
                            labels: {
                                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333'
                            }
                        }
                    }
                }
            };

            if (canvasElement === expenseByCategoryChartCanvas) {
                expenseByCategoryChartInstance = new Chart(canvasElement, chartConfig);
            } else if (canvasElement === incomeByCategoryChartCanvas) {
                incomeByCategoryChartInstance = new Chart(canvasElement, chartConfig);
            }
        }

        // --- Analysis Functions ---

        function renderAnalysis() {
            const transactions = getUserTransactions();

            if (transactions.length === 0) {
                // Clear any existing charts and display a message
                if (financialTrendsChartInstance) financialTrendsChartInstance.destroy();
                if (topExpenseCategoriesChartInstance) topExpenseCategoriesChartInstance.destroy();
                if (topIncomeCategoriesChartInstance) topIncomeCategoriesChartInstance.destroy();

                // Clear canvas content
                const financialCtx = financialTrendsChartCanvas.getContext('2d');
                financialCtx.clearRect(0, 0, financialTrendsChartCanvas.width, financialTrendsChartCanvas.height);
                const expenseCtx = topExpenseCategoriesChartCanvas.getContext('2d');
                expenseCtx.clearRect(0, 0, topExpenseCategoriesChartCanvas.width, topExpenseCategoriesChartCanvas.height);
                const incomeCtx = topIncomeCategoriesChartCanvas.getContext('2d');
                incomeCtx.clearRect(0, 0, topIncomeCategoriesChartCanvas.width, topIncomeCategoriesChartCanvas.height);

                topExpenseCategoriesSummary.innerHTML = '<p class="text-gray-500 text-center text-base">Belum ada data pengeluaran untuk analisis.</p>';
                topIncomeCategoriesSummary.innerHTML = '<p class="text-gray-500 text-center text-base">Belum ada data pemasukan untuk analisis.</p>';
                return;
            }

            // 1. Calculate Monthly Financial Trends
            const monthlyData = calculateMonthlyFinancialData(transactions);
            renderFinancialTrendsChart(monthlyData);

            // 2. Calculate Top Categories
            const expenseCategories = calculateCategoryTotals(transactions, 'expense');
            const incomeCategories = calculateCategoryTotals(transactions, 'income');

            renderTopCategoriesChart(topExpenseCategoriesChartCanvas, expenseCategories, 'Pengeluaran', 'expense');
            renderTopCategoriesChart(topIncomeCategoriesChartCanvas, incomeCategories, 'Pemasukan', 'income');

            renderTopCategoriesSummary(topExpenseCategoriesSummary, expenseCategories, 'expense');
            renderTopCategoriesSummary(topIncomeCategoriesSummary, incomeCategories, 'income');
        }

        function calculateMonthlyFinancialData(transactions) {
            const monthlySummary = {};

            transactions.forEach(t => {
                const date = new Date(t.date);
                const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;

                if (!monthlySummary[monthYear]) {
                    monthlySummary[monthYear] = { income: 0, expense: 0, balance: 0 };
                }

                if (t.type === 'income') {
                    monthlySummary[monthYear].income += t.amount;
                } else {
                    monthlySummary[monthYear].expense += t.amount;
                }
            });

            // Calculate cumulative balance
            const sortedMonths = Object.keys(monthlySummary).sort();
            let cumulativeBalance = 0;
            sortedMonths.forEach(month => {
                const data = monthlySummary[month];
                data.balance = data.income - data.expense;
                cumulativeBalance += data.balance;
                data.cumulativeBalance = cumulativeBalance; // Store cumulative balance
            });

            return monthlySummary;
        }

        function renderFinancialTrendsChart(monthlyData) {
            if (financialTrendsChartInstance) {
                financialTrendsChartInstance.destroy();
            }

            const labels = Object.keys(monthlyData).sort();
            const incomeData = labels.map(month => monthlyData[month].income);
            const expenseData = labels.map(month => monthlyData[month].expense);
            const balanceData = labels.map(month => monthlyData[month].cumulativeBalance); // Use cumulative balance

            financialTrendsChartInstance = new Chart(financialTrendsChartCanvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Pemasukan Bulanan',
                            data: incomeData,
                            borderColor: 'rgba(16, 185, 129, 1)', /* green-500 yang lebih jelas */
                            backgroundColor: 'rgba(16, 185, 129, 0.2)',
                            fill: true,
                            tension: 0.4 /* Smooth lines */
                        },
                        {
                            label: 'Pengeluaran Bulanan',
                            data: expenseData,
                            borderColor: 'rgba(239, 68, 68, 1)', /* red-500 */
                            backgroundColor: 'rgba(239, 68, 68, 0.2)',
                            fill: true,
                            tension: 0.4 /* Smooth lines */
                        },
                        {
                            label: 'Saldo Kumulatif',
                            data: balanceData,
                            borderColor: 'rgba(26, 115, 232, 1)', /* blue Google */
                            backgroundColor: 'rgba(26, 115, 232, 0.2)',
                            fill: true,
                            tension: 0.4 /* Smooth lines */
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Bulan',
                                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333'
                            },
                            ticks: {
                                color: document.body.classList.contains('dark-mode') ? '#a0aec0' : '#333'
                            },
                            grid: {
                                display: false /* Hide x-axis grid lines */
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Jumlah (Rp)',
                                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    return formatRupiah(value);
                                },
                                color: document.body.classList.contains('dark-mode') ? '#a0aec0' : '#333'
                            },
                            grid: {
                                color: document.body.classList.contains('dark-mode') ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatRupiah(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        },
                        legend: {
                            labels: {
                                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333'
                            }
                        }
                    }
                }
            });
        }

        function calculateCategoryTotals(transactions, type) {
            const categoryTotals = {};
            transactions.forEach(t => {
                if (t.type === type) {
                    categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
                }
            });
            return categoryTotals;
        }

        function renderTopCategoriesChart(canvasElement, categoryData, titlePrefix, type) {
            let chartInstance;
            if (canvasElement === topExpenseCategoriesChartCanvas) {
                if (topExpenseCategoriesChartInstance) topExpenseCategoriesChartInstance.destroy();
                chartInstance = topExpenseCategoriesChartInstance;
            } else if (canvasElement === topIncomeCategoriesChartCanvas) {
                if (topIncomeCategoriesChartInstance) topIncomeCategoriesChartInstance.destroy();
                chartInstance = incomeByCategoryChartInstance;
            }

            const sortedCategories = Object.entries(categoryData)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5); // Get top 5

            const labels = sortedCategories.map(item => item[0]);
            const data = sortedCategories.map(item => item[1]);

            // Generate dynamic colors
            const backgroundColors = labels.map((_, i) => {
                const hue = (i * 137.508) % 360;
                return `hsla(${hue}, 70%, 60%, 0.8)`;
            });
            const borderColors = labels.map((_, i) => {
                const hue = (i * 137.508) % 360;
                return `hsla(${hue}, 70%, 50%, 1)`;
            });

            const chartConfig = {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${titlePrefix} (Rp)`,
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1,
                        borderRadius: 8 /* Rounded bars lebih besar */
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // Make it a horizontal bar chart
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Jumlah (Rp)',
                                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    return formatRupiah(value);
                                },
                                color: document.body.classList.contains('dark-mode') ? '#a0aec0' : '#333'
                            },
                            grid: {
                                color: document.body.classList.contains('dark-mode') ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Kategori',
                                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333'
                            },
                            ticks: {
                                color: document.body.classList.contains('dark-mode') ? '#a0aec0' : '#333'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.x !== null) {
                                        label += formatRupiah(context.parsed.x);
                                    }
                                    return label;
                                }
                            }
                        },
                        legend: {
                            labels: {
                                color: document.body.classList.contains('dark-mode') ? '#e2e8f0' : '#333'
                            }
                        }
                    }
                }
            };

            if (canvasElement === topExpenseCategoriesChartCanvas) {
                topExpenseCategoriesChartInstance = new Chart(canvasElement, chartConfig);
            } else if (canvasElement === topIncomeCategoriesChartCanvas) {
                topIncomeCategoriesChartInstance = new Chart(canvasElement, chartConfig);
            }
        }

        function renderTopCategoriesSummary(element, categoryData, type) {
            element.innerHTML = '';
            const sortedCategories = Object.entries(categoryData)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5); // Get top 5

            if (sortedCategories.length === 0) {
                element.innerHTML = `<p class="text-gray-500 text-center text-base">Belum ada ${type === 'expense' ? 'pengeluaran' : 'pemasukan'} berdasarkan kategori.</p>`;
                return;
            }

            sortedCategories.forEach(([category, amount]) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center text-base p-3 rounded-lg bg-gray-50 border border-gray-200 shadow-sm';
                div.innerHTML = `
                    <span class="text-gray-700">${category}</span>
                    <span class="font-semibold ${type === 'income' ? 'text-income' : 'text-expense'}">${formatRupiah(amount)}</span>
                `;
                element.appendChild(div);
            });
        }

        // --- Delete Own Account Function ---
        async function deleteOwnAccount() {
            if (!currentFirebaseUser) {
                showNotification('Fitur ini hanya untuk pengguna yang login.', 'error');
                return;
            }

            const confirmDelete = await new Promise(resolve => {
                showConfirmationModal('Ini akan menghapus akun Anda dan SEMUA data Anda secara permanen. Tindakan ini tidak dapat dibatalkan. Apakah Anda yakin?', () => resolve(true), () => resolve(false));
            });

            if (!confirmDelete) {
                showNotification('Penghapusan akun dibatalkan.', 'info');
                return;
            }

            const userId = currentFirebaseUser.uid;
            const userEmail = currentFirebaseUser.email;

            // Prompt for re-authentication
            const passwordPrompt = prompt("Untuk keamanan, masukkan kata sandi Anda untuk mengkonfirmasi penghapusan akun:");
            if (!passwordPrompt) {
                showNotification('Penghapusan akun dibatalkan (kata sandi tidak dimasukkan).', 'info');
                return;
            }

            try {
                const credential = EmailAuthProvider.credential(userEmail, passwordPrompt);
                await reauthenticateWithCredential(currentFirebaseUser, credential);

                // 1. Delete all transactions
                const transactionsRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
                const transactionsSnapshot = await getDocs(transactionsRef);
                const deleteTransactionsBatch = writeBatch(db);
                transactionsSnapshot.docs.forEach(doc => {
                    deleteTransactionsBatch.delete(doc.ref);
                });
                await deleteTransactionsBatch.commit();
                console.log("All transactions deleted.");

                // 2. Delete metadata (categories, budgets, favoriteCurrencies)
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'categories'));
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'budgets'));
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'favoriteCurrencies')); // Delete favorite currencies
                console.log("Metadata deleted.");

                // 3. Delete the Firebase Authentication user
                await deleteFirebaseAuthUser(currentFirebaseUser);

                showNotification('Akun Anda dan semua data berhasil dihapus.', 'success');
                // onAuthStateChanged will handle redirecting to auth section
            } catch (error) {
                console.error("Error deleting account:", error);
                let errorMessage = 'Gagal menghapus akun. Silakan coba lagi.';
                if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'Untuk keamanan, Anda harus login ulang dan coba lagi.';
                } else if (error.code === 'auth/invalid-credential') {
                    errorMessage = 'Kata sandi yang dimasukkan salah. Penghapusan akun dibatalkan.';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Kesalahan jaringan. Periksa koneksi internet Anda.';
                }
                showNotification(errorMessage, 'error');
            }
        }


        // --- Modal Functions ---
        function showConfirmationModal(message, onConfirm, onCancel) {
            confirmationModalMessage.textContent = message;
            confirmYesBtn.onclick = () => {
                hideConfirmationModal();
                if (onConfirm) onConfirm();
            };
            confirmNoBtn.onclick = () => {
                hideConfirmationModal();
                if (onCancel) onCancel();
            };
            confirmationModal.classList.remove('hidden');
        }

        function hideConfirmationModal() {
            confirmationModal.classList.add('hidden');
            confirmYesBtn.onclick = null;
            confirmNoBtn.onclick = null;
        }

        function showEditTransactionModal() {
            editTransactionModal.classList.remove('hidden');
        }

        function hideEditTransactionModal() {
            editTransactionModal.classList.add('hidden');
        }

        function showJsonDisplayModal() {
            jsonDisplayModal.classList.remove('hidden');
            // Select the text in the textarea to make it easy to copy
            jsonOutput.select();
            jsonOutput.setSelectionRange(0, 99999); // For mobile devices
        }

        function hideJsonDisplayModal() {
            jsonDisplayModal.classList.add('hidden');
        }

        // New: Forgot Password Modal functions
        function showForgotPasswordModal() {
            forgotPasswordModal.classList.remove('hidden');
            forgotPasswordMessageEl.classList.add('hidden'); // Clear previous messages
            forgotPasswordEmailInput.value = ''; // Clear input
        }

        function hideForgotPasswordModal() {
            forgotPasswordModal.classList.add('hidden');
        }

        // --- Chatbot Functions ---
        const chatbotQA = {
            "start": {
                question: "Halo! Saya asisten bantuan Anda. Silakan pilih topik yang ingin Anda ketahui lebih lanjut:",
                options: [
                    "Informasi Dashboard",
                    "Manajemen Transaksi",
                    "Rencana Anggaran",
                    "Laporan Keuangan",
                    "Analisis Keuangan",
                    "Pengaturan Akun",
                    "Verifikasi Email", // New option
                    "Kembali ke awal"
                ]
            },
            "Informasi Dashboard": {
                answer: "Dashboard adalah halaman utama yang menampilkan ringkasan keuangan Anda. Di sini Anda bisa melihat Saldo Saat Ini, Total Pemasukan, Total Pengeluaran, Ringkasan Pemasukan & Pengeluaran dalam bentuk grafik batang, serta Transaksi Terbaru Anda.",
                options: [
                    "Apa itu Saldo Saat Ini?",
                    "Apa itu Total Pemasukan/Pengeluaran?",
                    "Bagaimana grafik di Dashboard bekerja?",
                    "Transaksi Terbaru di Dashboard",
                    "Kembali ke awal"
                ]
            },
            "Apa itu Saldo Saat Ini?": {
                answer: "Saldo Saat Ini adalah jumlah uang yang Anda miliki, dihitung dari Total Pemasukan dikurangi Total Pengeluaran Anda."
            },
            "Apa itu Total Pemasukan/Pengeluaran?": {
                answer: "Total Pemasukan adalah jumlah semua transaksi dengan tipe 'Pemasukan'. Total Pengeluaran adalah jumlah semua transaksi dengan tipe 'Pengeluaran'."
            },
            "Bagaimana grafik di Dashboard bekerja?": {
                answer: "Grafik di Dashboard menampilkan perbandingan visual antara total pemasukan dan total pengeluaran Anda. Tinggi batang menunjukkan proporsi masing-masing terhadap total transaksi."
            },
            "Transaksi Terbaru di Dashboard": {
                answer: "Bagian 'Transaksi Terbaru' di Dashboard menampilkan hingga 5 transaksi terakhir yang Anda masukkan, memudahkan Anda untuk melacak aktivitas keuangan terkini."
            },
            "Manajemen Transaksi": {
                answer: "Di menu 'Transaksi', Anda bisa menambah, melihat, mengedit, dan menghapus semua transaksi keuangan Anda.",
                options: [
                    "Bagaimana cara menambahkan transaksi baru?",
                    "Bagaimana cara melihat daftar semua transaksi?",
                    "Bagaimana cara mencari, memfilter, dan mengurutkan transaksi?",
                    "Bagaimana cara mengedit transaksi yang sudah ada?",
                    "Bagaimana cara menghapus transaksi?",
                    "Apa fungsi paginasi di daftar transaksi?",
                    "Kembali ke awal"
                ]
            },
            "Bagaimana cara menambahkan transaksi baru?": {
                answer: "Untuk menambahkan transaksi baru, pergi ke menu 'Transaksi', lalu pada formulir 'Tambah Transaksi Baru', isi Tanggal, Deskripsi, Jumlah, pilih Tipe (Pemasukan/Pengeluaran), dan pilih Kategori. Setelah lengkap, klik tombol 'Tambah Transaksi'."
            },
            "Bagaimana cara melihat daftar semua transaksi?": {
                answer: "Daftar semua transaksi Anda dapat dilihat di bagian 'Daftar Semua Transaksi' pada menu 'Transaksi'. Transaksi akan ditampilkan dalam format daftar yang bisa Anda kelola."
            },
            "Bagaimana cara mencari, memfilter, dan mengurutkan transaksi?": {
                answer: "Di 'Daftar Semua Transaksi', Anda dapat menggunakan kolom 'Cari Deskripsi' untuk mencari berdasarkan teks, 'Filter Tipe' untuk memilih Pemasukan/Pengeluaran/Semua, 'Tanggal Mulai' dan 'Tanggal Akhir' untuk memfilter rentang waktu, serta 'Urutkan Berdasarkan' untuk mengurutkan data (Tanggal Terbaru/Terlama, Jumlah Terbesar/Terkecil)."
            },
            "Bagaimana cara mengedit transaksi yang sudah ada?": {
                answer: "Untuk mengedit transaksi, temukan transaksi di 'Daftar Semua Transaksi', lalu klik tombol 'Edit' di samping transaksi tersebut. Sebuah modal akan muncul, Anda bisa mengubah detail transaksi dan klik 'Simpan Perubahan'."
            },
            "Bagaimana cara menghapus transaksi?": {
                answer: "Untuk menghapus transaksi, temukan transaksi di 'Daftar Semua Transaksi', lalu klik tombol 'Hapus' di samping transaksi tersebut. Anda akan diminta konfirmasi sebelum transaksi dihapus secara permanen."
            },
            "Apa fungsi paginasi di daftar transaksi?": {
                answer: "Paginasi digunakan untuk membagi daftar transaksi menjadi beberapa halaman, biasanya 10 transaksi per halaman. Ini membantu dalam mengelola dan melihat data transaksi yang banyak secara lebih efisien. Anda bisa menggunakan tombol 'Sebelumnya' dan 'Berikutnya' untuk navigasi."
            },
            "Rencana Anggaran": {
                answer: "Menu 'Rencana Anggaran' memungkinkan Anda menetapkan batas pengeluaran untuk kategori tertentu dalam periode waktu tertentu. Anda akan diberi peringatan jika pengeluaran Anda melebihi anggaran yang ditetapkan.",
                options: [
                    "Bagaimana cara menetapkan anggaran baru?",
                    "Bagaimana cara melihat anggaran yang sudah ada?",
                    "Bagaimana cara menghapus anggaran?",
                    "Bagaimana peringatan anggaran bekerja?",
                    "Kembali ke awal"
                ]
            },
            "Bagaimana cara menetapkan anggaran baru?": {
                answer: "Di menu 'Rencana Anggaran', pada formulir 'Tetapkan Anggaran Baru', pilih Kategori, masukkan Jumlah Anggaran, dan tentukan Tanggal Mulai serta Tanggal Akhir periode anggaran. Klik 'Simpan Anggaran' untuk menyimpannya."
            },
            "Bagaimana cara melihat anggaran yang sudah ada?": {
                answer: "Daftar semua anggaran yang Anda tetapkan akan ditampilkan di bagian 'Daftar Anggaran Anda' pada menu 'Rencana Anggaran'. Anda bisa melihat detail setiap anggaran di sana."
            },
            "Bagaimana cara menghapus anggaran?": {
                answer: "Untuk menghapus anggaran, temukan anggaran di 'Daftar Anggaran Anda', lalu klik tombol 'Hapus' di samping anggaran tersebut. Anda akan diminta konfirmasi sebelum anggaran dihapus."
            },
            "Bagaimana peringatan anggaran bekerja?": {
                answer: "Ketika Anda menambahkan transaksi pengeluaran, sistem akan memeriksa apakah transaksi tersebut termasuk dalam kategori yang memiliki anggaran aktif. Jika jumlah transaksi baru akan menyebabkan total pengeluaran untuk kategori tersebut melebihi anggaran yang tersisa, sebuah peringatan akan muncul. Anda tetap bisa melanjutkan transaksi jika mau."
            },
            "Laporan Keuangan": {
                answer: "Menu 'Laporan' menyediakan ringkasan keuangan yang lebih mendalam, termasuk total pemasukan/pengeluaran, saldo bersih, serta grafik bulanan dan per kategori.",
                options: [
                    "Bagaimana cara memfilter laporan?",
                    "Jenis grafik apa saja yang ada di laporan keuangan?",
                    "Bagaimana cara melihat detail transaksi di laporan?",
                    "Kembali ke awal"
                ]
            },
            "Bagaimana cara memfilter laporan?": {
                answer: "Di menu 'Laporan', Anda bisa memfilter ringkasan laporan dan grafik berdasarkan 'Bulan' dan 'Tahun' tertentu, atau memilih 'Semua Bulan'/'Semua Tahun' untuk melihat data keseluruhan."
            },
            "Jenis grafik apa saja yang ada di laporan keuangan?": {
                answer: "Laporan keuangan menampilkan 'Grafik Pemasukan dan Pengeluaran Bulanan' (grafik batang) serta 'Pengeluaran per Kategori' dan 'Pemasukan per Kategori' (grafik lingkaran) untuk visualisasi data Anda."
            },
            "Bagaimana cara melihat detail transaksi di laporan?": {
                answer: "Di bagian bawah menu 'Laporan', terdapat 'Detail Transaksi' yang menampilkan daftar lengkap transaksi yang sesuai dengan filter bulan dan tahun yang Anda pilih di atas."
            },
            "Analisis Keuangan": {
                answer: "Bagian 'Analisis Keuangan' membantu Anda memahami tren dan pola pengeluaran/pemasukan Anda melalui grafik yang lebih mendalam.",
                options: [
                    "Apa itu Tren Keuangan Bulanan?",
                    "Apa itu 5 Kategori Pengeluaran/Pemasukan Teratas?",
                    "Kembali ke awal"
                ]
            },
            "Apa itu Tren Keuangan Bulanan?": {
                answer: "Grafik 'Tren Keuangan Bulanan' menunjukkan bagaimana pemasukan, pengeluaran, dan saldo kumulatif Anda berubah dari waktu ke waktu, memberikan gambaran tentang kesehatan finansial Anda."
            },
            "Apa itu 5 Kategori Pengeluaran/Pemasukan Teratas?": {
                answer: "Grafik ini menampilkan 5 kategori pengeluaran atau pemasukan terbesar Anda berdasarkan jumlah uang, membantu Anda mengidentifikasi area di mana Anda paling banyak menghabiskan atau menerima uang."
            },
            "Pengaturan Akun": {
                answer: "Menu 'Pengaturan' memungkinkan Anda untuk mengelola profil, kata sandi, kategori, serta melakukan backup dan ekspor data.",
                options: [
                    "Bagaimana cara mengubah kata sandi?",
                    "Bagaimana cara mengelola kategori?",
                    "Bagaimana cara backup/pulihkan data?",
                    "Bagaimana cara mengirim ringkasan transaksi ke WhatsApp?",
                    "Bagaimana cara mengekspor transaksi ke CSV?",
                    "Bagaimana cara menghapus akun saya?",
                    "Mode Gelap" // New option for dark mode
                ]
            },
            "Bagaimana cara mengubah kata sandi?": {
                answer: "Anda bisa mengubah kata sandi di menu 'Pengaturan', pada bagian 'Ubah Kata Sandi'. Masukkan kata sandi Anda saat ini, lalu masukkan kata sandi baru dan konfirmasinya. Pastikan kata sandi baru minimal 6 karakter."
            },
            "Bagaimana cara backup/pulihkan data?": {
                answer: "Anda dapat membackup data Anda ke file JSON lokal melalui menu 'Pengaturan', pada bagian 'Backup & Pulihkan Data (Lokal)'. Klik 'Ekspor Semua Data' untuk mengunduh file JSON, atau 'Impor Semua Data' untuk mengunggah file JSON dan memulihkan data Anda."
            },
            "Bagaimana cara mengirim ringkasan transaksi ke WhatsApp?": {
                answer: "Di menu 'Pengaturan', pada bagian 'Kirim Semua Transaksi ke WhatsApp', klik tombol 'Kirim Semua Transaksi ke WhatsApp'. Ini akan membuka aplikasi WhatsApp Anda dengan ringkasan keuangan dan detail transaksi yang sudah terisi, siap untuk Anda kirim."
            },
            "Bagaimana cara mengekspor transaksi ke CSV?": {
                answer: "Di menu 'Pengaturan', pada bagian 'Ekspor Data Transaksi (CSV)', klik tombol 'Ekspor Transaksi ke CSV'. Semua transaksi Anda akan diunduh sebagai file CSV yang dapat dibuka di program spreadsheet seperti Excel."
            },
            "Bagaimana cara menghapus akun saya?": {
                answer: "Di menu 'Pengaturan', pada bagian 'Hapus Akun', Anda dapat menghapus akun Anda secara permanen. Tindakan ini tidak dapat dibatalkan dan akan menghapus semua data Anda."
            },
            "Mode Gelap": { // New chatbot response for dark mode
                answer: "Mode gelap memungkinkan Anda mengubah tampilan aplikasi menjadi skema warna yang lebih gelap, yang dapat mengurangi ketegangan mata, terutama di lingkungan dengan cahaya rendah. Anda bisa mengaktifkan atau menonaktifkannya dari menu 'Pengaturan' di bagian 'Mode Tampilan'."
            },
            "Verifikasi Email": { // New section for chatbot
                answer: "Untuk memastikan keamanan akun Anda, kami memerlukan verifikasi email. Setelah mendaftar, tautan verifikasi akan dikirim ke email Anda. Anda harus mengklik tautan tersebut sebelum dapat masuk. Jika Anda tidak menerima email, silakan cek folder spam atau coba masuk lagi untuk memicu pengiriman ulang.",
                options: [
                    "Mengapa verifikasi email diperlukan?",
                    "Apa yang harus dilakukan jika tidak menerima email verifikasi?",
                    "Kembali ke awal"
                ]
            },
            "Mengapa verifikasi email diperlukan?": {
                answer: "Verifikasi email diperlukan untuk keamanan akun Anda. Ini membantu memastikan bahwa alamat email yang digunakan adalah milik Anda dan mencegah akses tidak sah."
            },
            "Apa yang harus dilakukan jika tidak menerima email verifikasi?": {
                answer: "Jika Anda tidak menerima email verifikasi, silakan periksa folder spam atau junk Anda. Terkadang, email bisa masuk ke sana. Anda juga bisa mencoba masuk kembali ke aplikasi; ini sering kali akan memicu pengiriman ulang email verifikasi."
            },
            "Bantuan Admin": {
                answer: "Fitur ini hanya tersedia untuk pengguna dengan peran 'Admin'. Admin dapat mengelola pengguna lain yang terdaftar di aplikasi. Namun, fungsi manajemen pengguna lain dari sisi klien tidak didukung secara langsung oleh Firebase SDK karena alasan keamanan. Ini memerlukan fungsi backend (misalnya, Firebase Cloud Functions)."
            },
            "Kembali ke awal": {
                answer: "Baik, apa lagi yang bisa saya bantu? Silakan pilih topik dari daftar di bawah:",
                options: [
                    "Informasi Dashboard",
                    "Manajemen Transaksi",
                    "Rencana Anggaran",
                    "Laporan Keuangan",
                    "Analisis Keuangan",
                    "Pengaturan Akun",
                    "Verifikasi Email", // New option
                    "Kembali ke awal"
                ]
            }
        };

        function startChatbot() {
            displayBotMessage(chatbotQA.start.question);
            displayChatOptions(chatbotQA.start.options);
        }

        function displayBotMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message bot';
            messageDiv.textContent = message;
            chatDisplay.appendChild(messageDiv);
            chatDisplay.scrollTop = chatDisplay.scrollHeight; // Scroll to bottom
        }

        function displayUserMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message user';
            messageDiv.textContent = message;
            chatDisplay.appendChild(messageDiv);
            chatDisplay.scrollTop = chatDisplay.scrollHeight; // Scroll to bottom
        }

        function displayChatOptions(options) {
            chatOptions.innerHTML = ''; // Clear previous options
            options.forEach(optionText => {
                const button = document.createElement('button');
                button.textContent = optionText;
                button.addEventListener('click', () => handleChatOptionClick(optionText));
                chatOptions.appendChild(button);
            });
        }

        function handleChatOptionClick(optionText) {
            displayUserMessage(optionText); // Show user's choice
            const response = chatbotQA[optionText];
            if (response) {
                displayBotMessage(response.answer);
                if (response.options) {
                    displayChatOptions(response.options);
                } else {
                    // If no further options, offer to go back to start
                    displayChatOptions(["Kembali ke awal"]);
                }
            } else {
                displayBotMessage("Maaf, saya tidak mengerti pertanyaan itu. Silakan pilih dari opsi yang tersedia atau ketik 'Kembali ke awal'.");
                displayChatOptions(["Kembali ke awal"]);
            }
            chatDisplay.scrollTop = chatDisplay.scrollHeight; // Scroll to bottom after new messages
        }

        // --- PDF Generation Function ---
        async function generatePdfReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const reportData = window._currentReportData;

            if (!reportData || !reportData.transactions) {
                showNotification('Tidak ada data laporan untuk dibuat PDF.', 'error');
                return;
            }

            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni",
                "Juli", "Agustus", "September", "Oktober", "November", "Desember"
            ];

            let titleMonth = reportData.selectedMonth === 'all' ? 'Semua Bulan' : monthNames[parseInt(reportData.selectedMonth) - 1];
            let titleYear = reportData.selectedYear === 'all' ? 'Semua Tahun' : reportData.selectedYear;
            let reportTitle = `Laporan Keuangan: ${titleMonth} ${titleYear}`;

            let yOffset = 20;

            doc.setFontSize(18);
            doc.text(reportTitle, 14, yOffset);
            yOffset += 10;

            doc.setFontSize(12);
            doc.text(`Total Pemasukan: ${formatRupiah(reportData.totalIncome)}`, 14, yOffset);
            yOffset += 7;
            doc.text(`Total Pengeluaran: ${formatRupiah(reportData.totalExpense)}`, 14, yOffset);
            yOffset += 7;
            doc.text(`Saldo Bersih: ${formatRupiah(reportData.netBalance)}`, 14, yOffset);
            yOffset += 10;

            // Expense by Category
            doc.setFontSize(14);
            doc.text("Pengeluaran per Kategori:", 14, yOffset);
            yOffset += 7;
            if (Object.keys(reportData.expenseCategories).length > 0) {
                for (const category in reportData.expenseCategories) {
                    doc.setFontSize(12);
                    doc.text(`  ${category}: ${formatRupiah(reportData.expenseCategories[category])}`, 14, yOffset);
                    yOffset += 7;
                }
            } else {
                doc.setFontSize(12);
                doc.text("  Belum ada pengeluaran berdasarkan kategori.", 14, yOffset);
                yOffset += 7;
            }
            yOffset += 5;

            // Income by Category
            doc.setFontSize(14);
            doc.text("Pemasukan per Kategori:", 14, yOffset);
            yOffset += 7;
            if (Object.keys(reportData.incomeCategories).length > 0) {
                for (const category in reportData.incomeCategories) {
                    doc.setFontSize(12);
                    doc.text(`  ${category}: ${formatRupiah(reportData.incomeCategories[category])}`, 14, yOffset);
                    yOffset += 7;
                }
            } else {
                doc.setFontSize(12);
                doc.text("  Belum ada pemasukan berdasarkan kategori.", 14, yOffset);
                yOffset += 7;
            }
            yOffset += 5;

            // Transaction Details
            doc.setFontSize(14);
            doc.text("Detail Transaksi:", 14, yOffset);
            yOffset += 7;

            if (reportData.transactions.length > 0) {
                const tableColumn = ["Tanggal", "Deskripsi", "Jumlah", "Tipe", "Kategori"];
                const tableRows = [];

                reportData.transactions.forEach(t => {
                    const transactionData = [
                        t.date,
                        t.description,
                        formatRupiah(t.amount),
                        t.type === 'income' ? 'Pemasukan' : 'Pengeluaran',
                        t.category
                    ];
                    tableRows.push(transactionData);
                });

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: yOffset,
                    theme: 'striped',
                    headStyles: { fillColor: [26, 115, 232] }, /* Blue Google header */
                    styles: { fontSize: 10, cellPadding: 2, overflow: 'linebreak', textColor: [31, 41, 55] }, /* Darker text */
                    bodyStyles: { fillColor: [255, 255, 255] }, /* White body */
                    alternateRowStyles: { fillColor: [248, 250, 252] }, /* Light gray alternate rows */
                    columnStyles: {
                        0: { cellWidth: 20 }, // Date
                        1: { cellWidth: 50 }, // Description
                        2: { cellWidth: 30 }, // Amount
                        3: { cellWidth: 20 }, // Type
                        4: { cellWidth: 30 }  // Category
                    }
                });
            } else {
                doc.setFontSize(12);
                doc.text("  Belum ada transaksi untuk laporan.", 14, yOffset);
            }

            doc.save(`Laporan_Keuangan_${titleMonth}_${titleYear}.pdf`);
            showNotification('Laporan PDF berhasil dibuat!', 'success');
        }

        // --- Exchange Rate Functions ---
        async function fetchCurrenciesAndRates() {
            if (!EXCHANGE_RATE_API_KEY) {
                showNotification('API Key untuk nilai tukar mata uang tidak ditemukan. Silakan tambahkan.', 'error');
                return;
            }

            try {
                // Fetch available currencies
                const currenciesResponse = await fetch(`https://api.freecurrencyapi.com/v1/currencies?apikey=${EXCHANGE_RATE_API_KEY}`);
                // Check if the response was successful
                if (!currenciesResponse.ok) {
                    const errorText = await currenciesResponse.text();
                    throw new Error(`Failed to fetch currencies: ${currenciesResponse.status} ${currenciesResponse.statusText} - ${errorText}`);
                }
                const currenciesData = await currenciesResponse.json();
                if (currenciesData.data) {
                    availableCurrencies = currenciesData.data;
                    populateCurrencySelects();
                } else {
                    console.error("Error fetching currencies (no data):", currenciesData);
                    showNotification('Gagal memuat daftar mata uang: Data tidak valid.', 'error');
                }

                // Fetch latest exchange rates (IDR as base)
                const latestRatesResponse = await fetch(`https://api.freecurrencyapi.com/v1/latest?apikey=${EXCHANGE_RATE_API_KEY}&base_currency=IDR`);
                // Check if the response was successful
                if (!latestRatesResponse.ok) {
                    const errorText = await latestRatesResponse.text();
                    throw new Error(`Failed to fetch latest rates: ${latestRatesResponse.status} ${latestRatesResponse.statusText} - ${errorText}`);
                }
                const latestRatesData = await latestRatesResponse.json();
                if (latestRatesData.data) {
                    currentExchangeRates = latestRatesData.data;
                    const date = new Date(latestRatesData.meta.last_updated_at).toLocaleString('id-ID', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    exchangeRateLastUpdatedEl.textContent = `Data terakhir diperbarui pada: ${date}`;
                    renderAllRatesTable();
                } else {
                    console.error("Error fetching latest rates (no data):", latestRatesData);
                    showNotification('Gagal memuat nilai tukar terbaru: Data tidak valid.', 'error');
                }
            } catch (error) {
                console.error("General error fetching exchange rate data:", error);
                let userMessage = 'Terjadi kesalahan saat mengambil data nilai tukar.';
                if (error.message.includes('403') || error.message.includes('Unauthorized') || error.message.includes('Rate Limit Exceeded')) {
                    userMessage += ' Periksa API Key Anda atau batas penggunaan API.';
                } else if (error.message.includes('Failed to fetch')) {
                    userMessage += ' Periksa koneksi internet Anda.';
                }
                showNotification(userMessage, 'error');
            }
        }

        function populateCurrencySelects() {
            fromCurrencySelect.innerHTML = '';
            toCurrencySelect.innerHTML = '';

            // Sort currencies alphabetically by code
            const sortedCurrencies = Object.keys(availableCurrencies).sort();

            sortedCurrencies.forEach(code => {
                const currency = availableCurrencies[code];
                const optionFrom = document.createElement('option');
                optionFrom.value = code;
                optionFrom.textContent = `${code} - ${currency.name}`;
                fromCurrencySelect.appendChild(optionFrom);

                const optionTo = document.createElement('option');
                optionTo.value = code;
                optionTo.textContent = `${code} - ${currency.name}`;
                toCurrencySelect.appendChild(optionTo);
            });

            // Set default selections
            fromCurrencySelect.value = 'IDR';
            toCurrencySelect.value = 'USD';
        }

        async function convertCurrency(event) {
            event.preventDefault();
            const amount = parseFloat(amountToConvertInput.value);
            const fromCurrency = fromCurrencySelect.value;
            const toCurrency = toCurrencySelect.value;

            if (isNaN(amount) || amount <= 0) {
                conversionResultEl.textContent = "Mohon masukkan jumlah yang valid.";
                conversionResultEl.classList.remove("hidden");
                conversionResultEl.classList.add("text-red-500");
                return;
            }

            if (!EXCHANGE_RATE_API_KEY) {
                showNotification('API Key untuk nilai tukar mata uang tidak ditemukan.', 'error');
                return;
            }

            try {
                // Fetch conversion directly (more robust than calculating from base IDR if base isn't IDR)
                const response = await fetch(`https://api.freecurrencyapi.com/v1/latest?apikey=${EXCHANGE_RATE_API_KEY}&base_currency=${fromCurrency}&currencies=${toCurrency}`);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to convert currency: ${response.status} ${response.statusText} - ${errorText}`);
                }
                const data = await response.json();

                if (data.data && data.data[toCurrency]) {
                    const rate = data.data[toCurrency];
                    const convertedAmount = amount * rate;
                    const formattedResult = new Intl.NumberFormat('id-ID', {
                        style: 'currency',
                        currency: toCurrency,
                        minimumFractionDigits: 2
                    }).format(convertedAmount);

                    conversionResultEl.textContent = `${amount} ${fromCurrency} = ${formattedResult}`;
                    conversionResultEl.classList.remove("hidden", "text-red-500");
                    conversionResultEl.classList.add("text-blue-600");
                } else {
                    console.error("Error during conversion (no data):", data);
                    conversionResultEl.textContent = "Gagal mengonversi mata uang: Data tidak valid.";
                    conversionResultEl.classList.remove("hidden");
                    conversionResultEl.classList.add("text-red-500");
                }
            } catch (error) {
                console.error("Network error during conversion:", error);
                let userMessage = "Terjadi kesalahan saat mengonversi. Periksa koneksi Anda.";
                if (error.message.includes('403') || error.message.includes('Unauthorized') || error.message.includes('Rate Limit Exceeded')) {
                    userMessage = 'Gagal mengonversi mata uang. Periksa API Key Anda atau batas penggunaan API.';
                } else if (error.message.includes('Failed to fetch')) {
                    userMessage = 'Terjadi kesalahan jaringan saat mengonversi. Periksa koneksi internet Anda.';
                }
                conversionResultEl.textContent = userMessage;
                conversionResultEl.classList.remove("hidden");
                conversionResultEl.classList.add("text-red-500");
            }
        }

        function renderAllRatesTable() {
            allRatesTableBody.innerHTML = '';
            if (Object.keys(currentExchangeRates).length === 0) {
                allRatesTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500">Tidak ada nilai tukar yang tersedia.</td></tr>';
                return;
            }

            const favoriteCurrencies = getFavoriteCurrencies();
            const sortedRates = Object.entries(currentExchangeRates).sort(([codeA], [codeB]) => {
                // Prioritize favorites
                const isAFav = favoriteCurrencies.includes(codeA);
                const isBFav = favoriteCurrencies.includes(codeB);
                if (isAFav && !isBFav) return -1;
                if (!isAFav && isBFav) return 1;
                // Then sort alphabetically
                return codeA.localeCompare(codeB);
            });


            sortedRates.forEach(([code, rate]) => {
                const currencyName = availableCurrencies[code]?.name || code;
                const isFavorite = favoriteCurrencies.includes(code);

                const row = document.createElement('tr');
                row.className = 'bg-white border-b last:border-b-0 border-gray-200';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${code} - ${currencyName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-700">${formatRupiah(1 / rate)} / ${code}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-blue-600 hover:text-blue-900 ml-2" onclick="toggleFavoriteCurrency('${code}')">
                            <i data-feather="${isFavorite ? 'star' : 'star'}" class="feather-icon ${isFavorite ? 'text-yellow-500 fill-current' : 'text-gray-400'}"></i>
                        </button>
                    </td>
                `;
                allRatesTableBody.appendChild(row);
            });
            feather.replace(); // Re-render icons
        }

        function renderFavoriteRates() {
            favoriteRatesListEl.innerHTML = '';
            const favoriteCurrencies = getFavoriteCurrencies();

            if (favoriteCurrencies.length === 0) {
                favoriteRatesListEl.innerHTML = '<p class="text-gray-500 text-center text-base">Belum ada mata uang favorit yang ditambahkan.</p>';
                return;
            }

            favoriteCurrencies.forEach(code => {
                const rate = currentExchangeRates[code];
                const currencyName = availableCurrencies[code]?.name || code;

                if (rate) {
                    const favItem = document.createElement('div');
                    favItem.className = 'flex items-center justify-between p-3.5 rounded-lg bg-blue-50 border border-blue-200 shadow-sm';
                    favItem.innerHTML = `
                        <span class="font-medium text-blue-800 text-base">${code} - ${currencyName}</span>
                        <div class="flex items-center gap-2">
                             <span class="font-semibold text-blue-700 text-lg">1 IDR = ${rate.toFixed(4)} ${code}</span>
                             <button class="btn-danger text-xs px-3 py-1.5" onclick="toggleFavoriteCurrency('${code}')">
                                <i data-feather="x-circle" class="feather-icon"></i> Hapus
                            </button>
                        </div>
                    `;
                    favoriteRatesListEl.appendChild(favItem);
                }
            });
            feather.replace();
        }

        async function toggleFavoriteCurrency(currencyCode) {
            let favorites = getFavoriteCurrencies();
            const index = favorites.indexOf(currencyCode);

            if (index > -1) {
                // Remove from favorites
                favorites.splice(index, 1);
                showNotification(`${currencyCode} dihapus dari favorit.`, 'info');
            } else {
                // Add to favorites
                favorites.push(currencyCode);
                showNotification(`${currencyCode} ditambahkan ke favorit.`, 'success');
            }
            await saveFavoriteCurrenciesToFirestore(favorites);
            renderAllRatesTable(); // Re-render all rates table to update star icon
            renderFavoriteRates(); // Re-render favorite rates list
        }

        // --- Event Listeners ---

        // Toggle sidebar on mobile
        menuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        // Close sidebar when clicking outside on mobile (optional, but good UX)
        document.addEventListener('click', (event) => {
            if (window.innerWidth < 768 && sidebar.classList.contains('open') && !sidebar.contains(event.target) && !menuBtn.contains(event.target)) {
                sidebar.classList.remove('open');
            }
        });

        // Authentication form submission
        authForm.addEventListener('submit', handleAuth);

        // Toggle between login and register modes
        toggleAuthModeBtn.addEventListener('click', (event) => {
            event.preventDefault();
            if (authMode === 'login') {
                authMode = 'register';
                authTitle.textContent = 'Daftar';
                authSubmitBtn.textContent = 'Daftar';
                toggleAuthModeBtn.textContent = 'Login di sini'; // Changed text
            } else {
                authMode = 'login';
                authTitle.textContent = 'Login';
                authSubmitBtn.textContent = 'Login';
                toggleAuthModeBtn.textContent = 'Daftar di sini';
            }
            authMessage.classList.add('hidden'); // Clear message on mode switch
            usernameInput.value = ''; // Clear fields
            passwordInput.value = ''; // Clear fields
        });

        // New: Forgot Password Link click
        forgotPasswordLink.addEventListener('click', (event) => {
            event.preventDefault();
            showForgotPasswordModal();
        });

        // New: Forgot Password Form submission
        forgotPasswordForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const email = forgotPasswordEmailInput.value.trim();
            forgotPasswordMessageEl.classList.add('hidden'); // Hide previous message

            if (!email) {
                showMessage(forgotPasswordMessageEl, 'Email tidak boleh kosong.', true);
                showNotification('Email tidak boleh kosong.', 'error');
                return;
            }

            try {
                await sendPasswordResetEmail(auth, email);
                showMessage(forgotPasswordMessageEl, 'Link reset kata sandi telah dikirim ke email Anda. Silakan cek kotak masuk Anda.', false);
                showNotification('Link reset kata sandi telah dikirim!', 'success');
                forgotPasswordEmailInput.value = ''; // Clear email input
            }
            catch (error) {
                console.error("Error sending password reset email:", error);
                let errorMessage = 'Gagal mengirim link reset kata sandi. Silakan coba lagi.';
                if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Format email tidak valid.';
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Tidak ada pengguna dengan email tersebut.';
                }
                showMessage(forgotPasswordMessageEl, errorMessage, true);
                showNotification(errorMessage, 'error');
            }
        });

        // Logout button
        logoutBtn.addEventListener('click', handleLogout);

        // Sidebar navigation
        sidebarItems.forEach(item => {
            item.addEventListener('click', (event) => {
                event.preventDefault();
                const sectionId = event.currentTarget.dataset.section + 'Section'; // Use currentTarget
                if (isLoggedIn) {
                    showSection(sectionId);
                } else {
                    showMessage(authMessage, 'Anda harus login terlebih dahulu.', true);
                    showNotification('Anda harus login terlebih dahulu.', 'error');
                }
            });
        });

        // Transaction form submission
        transactionForm.addEventListener('submit', addTransaction);

        // Filter, Sort, Search, and Pagination listeners
        transactionSearchInput.addEventListener('input', () => { currentPage = 1; renderTransactions(); });
        filterTypeSelect.addEventListener('change', () => { currentPage = 1; renderTransactions(); });
        filterStartDate.addEventListener('change', () => { currentPage = 1; renderTransactions(); });
        filterEndDate.addEventListener('change', () => { currentPage = 1; renderTransactions(); });
        sortBySelect.addEventListener('change', () => { currentPage = 1; renderTransactions(); });
        prevPageBtn.addEventListener('click', prevPage);
        nextPageBtn.addEventListener('click', nextPage);

        // Budget form submission
        budgetForm.addEventListener('submit', addBudget);

        // Edit Transaction Form Submission
        editTransactionForm.addEventListener('submit', updateTransaction);

        // Change Password Form Submission
        changePasswordForm.addEventListener('submit', handleChangePassword);

        // Add Category Form Submission
        addCategoryForm.addEventListener('submit', addCategory);

        // Local Data Import/Export
        exportAllDataBtn.addEventListener('click', exportAllData);
        importAllDataInput.addEventListener('change', importAllData);

        // Copy JSON to clipboard button
        copyJsonBtn.addEventListener('click', () => {
            jsonOutput.select();
            document.execCommand('copy');
            showNotification('Data JSON berhasil disalin ke clipboard!', 'success');
            hideJsonDisplayModal();
        });

        // Send WhatsApp All Transactions Button
        sendWhatsappSummaryBtn.addEventListener('click', sendTransactionsToWhatsApp);

        // Export Data Button (CSV)
        exportDataBtn.addEventListener('click', exportTransactionsToCSV);

        // Report Filters
        reportMonthSelect.addEventListener('change', renderReports);
        reportYearSelect.addEventListener('change', renderReports);

        // Generate PDF Report Button
        generatePdfReportBtn.addEventListener('click', generatePdfReport);

        // Delete Account Button
        deleteAccountBtn.addEventListener('click', deleteOwnAccount);

        // Dark Mode Toggle Listener
        darkModeToggle.addEventListener('change', toggleDarkMode);

        // Exchange Rate Conversion Form Submission
        currencyConverterForm.addEventListener('submit', convertCurrency);

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Handle initial auth token from Canvas environment
            if (initialAuthToken) {
                try {
                    await auth.signInWithCustomToken(initialAuthToken);
                    showNotification('Login otomatis berhasil!', 'success');
                } catch (error) {
                    console.error("Custom token sign-in error:", error);
                    showNotification('Gagal login otomatis. Silakan login manual.', 'error');
                }
            } else {
                // If no custom token, no anonymous sign-in by default now, user must explicitly login/register
            }

            // Set default date for transaction form to today
            const today = new Date().toISOString().split('T')[0];
            transactionDateInput.value = today;
            editTransactionDateInput.value = today; // Also for edit form
            budgetStartDateInput.value = today; // Set default start date for budget
            budgetEndDateInput.value = today; // Set default end date for budget
        });

        // Make functions globally accessible for onclick in HTML
        window.deleteTransaction = deleteTransaction;
        window.editTransaction = editTransaction;
        window.deleteCategory = deleteCategory;
        window.hideConfirmationModal = hideConfirmationModal; // For modal close button
        window.hideEditTransactionModal = hideEditTransactionModal; // For modal close button
        window.confirmAction = showConfirmationModal; // Expose for internal use
        window.hideJsonDisplayModal = hideJsonDisplayModal; // Expose for modal close button
        window.deleteBudget = deleteBudget; // Expose for budget deletion
        window.hideForgotPasswordModal = hideForgotPasswordModal; // Expose for modal close button
        window.toggleFavoriteCurrency = toggleFavoriteCurrency; // Expose for favorite currency toggle

        // Prevent pinch zoom
        document.addEventListener('gesturestart', function (e) {
            e.preventDefault();
        });

        document.addEventListener('gesturechange', function (e) {
            e.preventDefault();
        });

        document.addEventListener('gestureend', function (e) {
            e.preventDefault();
        });

        // Prevent double-tap zoom
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        feather.replace();


//savingCalculator
  const savingsCalculatorForm = document.getElementById('savingsCalculatorForm');
  const targetAmountInput = document.getElementById('targetAmount');
  const savingAmountInput = document.getElementById('savingAmount');
  const savingFrequencyInput = document.getElementById('savingFrequency');
  const savingsResult = document.getElementById('savingsResult');

  savingsCalculatorForm.addEventListener('submit', function (e) {
    e.preventDefault();

    const target = parseFloat(targetAmountInput.value);
    const amount = parseFloat(savingAmountInput.value);
    const frequency = savingFrequencyInput.value;

    if (isNaN(target) || isNaN(amount) || amount <= 0 || target <= 0) {
      savingsResult.textContent = "Mohon masukkan nilai yang valid.";
      savingsResult.classList.remove("hidden");
      savingsResult.classList.add("text-red-500");
      return;
    }

    const periodsNeeded = Math.ceil(target / amount);
    const today = new Date();
    let estimatedDate = new Date(today);

    if (frequency === "daily") {
      estimatedDate.setDate(today.getDate() + periodsNeeded);
    } else if (frequency === "monthly") {
      estimatedDate.setMonth(today.getMonth() + periodsNeeded);
    } else if (frequency === "yearly") {
      estimatedDate.setFullYear(today.getFullYear() + periodsNeeded);
    }

    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    const formattedDate = estimatedDate.toLocaleDateString('id-ID', options);
    const freqLabel = frequency === "daily" ? "hari" : frequency === "monthly" ? "bulan" : "tahun";

   savingsResult.textContent = `Dengan menabung Rp ${amount.toLocaleString('id-ID')} per ${freqLabel}, kamu bisa mencapai target Rp ${target.toLocaleString('id-ID')} dalam ${periodsNeeded} ${freqLabel}.
Estimasi tercapai pada: ${formattedDate}.`;
savingsResult.classList.remove("hidden", "text-red-500");
savingsResult.classList.add("text-blue-600");

savingsCalculatorForm.reset();

  });


    </script>
</body>
</html>
