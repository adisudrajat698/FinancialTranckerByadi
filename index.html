<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Catat Keuangan Pribadi</title>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom CSS untuk font dan warna */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Warna latar belakang umum */
            color: #333;
        }
        .sidebar {
            background-color: #2c3e50; /* Warna sidebar gelap */
            color: #ecf0f1; /* Warna teks sidebar */
            width: 250px;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 20;
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .sidebar-item {
            display: block;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem; /* rounded-md */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            transition: background-color 0.2s;
        }
        .sidebar-item:hover {
            background-color: #34495e; /* Warna hover untuk item sidebar */
        }
        .sidebar-item.active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            font-weight: 600; /* font-semibold */
        }
        .header {
            background-color: #ffffff; /* Warna header putih */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .main-content {
            background-color: #f9f9f9; /* Warna latar belakang konten utama */
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        input[type="text"],
        input[type="password"],
        input[type="number"],
        input[type="date"],
        select {
            border-color: #d1d5db; /* gray-300 */
            border-width: 1px;
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.75rem 1rem;
            width: 100%;
            outline: none;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus {
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); /* blue-500 with opacity */
        }
        .btn-primary {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* blue-600 */
        }
        .btn-danger {
            background-color: #ef4444; /* red-500 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.2s;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* red-600 */
        }
        .btn-secondary {
            background-color: #6b7280; /* gray-500 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #4b5563; /* gray-600 */
        }
        .text-income {
            color: #22c55e; /* green-500 */
        }
        .text-expense {
            color: #ef4444; /* red-500 */
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            width: 500px;
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }

        /* Chart Styles */
        .chart-bar-container {
            display: flex;
            align-items: flex-end;
            height: 150px; /* Fixed height for the chart area */
            background-color: #f0f2f5;
            border-radius: 0.5rem;
            overflow: hidden;
            position: relative;
        }
        .chart-bar {
            width: 50%;
            height: 0; /* Initial height */
            transition: height 0.5s ease-out;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.875rem; /* text-sm */
            position: relative;
        }
        .chart-bar span {
            position: absolute;
            bottom: -1.5rem; /* Label below the bar */
            color: #333;
            font-weight: normal;
            font-size: 0.75rem; /* text-xs */
        }
        .chart-bar-income {
            background-color: #22c55e; /* green-500 */
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        .chart-bar-expense {
            background-color: #ef4444; /* red-500 */
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }

        /* Responsive table for reports */
        .responsive-table {
            width: 100%;
            border-collapse: collapse;
        }
        .responsive-table th, .responsive-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb; /* gray-200 */
            text-align: left;
        }
        .responsive-table th {
            background-color: #f3f4f6; /* gray-100 */
            font-weight: 600;
            color: #4b5563;
        }
        @media (max-width: 767px) {
            .responsive-table, .responsive-table thead, .responsive-table tbody, .responsive-table th, .responsive-table td, .responsive-table tr {
                display: block;
            }
            .responsive-table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            .responsive-table tr {
                margin-bottom: 1rem;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                overflow: hidden;
            }
            .responsive-table td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 50%;
                text-align: right;
            }
            .responsive-table td:before {
                position: absolute;
                top: 0;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: 600;
                color: #4b5563;
            }
            /* Label the data */
            .responsive-table td:nth-of-type(1):before { content: "Deskripsi"; }
            .responsive-table td:nth-of-type(2):before { content: "Tanggal"; }
            .responsive-table td:nth-of-type(3):before { content: "Jumlah"; }
            .responsive-table td:nth-of-type(4):before { content: "Tipe"; }
            .responsive-table td:nth-of-type(5):before { content: "Kategori"; }
        }

        /* Responsiveness */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0); /* Sidebar always visible on desktop */
            }
            .content-wrapper {
                margin-left: 250px; /* Make space for sidebar */
            }
            .menu-button {
                display: none; /* Hide menu button on desktop */
            }
        }

        /* Notification Styles */
        #notificationContainer {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            pointer-events: none; /* Allow clicks to pass through */
        }
        .notification {
            background-color: #333;
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(-20px);
            animation: fadeInOut 3s forwards;
            min-width: 200px;
            text-align: center;
            pointer-events: all; /* Re-enable pointer events for the notification itself */
        }
        .notification.success {
            background-color: #22c55e; /* green-500 */
        }
        .notification.error {
            background-color: #ef4444; /* red-500 */
        }
        .notification.info {
            background-color: #3b82f6; /* blue-500 */
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        /* Profile Picture Styles */
        .profile-picture-container {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            background-color: #e2e8f0; /* gray-200 */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-bottom: 1rem;
        }
        .profile-picture-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .profile-picture-container svg {
            width: 60px;
            height: 60px;
            color: #94a3b8; /* gray-400 */
        }

        .profile-picture-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            background-color: #e2e8f0; /* gray-200 */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .profile-picture-small img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .profile-picture-small svg {
            width: 20px;
            height: 20px;
            color: #94a3b8; /* gray-400 */
        }

        /* New styles for JSON display modal */
        #jsonDisplayModal .modal-content {
            width: 90%;
            max-width: 700px;
        }
        #jsonOutput {
            width: 100%;
            height: 300px;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            padding: 1rem;
            font-family: monospace;
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            word-wrap: break-word; /* Break long words */
            overflow-y: scroll;
            resize: vertical; /* Allow vertical resizing */
            border-radius: 0.5rem;
        }
        #copyJsonBtn {
            margin-top: 1rem;
            width: 100%;
        }

        /* Chatbot styles */
        #chatbotModal .modal-content {
            width: 90%;
            max-width: 600px;
            height: 80vh;
            display: flex;
            flex-direction: column;
        }
        #chatDisplay {
            flex-grow: 1;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            overflow-y: auto;
            margin-bottom: 1rem;
            background-color: #f9fafb;
        }
        .chat-message {
            margin-bottom: 0.75rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            max-width: 80%;
        }
        .chat-message.user {
            background-color: #dbeafe; /* blue-100 */
            align-self: flex-end;
            margin-left: auto;
            text-align: right;
        }
        .chat-message.bot {
            background-color: #e2e8f0; /* gray-200 */
            align-self: flex-start;
            margin-right: auto;
            text-align: left;
        }
        .chat-options button {
            background-color: #e0f2fe; /* light blue */
            color: #0369a1; /* dark blue */
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            margin: 0.25rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .chat-options button:hover {
            background-color: #bae6fd; /* lighter blue */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <aside id="sidebar" class="sidebar fixed top-0 left-0 h-full p-4 flex flex-col md:relative md:flex-shrink-0">
        <div class="text-2xl font-bold mb-4 text-center">KeuanganKu</div>
        <div class="flex flex-col items-center mb-8">
            <div class="profile-picture-container profile-picture-small">
                <img id="profilePictureDisplaySidebar" src="" alt="Foto Profil">
                <svg id="profilePicturePlaceholderSidebar" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                </svg>
            </div>
            <p id="sidebarUsername" class="text-lg font-semibold text-white mt-2"></p>
        </div>
        <nav class="flex-grow">
            <ul class="space-y-2">
              <li id="dashboardSidebarItem"><a href="#" class="sidebar-item" data-section="dashboard"><i data-feather="home" class="inline-block w-4 h-4 mr-2"></i> Dashboard </a></li>
              <li id="transactionsSidebarItem"><a href="#" class="sidebar-item" data-section="transactions"><i data-feather="file-text" class="inline-block w-4 h-4 mr-2"></i> Transaksi </a></li>
              <li id="budgetingSidebarItem"><a href="#" class="sidebar-item" data-section="budgeting"><i data-feather="credit-card" class="inline-block w-4 h-4 mr-2"></i> Rencana Anggaran </a></li> <!-- New Budgeting Item -->
              <li id="reportsSidebarItem"><a href="#" class="sidebar-item" data-section="reports"><i data-feather="bar-chart-2" class="inline-block w-4 h-4 mr-2"></i> Laporan </a></li>
              <li id="analysisSidebarItem"><a href="#" class="sidebar-item" data-section="analysis"><i data-feather="pie-chart" class="inline-block w-4 h-4 mr-2"></i> Analisis Keuangan </a></li>
              <li id="settingsSidebarItem"><a href="#" class="sidebar-item" data-section="settings"><i data-feather="settings" class="inline-block w-4 h-4 mr-2"></i> Pengaturan </a></li>
              <li id="helpSidebarItem"><a href="#" class="sidebar-item" data-section="help"><i data-feather="help-circle" class="inline-block w-4 h-4 mr-2"></i> Bantuan </a></li>
              <li id="adminSidebarItem" class="hidden"><a href="#" class="sidebar-item" data-section="admin">Admin</a></li>
            </ul>
        </nav>
        <div class="mt-auto">
            <button id="logoutBtn" class="w-full btn-primary text-sm font-medium py-2 px-4 rounded-md">Logout</button>
        </div>
    </aside>

    <div class="flex-grow flex flex-col content-wrapper md:ml-0">
        <header class="header p-4 flex items-center justify-between sticky top-0 md:hidden">
            <button id="menuBtn" class="menu-button text-gray-600 focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <h1 class="text-xl font-semibold">Keuangan Pribadi</h1>
            <div class="w-6 h-6"></div> </header>

        <main class="flex-grow p-4 md:p-8 overflow-y-auto">
            <section id="authSection" class="flex items-center justify-center min-h-screen-minus-header">
                <div class="card p-8 w-full max-w-md">
                    <h2 class="text-2xl font-bold text-center mb-6" id="authTitle">Login</h2>
                    <form id="authForm" class="space-y-4">
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                            <input type="text" id="username" name="username" required class="block">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="password" name="password" required class="block">
                        </div>
                        <p id="authMessage" class="text-red-500 text-sm hidden"></p>
                        <button type="submit" id="authSubmitBtn" class="w-full btn-primary font-semibold">Login</button>
                    </form>
                    <p class="text-center text-sm mt-4">
                        Belum punya akun? <a href="#" id="toggleAuthMode" class="text-blue-500 hover:underline">Daftar di sini</a>
                    </p>
                </div>
            </section>

            <section id="dashboardSection" class="hidden">
                <h2 class="text-3xl font-bold mb-6">Dashboard</h2>
                <div class="flex items-center gap-4 mb-6">
                    <div class="profile-picture-small">
                        <img id="profilePictureDisplayDashboard" src="" alt="Foto Profil">
                        <svg id="profilePicturePlaceholderDashboard" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                        </svg>
                    </div>
                    <p class="text-xl text-gray-700">Selamat datang, <span id="dashboardUsername" class="font-semibold text-blue-600"></span>!</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="card p-6 text-center flex flex-col items-center">
                        <i data-feather="dollar-sign" class="w-10 h-10 text-blue-500 mb-2"></i>
                        <h3 class="text-lg font-medium text-gray-600">Saldo Saat Ini</h3>
                        <p id="currentBalance" class="text-4xl font-bold mt-2">Rp 0</p>
                    </div>
                    <div class="card p-6 text-center flex flex-col items-center">
                        <i data-feather="arrow-down-left" class="w-10 h-10 text-green-500 mb-2"></i>
                        <h3 class="text-lg font-medium text-gray-600">Total Pemasukan</h3>
                        <p id="totalIncome" class="text-3xl font-bold text-income mt-2">Rp 0</p>
                    </div>
                    <div class="card p-6 text-center flex flex-col items-center">
                        <i data-feather="arrow-up-right" class="w-10 h-10 text-red-500 mb-2"></i>
                        <h3 class="text-lg font-medium text-gray-600">Total Pengeluaran</h3>
                        <p id="totalExpense" class="text-3xl font-bold text-expense mt-2">Rp 0</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold mb-4">Ringkasan Pemasukan & Pengeluaran</h3>
                        <div id="incomeExpenseChart" class="chart-bar-container">
                            </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold mb-4">Pengeluaran Berdasarkan Kategori</h3>
                        <div id="expenseByCategorySummary" class="space-y-3">
                            <p class="text-gray-500 text-center">Belum ada pengeluaran berdasarkan kategori.</p>
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-4">Transaksi Terbaru</h3>
                    <div id="latestTransactions" class="space-y-4">
                        <p class="text-gray-500 text-center">Belum ada transaksi.</p>
                    </div>
                </div>
            </section>

            <section id="transactionsSection" class="hidden">
                <h2 class="text-3xl font-bold mb-6">Transaksi</h2>
                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-4">Tambah Transaksi Baru</h3>
                    <form id="transactionForm" class="space-y-4">
                        <div>
                            <label for="transactionDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                            <input type="date" id="transactionDate" required class="block">
                        </div>
                        <div>
                            <label for="transactionDescription" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi</label>
                            <input type="text" id="transactionDescription" placeholder="Contoh: Beli Kopi" required class="block">
                        </div>
                        <div>
                            <label for="transactionAmount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah (Rp)</label>
                            <input type="number" id="transactionAmount" placeholder="Contoh: 25000" required min="1" class="block">
                        </div>
                        <div>
                            <label for="transactionType" class="block text-sm font-medium text-gray-700 mb-1">Tipe</label>
                            <select id="transactionType" required class="block">
                                <option value="income">Pemasukan</option>
                                <option value="expense">Pengeluaran</option>
                            </select>
                        </div>
                        <div>
                            <label for="transactionCategory" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                            <select id="transactionCategory" required class="block">
                                </select>
                        </div>
                        <button type="submit" class="w-full btn-primary font-semibold">Tambah Transaksi</button>
                    </form>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-4">Daftar Semua Transaksi</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div class="col-span-full lg:col-span-1">
                            <label for="transactionSearchInput" class="block text-sm font-medium text-gray-700 mb-1">Cari Deskripsi</label>
                            <input type="text" id="transactionSearchInput" placeholder="Cari transaksi..." class="block">
                        </div>
                        <div>
                            <label for="filterType" class="block text-sm font-medium text-gray-700 mb-1">Filter Tipe</label>
                            <select id="filterType" class="block">
                                <option value="all">Semua</option>
                                <option value="income">Pemasukan</option>
                                <option value="expense">Pengeluaran</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterStartDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Mulai</label>
                            <input type="date" id="filterStartDate" class="block">
                        </div>
                        <div>
                            <label for="filterEndDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Akhir</label>
                            <input type="date" id="filterEndDate" class="block">
                        </div>
                        <div class="col-span-full sm:col-span-2 lg:col-span-1">
                            <label for="sortBy" class="block text-sm font-medium text-gray-700 mb-1">Urutkan Berdasarkan</label>
                            <select id="sortBy" class="block">
                                <option value="dateDesc">Tanggal (Terbaru)</option>
                                <option value="dateAsc">Tanggal (Terlama)</option>
                                <option value="amountDesc">Jumlah (Terbesar)</option>
                                <option value="amountAsc">Jumlah (Terkecil)</option>
                            </select>
                        </div>
                    </div>
                    <div id="allTransactionsList" class="space-y-4">
                        <p class="text-gray-500 text-center">Belum ada transaksi.</p>
                    </div>
                    <div id="paginationControls" class="flex justify-center items-center gap-4 mt-6">
                        <button id="prevPageBtn" class="btn-secondary px-4 py-2 rounded-md" disabled>Sebelumnya</button>
                        <span id="pageInfo" class="text-gray-700">Halaman 1 dari 1</span>
                        <button id="nextPageBtn" class="btn-secondary px-4 py-2 rounded-md" disabled>Berikutnya</button>
                    </div>
                </div>
            </section>

            <!-- New Budgeting Section -->
            <section id="budgetingSection" class="hidden">
                <h2 class="text-3xl font-bold mb-6">Rencana Anggaran</h2>
                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-4">Tetapkan Anggaran Baru</h3>
                    <form id="budgetForm" class="space-y-4">
                        <div>
                            <label for="budgetItemCategory" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                            <select id="budgetItemCategory" required class="block">
                                <!-- Categories will be loaded here -->
                            </select>
                        </div>
                        <div>
                            <label for="budgetAmount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Anggaran (Rp)</label>
                            <input type="number" id="budgetAmount" placeholder="Contoh: 500000" required min="1" class="block">
                        </div>
                        <div>
                            <label for="budgetStartDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Mulai</label>
                            <input type="date" id="budgetStartDate" required class="block">
                        </div>
                        <div>
                            <label for="budgetEndDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Akhir</label>
                            <input type="date" id="budgetEndDate" required class="block">
                        </div>
                        <button type="submit" class="w-full btn-primary font-semibold">Simpan Anggaran</button>
                    </form>
                    <p id="budgetMessage" class="text-red-500 text-sm hidden mt-4"></p>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-4">Daftar Anggaran Anda</h3>
                    <div id="budgetList" class="space-y-4">
                        <p class="text-gray-500 text-center">Belum ada anggaran yang ditetapkan.</p>
                    </div>
                </div>
            </section>

            <section id="reportsSection" class="hidden">
                <h2 class="text-3xl font-bold mb-6">Laporan Keuangan</h2>
                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-4">Ringkasan Laporan</h3>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <div class="flex-1">
                            <label for="reportMonthSelect" class="block text-sm font-medium text-gray-700 mb-1">Bulan</label>
                            <select id="reportMonthSelect" class="block">
                                <option value="all">Semua Bulan</option>
                                <option value="01">Januari</option>
                                <option value="02">Februari</option>
                                <option value="03">Maret</option>
                                <option value="04">April</option>
                                <option value="05">Mei</option>
                                <option value="06">Juni</option>
                                <option value="07">Juli</option>
                                <option value="08">Agustus</option>
                                <option value="09">September</option>
                                <option value="10">Oktober</option>
                                <option value="11">November</option>
                                <option value="12">Desember</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label for="reportYearSelect" class="block text-sm font-medium text-gray-700 mb-1">Tahun</label>
                            <select id="reportYearSelect" class="block">
                                </select>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <p class="text-lg">Total Pemasukan: <span id="reportTotalIncome" class="font-semibold text-income">Rp 0</span></p>
                        <p class="text-lg">Total Pengeluaran: <span id="reportTotalExpense" class="font-semibold text-expense">Rp 0</span></p>
                        <p class="text-lg">Saldo Bersih: <span id="reportNetBalance" class="font-semibold">Rp 0</span></p>
                    </div>

                    <h4 class="text-xl font-bold mt-8 mb-4">Grafik Pemasukan dan Pengeluaran Bulanan</h4>
                    <div class="relative h-64">
                        <canvas id="monthlySummaryChart"></canvas>
                    </div>

                    <h4 class="text-xl font-bold mt-8 mb-4">Pengeluaran per Kategori (Grafik Lingkaran)</h4>
                    <div class="relative h-64">
                        <canvas id="expenseByCategoryChart"></canvas>
                    </div>

                    <h4 class="text-xl font-bold mt-8 mb-4">Pemasukan per Kategori (Grafik Lingkaran)</h4>
                    <div class="relative h-64">
                        <canvas id="incomeByCategoryChart"></canvas>
                    </div>

                    <h4 class="text-xl font-bold mt-8 mb-4">Pengeluaran per Kategori</h4>
                    <div id="reportExpenseByCategory" class="space-y-3">
                        <p class="text-gray-500 text-center">Belum ada data pengeluaran per kategori.</p>
                    </div>
                    <h4 class="text-xl font-bold mt-8 mb-4">Pemasukan per Kategori</h4>
                    <div id="reportIncomeByCategory" class="space-y-3">
                        <p class="text-gray-500 text-center">Belum ada data pemasukan per kategori.</p>
                    </div>
                    <h4 class="text-xl font-bold mt-8 mb-4">Detail Transaksi</h4>
                    <div id="reportTransactionsList" class="overflow-x-auto">
                        <p class="text-gray-500 text-center">Belum ada transaksi untuk laporan.</p>
                    </div>
                </div>
            </section>

            <section id="analysisSection" class="hidden">
                <h2 class="text-3xl font-bold mb-6">Analisis Keuangan</h2>
                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-4">Tren Keuangan Bulanan</h3>
                    <p class="text-gray-700 mb-4">Lihat bagaimana pemasukan, pengeluaran, dan saldo Anda berkembang dari waktu ke waktu.</p>
                    <div class="relative h-80">
                        <canvas id="financialTrendsChart"></canvas>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold mb-4">5 Kategori Pengeluaran Teratas</h3>
                        <div class="relative h-64">
                            <canvas id="topExpenseCategoriesChart"></canvas>
                        </div>
                        <div id="topExpenseCategoriesSummary" class="space-y-2 mt-4">
                            <p class="text-gray-500 text-center">Belum ada data pengeluaran.</p>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold mb-4">5 Kategori Pemasukan Teratas</h3>
                        <div class="relative h-64">
                            <canvas id="topIncomeCategoriesChart"></canvas>
                        </div>
                        <div id="topIncomeCategoriesSummary" class="space-y-2 mt-4">
                            <p class="text-gray-500 text-center">Belum ada data pemasukan.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="settingsSection" class="hidden">
                <h2 class="text-3xl font-bold mb-6">Pengaturan</h2>
                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-4">Foto Profil</h3>
                    <div class="flex flex-col items-center mb-4">
                        <div class="profile-picture-container">
                            <img id="profilePictureDisplaySettings" src="" alt="Foto Profil">
                            <svg id="profilePicturePlaceholderSettings" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                            </svg>
                        </div>
                        <input type="file" id="profilePictureInput" accept="image/*" class="hidden">
                        <label for="profilePictureInput" class="btn-primary cursor-pointer text-sm font-medium py-2 px-4 rounded-md mb-2">
                            Ubah Foto Profil
                        </label>
                        <button id="deleteProfilePictureBtn" class="btn-danger text-sm font-medium py-2 px-4 rounded-md">
                            Hapus Foto Profil
                        </button>
                    </div>
                    <p id="profilePictureMessage" class="text-red-500 text-sm hidden text-center"></p>
                </div>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-4">Ubah Kata Sandi</h3>
                    <form id="changePasswordForm" class="space-y-4">
                        <div>
                            <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-1">Kata Sandi Saat Ini</label>
                            <input type="password" id="currentPassword" required class="block">
                        </div>
                        <div>
                            <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1">Kata Sandi Baru</label>
                            <input type="password" id="newPassword" required class="block">
                        </div>
                        <div>
                            <label for="confirmNewPassword" class="block text-sm font-medium text-gray-700 mb-1">Konfirmasi Kata Sandi Baru</label>
                            <input type="password" id="confirmNewPassword" required class="block">
                        </div>
                        <p id="passwordMessage" class="text-red-500 text-sm hidden"></p>
                        <button type="submit" class="w-full btn-primary font-semibold">Ubah Kata Sandi</button>
                    </form>
                </div>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-4">Kelola Kategori</h3>
                    <form id="addCategoryForm" class="flex flex-col sm:flex-row gap-4 mb-4">
                        <input type="text" id="newCategoryName" placeholder="Nama Kategori Baru" required class="flex-grow">
                        <button type="submit" class="btn-primary font-semibold">Tambah Kategori</button>
                    </form>
                    <div id="categoryList" class="space-y-2">
                        <p class="text-gray-500 text-center">Belum ada kategori.</p>
                    </div>
                </div>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-4">Backup & Pulihkan Data (Lokal)</h3>
                    <p class="text-gray-700 mb-4">Ekspor semua data Anda ke file atau impor dari file yang sudah ada.</p>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="exportAllDataBtn" class="w-full sm:w-1/2 btn-primary font-semibold">Ekspor Semua Data</button>
                        <input type="file" id="importAllDataInput" accept=".json" class="hidden">
                        <label for="importAllDataInput" class="w-full sm:w-1/2 btn-secondary cursor-pointer text-center font-semibold">Impor Semua Data</label>
                    </div>
                </div>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-4">Kirim Semua Transaksi ke WhatsApp</h3>
                    <p class="text-gray-700 mb-4">Klik tombol di bawah untuk mengirim semua detail transaksi Anda ke nomor WhatsApp yang ditentukan.</p>
                    <button id="sendWhatsappSummaryBtn" class="w-full btn-primary font-semibold">Kirim Semua Transaksi ke WhatsApp</button>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-4">Ekspor Data Transaksi (CSV)</h3>
                    <p class="text-gray-700 mb-4">Unduh semua transaksi Anda dalam format CSV.</p>
                    <button id="exportDataBtn" class="btn-primary font-semibold">Ekspor Transaksi ke CSV</button>
                </div>
            </section>

            <section id="helpSection" class="hidden">
                <h2 class="text-3xl font-bold mb-6">Bantuan</h2>
                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-4">Asisten Bantuan</h3>
                    <div id="chatDisplay" class="flex flex-col">
                        <!-- Chat messages will be displayed here -->
                        <div class="chat-message bot">Halo! Saya asisten bantuan Anda. Bagaimana saya bisa membantu?</div>
                    </div>
                    <div id="chatOptions" class="flex flex-wrap justify-center gap-2">
                        <!-- Chat options will be dynamically generated here -->
                    </div>
                </div>
            </section>

            <section id="adminSection" class="hidden">
                <h2 class="text-3xl font-bold mb-6">Panel Admin</h2>
                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-4">Kelola Pengguna</h3>
                    <div id="userList" class="space-y-2">
                        <p class="text-gray-500 text-center">Tidak ada pengguna lain.</p>
                    </div>
                </div>
            </section>
            </main>

        <footer class="bg-gray-800 text-white text-center p-4 text-sm mt-auto">
            &copy; 2025 by Adi Sudrajat. All rights reserved.
        </footer>
    </div>

    <div id="confirmationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideConfirmationModal()">&times;</button>
            <h3 class="text-xl font-bold mb-4" id="confirmationModalTitle">Konfirmasi</h3>
            <p id="confirmationModalMessage" class="mb-6">Apakah Anda yakin?</p>
            <div class="flex justify-end gap-4">
                <button id="confirmNoBtn" class="btn-secondary">Tidak</button>
                <button id="confirmYesBtn" class="btn-danger">Ya</button>
            </div>
        </div>
    </div>

    <div id="editTransactionModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideEditTransactionModal()">&times;</button>
            <h3 class="text-xl font-bold mb-4">Edit Transaksi</h3>
            <form id="editTransactionForm" class="space-y-4">
                <input type="hidden" id="editTransactionId">
                <div>
                    <label for="editTransactionDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                    <input type="date" id="editTransactionDate" required class="block">
                </div>
                <div>
                    <label for="editTransactionDescription" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi</label>
                    <input type="text" id="editTransactionDescription" required class="block">
                </div>
                <div>
                    <label for="editTransactionAmount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah (Rp)</label>
                    <input type="number" id="editTransactionAmount" required min="1" class="block">
                </div>
                <div>
                    <label for="editTransactionType" class="block text-sm font-medium text-gray-700 mb-1">Tipe</label>
                    <select id="editTransactionType" required class="block">
                        <option value="income">Pemasukan</option>
                        <option value="expense">Pengeluaran</option>
                    </select>
                </div>
                <div>
                    <label for="editTransactionCategory" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                    <select id="editTransactionCategory" required class="block">
                        </select>
                </div>
                <button type="submit" class="w-full btn-primary font-semibold">Simpan Perubahan</button>
            </form>
        </div>
    </div>

    <div id="jsonDisplayModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideJsonDisplayModal()">&times;</button>
            <h3 class="text-xl font-bold mb-4">Ekspor Data JSON</h3>
            <p class="text-gray-700 mb-4">Salin teks di bawah ini dan tempelkan ke editor teks di perangkat Anda, lalu simpan sebagai file `.json`.</p>
            <textarea id="jsonOutput" readonly></textarea>
            <button id="copyJsonBtn" class="btn-primary font-semibold">Salin ke Clipboard</button>
        </div>
    </div>

    <div id="notificationContainer"></div>

    <script>
        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const menuBtn = document.getElementById('menuBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const authSection = document.getElementById('authSection');
        const authTitle = document.getElementById('authTitle');
        const authForm = document.getElementById('authForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const authSubmitBtn = document.getElementById('authSubmitBtn');
        const authMessage = document.getElementById('authMessage');
        const toggleAuthModeBtn = document.getElementById('toggleAuthMode');

        const dashboardSection = document.getElementById('dashboardSection');
        const dashboardUsernameEl = document.getElementById('dashboardUsername');
        const currentBalanceEl = document.getElementById('currentBalance');
        const totalIncomeEl = document.getElementById('totalIncome');
        const totalExpenseEl = document.getElementById('totalExpense');
        const latestTransactionsEl = document.getElementById('latestTransactions');
        const incomeExpenseChart = document.getElementById('incomeExpenseChart');
        const expenseByCategorySummary = document.getElementById('expenseByCategorySummary');

        const transactionsSection = document.getElementById('transactionsSection');
        const transactionForm = document.getElementById('transactionForm');
        const transactionDateInput = document.getElementById('transactionDate');
        const transactionDescriptionInput = document.getElementById('transactionDescription');
        const transactionAmountInput = document.getElementById('transactionAmount');
        const transactionTypeInput = document.getElementById('transactionType');
        const transactionCategoryInput = document.getElementById('transactionCategory');
        const allTransactionsListEl = document.getElementById('allTransactionsList');
        const transactionSearchInput = document.getElementById('transactionSearchInput');
        const filterTypeSelect = document.getElementById('filterType');
        const filterStartDate = document.getElementById('filterStartDate');
        const filterEndDate = document.getElementById('filterEndDate');
        const sortBySelect = document.getElementById('sortBy');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const pageInfo = document.getElementById('pageInfo');

        // New Budgeting Section Elements
        const budgetingSidebarItem = document.getElementById('budgetingSidebarItem');
        const budgetingSection = document.getElementById('budgetingSection');
        const budgetForm = document.getElementById('budgetForm');
        const budgetItemCategorySelect = document.getElementById('budgetItemCategory');
        const budgetAmountInput = document.getElementById('budgetAmount');
        const budgetStartDateInput = document.getElementById('budgetStartDate');
        const budgetEndDateInput = document.getElementById('budgetEndDate');
        const budgetListEl = document.getElementById('budgetList');
        const budgetMessageEl = document.getElementById('budgetMessage');

        const reportsSection = document.getElementById('reportsSection');
        const reportMonthSelect = document.getElementById('reportMonthSelect');
        const reportYearSelect = document.getElementById('reportYearSelect');
        const reportTotalIncomeEl = document.getElementById('reportTotalIncome');
        const reportTotalExpenseEl = document.getElementById('reportTotalExpense');
        const reportNetBalanceEl = document.getElementById('reportNetBalance');
        const reportExpenseByCategory = document.getElementById('reportExpenseByCategory');
        const reportIncomeByCategory = document.getElementById('reportIncomeByCategory');
        const reportTransactionsListEl = document.getElementById('reportTransactionsList');

        // New Chart.js canvas elements
        const monthlySummaryChartCanvas = document.getElementById('monthlySummaryChart');
        const expenseByCategoryChartCanvas = document.getElementById('expenseByCategoryChart');
        const incomeByCategoryChartCanvas = document.getElementById('incomeByCategoryChart');

        let monthlySummaryChartInstance = null; // To store Chart.js instance for monthly summary
        let expenseByCategoryChartInstance = null; // To store Chart.js instance for expense by category
        let incomeByCategoryChartInstance = null; // To store Chart.js instance for income by category

        // Analysis Section Elements
        const analysisSidebarItem = document.getElementById('analysisSidebarItem');
        const analysisSection = document.getElementById('analysisSection');
        const financialTrendsChartCanvas = document.getElementById('financialTrendsChart');
        const topExpenseCategoriesChartCanvas = document.getElementById('topExpenseCategoriesChart');
        const topIncomeCategoriesChartCanvas = document.getElementById('topIncomeCategoriesChart');
        const topExpenseCategoriesSummary = document.getElementById('topExpenseCategoriesSummary');
        const topIncomeCategoriesSummary = document.getElementById('topIncomeCategoriesSummary');

        let financialTrendsChartInstance = null;
        let topExpenseCategoriesChartInstance = null;
        let topIncomeCategoriesChartInstance = null;

        const settingsSection = document.getElementById('settingsSection');
        const changePasswordForm = document.getElementById('changePasswordForm');
        const currentPasswordInput = document.getElementById('currentPassword');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
        const passwordMessageEl = document.getElementById('passwordMessage');
        const addCategoryForm = document.getElementById('addCategoryForm');
        const newCategoryNameInput = document.getElementById('newCategoryName');
        const categoryListEl = document.getElementById('categoryList');
        const exportDataBtn = document.getElementById('exportDataBtn');

        // WhatsApp Send Button
        const sendWhatsappSummaryBtn = document.getElementById('sendWhatsappSummaryBtn');

        // Profile Picture Elements
        const profilePictureDisplaySettings = document.getElementById('profilePictureDisplaySettings');
        const profilePicturePlaceholderSettings = document.getElementById('profilePicturePlaceholderSettings');
        const profilePictureInput = document.getElementById('profilePictureInput');
        const deleteProfilePictureBtn = document.getElementById('deleteProfilePictureBtn');
        const profilePictureMessage = document.getElementById('profilePictureMessage');

        // New Profile Picture Elements for Sidebar and Dashboard
        const profilePictureDisplaySidebar = document.getElementById('profilePictureDisplaySidebar');
        const profilePicturePlaceholderSidebar = document.getElementById('profilePicturePlaceholderSidebar');
        const sidebarUsername = document.getElementById('sidebarUsername');

        const profilePictureDisplayDashboard = document.getElementById('profilePictureDisplayDashboard');
        const profilePicturePlaceholderDashboard = document.getElementById('profilePicturePlaceholderDashboard');

        // Admin section elements
        const adminSidebarItem = document.getElementById('adminSidebarItem');
        const adminSection = document.getElementById('adminSection');
        const userListEl = document.getElementById('userList');

        // Specific sidebar items to hide/show
        const dashboardSidebarItem = document.getElementById('dashboardSidebarItem');
        const transactionsSidebarItem = document.getElementById('transactionsSidebarItem');
        const reportsSidebarItem = document.getElementById('reportsSidebarItem');
        const settingsSidebarItem = document.getElementById('settingsSidebarItem');
        const helpSidebarItem = document.getElementById('helpSidebarItem'); // New help sidebar item

        const sidebarItems = document.querySelectorAll('.sidebar-item');

        // Modal Elements
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationModalTitle = document.getElementById('confirmationModalTitle');
        const confirmationModalMessage = document.getElementById('confirmationModalMessage');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmNoBtn = document.getElementById('confirmNoBtn');

        const editTransactionModal = document.getElementById('editTransactionModal');
        const editTransactionForm = document.getElementById('editTransactionForm');
        const editTransactionIdInput = document.getElementById('editTransactionId');
        const editTransactionDateInput = document.getElementById('editTransactionDate');
        const editTransactionDescriptionInput = document.getElementById('editTransactionDescription');
        const editTransactionAmountInput = document.getElementById('editTransactionAmount');
        const editTransactionTypeInput = document.getElementById('editTransactionType');
        const editTransactionCategoryInput = document.getElementById('editTransactionCategory');

        // New JSON Display Modal Elements
        const jsonDisplayModal = document.getElementById('jsonDisplayModal');
        const jsonOutput = document.getElementById('jsonOutput');
        const copyJsonBtn = document.getElementById('copyJsonBtn');

        // Notification Container
        const notificationContainer = document.getElementById('notificationContainer');

        // New Import/Export Buttons
        const exportAllDataBtn = document.getElementById('exportAllDataBtn');
        const importAllDataInput = document.getElementById('importAllDataInput');

        // Chatbot Elements
        const helpSection = document.getElementById('helpSection');
        const chatDisplay = document.getElementById('chatDisplay');
        const chatOptions = document.getElementById('chatOptions');

        // State Variables
        let isLoggedIn = false;
        let authMode = 'login'; // 'login' or 'register'
        let currentUser = null; // Stores the username of the logged-in user
        // let currentConfirmationCallback = null; // Removed as showConfirmationModal now takes callbacks directly

        // Pagination variables
        const transactionsPerPage = 10;
        let currentPage = 1;
        let filteredTransactions = []; // To store transactions after search/filter for pagination

        // Super Admin Credentials (for demonstration purposes)
        const ADMIN_USERNAME = 'admin';
        const ADMIN_PASSWORD = 'admin123';

        // Chatbot Questions and Answers
        const chatbotQA = {
            "start": {
                question: "Halo! Saya asisten bantuan Anda. Silakan pilih topik yang ingin Anda ketahui lebih lanjut:",
                options: [
                    "Informasi Dashboard",
                    "Manajemen Transaksi",
                    "Rencana Anggaran", // New option
                    "Laporan Keuangan",
                    "Analisis Keuangan",
                    "Pengaturan Akun",
                    "Bantuan Admin",
                    "Kembali ke awal"
                ]
            },
            "Informasi Dashboard": {
                answer: "Dashboard adalah halaman utama yang menampilkan ringkasan keuangan Anda. Di sini Anda bisa melihat Saldo Saat Ini, Total Pemasukan, Total Pengeluaran, Ringkasan Pemasukan & Pengeluaran dalam bentuk grafik batang, serta Transaksi Terbaru Anda.",
                options: [
                    "Apa itu Saldo Saat Ini?",
                    "Apa itu Total Pemasukan/Pengeluaran?",
                    "Bagaimana grafik di Dashboard bekerja?",
                    "Transaksi Terbaru di Dashboard",
                    "Kembali ke awal"
                ]
            },
            "Apa itu Saldo Saat Ini?": {
                answer: "Saldo Saat Ini adalah jumlah uang yang Anda miliki, dihitung dari Total Pemasukan dikurangi Total Pengeluaran Anda."
            },
            "Apa itu Total Pemasukan/Pengeluaran?": {
                answer: "Total Pemasukan adalah jumlah semua transaksi dengan tipe 'Pemasukan'. Total Pengeluaran adalah jumlah semua transaksi dengan tipe 'Pengeluaran'."
            },
            "Bagaimana grafik di Dashboard bekerja?": {
                answer: "Grafik di Dashboard menampilkan perbandingan visual antara total pemasukan dan total pengeluaran Anda. Tinggi batang menunjukkan proporsi masing-masing terhadap total transaksi."
            },
            "Transaksi Terbaru di Dashboard": {
                answer: "Bagian 'Transaksi Terbaru' di Dashboard menampilkan hingga 5 transaksi terakhir yang Anda masukkan, memudahkan Anda untuk melacak aktivitas keuangan terkini."
            },
            "Manajemen Transaksi": {
                answer: "Di menu 'Transaksi', Anda bisa menambah, melihat, mengedit, dan menghapus semua transaksi keuangan Anda.",
                options: [
                    "Bagaimana cara menambahkan transaksi baru?",
                    "Bagaimana cara melihat daftar semua transaksi?",
                    "Bagaimana cara mencari, memfilter, dan mengurutkan transaksi?",
                    "Bagaimana cara mengedit transaksi yang sudah ada?",
                    "Bagaimana cara menghapus transaksi?",
                    "Apa fungsi paginasi di daftar transaksi?",
                    "Kembali ke awal"
                ]
            },
            "Bagaimana cara menambahkan transaksi baru?": {
                answer: "Untuk menambahkan transaksi baru, pergi ke menu 'Transaksi', lalu pada formulir 'Tambah Transaksi Baru', isi Tanggal, Deskripsi, Jumlah, pilih Tipe (Pemasukan/Pengeluaran), dan pilih Kategori. Setelah lengkap, klik tombol 'Tambah Transaksi'."
            },
            "Bagaimana cara melihat daftar semua transaksi?": {
                answer: "Daftar semua transaksi Anda dapat dilihat di bagian 'Daftar Semua Transaksi' pada menu 'Transaksi'. Transaksi akan ditampilkan dalam format daftar yang bisa Anda kelola."
            },
            "Bagaimana cara mencari, memfilter, dan mengurutkan transaksi?": {
                answer: "Di 'Daftar Semua Transaksi', Anda dapat menggunakan kolom 'Cari Deskripsi' untuk mencari berdasarkan teks, 'Filter Tipe' untuk memilih Pemasukan/Pengeluaran/Semua, 'Tanggal Mulai' dan 'Tanggal Akhir' untuk memfilter rentang waktu, serta 'Urutkan Berdasarkan' untuk mengurutkan data (Tanggal Terbaru/Terlama, Jumlah Terbesar/Terkecil)."
            },
            "Bagaimana cara mengedit transaksi yang sudah ada?": {
                answer: "Untuk mengedit transaksi, temukan transaksi di 'Daftar Semua Transaksi', lalu klik tombol 'Edit' di samping transaksi tersebut. Sebuah modal akan muncul, Anda bisa mengubah detail transaksi dan klik 'Simpan Perubahan'."
            },
            "Bagaimana cara menghapus transaksi?": {
                answer: "Untuk menghapus transaksi, temukan transaksi di 'Daftar Semua Transaksi', lalu klik tombol 'Hapus' di samping transaksi tersebut. Anda akan diminta konfirmasi sebelum transaksi dihapus secara permanen."
            },
            "Apa fungsi paginasi di daftar transaksi?": {
                answer: "Paginasi digunakan untuk membagi daftar transaksi menjadi beberapa halaman, biasanya 10 transaksi per halaman. Ini membantu dalam mengelola dan melihat data transaksi yang banyak secara lebih efisien. Anda bisa menggunakan tombol 'Sebelumnya' dan 'Berikutnya' untuk navigasi."
            },
            "Rencana Anggaran": { // New chatbot entry for budgeting
                answer: "Menu 'Rencana Anggaran' memungkinkan Anda menetapkan batas pengeluaran untuk kategori tertentu dalam periode waktu tertentu. Anda akan diberi peringatan jika pengeluaran Anda melebihi anggaran yang ditetapkan.",
                options: [
                    "Bagaimana cara menetapkan anggaran baru?",
                    "Bagaimana cara melihat anggaran yang sudah ada?",
                    "Bagaimana cara menghapus anggaran?",
                    "Bagaimana peringatan anggaran bekerja?",
                    "Kembali ke awal"
                ]
            },
            "Bagaimana cara menetapkan anggaran baru?": {
                answer: "Di menu 'Rencana Anggaran', pada formulir 'Tetapkan Anggaran Baru', pilih Kategori, masukkan Jumlah Anggaran, dan tentukan Tanggal Mulai serta Tanggal Akhir periode anggaran. Klik 'Simpan Anggaran' untuk menyimpannya."
            },
            "Bagaimana cara melihat anggaran yang sudah ada?": {
                answer: "Daftar semua anggaran yang Anda tetapkan akan ditampilkan di bagian 'Daftar Anggaran Anda' pada menu 'Rencana Anggaran'. Anda bisa melihat detail setiap anggaran di sana."
            },
            "Bagaimana cara menghapus anggaran?": {
                answer: "Untuk menghapus anggaran, temukan anggaran di 'Daftar Anggaran Anda', lalu klik tombol 'Hapus' di samping anggaran tersebut. Anda akan diminta konfirmasi sebelum anggaran dihapus."
            },
            "Bagaimana peringatan anggaran bekerja?": {
                answer: "Ketika Anda menambahkan transaksi pengeluaran, sistem akan memeriksa apakah transaksi tersebut termasuk dalam kategori yang memiliki anggaran aktif. Jika jumlah transaksi baru akan menyebabkan total pengeluaran untuk kategori tersebut melebihi anggaran yang tersisa, sebuah peringatan akan muncul. Anda tetap bisa melanjutkan transaksi jika mau."
            },
            "Laporan Keuangan": {
                answer: "Menu 'Laporan' menyediakan ringkasan keuangan yang lebih mendalam, termasuk total pemasukan/pengeluaran, saldo bersih, serta grafik bulanan dan per kategori.",
                options: [
                    "Bagaimana cara memfilter laporan?",
                    "Jenis grafik apa saja yang ada di laporan keuangan?",
                    "Bagaimana cara melihat detail transaksi di laporan?",
                    "Kembali ke awal"
                ]
            },
            "Bagaimana cara memfilter laporan?": {
                answer: "Di menu 'Laporan', Anda bisa memfilter ringkasan laporan dan grafik berdasarkan 'Bulan' dan 'Tahun' tertentu, atau memilih 'Semua Bulan'/'Semua Tahun' untuk melihat data keseluruhan."
            },
            "Jenis grafik apa saja yang ada di laporan keuangan?": {
                answer: "Laporan keuangan menampilkan 'Grafik Pemasukan dan Pengeluaran Bulanan' (grafik batang) serta 'Pengeluaran per Kategori' dan 'Pemasukan per Kategori' (grafik lingkaran) untuk visualisasi data Anda."
            },
            "Bagaimana cara melihat detail transaksi di laporan?": {
                answer: "Di bagian bawah menu 'Laporan', terdapat 'Detail Transaksi' yang menampilkan daftar lengkap transaksi yang sesuai dengan filter bulan dan tahun yang Anda pilih di atas."
            },
            "Analisis Keuangan": {
                answer: "Bagian 'Analisis Keuangan' membantu Anda memahami tren dan pola pengeluaran/pemasukan Anda melalui grafik yang lebih mendalam.",
                options: [
                    "Apa itu Tren Keuangan Bulanan?",
                    "Apa itu 5 Kategori Pengeluaran/Pemasukan Teratas?",
                    "Kembali ke awal"
                ]
            },
            "Apa itu Tren Keuangan Bulanan?": {
                answer: "Grafik 'Tren Keuangan Bulanan' menunjukkan bagaimana pemasukan, pengeluaran, dan saldo kumulatif Anda berubah dari waktu ke waktu, memberikan gambaran tentang kesehatan finansial Anda."
            },
            "Apa itu 5 Kategori Pengeluaran/Pemasukan Teratas?": {
                answer: "Grafik ini menampilkan 5 kategori pengeluaran atau pemasukan terbesar Anda berdasarkan jumlah uang, membantu Anda mengidentifikasi area di mana Anda paling banyak menghabiskan atau menerima uang."
            },
            "Pengaturan Akun": {
                answer: "Menu 'Pengaturan' memungkinkan Anda untuk mengelola profil, kata sandi, kategori, serta melakukan backup dan ekspor data.",
                options: [
                    "Bagaimana cara mengelola foto profil?",
                    "Bagaimana cara mengubah kata sandi?",
                    "Bagaimana cara mengelola kategori?",
                    "Bagaimana cara backup/pulihkan data?",
                    "Bagaimana cara mengirim ringkasan transaksi ke WhatsApp?",
                    "Bagaimana cara mengekspor transaksi ke CSV?",
                    "Kembali ke awal"
                ]
            },
            "Bagaimana cara mengelola foto profil?": {
                answer: "Di menu 'Pengaturan', pada bagian 'Foto Profil', Anda dapat mengunggah foto profil baru dengan mengklik 'Ubah Foto Profil' atau menghapus foto profil yang sudah ada dengan 'Hapus Foto Profil'."
            },
            "Bagaimana cara mengubah kata sandi?": {
                answer: "Anda bisa mengubah kata sandi di menu 'Pengaturan', pada bagian 'Ubah Kata Sandi'. Masukkan kata sandi Anda saat ini, lalu masukkan kata sandi baru dan konfirmasinya. Pastikan kata sandi baru minimal 6 karakter."
            },
            "Bagaimana cara backup/pulihkan data?": {
                answer: "Anda dapat membackup data Anda ke file JSON lokal melalui menu 'Pengaturan', pada bagian 'Backup & Pulihkan Data (Lokal)'. Klik 'Ekspor Semua Data' untuk mengunduh file JSON, atau 'Impor Semua Data' untuk mengunggah file JSON dan memulihkan data Anda."
            },
            "Bagaimana cara mengirim ringkasan transaksi ke WhatsApp?": {
                answer: "Di menu 'Pengaturan', pada bagian 'Kirim Semua Transaksi ke WhatsApp', klik tombol 'Kirim Semua Transaksi ke WhatsApp'. Ini akan membuka aplikasi WhatsApp Anda dengan ringkasan keuangan dan detail transaksi yang sudah terisi, siap untuk Anda kirim."
            },
            "Bagaimana cara mengekspor transaksi ke CSV?": {
                answer: "Di menu 'Pengaturan', pada bagian 'Ekspor Data Transaksi (CSV)', klik tombol 'Ekspor Transaksi ke CSV'. Semua transaksi Anda akan diunduh sebagai file CSV yang dapat dibuka di program spreadsheet seperti Excel."
            },
            "Bantuan Admin": {
                answer: "Fitur ini hanya tersedia untuk pengguna dengan peran 'Admin'. Admin dapat mengelola pengguna lain yang terdaftar di aplikasi.",
                options: [
                    "Bagaimana cara menghapus pengguna (Admin)?",
                    "Kembali ke awal"
                ]
            },
            "Bagaimana cara menghapus pengguna (Admin)?": {
                answer: "Sebagai pengguna 'Admin', Anda dapat masuk ke 'Panel Admin'. Di sana akan ada daftar pengguna terdaftar, dan Anda bisa memilih untuk menghapus pengguna tertentu beserta semua datanya."
            },
            "Kembali ke awal": {
                answer: "Baik, apa lagi yang bisa saya bantu? Silakan pilih topik dari daftar di bawah:",
                options: [
                    "Informasi Dashboard",
                    "Manajemen Transaksi",
                    "Rencana Anggaran", // New option
                    "Laporan Keuangan",
                    "Analisis Keuangan",
                    "Pengaturan Akun",
                    "Bantuan Admin",
                    "Kembali ke awal"
                ]
            }
        };

        // --- Utility Functions ---

        // Function to format number as Rupiah
        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Function to show a message (e.g., error, success)
        function showMessage(element, message, isError = true) {
            element.textContent = message;
            element.classList.remove('hidden');
            element.classList.toggle('text-red-500', isError);
            element.classList.toggle('text-green-500', !isError);
            // Removed setTimeout here to keep messages visible until next action/switch
        }

        // Function to show a notification
        function showNotification(message, type = 'success', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notificationContainer.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, duration);
        }

        // Function to get data from localStorage
        function getLocalStorage(key) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : null;
        }

        // Function to set data to localStorage
        function setLocalStorage(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        // --- Authentication Functions ---

        function checkAuthStatus() {
            const users = getLocalStorage('users') || {};
            const loggedInUser = getLocalStorage('loggedInUser');

            if (loggedInUser && users[loggedInUser]) {
                isLoggedIn = true;
                currentUser = loggedInUser;
                showSection(currentUser === ADMIN_USERNAME ? 'adminSection' : 'dashboardSection');
            } else {
                isLoggedIn = false;
                currentUser = null;
                showSection('authSection');
            }
            updateUIBasedOnAuth();
            loadProfilePicture(); // Load profile picture on initial auth check
        }

        function updateUIBasedOnAuth() {
            if (isLoggedIn) {
                authSection.classList.add('hidden');
                sidebar.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                // Ensure sidebar is open on desktop, hidden on mobile initially
                if (window.innerWidth < 768) {
                    sidebar.classList.remove('open');
                } else {
                    sidebar.classList.add('open');
                }

                // Show/hide sidebar items based on user role
                if (currentUser === ADMIN_USERNAME) {
                    dashboardSidebarItem.classList.add('hidden');
                    transactionsSidebarItem.classList.add('hidden');
                    budgetingSidebarItem.classList.add('hidden'); // Hide for admin
                    reportsSidebarItem.classList.add('hidden');
                    analysisSidebarItem.classList.add('hidden'); // Hide for admin
                    settingsSidebarItem.classList.add('hidden');
                    helpSidebarItem.classList.add('hidden'); // Hide help for admin
                    adminSidebarItem.classList.remove('hidden');
                } else {
                    dashboardSidebarItem.classList.remove('hidden');
                    transactionsSidebarItem.classList.remove('hidden');
                    budgetingSidebarItem.classList.remove('hidden'); // Show for regular user
                    reportsSidebarItem.classList.remove('hidden');
                    analysisSidebarItem.classList.remove('hidden'); // Show for regular user
                    settingsSidebarItem.classList.remove('hidden');
                    helpSidebarItem.classList.remove('hidden'); // Show help for regular user
                    adminSidebarItem.classList.add('hidden');
                }
                // Update username in sidebar
                sidebarUsername.textContent = currentUser;

            } else {
                authSection.classList.remove('hidden');
                sidebar.classList.add('hidden');
                logoutBtn.classList.add('hidden');
                // Hide all sidebar items on logout
                dashboardSidebarItem.classList.add('hidden');
                transactionsSidebarItem.classList.add('hidden');
                budgetingSidebarItem.classList.add('hidden');
                reportsSidebarItem.classList.add('hidden');
                analysisSidebarItem.classList.add('hidden');
                settingsSidebarItem.classList.add('hidden');
                helpSidebarItem.classList.add('hidden');
                adminSidebarItem.classList.add('hidden');

                // Hide all other sections
                document.querySelectorAll('main > section:not(#authSection)').forEach(section => {
                    section.classList.add('hidden');
                });
                sidebarUsername.textContent = ''; // Clear username in sidebar
            }
            loadProfilePicture(); // Always attempt to load/clear profile picture based on auth state
        }

        function handleAuth(event) {
            event.preventDefault();
            authMessage.classList.add('hidden'); // Hide previous message immediately
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            let users = getLocalStorage('users') || {};

            if (!username || !password) {
                showMessage(authMessage, 'Username dan password tidak boleh kosong.', true);
                showNotification('Username dan password tidak boleh kosong.', 'error');
                return;
            }

            // Check for super admin login
            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                setLocalStorage('loggedInUser', ADMIN_USERNAME);
                isLoggedIn = true;
                currentUser = ADMIN_USERNAME;
                showMessage(authMessage, 'Login admin berhasil!', false);
                showNotification('Login admin berhasil!', 'success');
                showSection('adminSection'); // Redirect to admin panel
                updateUIBasedOnAuth();
                return;
            }

            if (authMode === 'register') {
                if (users[username]) {
                    showMessage(authMessage, 'Username sudah terdaftar. Silakan gunakan username lain.', true);
                    showNotification('Username sudah terdaftar. Silakan gunakan username lain.', 'error');
                } else {
                    users[username] = {
                        password: password,
                        transactions: [],
                        categories: ['Makanan', 'Transportasi', 'Gaji', 'Hiburan', 'Tagihan', 'Lain-lain'],
                        budgets: [], // Initialize budgets array
                        profilePicture: null // Initialize profile picture as null
                    }; // Default categories and profile picture
                    setLocalStorage('users', users);
                    showMessage(authMessage, 'Registrasi berhasil! Silakan login.', false);
                    showNotification('Registrasi berhasil! Silakan login.', 'success');
                    // Switch to login mode after successful registration
                    authMode = 'login';
                    authTitle.textContent = 'Login';
                    authSubmitBtn.textContent = 'Login';
                    toggleAuthModeBtn.textContent = 'Daftar di sini';
                    usernameInput.value = ''; // Clear fields after successful registration
                    passwordInput.value = ''; // Clear fields after successful registration
                }
            } else { // Login mode
                if (users[username] && users[username].password === password) {
                    setLocalStorage('loggedInUser', username);
                    isLoggedIn = true;
                    currentUser = username;
                    showMessage(authMessage, 'Login berhasil!', false);
                    showNotification('Login berhasil!', 'success');
                    showSection('dashboardSection');
                    updateUIBasedOnAuth();
                } else {
                    showMessage(authMessage, 'Username atau password salah.', true);
                    showNotification('Username atau password salah.', 'error');
                }
            }
        }

        function handleLogout() {
            setLocalStorage('loggedInUser', null);
            isLoggedIn = false;
            currentUser = null;
            showMessage(authMessage, 'Anda telah logout.', false);
            showNotification('Anda telah logout.', 'success');
            showSection('authSection');
            updateUIBasedOnAuth();
            // Reset form fields
            usernameInput.value = '';
            passwordInput.value = '';
        }

        // --- Section Management ---

        function showSection(sectionId) {
            // Prevent non-admin sections for admin user
            if (currentUser === ADMIN_USERNAME && sectionId !== 'adminSection' && sectionId !== 'authSection') {
                showNotification('Akses ditolak. Admin hanya dapat mengakses panel admin.', 'error');
                return;
            }

            document.querySelectorAll('main > section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            // Update active sidebar item
            sidebarItems.forEach(item => {
                item.classList.remove('active');
                if (item.dataset.section + 'Section' === sectionId) {
                    item.classList.add('active');
                }
            });

            // Close sidebar on mobile after navigating
            if (window.innerWidth < 768) {
                sidebar.classList.remove('open');
            }

            // Update data for the displayed section
            if (sectionId === 'dashboardSection') {
                renderDashboard();
            } else if (sectionId === 'transactionsSection') {
                renderCategoryOptions(transactionCategoryInput); // Populate categories for new transaction form
                currentPage = 1; // Reset pagination
                renderTransactions();
            } else if (sectionId === 'budgetingSection') { // New: Handle budgeting section
                renderCategoryOptions(budgetItemCategorySelect);
                renderBudgets();
            }
            else if (sectionId === 'reportsSection') {
                populateReportYears();
                renderReports();
            } else if (sectionId === 'analysisSection') {
                renderAnalysis(); // Render analysis charts
            } else if (sectionId === 'settingsSection') {
                renderManageCategories();
                loadProfilePicture(); // Load profile picture when entering settings
            } else if (sectionId === 'helpSection') { // New: Handle help section
                startChatbot();
            } else if (sectionId === 'adminSection') {
                renderAdminPanel();
            }
        }

        // --- Transaction Management ---

        function getUserData() {
            const users = getLocalStorage('users') || {};
            // Return empty data if currentUser is admin, as admin doesn't have personal transactions
            if (currentUser === ADMIN_USERNAME) {
                return { transactions: [], categories: [], budgets: [], profilePicture: null }; // Include budgets for admin
            }
            // Ensure profilePicture and budgets exist for existing users
            if (users[currentUser] && !users[currentUser].profilePicture) {
                users[currentUser].profilePicture = null;
                setLocalStorage('users', users); // Save updated user data
            }
            if (users[currentUser] && !users[currentUser].budgets) {
                users[currentUser].budgets = [];
                setLocalStorage('users', users); // Save updated user data
            }
            return users[currentUser] || { transactions: [], categories: ['Makanan', 'Transportasi', 'Gaji', 'Hiburan', 'Tagihan', 'Lain-lain'], budgets: [], profilePicture: null };
        }

        function saveUserData(data) {
            let users = getLocalStorage('users') || {};
            if (users[currentUser]) {
                users[currentUser] = data;
                setLocalStorage('users', users);
            }
        }

        function getUserTransactions() {
            // Admin user does not have personal transactions
            if (currentUser === ADMIN_USERNAME) return [];
            return getUserData().transactions;
        }

        function saveUserTransactions(transactions) {
            // Admin user does not save personal transactions
            if (currentUser === ADMIN_USERNAME) return;
            let userData = getUserData();
            userData.transactions = transactions;
            saveUserData(userData);
        }

        async function addTransaction(event) {
            event.preventDefault();
            const date = transactionDateInput.value;
            const description = transactionDescriptionInput.value.trim();
            const amount = parseFloat(transactionAmountInput.value);
            const type = transactionTypeInput.value;
            const category = transactionCategoryInput.value;

            if (!date || !description || isNaN(amount) || amount <= 0 || !category) {
                showMessage(authMessage, 'Semua field harus diisi dengan benar.');
                showNotification('Semua field harus diisi dengan benar.', 'error');
                return;
            }

            // Budgeting check for expense transactions
            if (type === 'expense') {
                const budgets = getUserBudgets();
                const activeBudgets = budgets.filter(b => {
                    const budgetStart = new Date(b.startDate);
                    const budgetEnd = new Date(b.endDate);
                    const transactionDate = new Date(date);
                    return b.category === category && transactionDate >= budgetStart && transactionDate <= budgetEnd;
                });

                if (activeBudgets.length > 0) {
                    const currentExpensesForCategory = getUserTransactions().filter(t =>
                        t.type === 'expense' &&
                        t.category === category &&
                        new Date(t.date) >= new Date(activeBudgets[0].startDate) &&
                        new Date(t.date) <= new Date(activeBudgets[0].endDate)
                    ).reduce((sum, t) => sum + t.amount, 0);

                    const budgetLimit = activeBudgets[0].amount;
                    const remainingBudget = budgetLimit - currentExpensesForCategory;

                    if (amount > remainingBudget) {
                        const confirm = await new Promise(resolve => {
                            showConfirmationModal(`Transaksi ini (${formatRupiah(amount)}) akan melebihi anggaran Anda untuk kategori '${category}' (Sisa anggaran: ${formatRupiah(remainingBudget)}). Lanjutkan?`, () => resolve(true), () => resolve(false));
                        });
                        if (!confirm) {
                            showNotification('Transaksi dibatalkan karena melebihi anggaran.', 'info');
                            return;
                        }
                    }
                }
            }

            const newTransaction = {
                id: Date.now(), // Unique ID for each transaction
                date: date,
                description: description,
                amount: amount,
                type: type,
                category: category
            };

            const transactions = getUserTransactions();
            transactions.push(newTransaction);
            saveUserTransactions(transactions);

            showMessage(authMessage, 'Transaksi berhasil ditambahkan!', false);
            showNotification('Transaksi berhasil ditambahkan!', 'success');
            transactionForm.reset(); // Clear form
            const today = new Date().toISOString().split('T')[0];
            transactionDateInput.value = today; // Reset date to today
            renderDashboard();
            currentPage = 1; // Reset pagination
            renderTransactions();
            renderReports();
            renderAnalysis(); // Update analysis charts
            renderBudgets(); // Update budgets display
        }

        function deleteTransaction(id) {
            confirmAction('Apakah Anda yakin ingin menghapus transaksi ini?', () => {
                let transactions = getUserTransactions();
                transactions = transactions.filter(t => t.id !== id);
                saveUserTransactions(transactions);
                showMessage(authMessage, 'Transaksi berhasil dihapus!', false);
                showNotification('Transaksi berhasil dihapus!', 'success');
                renderDashboard();
                currentPage = 1; // Reset pagination on delete
                renderTransactions();
                renderReports();
                renderAnalysis(); // Update analysis charts
                renderBudgets(); // Update budgets display
            });
        }

        function editTransaction(id) {
            const transactions = getUserTransactions();
            const transactionToEdit = transactions.find(t => t.id === id);

            if (transactionToEdit) {
                editTransactionIdInput.value = transactionToEdit.id;
                editTransactionDateInput.value = transactionToEdit.date;
                editTransactionDescriptionInput.value = transactionToEdit.description;
                editTransactionAmountInput.value = transactionToEdit.amount;
                editTransactionTypeInput.value = transactionToEdit.type;
                renderCategoryOptions(editTransactionCategoryInput); // Populate categories for edit form
                editTransactionCategoryInput.value = transactionToEdit.category;

                showEditTransactionModal();
            }
        }

        function updateTransaction(event) {
            event.preventDefault();
            const id = parseInt(editTransactionIdInput.value);
            const date = editTransactionDateInput.value;
            const description = editTransactionDescriptionInput.value.trim();
            const amount = parseFloat(editTransactionAmountInput.value);
            const type = editTransactionTypeInput.value;
            const category = editTransactionCategoryInput.value;

            if (!date || !description || isNaN(amount) || amount <= 0 || !category) {
                showMessage(authMessage, 'Semua field harus diisi dengan benar.');
                showNotification('Semua field harus diisi dengan benar.', 'error');
                return;
            }

            let transactions = getUserTransactions();
            const index = transactions.findIndex(t => t.id === id);

            if (index !== -1) {
                transactions[index] = { id, date, description, amount, type, category };
                saveUserTransactions(transactions);
                showMessage(authMessage, 'Transaksi berhasil diperbarui!', false);
                showNotification('Transaksi berhasil diperbarui!', 'success');
                hideEditTransactionModal();
                renderDashboard();
                renderTransactions();
                renderReports();
                renderAnalysis(); // Update analysis charts
                renderBudgets(); // Update budgets display
            }
        }

        // --- Category Management ---

        function getUserCategories() {
            // Admin user does not have personal categories
            if (currentUser === ADMIN_USERNAME) return [];
            return getUserData().categories;
        }

        function saveUserCategories(categories) {
            // Admin user does not save personal categories
            if (currentUser === ADMIN_USERNAME) return;
            let userData = getUserData();
            userData.categories = categories;
            saveUserData(userData);
        }

        function renderCategoryOptions(selectElement) {
            const categories = getUserCategories();
            selectElement.innerHTML = ''; // Clear existing options
            if (categories.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Tidak ada kategori';
                selectElement.appendChild(option);
                selectElement.disabled = true;
                return;
            }
            selectElement.disabled = false;
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                selectElement.appendChild(option);
            });
        }

        function addCategory(event) {
            event.preventDefault();
            const newCategory = newCategoryNameInput.value.trim();
            if (!newCategory) {
                showMessage(passwordMessageEl, 'Nama kategori tidak boleh kosong.', true);
                showNotification('Nama kategori tidak boleh kosong.', 'error');
                return;
            }

            let categories = getUserCategories();
            if (categories.includes(newCategory)) {
                showMessage(passwordMessageEl, 'Kategori ini sudah ada.', true);
                showNotification('Kategori ini sudah ada.', 'error');
                return;
            }

            categories.push(newCategory);
            saveUserCategories(categories);
            showMessage(passwordMessageEl, 'Kategori berhasil ditambahkan!', false);
            showNotification('Kategori berhasil ditambahkan!', 'success');
            newCategoryNameInput.value = '';
            renderManageCategories(); // Re-render category list in settings
            renderCategoryOptions(transactionCategoryInput); // Update transaction form categories
            renderCategoryOptions(editTransactionCategoryInput); // Update edit form categories
            renderCategoryOptions(budgetItemCategorySelect); // Update budget form categories
            renderAnalysis(); // Update analysis charts
        }

        function deleteCategory(categoryToDelete) {
            confirmAction(`Apakah Anda yakin ingin menghapus kategori "${categoryToDelete}"? Transaksi dan anggaran yang terkait tidak akan terhapus, tetapi kategorinya akan dialihkan ke 'Lain-lain'.`, () => {
                let categories = getUserCategories();
                categories = categories.filter(cat => cat !== categoryToDelete);
                saveUserCategories(categories);

                // Update transactions that used this category
                let transactions = getUserTransactions();
                transactions.forEach(t => {
                    if (t.category === categoryToDelete) {
                        t.category = 'Lain-lain'; // Assign to a default or 'Uncategorized'
                    }
                });
                saveUserTransactions(transactions);

                // Update budgets that used this category
                let budgets = getUserBudgets();
                budgets.forEach(b => {
                    if (b.category === categoryToDelete) {
                        b.category = 'Lain-lain'; // Assign to a default or 'Uncategorized'
                    }
                });
                saveUserBudgets(budgets);

                showMessage(passwordMessageEl, 'Kategori berhasil dihapus!', false);
                showNotification('Kategori berhasil dihapus!', 'success');
                renderManageCategories();
                renderCategoryOptions(transactionCategoryInput);
                renderCategoryOptions(editTransactionCategoryInput);
                renderCategoryOptions(budgetItemCategorySelect); // Update budget form categories
                renderTransactions(); // Re-render to reflect category changes
                renderReports();
                renderDashboard(); // Re-render dashboard for category summary
                renderAnalysis(); // Update analysis charts
                renderBudgets(); // Update budgets display
            });
        }

        function renderManageCategories() {
            const categories = getUserCategories();
            categoryListEl.innerHTML = '';
            if (categories.length === 0) {
                categoryListEl.innerHTML = '<p class="text-gray-500 text-center">Belum ada kategori.</p>';
            } else {
                categories.forEach(cat => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'flex items-center justify-between p-2 rounded-md bg-gray-50 border border-gray-200';
                    categoryDiv.innerHTML = `
                        <span class="font-medium">${cat}</span>
                        <button class="btn-danger text-xs px-2 py-1" onclick="deleteCategory('${cat}')">Hapus</button>
                    `;
                    categoryListEl.appendChild(categoryDiv);
                });
            }
        }

        // --- Budgeting Functions ---

        function getUserBudgets() {
            if (currentUser === ADMIN_USERNAME) return [];
            return getUserData().budgets;
        }

        function saveUserBudgets(budgets) {
            if (currentUser === ADMIN_USERNAME) return;
            let userData = getUserData();
            userData.budgets = budgets;
            saveUserData(userData);
        }

        function addBudget(event) {
            event.preventDefault();
            const category = budgetItemCategorySelect.value;
            const amount = parseFloat(budgetAmountInput.value);
            const startDate = budgetStartDateInput.value;
            const endDate = budgetEndDateInput.value;

            if (!category || isNaN(amount) || amount <= 0 || !startDate || !endDate) {
                showMessage(budgetMessageEl, 'Semua field harus diisi dengan benar.', true);
                showNotification('Semua field harus diisi dengan benar.', 'error');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showMessage(budgetMessageEl, 'Tanggal mulai tidak boleh lebih lambat dari tanggal akhir.', true);
                showNotification('Tanggal mulai tidak boleh lebih lambat dari tanggal akhir.', 'error');
                return;
            }

            let budgets = getUserBudgets();

            // Check for overlapping budgets for the same category
            const overlappingBudget = budgets.find(b =>
                b.category === category &&
                ((new Date(startDate) <= new Date(b.endDate) && new Date(endDate) >= new Date(b.startDate)))
            );

            if (overlappingBudget) {
                showMessage(budgetMessageEl, `Sudah ada anggaran untuk kategori '${category}' yang tumpang tindih dengan periode ini.`, true);
                showNotification(`Anggaran untuk '${category}' tumpang tindih.`, 'error');
                return;
            }

            const newBudget = {
                id: Date.now(),
                category,
                amount,
                startDate,
                endDate
            };

            budgets.push(newBudget);
            saveUserBudgets(budgets);
            showMessage(budgetMessageEl, 'Anggaran berhasil ditambahkan!', false);
            showNotification('Anggaran berhasil ditambahkan!', 'success');
            budgetForm.reset();
            renderBudgets();
        }

        function deleteBudget(id) {
            confirmAction('Apakah Anda yakin ingin menghapus anggaran ini?', () => {
                let budgets = getUserBudgets();
                budgets = budgets.filter(b => b.id !== id);
                saveUserBudgets(budgets);
                showNotification('Anggaran berhasil dihapus!', 'success');
                renderBudgets();
            });
        }

        function renderBudgets() {
            const budgets = getUserBudgets();
            const transactions = getUserTransactions();
            budgetListEl.innerHTML = '';

            if (budgets.length === 0) {
                budgetListEl.innerHTML = '<p class="text-gray-500 text-center">Belum ada anggaran yang ditetapkan.</p>';
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize today's date to start of day

            budgets.sort((a, b) => new Date(a.startDate) - new Date(b.startDate)); // Sort by start date

            budgets.forEach(budget => {
                const budgetStart = new Date(budget.startDate);
                const budgetEnd = new Date(budget.endDate);
                budgetEnd.setHours(23, 59, 59, 999); // Normalize end date to end of day

                const expensesForBudget = transactions.filter(t =>
                    t.type === 'expense' &&
                    t.category === budget.category &&
                    new Date(t.date) >= budgetStart &&
                    new Date(t.date) <= budgetEnd
                ).reduce((sum, t) => sum + t.amount, 0);

                const remainingAmount = budget.amount - expensesForBudget;
                const percentageUsed = (expensesForBudget / budget.amount) * 100;

                let statusText = '';
                let statusColor = 'text-gray-600';
                let progressBarColor = 'bg-blue-400';

                if (today > budgetEnd) {
                    statusText = 'Berakhir';
                    statusColor = 'text-gray-500';
                    progressBarColor = 'bg-gray-400';
                } else if (today < budgetStart) {
                    statusText = 'Mendatang';
                    statusColor = 'text-blue-500';
                    progressBarColor = 'bg-blue-200';
                } else if (remainingAmount <= 0) {
                    statusText = 'Anggaran Habis!';
                    statusColor = 'text-red-500 font-bold';
                    progressBarColor = 'bg-red-500';
                } else if (percentageUsed >= 75) {
                    statusText = 'Hampir Habis!';
                    statusColor = 'text-orange-500 font-bold';
                    progressBarColor = 'bg-orange-400';
                } else {
                    statusText = 'Aktif';
                    statusColor = 'text-green-500';
                    progressBarColor = 'bg-green-400';
                }

                const budgetDiv = document.createElement('div');
                budgetDiv.className = 'card p-4 mb-4';
                budgetDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-xl font-semibold">${budget.category}</h4>
                        <button class="btn-danger text-xs px-2 py-1" onclick="deleteBudget(${budget.id})">Hapus</button>
                    </div>
                    <p class="text-gray-700">Periode: ${budget.startDate} s/d ${budget.endDate}</p>
                    <p class="text-lg font-medium">Anggaran: ${formatRupiah(budget.amount)}</p>
                    <p class="text-lg font-medium">Terpakai: <span class="text-expense">${formatRupiah(expensesForBudget)}</span></p>
                    <p class="text-lg font-medium">Sisa: <span class="${remainingAmount <= 0 ? 'text-red-500' : 'text-green-500'}">${formatRupiah(remainingAmount)}</span></p>
                    <p class="text-sm mt-1 ${statusColor}">Status: ${statusText}</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                        <div class="${progressBarColor} h-2.5 rounded-full" style="width: ${Math.min(100, percentageUsed)}%;"></div>
                    </div>
                    <p class="text-xs text-gray-500 text-right mt-1">${percentageUsed.toFixed(2)}% Terpakai</p>
                `;
                budgetListEl.appendChild(budgetDiv);
            });
        }


        // --- Password Change ---

        function handleChangePassword(event) {
            event.preventDefault();
            const currentPass = currentPasswordInput.value;
            const newPass = newPasswordInput.value;
            const confirmNewPass = confirmNewPasswordInput.value;

            let users = getLocalStorage('users') || {};
            const userData = users[currentUser];

            if (!currentPass || !newPass || !confirmNewPass) {
                showMessage(passwordMessageEl, 'Semua field harus diisi.', true);
                showNotification('Semua field harus diisi.', 'error');
                return;
            }

            if (userData.password !== currentPass) {
                showMessage(passwordMessageEl, 'Kata sandi saat ini salah.', true);
                showNotification('Kata sandi saat ini salah.', 'error');
                return;
            }

            if (newPass !== confirmNewPass) {
                showMessage(passwordMessageEl, 'Kata sandi baru tidak cocok dengan konfirmasi.', true);
                showNotification('Kata sandi baru tidak cocok dengan konfirmasi.', 'error');
                return;
            }

            if (newPass.length < 6) {
                showMessage(passwordMessageEl, 'Kata sandi baru minimal 6 karakter.', true);
                showNotification('Kata sandi baru minimal 6 karakter.', 'error');
                return;
            }

            userData.password = newPass;
            setLocalStorage('users', users);
            showMessage(passwordMessageEl, 'Kata sandi berhasil diubah!', false);
            showNotification('Kata sandi berhasil diubah!', 'success');
            changePasswordForm.reset();
        }

        // --- Profile Picture Management ---

        function loadProfilePicture() {
            const userData = getUserData();
            const profilePictureBase64 = userData.profilePicture;

            // Update sidebar profile picture
            if (profilePictureBase64) {
                profilePictureDisplaySidebar.src = profilePictureBase64;
                profilePictureDisplaySidebar.classList.remove('hidden');
                profilePicturePlaceholderSidebar.classList.add('hidden');
            } else {
                profilePictureDisplaySidebar.src = ''; // Clear src
                profilePictureDisplaySidebar.classList.add('hidden');
                profilePicturePlaceholderSidebar.classList.remove('hidden');
            }

            // Update dashboard profile picture
            if (profilePictureBase64) {
                profilePictureDisplayDashboard.src = profilePictureBase64;
                profilePictureDisplayDashboard.classList.remove('hidden');
                profilePicturePlaceholderDashboard.classList.add('hidden');
            } else {
                profilePictureDisplayDashboard.src = ''; // Clear src
                profilePictureDisplayDashboard.classList.add('hidden');
                profilePicturePlaceholderDashboard.classList.remove('hidden');
            }

            // Update settings profile picture
            if (profilePictureBase64) {
                profilePictureDisplaySettings.src = profilePictureBase64;
                profilePictureDisplaySettings.classList.remove('hidden');
                profilePicturePlaceholderSettings.classList.add('hidden');
                deleteProfilePictureBtn.classList.remove('hidden');
            } else {
                profilePictureDisplaySettings.src = ''; // Clear src
                profilePictureDisplaySettings.classList.add('hidden');
                profilePicturePlaceholderSettings.classList.remove('hidden');
                deleteProfilePictureBtn.classList.add('hidden');
            }
            profilePictureMessage.classList.add('hidden'); // Clear any previous messages
        }

        function handleProfilePictureUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            profilePictureMessage.classList.add('hidden'); // Hide previous messages

            // Basic file type and size validation
            if (!file.type.startsWith('image/')) {
                showMessage(profilePictureMessage, 'Hanya file gambar yang diizinkan.', true);
                showNotification('Hanya file gambar yang diizinkan.', 'error');
                return;
            }

            // Warning for large files (e.g., > 1MB)
            const MAX_FILE_SIZE_MB = 1;
            if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) {
                showMessage(profilePictureMessage, `Ukuran gambar terlalu besar. Maksimal ${MAX_FILE_SIZE_MB}MB.`, true);
                showNotification(`Ukuran gambar terlalu besar. Maksimal ${MAX_FILE_SIZE_MB}MB.`, 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Image = e.target.result;
                let userData = getUserData();
                userData.profilePicture = base64Image;
                saveUserData(userData);
                loadProfilePicture(); // Update all displays
                showNotification('Foto profil berhasil diunggah!', 'success');
                showMessage(profilePictureMessage, 'Foto profil berhasil diunggah!', false);
            };
            reader.onerror = function() {
                showMessage(profilePictureMessage, 'Gagal membaca file gambar.', true);
                showNotification('Gagal membaca file gambar.', 'error');
            };
            reader.readAsDataURL(file);
        }

        function deleteProfilePicture() {
            confirmAction('Apakah Anda yakin ingin menghapus foto profil Anda?', () => {
                let userData = getUserData();
                userData.profilePicture = null; // Set to null to remove
                saveUserData(userData);
                loadProfilePicture(); // Update all displays to placeholder
                showNotification('Foto profil berhasil dihapus!', 'success');
                showMessage(profilePictureMessage, 'Foto profil berhasil dihapus!', false);
            });
        }

        // --- Local Data Import/Export ---

        function exportAllData() {
            if (!currentUser) {
                showNotification('Anda harus login untuk mengekspor data.', 'error');
                return;
            }

            const users = getLocalStorage('users') || {};
            const userDataToExport = users[currentUser];

            if (!userDataToExport) {
                showNotification('Tidak ada data pengguna untuk diekspor.', 'error');
                return;
            }

            const dataStr = JSON.stringify(userDataToExport, null, 2); // Pretty print JSON

            // Display JSON in a modal for manual copy on Android/WebView
            jsonOutput.value = dataStr;
            showJsonDisplayModal();
            showNotification('Salin data JSON dari jendela yang muncul dan simpan secara manual.', 'info', 5000);
        }

        async function importAllData(event) { // Make it async
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            // Relax file type check: check for .json extension
            if (!file.name.toLowerCase().endsWith('.json')) {
                showNotification('Hanya file JSON yang diizinkan.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) { // Make onload handler async
                try {
                    const importedData = JSON.parse(e.target.result);

                    // Relax validation for optional fields like budgets and profilePicture
                    // Ensure core data (transactions, categories) exists
                    if (!importedData || !Array.isArray(importedData.transactions) || !Array.isArray(importedData.categories)) {
                        showNotification('Format file JSON tidak valid. Data transaksi atau kategori tidak ditemukan.', 'error');
                        return;
                    }

                    const confirmImport = await new Promise(resolve => { // Await user confirmation
                        showConfirmationModal('Apakah Anda yakin ingin mengimpor data ini? Ini akan menimpa semua data Anda saat ini.', () => resolve(true), () => resolve(false));
                    });

                    if (!confirmImport) {
                        showNotification('Impor data dibatalkan.', 'info');
                        return;
                    }

                    let users = getLocalStorage('users') || {};
                    if (!users[currentUser]) {
                        users[currentUser] = {};
                    }
                    users[currentUser].transactions = importedData.transactions;
                    users[currentUser].categories = importedData.categories;
                    // Handle budgets and profilePicture gracefully if they don't exist in importedData
                    users[currentUser].budgets = importedData.budgets || []; // Default to empty array if not present
                    users[currentUser].profilePicture = importedData.profilePicture || null; // Default to null if not present

                    setLocalStorage('users', users);
                    setLocalStorage('loggedInUser', currentUser);

                    showNotification('Data berhasil diimpor dan dipulihkan!', 'success');
                    renderDashboard();
                    renderTransactions();
                    renderBudgets();
                    renderReports();
                    renderAnalysis();
                    renderManageCategories();
                    loadProfilePicture();

                } catch (error) {
                    console.error("Error parsing imported JSON:", error);
                    showNotification('Gagal membaca atau mengurai file JSON. Pastikan formatnya benar dan tidak rusak.', 'error');
                }
            };
            reader.onerror = function() {
                showNotification('Gagal membaca file.', 'error');
            };
            reader.readAsText(file);
            event.target.value = ''; // Clear the file input value to allow selecting the same file again if needed
        }

        // --- Send All Data to WhatsApp (Click-to-Chat) ---
        function sendTransactionsToWhatsApp() {
            const targetPhoneNumber = '6282124064576'; // Nomor WhatsApp tujuan
            const transactions = getUserTransactions();
            let totalIncome = 0;
            let totalExpense = 0;

            transactions.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                } else {
                    totalExpense += t.amount;
                }
            });

            const currentBalance = totalIncome - totalExpense;

            // Prepare summary message
            let message = `Ringkasan Keuangan Anda:\n`;
            message += `Saldo Saat Ini: ${formatRupiah(currentBalance)}\n`;
            message += `Total Pemasukan: ${formatRupiah(totalIncome)}\n`;
            message += `Total Pengeluaran: ${formatRupiah(totalExpense)}\n\n`;

            // Add all transactions
            if (transactions.length > 0) {
                message += `Detail Semua Transaksi:\n`;
                // Sort transactions by date (newest first) for better readability
                transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                transactions.forEach(t => {
                    const typeLabel = t.type === 'income' ? 'Pemasukan' : 'Pengeluaran';
                    message += `- ${t.date} | ${typeLabel} | ${t.category} | ${formatRupiah(t.amount)} | ${t.description}\n`;
                });
            } else {
                message += `Belum ada transaksi tercatat.\n`;
            }

            // Encode the message for URL
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${targetPhoneNumber}?text=${encodedMessage}`;

            // Open WhatsApp in a new tab
            window.open(whatsappUrl, '_blank');

            showNotification('WhatsApp akan terbuka. Mohon kirim pesan secara manual.', 'info', 5000);
        }

        // --- Data Export (CSV) ---
        function exportTransactionsToCSV() {
            const transactions = getUserTransactions();
            if (transactions.length === 0) {
                showNotification('Tidak ada transaksi untuk diekspor.', 'error');
                return;
            }

            const headers = ["ID", "Tanggal", "Deskripsi", "Jumlah", "Tipe", "Kategori"];
            const csvRows = [];
            csvRows.push(headers.join(','));

            transactions.forEach(t => {
                const row = [
                    t.id,
                    t.date,
                    `"${t.description.replace(/"/g, '""')}"`, // Handle commas and quotes in description
                    t.amount,
                    t.type,
                    `"${t.category.replace(/"/g, '""')}"`
                ];
                csvRows.push(row.join(','));
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `transaksi_keuanganku_${currentUser}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('Data berhasil diekspor!', 'success');
        }

        // --- Render Functions ---

        function renderDashboard() {
            // Display current username
            if (currentUser) {
                dashboardUsernameEl.textContent = currentUser;
            } else {
                dashboardUsernameEl.textContent = 'Tamu'; // Fallback if no user is logged in (shouldn't happen here)
            }

            const transactions = getUserTransactions();

            let totalIncome = 0;
            let totalExpense = 0;
            const expenseCategories = {};
            const incomeCategories = {};

            transactions.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                    incomeCategories[t.category] = (incomeCategories[t.category] || 0) + t.amount;
                } else {
                    totalExpense += t.amount;
                    expenseCategories[t.category] = (expenseCategories[t.category] || 0) + t.amount;
                }
            });

            const currentBalance = totalIncome - totalExpense;

            currentBalanceEl.textContent = formatRupiah(currentBalance);
            totalIncomeEl.textContent = formatRupiah(totalIncome);
            totalExpenseEl.textContent = formatRupiah(totalExpense);

            // Render Income/Expense Chart
            renderIncomeExpenseChart(totalIncome, totalExpense);

            // Render Expense by Category Summary
            renderCategorySummary(expenseByCategorySummary, expenseCategories, 'expense');

            // Display latest 5 transactions
            // Sort transactions by date (newest first) and then by ID (as a tie-breaker for same date)
            const latest = transactions.slice().sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (dateB - dateA !== 0) {
                    return dateB - dateA; // Sort by date descending
                }
                return b.id - a.id; // If dates are the same, sort by ID descending (newer ID means more recent)
            }).slice(0, 5);

            latestTransactionsEl.innerHTML = '';
            if (latest.length === 0) {
                latestTransactionsEl.innerHTML = '<p class="text-gray-500 text-center">Belum ada transaksi.</p>';
            } else {
                latest.forEach(t => {
                    const transactionDiv = document.createElement('div');
                    transactionDiv.className = `flex items-center justify-between p-3 rounded-lg ${t.type === 'income' ? 'bg-green-50' : 'bg-red-50'}`;
                    transactionDiv.innerHTML = `
                        <div>
                            <p class="font-medium">${t.description}</p>
                            <p class="text-xs text-gray-500">${t.date} - ${t.category}</p>
                        </div>
                        <p class="font-semibold ${t.type === 'income' ? 'text-income' : 'text-expense'}">${formatRupiah(t.amount)}</p>
                    `;
                    latestTransactionsEl.appendChild(transactionDiv);
                });
            }
            loadProfilePicture(); // Ensure profile picture is loaded on dashboard
        }

        function renderIncomeExpenseChart(income, expense) {
            incomeExpenseChart.innerHTML = ''; // Clear previous chart
            const total = income + expense;
            let incomeHeight = 0;
            let expenseHeight = 0;

            if (total > 0) {
                incomeHeight = (income / total) * 100;
                expenseHeight = (expense / total) * 100;
            }

            const incomeBar = document.createElement('div');
            incomeBar.className = 'chart-bar chart-bar-income';
            incomeBar.style.height = `${incomeHeight}%`;
            incomeBar.innerHTML = `<span>Pemasukan</span>`;

            const expenseBar = document.createElement('div');
            expenseBar.className = 'chart-bar chart-bar-expense';
            expenseBar.style.height = `${expenseHeight}%`;
            expenseBar.innerHTML = `<span>Pengeluaran</span>`;

            incomeExpenseChart.appendChild(incomeBar);
            incomeExpenseChart.appendChild(expenseBar);
        }

        function renderCategorySummary(element, categoryData, type) {
            element.innerHTML = '';
            const sortedCategories = Object.entries(categoryData).sort(([, a], [, b]) => b - a);

            if (sortedCategories.length === 0) {
                element.innerHTML = `<p class="text-gray-500 text-center">Belum ada ${type === 'expense' ? 'pengeluaran' : 'pemasukan'} berdasarkan kategori.</p>`;
                return;
            }

            sortedCategories.forEach(([category, amount]) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center text-sm';
                div.innerHTML = `
                    <span>${category}</span>
                    <span class="font-semibold ${type === 'income' ? 'text-income' : 'text-expense'}">${formatRupiah(amount)}</span>
                `;
                element.appendChild(div);
            });
        }

        function renderTransactions() {
            let transactions = getUserTransactions();

            // Apply search filter
            const searchTerm = transactionSearchInput.value.toLowerCase();
            if (searchTerm) {
                transactions = transactions.filter(t => t.description.toLowerCase().includes(searchTerm));
            }

            // Apply type filter
            const filterType = filterTypeSelect.value;
            if (filterType !== 'all') {
                transactions = transactions.filter(t => t.type === filterType);
            }

            // Apply date range filter
            const start = filterStartDate.value;
            const end = filterEndDate.value;
            if (start && end) {
                transactions = transactions.filter(t => t.date >= start && t.date <= end);
            } else if (start) {
                transactions = transactions.filter(t => t.date >= start);
            } else if (end) {
                transactions = transactions.filter(t => t.date <= end);
            }

            // Apply sort
            const sortBy = sortBySelect.value;
            transactions.sort((a, b) => {
                if (sortBy === 'dateDesc') return new Date(b.date) - new Date(a.date);
                if (sortBy === 'dateAsc') return new Date(a.date) - new Date(b.date);
                if (sortBy === 'amountDesc') return b.amount - a.amount;
                if (sortBy === 'amountAsc') return a.amount - b.amount;
                return 0;
            });

            filteredTransactions = transactions; // Store filtered transactions for pagination
            updatePaginationControls();
            const startIndex = (currentPage - 1) * transactionsPerPage;
            const endIndex = startIndex + transactionsPerPage;
            const transactionsToDisplay = filteredTransactions.slice(startIndex, endIndex);

            allTransactionsListEl.innerHTML = '';

            if (transactionsToDisplay.length === 0) {
                allTransactionsListEl.innerHTML = '<p class="text-gray-500 text-center">Belum ada transaksi.</p>';
            } else {
                transactionsToDisplay.forEach(t => {
                    const transactionDiv = document.createElement('div');
                    transactionDiv.className = `flex flex-col sm:flex-row items-start sm:items-center justify-between p-3 rounded-lg border border-gray-200 bg-white`;
                    transactionDiv.innerHTML = `
                        <div class="flex-grow mb-2 sm:mb-0">
                            <p class="font-medium">${t.description}</p>
                            <p class="text-sm text-gray-500">${t.date} - ${t.category}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <p class="font-semibold ${t.type === 'income' ? 'text-income' : 'text-expense'} mr-2">${formatRupiah(t.amount)}</p>
                            <button class="btn-secondary text-xs px-2 py-1" onclick="editTransaction(${t.id})">Edit</button>
                            <button class="btn-danger text-xs px-2 py-1" onclick="deleteTransaction(${t.id})">Hapus</button>
                        </div>
                    `;
                    allTransactionsListEl.appendChild(transactionDiv);
                });
            }
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredTransactions.length / transactionsPerPage);
            pageInfo.textContent = `Halaman ${currentPage} dari ${totalPages || 1}`;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
        }

        function goToPage(page) {
            currentPage = page;
            renderTransactions();
        }

        function nextPage() {
            if (currentPage * transactionsPerPage < filteredTransactions.length) {
                currentPage++;
                renderTransactions();
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTransactions();
            }
        }

        function populateReportYears() {
            const transactions = getUserTransactions();
            const years = new Set();
            transactions.forEach(t => years.add(new Date(t.date).getFullYear()));
            const sortedYears = Array.from(years).sort((a, b) => b - a);

            reportYearSelect.innerHTML = '<option value="all">Semua Tahun</option>';
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                reportYearSelect.appendChild(option);
            });
        }

        function renderReports() {
            let transactions = getUserTransactions();

            const selectedMonth = reportMonthSelect.value;
            const selectedYear = reportYearSelect.value;

            // Filter by month and year
            transactions = transactions.filter(t => {
                const date = new Date(t.date);
                const transactionMonth = (date.getMonth() + 1).toString().padStart(2, '0');
                const transactionYear = date.getFullYear().toString();

                const matchMonth = selectedMonth === 'all' || transactionMonth === selectedMonth;
                const matchYear = selectedYear === 'all' || transactionYear === selectedYear;

                return matchMonth && matchYear;
            });

            let totalIncome = 0;
            let totalExpense = 0;
            const expenseCategories = {};
            const incomeCategories = {};
            const monthlyData = {}; // For monthly summary chart

            transactions.forEach(t => {
                const date = new Date(t.date);
                const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;

                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = { income: 0, expense: 0 };
                }

                if (t.type === 'income') {
                    totalIncome += t.amount;
                    incomeCategories[t.category] = (incomeCategories[t.category] || 0) + t.amount;
                    monthlyData[monthYear].income += t.amount;
                } else {
                    totalExpense += t.amount;
                    expenseCategories[t.category] = (expenseCategories[t.category] || 0) + t.amount;
                    monthlyData[monthYear].expense += t.amount;
                }
            });

            const netBalance = totalIncome - totalExpense;

            reportTotalIncomeEl.textContent = formatRupiah(totalIncome);
            reportTotalExpenseEl.textContent = formatRupiah(totalExpense);
            reportNetBalanceEl.textContent = formatRupiah(netBalance);

            // Render category breakdown for reports
            renderCategorySummary(reportExpenseByCategory, expenseCategories, 'expense');
            renderCategorySummary(reportIncomeByCategory, incomeCategories, 'income');

            // Render Chart.js graphs
            renderMonthlySummaryChart(monthlyData);
            renderPieChart(expenseByCategoryChartCanvas, expenseCategories, 'Pengeluaran per Kategori', 'rgba(239, 68, 68, 0.8)'); // red-500
            renderPieChart(incomeByCategoryChartCanvas, incomeCategories, 'Pemasukan per Kategori', 'rgba(34, 197, 94, 0.8)'); // green-500

            reportTransactionsListEl.innerHTML = '';
            if (transactions.length === 0) {
                reportTransactionsListEl.innerHTML = '<p class="text-gray-500 text-center">Belum ada transaksi untuk laporan.</p>';
            } else {
                const table = document.createElement('table');
                table.className = 'responsive-table w-full text-sm';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Deskripsi</th>
                            <th>Tanggal</th>
                            <th>Jumlah</th>
                            <th>Tipe</th>
                            <th>Kategori</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = table.querySelector('tbody');

                transactions.forEach(t => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${t.description}</td>
                        <td>${t.date}</td>
                        <td class="${t.type === 'income' ? 'text-income' : 'text-expense'}">${formatRupiah(t.amount)}</td>
                        <td>${t.type === 'income' ? 'Pemasukan' : 'Pengeluaran'}</td>
                        <td>${t.category}</td>
                    `;
                    tbody.appendChild(row);
                });
                reportTransactionsListEl.appendChild(table);
            }
        }

        function renderMonthlySummaryChart(monthlyData) {
            // Destroy existing chart instance if it exists
            if (monthlySummaryChartInstance) {
                monthlySummaryChartInstance.destroy();
            }

            const labels = Object.keys(monthlyData).sort();
            const incomeData = labels.map(month => monthlyData[month].income);
            const expenseData = labels.map(month => monthlyData[month].expense);

            monthlySummaryChartInstance = new Chart(monthlySummaryChartCanvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Pemasukan Bulanan',
                            data: incomeData,
                            backgroundColor: 'rgba(34, 197, 94, 0.6)', // green-500
                            borderColor: 'rgba(34, 197, 94, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Pengeluaran Bulanan',
                            data: expenseData,
                            backgroundColor: 'rgba(239, 68, 68, 0.6)', // red-500
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: false,
                            title: {
                                display: true,
                                text: 'Bulan'
                            }
                        },
                        y: {
                            stacked: false,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Jumlah (Rp)'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    return formatRupiah(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatRupiah(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderPieChart(canvasElement, categoryData, title, colorBase) {
            // Destroy existing chart instance if it exists
            let chartInstance;
            if (canvasElement === expenseByCategoryChartCanvas) {
                if (expenseByCategoryChartInstance) expenseByCategoryChartInstance.destroy();
                chartInstance = expenseByCategoryChartInstance;
            } else if (canvasElement === incomeByCategoryChartCanvas) {
                if (incomeByCategoryChartInstance) incomeByCategoryChartInstance.destroy();
                chartInstance = incomeByCategoryChartInstance;
            }

            const labels = Object.keys(categoryData);
            const data = Object.values(categoryData);

            // Generate dynamic colors
            const backgroundColors = labels.map((_, i) => {
                const hue = (i * 137.508) % 360; // Use golden angle approximation for distinct colors
                return `hsla(${hue}, 70%, 60%, 0.8)`;
            });
            const borderColors = labels.map((_, i) => {
                const hue = (i * 137.508) % 360;
                return `hsla(${hue}, 70%, 50%, 1)`;
            });

            const chartConfig = {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: title,
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: false, // Title is handled in HTML
                            text: title
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += formatRupiah(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            };

            if (canvasElement === expenseByCategoryChartCanvas) {
                expenseByCategoryChartInstance = new Chart(canvasElement, chartConfig);
            } else if (canvasElement === incomeByCategoryChartCanvas) {
                incomeByCategoryChartInstance = new Chart(canvasElement, chartConfig);
            }
        }

        // --- Analysis Functions ---

        function renderAnalysis() {
            const transactions = getUserTransactions();

            if (transactions.length === 0) {
                // Clear any existing charts and display a message
                if (financialTrendsChartInstance) financialTrendsChartInstance.destroy();
                if (topExpenseCategoriesChartInstance) topExpenseCategoriesChartInstance.destroy();
                if (topIncomeCategoriesChartInstance) topIncomeCategoriesChartInstance.destroy();

                // Clear canvas content
                const financialCtx = financialTrendsChartCanvas.getContext('2d');
                financialCtx.clearRect(0, 0, financialTrendsChartCanvas.width, financialTrendsChartCanvas.height);
                const expenseCtx = topExpenseCategoriesChartCanvas.getContext('2d');
                expenseCtx.clearRect(0, 0, topExpenseCategoriesChartCanvas.width, topExpenseCategoriesChartCanvas.height);
                const incomeCtx = topIncomeCategoriesChartCanvas.getContext('2d');
                incomeCtx.clearRect(0, 0, topIncomeCategoriesChartCanvas.width, topIncomeCategoriesChartCanvas.height);

                topExpenseCategoriesSummary.innerHTML = '<p class="text-gray-500 text-center">Belum ada data pengeluaran untuk analisis.</p>';
                topIncomeCategoriesSummary.innerHTML = '<p class="text-gray-500 text-center">Belum ada data pemasukan untuk analisis.</p>';
                return;
            }

            // 1. Calculate Monthly Financial Trends
            const monthlyData = calculateMonthlyFinancialData(transactions);
            renderFinancialTrendsChart(monthlyData);

            // 2. Calculate Top Categories
            const expenseCategories = calculateCategoryTotals(transactions, 'expense');
            const incomeCategories = calculateCategoryTotals(transactions, 'income');

            renderTopCategoriesChart(topExpenseCategoriesChartCanvas, expenseCategories, 'Pengeluaran', 'expense');
            renderTopCategoriesChart(topIncomeCategoriesChartCanvas, incomeCategories, 'Pemasukan', 'income');

            renderTopCategoriesSummary(topExpenseCategoriesSummary, expenseCategories, 'expense');
            renderTopCategoriesSummary(topIncomeCategoriesSummary, incomeCategories, 'income');
        }

        function calculateMonthlyFinancialData(transactions) {
            const monthlySummary = {};

            transactions.forEach(t => {
                const date = new Date(t.date);
                const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;

                if (!monthlySummary[monthYear]) {
                    monthlySummary[monthYear] = { income: 0, expense: 0, balance: 0 };
                }

                if (t.type === 'income') {
                    monthlySummary[monthYear].income += t.amount;
                } else {
                    monthlySummary[monthYear].expense += t.amount;
                }
            });

            // Calculate cumulative balance
            const sortedMonths = Object.keys(monthlySummary).sort();
            let cumulativeBalance = 0;
            sortedMonths.forEach(month => {
                const data = monthlySummary[month];
                data.balance = data.income - data.expense;
                cumulativeBalance += data.balance;
                data.cumulativeBalance = cumulativeBalance; // Store cumulative balance
            });

            return monthlySummary;
        }

        function renderFinancialTrendsChart(monthlyData) {
            if (financialTrendsChartInstance) {
                financialTrendsChartInstance.destroy();
            }

            const labels = Object.keys(monthlyData).sort();
            const incomeData = labels.map(month => monthlyData[month].income);
            const expenseData = labels.map(month => monthlyData[month].expense);
            const balanceData = labels.map(month => monthlyData[month].cumulativeBalance); // Use cumulative balance

            financialTrendsChartInstance = new Chart(financialTrendsChartCanvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Pemasukan Bulanan',
                            data: incomeData,
                            borderColor: 'rgba(34, 197, 94, 1)', // green-500
                            backgroundColor: 'rgba(34, 197, 94, 0.2)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Pengeluaran Bulanan',
                            data: expenseData,
                            borderColor: 'rgba(239, 68, 68, 1)', // red-500
                            backgroundColor: 'rgba(239, 68, 68, 0.2)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Saldo Kumulatif',
                            data: balanceData,
                            borderColor: 'rgba(59, 130, 246, 1)', // blue-500
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Bulan'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Jumlah (Rp)'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    return formatRupiah(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatRupiah(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function calculateCategoryTotals(transactions, type) {
            const categoryTotals = {};
            transactions.forEach(t => {
                if (t.type === type) {
                    categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
                }
            });
            return categoryTotals;
        }

        function renderTopCategoriesChart(canvasElement, categoryData, titlePrefix, type) {
            let chartInstance;
            if (canvasElement === topExpenseCategoriesChartCanvas) {
                if (topExpenseCategoriesChartInstance) topExpenseCategoriesChartInstance.destroy();
                chartInstance = topExpenseCategoriesChartInstance;
            } else if (canvasElement === topIncomeCategoriesChartCanvas) {
                if (topIncomeCategoriesChartInstance) topIncomeCategoriesChartInstance.destroy();
                chartInstance = topIncomeCategoriesChartInstance;
            }

            const sortedCategories = Object.entries(categoryData)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5); // Get top 5

            const labels = sortedCategories.map(item => item[0]);
            const data = sortedCategories.map(item => item[1]);

            // Generate dynamic colors for bars
            const backgroundColors = labels.map((_, i) => {
                const hue = (i * 137.508) % 360;
                return `hsla(${hue}, 70%, 60%, 0.8)`;
            });
            const borderColors = labels.map((_, i) => {
                const hue = (i * 137.508) % 360;
                return `hsla(${hue}, 70%, 50%, 1)`;
            });

            const chartConfig = {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${titlePrefix} (Rp)`,
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // Make it a horizontal bar chart
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Jumlah (Rp)'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    return formatRupiah(value);
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Kategori'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.x !== null) {
                                        label += formatRupiah(context.parsed.x);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            };

            if (canvasElement === topExpenseCategoriesChartCanvas) {
                topExpenseCategoriesChartInstance = new Chart(canvasElement, chartConfig);
            } else if (canvasElement === topIncomeCategoriesChartCanvas) {
                topIncomeCategoriesChartInstance = new Chart(canvasElement, chartConfig);
            }
        }

        function renderTopCategoriesSummary(element, categoryData, type) {
            element.innerHTML = '';
            const sortedCategories = Object.entries(categoryData)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5); // Get top 5

            if (sortedCategories.length === 0) {
                element.innerHTML = `<p class="text-gray-500 text-center">Belum ada ${type === 'expense' ? 'pengeluaran' : 'pemasukan'} berdasarkan kategori.</p>`;
                return;
            }

            sortedCategories.forEach(([category, amount]) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center text-sm';
                div.innerHTML = `
                    <span>${category}</span>
                    <span class="font-semibold ${type === 'income' ? 'text-income' : 'text-expense'}">${formatRupiah(amount)}</span>
                `;
                element.appendChild(div);
            });
        }

        // --- Admin Panel Functions ---
        function renderAdminPanel() {
            userListEl.innerHTML = '';
            const users = getLocalStorage('users') || {};
            const userUsernames = Object.keys(users).filter(username => username !== ADMIN_USERNAME); // Exclude admin from list

            if (userUsernames.length === 0) {
                userListEl.innerHTML = '<p class="text-gray-500 text-center">Tidak ada pengguna lain yang terdaftar.</p>';
                return;
            }

            userUsernames.forEach(username => {
                const userData = users[username];
                const password = userData.password; // Get the password

                const userDiv = document.createElement('div');
                userDiv.className = 'flex flex-col sm:flex-row items-start sm:items-center justify-between p-3 rounded-lg border border-gray-200 bg-white';
                userDiv.innerHTML = `
                    <div class="flex-grow mb-2 sm:mb-0">
                        <p class="font-medium">Username: ${username}</p>
                        <p class="text-sm text-gray-500">Password: ${password}</p>
                    </div>
                    <button class="btn-danger text-xs px-2 py-1" onclick="deleteUser('${username}')">Hapus Pengguna</button>
                `;
                userListEl.appendChild(userDiv);
            });
        }

        function deleteUser(usernameToDelete) {
            confirmAction(`Apakah Anda yakin ingin menghapus pengguna "${usernameToDelete}"? Semua data pengguna ini akan hilang.`, () => {
                let users = getLocalStorage('users') || {};
                if (users[usernameToDelete]) {
                    delete users[usernameToDelete];
                    setLocalStorage('users', users);
                    showNotification(`Pengguna "${usernameToDelete}" berhasil dihapus.`, 'success');
                    renderAdminPanel(); // Refresh the list
                } else {
                    showNotification(`Pengguna "${usernameToDelete}" tidak ditemukan.`, 'error');
                }
            });
        }

        // --- Modal Functions ---
        function showConfirmationModal(message, onConfirm, onCancel) {
            confirmationModalMessage.textContent = message;
            confirmYesBtn.onclick = () => {
                hideConfirmationModal();
                if (onConfirm) onConfirm();
            };
            confirmNoBtn.onclick = () => {
                hideConfirmationModal();
                if (onCancel) onCancel();
            };
            confirmationModal.classList.remove('hidden');
        }

        function hideConfirmationModal() {
            confirmationModal.classList.add('hidden');
            confirmYesBtn.onclick = null;
            confirmNoBtn.onclick = null;
        }

        function showEditTransactionModal() {
            editTransactionModal.classList.remove('hidden');
        }

        function hideEditTransactionModal() {
            editTransactionModal.classList.add('hidden');
        }

        function showJsonDisplayModal() {
            jsonDisplayModal.classList.remove('hidden');
            // Select the text in the textarea to make it easy to copy
            jsonOutput.select();
            jsonOutput.setSelectionRange(0, 99999); // For mobile devices
        }

        function hideJsonDisplayModal() {
            jsonDisplayModal.classList.add('hidden');
        }

        // --- Chatbot Functions ---
        function startChatbot() {
            displayBotMessage(chatbotQA.start.question);
            displayChatOptions(chatbotQA.start.options);
        }

        function displayBotMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message bot';
            messageDiv.textContent = message;
            chatDisplay.appendChild(messageDiv);
            chatDisplay.scrollTop = chatDisplay.scrollHeight; // Scroll to bottom
        }

        function displayUserMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message user';
            messageDiv.textContent = message;
            chatDisplay.appendChild(messageDiv);
            chatDisplay.scrollTop = chatDisplay.scrollHeight; // Scroll to bottom
        }

        function displayChatOptions(options) {
            chatOptions.innerHTML = ''; // Clear previous options
            options.forEach(optionText => {
                const button = document.createElement('button');
                button.textContent = optionText;
                button.addEventListener('click', () => handleChatOptionClick(optionText));
                chatOptions.appendChild(button);
            });
        }

        function handleChatOptionClick(optionText) {
            displayUserMessage(optionText); // Show user's choice
            const response = chatbotQA[optionText];
            if (response) {
                displayBotMessage(response.answer);
                if (response.options) {
                    displayChatOptions(response.options);
                } else {
                    // If no further options, offer to go back to start
                    displayChatOptions(["Kembali ke awal"]);
                }
            } else {
                displayBotMessage("Maaf, saya tidak mengerti pertanyaan itu. Silakan pilih dari opsi yang tersedia atau ketik 'Kembali ke awal'.");
                displayChatOptions(["Kembali ke awal"]);
            }
            chatDisplay.scrollTop = chatDisplay.scrollHeight; // Scroll to bottom after new messages
        }


        // --- Event Listeners ---

        // Toggle sidebar on mobile
        menuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        // Close sidebar when clicking outside on mobile (optional, but good UX)
        document.addEventListener('click', (event) => {
            if (window.innerWidth < 768 && sidebar.classList.contains('open') && !sidebar.contains(event.target) && !menuBtn.contains(event.target)) {
                sidebar.classList.remove('open');
            }
        });

        // Authentication form submission
        authForm.addEventListener('submit', handleAuth);

        // Toggle between login and register modes
        toggleAuthModeBtn.addEventListener('click', (event) => {
            event.preventDefault();
            if (authMode === 'login') {
                authMode = 'register';
                authTitle.textContent = 'Daftar';
                authSubmitBtn.textContent = 'Daftar';
                toggleAuthModeBtn.textContent = 'Daftar di sini';
            } else {
                authMode = 'login';
                authTitle.textContent = 'Login';
                authSubmitBtn.textContent = 'Login';
                toggleAuthModeBtn.textContent = 'Daftar di sini';
            }
            authMessage.classList.add('hidden'); // Clear message on mode switch
            usernameInput.value = ''; // Clear fields
            passwordInput.value = ''; // Clear fields
        });

        // Logout button
        logoutBtn.addEventListener('click', handleLogout);

        // Sidebar navigation
        sidebarItems.forEach(item => {
            item.addEventListener('click', (event) => {
                event.preventDefault();
                const sectionId = event.target.dataset.section + 'Section';
                if (isLoggedIn) {
                    showSection(sectionId);
                } else {
                    showMessage(authMessage, 'Anda harus login terlebih dahulu.', true);
                    showNotification('Anda harus login terlebih dahulu.', 'error');
                }
            });
        });

        // Transaction form submission
        transactionForm.addEventListener('submit', addTransaction);

        // Filter, Sort, Search, and Pagination listeners
        transactionSearchInput.addEventListener('input', () => { currentPage = 1; renderTransactions(); });
        filterTypeSelect.addEventListener('change', () => { currentPage = 1; renderTransactions(); });
        filterStartDate.addEventListener('change', () => { currentPage = 1; renderTransactions(); });
        filterEndDate.addEventListener('change', () => { currentPage = 1; renderTransactions(); });
        sortBySelect.addEventListener('change', () => { currentPage = 1; renderTransactions(); });
        prevPageBtn.addEventListener('click', prevPage);
        nextPageBtn.addEventListener('click', nextPage);

        // Budget form submission
        budgetForm.addEventListener('submit', addBudget);

        // Edit Transaction Form Submission
        editTransactionForm.addEventListener('submit', updateTransaction);

        // Change Password Form Submission
        changePasswordForm.addEventListener('submit', handleChangePassword);

        // Add Category Form Submission
        addCategoryForm.addEventListener('submit', addCategory);

        // Profile Picture Upload/Delete
        profilePictureInput.addEventListener('change', handleProfilePictureUpload);
        deleteProfilePictureBtn.addEventListener('click', deleteProfilePicture);

        // Local Data Import/Export
        exportAllDataBtn.addEventListener('click', exportAllData);
        importAllDataInput.addEventListener('change', importAllData);

        // Copy JSON to clipboard button
        copyJsonBtn.addEventListener('click', () => {
            jsonOutput.select();
            document.execCommand('copy');
            showNotification('Data JSON berhasil disalin ke clipboard!', 'success');
            hideJsonDisplayModal();
        });

        // Send WhatsApp All Transactions Button
        sendWhatsappSummaryBtn.addEventListener('click', sendTransactionsToWhatsApp);

        // Export Data Button (CSV)
        exportDataBtn.addEventListener('click', exportTransactionsToCSV);

        // Report Filters
        reportMonthSelect.addEventListener('change', renderReports);
        reportYearSelect.addEventListener('change', renderReports);

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthStatus();
            // Set default date for transaction form to today
            const today = new Date().toISOString().split('T')[0];
            transactionDateInput.value = today;
            editTransactionDateInput.value = today; // Also for edit form
            budgetStartDateInput.value = today; // Set default start date for budget
            budgetEndDateInput.value = today; // Set default end date for budget
        });

        // Make functions globally accessible for onclick in HTML
        window.deleteTransaction = deleteTransaction;
        window.editTransaction = editTransaction;
        window.deleteCategory = deleteCategory;
        window.hideConfirmationModal = hideConfirmationModal; // For modal close button
        window.hideEditTransactionModal = hideEditTransactionModal; // For modal close button
        window.confirmAction = showConfirmationModal; // Expose for internal use
        window.deleteUser = deleteUser; // Expose for admin panel
        window.hideJsonDisplayModal = hideJsonDisplayModal; // Expose for modal close button
        window.deleteBudget = deleteBudget; // Expose for budget deletion

        // Cegah pinch zoom
        document.addEventListener('gesturestart', function (e) {
            e.preventDefault();
        });

        document.addEventListener('gesturechange', function (e) {
            e.preventDefault();
        });

        document.addEventListener('gestureend', function (e) {
            e.preventDefault();
        });

        // Cegah double-tap zoom
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        feather.replace();
    </script>
</body>
</html>
