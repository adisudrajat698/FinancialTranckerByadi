<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AdiWallet - Catat Keuangan Pribadi</title>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Modern Finance App Styling */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --income-color: #00d4aa;
            --expense-color: #ff6b6b;
            --primary-color: #6c5ce7;
            --secondary-color: #a29bfe;
            --dark-bg: #1a1a2e;
            --dark-card: #16213e;
            --dark-sidebar: #0f3460;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #2d3436;
            transition: all 0.3s ease;
            min-height: 100vh;
        }

        /* Sidebar Modern Styling */
        .sidebar {
            background: linear-gradient(180deg, #2d3436 0%, #636e72 100%);
            color: #ddd;
            width: 280px;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 20;
            box-shadow: 4px 0 20px rgba(0,0,0,0.1);
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-logo {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            border-radius: 15px;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-bottom: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .sidebar-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .sidebar-item:hover::before {
            left: 100%;
        }

        .sidebar-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }

        .sidebar-item.active {
            background: var(--primary-gradient);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
        }

        .sidebar-item i {
            margin-right: 12px;
            width: 20px;
            height: 20px;
        }

        /* Header Modern Styling */
        .header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            z-index: 10;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        /* Main Content Modern Styling */
        .main-content {
            background: transparent;
            min-height: 100vh;
        }

        /* Modern Card Styling */
        .card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        /* Balance Card Special Styling */
        .balance-card {
            background: var(--primary-gradient);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .balance-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }

        /* Income/Expense Cards */
        .income-card {
            background: linear-gradient(135deg, #00d4aa 0%, #00a085 100%);
            color: white;
        }

        .expense-card {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }

        /* Form Styling */
        input[type="text"],
        input[type="password"],
        input[type="email"],
        input[type="number"],
        input[type="date"],
        select {
            border: 2px solid #e9ecef;
            border-radius: 16px;
            padding: 1rem 1.25rem;
            width: 100%;
            outline: none;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.9);
            font-size: 0.95rem;
        }

        input:focus,
        select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(108, 92, 231, 0.1);
            background: white;
        }

        /* Button Modern Styling */
        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            padding: 1rem 2rem;
            border-radius: 16px;
            transition: all 0.3s ease;
            font-weight: 600;
            border: none;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(108, 92, 231, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
            border: none;
            cursor: pointer;
        }

        .btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
            border: none;
            cursor: pointer;
        }

        .btn-secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(116, 185, 255, 0.3);
        }

        /* Stats Cards */
        .stat-card {
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            background: rgba(255,255,255,0.2);
        }

        .balance-card .stat-icon {
            background: rgba(255,255,255,0.2);
        }

        .income-card .stat-icon {
            background: rgba(255,255,255,0.2);
        }

        .expense-card .stat-icon {
            background: rgba(255,255,255,0.2);
        }

        /* Transaction Items */
        .transaction-item {
            background: rgba(255,255,255,0.9);
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .transaction-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: var(--income-color);
        }

        .transaction-item.expense::before {
            background: var(--expense-color);
        }

        .transaction-item:hover {
            transform: translateX(4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        /* Chart Container */
        .chart-container {
            background: rgba(255,255,255,0.9);
            border-radius: 20px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        /* Modal Modern Styling */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modal-content {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            padding: 2.5rem;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            max-width: 90%;
            width: 500px;
            position: relative;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .modal-close-btn {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: rgba(0,0,0,0.1);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-close-btn:hover {
            background: rgba(0,0,0,0.2);
            transform: rotate(90deg);
        }

        /* Notification Modern Styling */
        .notification {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            color: #2d3436;
            padding: 1rem 1.5rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            opacity: 0;
            transform: translateY(-20px);
            animation: slideInOut 4s forwards;
            min-width: 250px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .notification.success {
            border-left: 4px solid var(--income-color);
        }

        .notification.error {
            border-left: 4px solid var(--expense-color);
        }

        .notification.info {
            border-left: 4px solid var(--primary-color);
        }

        @keyframes slideInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            15% { opacity: 1; transform: translateY(0); }
            85% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        /* Budget Progress Bar */
        .budget-progress {
            width: 100%;
            height: 8px;
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .budget-progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
            background: linear-gradient(90deg, var(--income-color) 0%, var(--primary-color) 100%);
        }

        .budget-progress-fill.warning {
            background: linear-gradient(90deg, #fdcb6e 0%, #e17055 100%);
        }

        .budget-progress-fill.danger {
            background: linear-gradient(90deg, #fd79a8 0%, #e84393 100%);
        }

        /* Auth Section Special Styling */
        .auth-container {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.3);
        }

        /* Responsive Design */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
            }
            .content-wrapper {
                margin-left: 280px;
            }
            .menu-button {
                display: none;
            }
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background: linear-gradient(135deg, var(--dark-bg) 0%, #16213e 100%);
            color: #e2e8f0;
        }

        body.dark-mode .sidebar {
            background: linear-gradient(180deg, var(--dark-sidebar) 0%, #1a1a2e 100%);
        }

        body.dark-mode .card {
            background: rgba(22, 33, 62, 0.95);
            border: 1px solid rgba(255,255,255,0.1);
        }

        body.dark-mode .header {
            background: rgba(22, 33, 62, 0.95);
        }

        body.dark-mode input,
        body.dark-mode select {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
            color: #e2e8f0;
        }

        body.dark-mode input:focus,
        body.dark-mode select:focus {
            background: rgba(255,255,255,0.15);
            border-color: var(--primary-color);
        }

        body.dark-mode .transaction-item {
            background: rgba(255,255,255,0.1);
        }

        body.dark-mode .modal-content {
            background: rgba(22, 33, 62, 0.95);
            color: #e2e8f0;
        }

        body.dark-mode .notification {
            background: rgba(22, 33, 62, 0.95);
            color: #e2e8f0;
        }

        body.dark-mode .auth-container {
            background: rgba(22, 33, 62, 0.95);
            color: #e2e8f0;
        }

        /* Quick Action Buttons */
        .quick-action {
            background: rgba(255,255,255,0.9);
            border-radius: 16px;
            padding: 1rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .quick-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .quick-action-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            background: var(--primary-gradient);
            color: white;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-gradient);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(108, 92, 231, 0.3);
            transition: all 0.3s ease;
            z-index: 30;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(108, 92, 231, 0.4);
        }

        /* Hide FAB on desktop */
        @media (min-width: 768px) {
            .fab {
                display: none;
            }
        }

        /* Category Badge */
        .category-badge {
            background: rgba(108, 92, 231, 0.1);
            color: var(--primary-color);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Amount Display */
        .amount-display {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .amount-income {
            color: var(--income-color);
        }

        .amount-expense {
            color: var(--expense-color);
        }

        /* Loading Animation */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(108, 92, 231, 0.1);
            border-left: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-gradient);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }

        /* Section Headers */
        .section-header {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 2rem;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .section-subtitle {
            color: #636e72;
            font-size: 1rem;
        }

        body.dark-mode .section-subtitle {
            color: #b2bec3;
        }

        /* Enhanced Chart Styling */
        .chart-bar-container {
            display: flex;
            align-items: flex-end;
            height: 200px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            padding: 1rem;
        }

        body.dark-mode .chart-bar-container {
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.1) 100%);
        }

        .chart-bar {
            width: 50%;
            height: 0;
            transition: height 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            position: relative;
            margin: 0 0.5rem;
            border-radius: 8px 8px 0 0;
        }

        .chart-bar-income {
            background: linear-gradient(180deg, var(--income-color) 0%, #00a085 100%);
        }

        .chart-bar-expense {
            background: linear-gradient(180deg, var(--expense-color) 0%, #ee5a52 100%);
        }

        /* Enhanced Table Styling */
        .responsive-table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .responsive-table th {
            background: var(--primary-gradient);
            color: white;
            padding: 1rem;
            font-weight: 600;
            text-align: left;
        }

        .responsive-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            transition: background-color 0.3s ease;
        }

        .responsive-table tr:hover td {
            background-color: rgba(108, 92, 231, 0.05);
        }

        body.dark-mode .responsive-table th {
            background: var(--dark-sidebar);
        }

        body.dark-mode .responsive-table td {
            border-bottom-color: rgba(255,255,255,0.1);
        }

        body.dark-mode .responsive-table tr:hover td {
            background-color: rgba(255,255,255,0.05);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <aside id="sidebar" class="sidebar fixed top-0 left-0 h-full p-6 flex flex-col md:relative md:flex-shrink-0">
        <div class="sidebar-logo">
            <img src="logo.jpeg" alt="Logo Aplikasi" class="mx-auto w-16 h-16 mb-3 rounded-full border-4 border-white/20">
            <div class="text-2xl font-bold text-white">AdiWallet</div>
            <div class="text-sm text-white/70 mt-1">Kelola Keuangan Anda</div>
        </div>

        <div class="flex flex-col items-center mb-8 p-4 bg-white/10 rounded-2xl backdrop-blur-sm">
            <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-white">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                </svg>
            </div>
            <p id="sidebarUsername" class="text-lg font-semibold text-white text-center"></p>
        </div>

        <nav class="flex-grow">
            <ul class="space-y-2">
                <li id="dashboardSidebarItem">
                    <a href="#" class="sidebar-item" data-section="dashboard">
                        <i data-feather="home"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li id="transactionsSidebarItem">
                    <a href="#" class="sidebar-item" data-section="transactions">
                        <i data-feather="credit-card"></i>
                        <span>Transaksi</span>
                    </a>
                </li>
                <li id="budgetingSidebarItem">
                    <a href="#" class="sidebar-item" data-section="budgeting">
                        <i data-feather="target"></i>
                        <span>Rencana Anggaran</span>
                    </a>
                </li>
                <li id="reportsSidebarItem">
                    <a href="#" class="sidebar-item" data-section="reports">
                        <i data-feather="bar-chart-2"></i>
                        <span>Laporan</span>
                    </a>
                </li>
                <li id="analysisSidebarItem">
                    <a href="#" class="sidebar-item" data-section="analysis">
                        <i data-feather="trending-up"></i>
                        <span>Analisis Keuangan</span>
                    </a>
                </li>
                <li id="settingsSidebarItem">
                    <a href="#" class="sidebar-item" data-section="settings">
                        <i data-feather="settings"></i>
                        <span>Pengaturan</span>
                    </a>
                </li>
                <li id="helpSidebarItem">
                    <a href="#" class="sidebar-item" data-section="help">
                        <i data-feather="help-circle"></i>
                        <span>Bantuan</span>
                    </a>
                </li>
            </ul>
        </nav>

        <div class="mt-auto">
            <button id="logoutBtn" class="w-full bg-white/10 hover:bg-white/20 text-white font-medium py-3 px-4 rounded-2xl transition-all duration-300 backdrop-blur-sm border border-white/20">
                <i data-feather="log-out" class="inline-block w-4 h-4 mr-2"></i>
                Logout
            </button>
        </div>
    </aside>

    <div class="flex-grow flex flex-col content-wrapper md:ml-0">
        <header class="header p-4 flex items-center justify-between sticky top-0 md:hidden">
            <button id="menuBtn" class="menu-button text-gray-600 focus:outline-none p-2 rounded-xl hover:bg-white/20 transition-all duration-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
            <h1 class="text-xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">AdiWallet</h1>
            <div class="w-10 h-10"></div>
        </header>

        <main class="flex-grow p-4 md:p-8 overflow-y-auto">
            <section id="authSection" class="flex items-center justify-center min-h-screen-minus-header">
                <div class="auth-container p-8 w-full max-w-md">
                    <div class="flex flex-col items-center mb-8">
                        <div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-blue-600 rounded-3xl flex items-center justify-center mb-4 shadow-lg">
                            <img src="logo.jpeg" alt="Logo Aplikasi" class="w-16 h-16 rounded-2xl">
                        </div>
                        <h2 class="text-3xl font-bold text-center mb-2" id="authTitle">Selamat Datang</h2>
                        <p class="text-gray-600 text-center">Kelola keuangan Anda dengan mudah</p>
                    </div>
                    <form id="authForm" class="space-y-6">
                        <div>
                            <label for="username" class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                            <input type="email" id="username" name="username" required class="block" placeholder="Masukkan email Anda">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                            <input type="password" id="password" name="password" required class="block" placeholder="Masukkan password Anda">
                        </div>
                        <p id="authMessage" class="text-red-500 text-sm hidden"></p>
                        <button type="submit" id="authSubmitBtn" class="w-full btn-primary font-semibold text-lg py-3">Login</button>
                    </form>
                    <div class="text-center text-sm mt-6 space-y-2">
                        <a href="#" id="forgotPasswordLink" class="text-purple-600 hover:text-purple-800 font-medium">Lupa Kata Sandi?</a>
                        <div class="text-gray-600">
                            Belum punya akun? 
                            <a href="#" id="toggleAuthMode" class="text-purple-600 hover:text-purple-800 font-medium">Daftar di sini</a>
                        </div>
                    </div>
                </div>
            </section>

            <section id="dashboardSection" class="hidden">
                <div class="section-header">
                    <h2 class="section-title">Dashboard</h2>
                    <p class="section-subtitle">Ringkasan keuangan Anda hari ini</p>
                </div>

                <div class="flex items-center gap-4 mb-8 p-6 card">
                    <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-blue-600 rounded-2xl flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-white">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                        </svg>
                    </div>
                    <div>
                        <p class="text-xl font-bold">Selamat datang kembali!</p>
                        <p id="dashboardUsername" class="text-purple-600 font-semibold"></p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="card balance-card p-6 stat-card relative">
                        <div class="stat-icon">
                            <i data-feather="wallet" class="w-8 h-8"></i>
                        </div>
                        <h3 class="text-lg font-medium mb-2">Saldo Saat Ini</h3>
                        <p id="currentBalance" class="text-4xl font-bold">Rp 0</p>
                        <div class="absolute top-4 right-4 opacity-20">
                            <i data-feather="trending-up" class="w-8 h-8"></i>
                        </div>
                    </div>
                    <div class="card income-card p-6 stat-card relative">
                        <div class="stat-icon">
                            <i data-feather="arrow-down-left" class="w-8 h-8"></i>
                        </div>
                        <h3 class="text-lg font-medium mb-2">Total Pemasukan</h3>
                        <p id="totalIncome" class="text-3xl font-bold">Rp 0</p>
                        <div class="absolute top-4 right-4 opacity-20">
                            <i data-feather="plus-circle" class="w-8 h-8"></i>
                        </div>
                    </div>
                    <div class="card expense-card p-6 stat-card relative">
                        <div class="stat-icon">
                            <i data-feather="arrow-up-right" class="w-8 h-8"></i>
                        </div>
                        <h3 class="text-lg font-medium mb-2">Total Pengeluaran</h3>
                        <p id="totalExpense" class="text-3xl font-bold">Rp 0</p>
                        <div class="absolute top-4 right-4 opacity-20">
                            <i data-feather="minus-circle" class="w-8 h-8"></i>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold mb-6 flex items-center">
                            <i data-feather="bar-chart" class="w-6 h-6 mr-3 text-purple-600"></i>
                            Ringkasan Keuangan
                        </h3>
                        <div id="incomeExpenseChart" class="chart-bar-container"></div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold mb-6 flex items-center">
                            <i data-feather="pie-chart" class="w-6 h-6 mr-3 text-purple-600"></i>
                            Pengeluaran per Kategori
                        </h3>
                        <div id="expenseByCategorySummary" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">Belum ada pengeluaran berdasarkan kategori.</p>
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-6 flex items-center">
                        <i data-feather="clock" class="w-6 h-6 mr-3 text-purple-600"></i>
                        Transaksi Terbaru
                    </h3>
                    <div id="latestTransactions" class="space-y-4">
                        <p class="text-gray-500 text-center py-8">Belum ada transaksi.</p>
                    </div>
                </div>
            </section>

            <section id="transactionsSection" class="hidden">
                <div class="section-header">
                    <h2 class="section-title">Transaksi</h2>
                    <p class="section-subtitle">Kelola semua transaksi keuangan Anda</p>
                </div>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-6 flex items-center">
                        <i data-feather="plus-circle" class="w-6 h-6 mr-3 text-purple-600"></i>
                        Tambah Transaksi Baru
                    </h3>
                    <form id="transactionForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="transactionDate" class="block text-sm font-semibold text-gray-700 mb-2">Tanggal</label>
                            <input type="date" id="transactionDate" required class="block">
                        </div>
                        <div>
                            <label for="transactionDescription" class="block text-sm font-semibold text-gray-700 mb-2">Deskripsi</label>
                            <input type="text" id="transactionDescription" placeholder="Contoh: Beli Kopi" required class="block">
                        </div>
                        <div>
                            <label for="transactionAmount" class="block text-sm font-semibold text-gray-700 mb-2">Jumlah (Rp)</label>
                            <input type="number" id="transactionAmount" placeholder="Contoh: 25000" required min="1" class="block">
                        </div>
                        <div>
                            <label for="transactionType" class="block text-sm font-semibold text-gray-700 mb-2">Tipe</label>
                            <select id="transactionType" required class="block">
                                <option value="income">Pemasukan</option>
                                <option value="expense">Pengeluaran</option>
                            </select>
                        </div>
                        <div>
                            <label for="transactionCategory" class="block text-sm font-semibold text-gray-700 mb-2">Kategori</label>
                            <select id="transactionCategory" required class="block"></select>
                        </div>
                        <div class="flex items-end">
                            <button type="submit" class="w-full btn-primary font-semibold py-3">
                                <i data-feather="plus" class="inline-block w-4 h-4 mr-2"></i>
                                Tambah Transaksi
                            </button>
                        </div>
                    </form>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-6 flex items-center">
                        <i data-feather="list" class="w-6 h-6 mr-3 text-purple-600"></i>
                        Daftar Semua Transaksi
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label for="transactionSearchInput" class="block text-sm font-semibold text-gray-700 mb-2">Cari Deskripsi</label>
                            <input type="text" id="transactionSearchInput" placeholder="Cari transaksi..." class="block">
                        </div>
                        <div>
                            <label for="filterType" class="block text-sm font-semibold text-gray-700 mb-2">Filter Tipe</label>
                            <select id="filterType" class="block">
                                <option value="all">Semua</option>
                                <option value="income">Pemasukan</option>
                                <option value="expense">Pengeluaran</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterStartDate" class="block text-sm font-semibold text-gray-700 mb-2">Tanggal Mulai</label>
                            <input type="date" id="filterStartDate" class="block">
                        </div>
                        <div>
                            <label for="filterEndDate" class="block text-sm font-semibold text-gray-700 mb-2">Tanggal Akhir</label>
                            <input type="date" id="filterEndDate" class="block">
                        </div>
                        <div class="col-span-full sm:col-span-2 lg:col-span-1">
                            <label for="sortBy" class="block text-sm font-semibold text-gray-700 mb-2">Urutkan</label>
                            <select id="sortBy" class="block">
                                <option value="dateDesc">Tanggal (Terbaru)</option>
                                <option value="dateAsc">Tanggal (Terlama)</option>
                                <option value="amountDesc">Jumlah (Terbesar)</option>
                                <option value="amountAsc">Jumlah (Terkecil)</option>
                            </select>
                        </div>
                    </div>
                    <div id="allTransactionsList" class="space-y-4">
                        <p class="text-gray-500 text-center py-8">Belum ada transaksi.</p>
                    </div>
                    <div id="paginationControls" class="flex justify-center items-center gap-4 mt-8">
                        <button id="prevPageBtn" class="btn-secondary px-6 py-2 rounded-xl" disabled>
                            <i data-feather="chevron-left" class="inline-block w-4 h-4 mr-1"></i>
                            Sebelumnya
                        </button>
                        <span id="pageInfo" class="text-gray-700 font-medium px-4">Halaman 1 dari 1</span>
                        <button id="nextPageBtn" class="btn-secondary px-6 py-2 rounded-xl" disabled>
                            Berikutnya
                            <i data-feather="chevron-right" class="inline-block w-4 h-4 ml-1"></i>
                        </button>
                    </div>
                </div>
            </section>

            <section id="budgetingSection" class="hidden">
                <div class="section-header">
                    <h2 class="section-title">Rencana Anggaran</h2>
                    <p class="section-subtitle">Atur dan pantau anggaran keuangan Anda</p>
                </div>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-6 flex items-center">
                        <i data-feather="target" class="w-6 h-6 mr-3 text-purple-600"></i>
                        Tetapkan Anggaran Baru
                    </h3>
                    <form id="budgetForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="budgetItemCategory" class="block text-sm font-semibold text-gray-700 mb-2">Kategori</label>
                            <select id="budgetItemCategory" required class="block"></select>
                        </div>
                        <div>
                            <label for="budgetAmount" class="block text-sm font-semibold text-gray-700 mb-2">Jumlah Anggaran (Rp)</label>
                            <input type="number" id="budgetAmount" placeholder="Contoh: 500000" required min="1" class="block">
                        </div>
                        <div>
                            <label for="budgetStartDate" class="block text-sm font-semibold text-gray-700 mb-2">Tanggal Mulai</label>
                            <input type="date" id="budgetStartDate" required class="block">
                        </div>
                        <div>
                            <label for="budgetEndDate" class="block text-sm font-semibold text-gray-700 mb-2">Tanggal Akhir</label>
                            <input type="date" id="budgetEndDate" required class="block">
                        </div>
                        <div class="col-span-full">
                            <button type="submit" class="w-full btn-primary font-semibold py-3">
                                <i data-feather="save" class="inline-block w-4 h-4 mr-2"></i>
                                Simpan Anggaran
                            </button>
                        </div>
                    </form>
                    <p id="budgetMessage" class="text-red-500 text-sm hidden mt-4"></p>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-6 flex items-center">
                        <i data-feather="list" class="w-6 h-6 mr-3 text-purple-600"></i>
                        Daftar Anggaran Anda
                    </h3>
                    <div id="budgetList" class="space-y-6">
                        <p class="text-gray-500 text-center py-8">Belum ada anggaran yang ditetapkan.</p>
                    </div>
                </div>
            </section>

            <section id="reportsSection" class="hidden">
                <div class="section-header">
                    <h2 class="section-title">Laporan Keuangan</h2>
                    <p class="section-subtitle">Analisis mendalam tentang keuangan Anda</p>
                </div>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-6 flex items-center">
                        <i data-feather="filter" class="w-6 h-6 mr-3 text-purple-600"></i>
                        Filter Laporan
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="reportMonthSelect" class="block text-sm font-semibold text-gray-700 mb-2">Bulan</label>
                            <select id="reportMonthSelect" class="block">
                                <option value="all">Semua Bulan</option>
                                <option value="01">Januari</option>
                                <option value="02">Februari</option>
                                <option value="03">Maret</option>
                                <option value="04">April</option>
                                <option value="05">Mei</option>
                                <option value="06">Juni</option>
                                <option value="07">Juli</option>
                                <option value="08">Agustus</option>
                                <option value="09">September</option>
                                <option value="10">Oktober</option>
                                <option value="11">November</option>
                                <option value="12">Desember</option>
                            </select>
                        </div>
                        <div>
                            <label for="reportYearSelect" class="block text-sm font-semibold text-gray-700 mb-2">Tahun</label>
                            <select id="reportYearSelect" class="block"></select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="text-center p-6 bg-gradient-to-br from-green-400 to-green-600 rounded-2xl text-white">
                            <i data-feather="trending-up" class="w-8 h-8 mx-auto mb-2"></i>
                            <p class="text-sm font-medium mb-1">Total Pemasukan</p>
                            <p id="reportTotalIncome" class="text-2xl font-bold">Rp 0</p>
                        </div>
                        <div class="text-center p-6 bg-gradient-to-br from-red-400 to-red-600 rounded-2xl text-white">
                            <i data-feather="trending-down" class="w-8 h-8 mx-auto mb-2"></i>
                            <p class="text-sm font-medium mb-1">Total Pengeluaran</p>
                            <p id="reportTotalExpense" class="text-2xl font-bold">Rp 0</p>
                        </div>
                        <div class="text-center p-6 bg-gradient-to-br from-purple-400 to-purple-600 rounded-2xl text-white">
                            <i data-feather="dollar-sign" class="w-8 h-8 mx-auto mb-2"></i>
                            <p class="text-sm font-medium mb-1">Saldo Bersih</p>
                            <p id="reportNetBalance" class="text-2xl font-bold">Rp 0</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="chart-container">
                            <h4 class="text-xl font-bold mb-4">Grafik Bulanan</h4>
                            <div class="relative h-64">
                                <canvas id="monthlySummaryChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-container">
                            <h4 class="text-xl font-bold mb-4">Pengeluaran per Kategori</h4>
                            <div class="relative h-64">
                                <canvas id="expenseByCategoryChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container mb-8">
                        <h4 class="text-xl font-bold mb-4">Pemasukan per Kategori</h4>
                        <div class="relative h-64">
                            <canvas id="incomeByCategoryChart"></canvas>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div>
                            <h4 class="text-xl font-bold mb-4 flex items-center">
                                <i data-feather="arrow-up" class="w-5 h-5 mr-2 text-red-500"></i>
                                Pengeluaran per Kategori
                            </h4>
                            <div id="reportExpenseByCategory" class="space-y-3">
                                <p class="text-gray-500 text-center py-4">Belum ada data pengeluaran per kategori.</p>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-xl font-bold mb-4 flex items-center">
                                <i data-feather="arrow-down" class="w-5 h-5 mr-2 text-green-500"></i>
                                Pemasukan per Kategori
                            </h4>
                            <div id="reportIncomeByCategory" class="space-y-3">
                                <p class="text-gray-500 text-center py-4">Belum ada data pemasukan per kategori.</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h4 class="text-xl font-bold mb-4 flex items-center">
                            <i data-feather="file-text" class="w-5 h-5 mr-2 text-purple-600"></i>
                            Detail Transaksi
                        </h4>
                        <div id="reportTransactionsList" class="overflow-x-auto">
                            <p class="text-gray-500 text-center py-8">Belum ada transaksi untuk laporan.</p>
                        </div>
                    </div>

                    <button id="generatePdfReportBtn" class="w-full btn-primary font-semibold py-3">
                        <i data-feather="download" class="inline-block w-4 h-4 mr-2"></i>
                        Generate Laporan PDF
                    </button>
                </div>
            </section>

            <section id="analysisSection" class="hidden">
                <div class="section-header">
                    <h2 class="section-title">Analisis Keuangan</h2>
                    <p class="section-subtitle">Wawasan mendalam tentang pola keuangan Anda</p>
                </div>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-6 flex items-center">
                        <i data-feather="trending-up" class="w-6 h-6 mr-3 text-purple-600"></i>
                        Tren Keuangan Bulanan
                    </h3>
                    <p class="text-gray-700 mb-6">Lihat bagaimana pemasukan, pengeluaran, dan saldo Anda berkembang dari waktu ke waktu.</p>
                    <div class="chart-container">
                        <div class="relative h-80">
                            <canvas id="financialTrendsChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold mb-6 flex items-center">
                            <i data-feather="bar-chart-2" class="w-6 h-6 mr-3 text-red-500"></i>
                            Top 5 Pengeluaran
                        </h3>
                        <div class="chart-container mb-4">
                            <div class="relative h-64">
                                <canvas id="topExpenseCategoriesChart"></canvas>
                            </div>
                        </div>
                        <div id="topExpenseCategoriesSummary" class="space-y-3">
                            <p class="text-gray-500 text-center py-4">Belum ada data pengeluaran.</p>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold mb-6 flex items-center">
                            <i data-feather="bar-chart-2" class="w-6 h-6 mr-3 text-green-500"></i>
                            Top 5 Pemasukan
                        </h3>
                        <div class="chart-container mb-4">
                            <div class="relative h-64">
                                <canvas id="topIncomeCategoriesChart"></canvas>
                            </div>
                        </div>
                        <div id="topIncomeCategoriesSummary" class="space-y-3">
                            <p class="text-gray-500 text-center py-4">Belum ada data pemasukan.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="settingsSection" class="hidden">
                <div class="section-header">
                    <h2 class="section-title">Pengaturan</h2>
                    <p class="section-subtitle">Kelola akun dan preferensi Anda</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold mb-6 flex items-center">
                            <i data-feather="moon" class="w-6 h-6 mr-3 text-purple-600"></i>
                            Mode Tampilan
                        </h3>
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-2xl">
                            <div>
                                <p class="font-semibold">Mode Gelap</p>
                                <p class="text-sm text-gray-600">Aktifkan tema gelap</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="darkModeToggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                            </label>
                        </div>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-2xl font-bold mb-6 flex items-center">
                            <i data-feather="lock" class="w-6 h-6 mr-3 text-purple-600"></i>
                            Ubah Kata Sandi
                        </h3>
                        <form id="changePasswordForm" class="space-y-4">
                            <div>
                                <label for="currentPassword" class="block text-sm font-semibold text-gray-700 mb-2">Kata Sandi Saat Ini</label>
                                <input type="password" id="currentPassword" required class="block">
                            </div>
                            <div>
                                <label for="newPassword" class="block text-sm font-semibold text-gray-700 mb-2">Kata Sandi Baru</label>
                                <input type="password" id="newPassword" required class="block">
                            </div>
                            <div>
                                <label for="confirmNewPassword" class="block text-sm font-semibold text-gray-700 mb-2">Konfirmasi Kata Sandi Baru</label>  class="block text-sm font-semibold text-gray-700 mb-2">Konfirmasi Kata Sandi Baru</label>
                                <input type="password" id="confirmNewPassword" required class="block">
                            </div>
                            <p id="passwordMessage" class="text-red-500 text-sm hidden"></p>
                            <button type="submit" class="w-full btn-primary font-semibold py-3">
                                <i data-feather="key" class="inline-block w-4 h-4 mr-2"></i>
                                Ubah Kata Sandi
                            </button>
                        </form>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-2xl font-bold mb-6 flex items-center">
                            <i data-feather="tag" class="w-6 h-6 mr-3 text-purple-600"></i>
                            Kelola Kategori
                        </h3>
                        <form id="addCategoryForm" class="flex gap-4 mb-6">
                            <input type="text" id="newCategoryName" placeholder="Nama Kategori Baru" required class="flex-grow">
                            <button type="submit" class="btn-primary font-semibold px-6">
                                <i data-feather="plus" class="inline-block w-4 h-4 mr-1"></i>
                                Tambah
                            </button>
                        </form>
                        <div id="categoryList" class="space-y-3">
                            <p class="text-gray-500 text-center py-4">Belum ada kategori.</p>
                        </div>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-2xl font-bold mb-6 flex items-center">
                            <i data-feather="database" class="w-6 h-6 mr-3 text-purple-600"></i>
                            Backup & Pulihkan Data
                        </h3>
                        <p class="text-gray-700 mb-6">Ekspor semua data Anda ke file atau impor dari file yang sudah ada.</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <button id="exportAllDataBtn" class="btn-primary font-semibold py-3">
                                <i data-feather="download" class="inline-block w-4 h-4 mr-2"></i>
                                Ekspor Data
                            </button>
                            <div>
                                <input type="file" id="importAllDataInput" accept=".json" class="hidden">
                                <label for="importAllDataInput" class="w-full btn-secondary cursor-pointer text-center font-semibold py-3 px-4 rounded-2xl inline-block">
                                    <i data-feather="upload" class="inline-block w-4 h-4 mr-2"></i>
                                    Impor Data
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-2xl font-bold mb-6 flex items-center">
                            <i data-feather="message-circle" class="w-6 h-6 mr-3 text-green-600"></i>
                            Kirim ke WhatsApp
                        </h3>
                        <p class="text-gray-700 mb-6">Kirim ringkasan semua transaksi Anda ke WhatsApp.</p>
                        <button id="sendWhatsappSummaryBtn" class="w-full btn-primary font-semibold py-3">
                            <i data-feather="send" class="inline-block w-4 h-4 mr-2"></i>
                            Kirim ke WhatsApp
                        </button>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-2xl font-bold mb-6 flex items-center">
                            <i data-feather="file-text" class="w-6 h-6 mr-3 text-blue-600"></i>
                            Ekspor CSV
                        </h3>
                        <p class="text-gray-700 mb-6">Unduh semua transaksi Anda dalam format CSV.</p>
                        <button id="exportDataBtn" class="w-full btn-primary font-semibold py-3">
                            <i data-feather="download" class="inline-block w-4 h-4 mr-2"></i>
                            Ekspor ke CSV
                        </button>
                    </div>

                    <div class="card p-6 border-2 border-red-200">
                        <h3 class="text-2xl font-bold mb-6 flex items-center text-red-600">
                            <i data-feather="trash-2" class="w-6 h-6 mr-3"></i>
                            Zona Bahaya
                        </h3>
                        <p class="text-gray-700 mb-6">Menghapus akun Anda akan menghapus semua data Anda secara permanen. Tindakan ini tidak dapat dibatalkan.</p>
                        <button id="deleteAccountBtn" class="w-full btn-danger font-semibold py-3">
                            <i data-feather="user-x" class="inline-block w-4 h-4 mr-2"></i>
                            Hapus Akun Saya
                        </button>
                    </div>
                </div>
            </section>

            <section id="helpSection" class="hidden">
                <div class="section-header">
                    <h2 class="section-title">Bantuan</h2>
                    <p class="section-subtitle">Dapatkan bantuan dan dukungan</p>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-6 flex items-center">
                        <i data-feather="message-square" class="w-6 h-6 mr-3 text-purple-600"></i>
                        Asisten Bantuan
                    </h3>
                    <div id="chatDisplay" class="bg-gray-50 rounded-2xl p-6 mb-6 min-h-[400px] max-h-[500px] overflow-y-auto">
                        <div class="chat-message bot bg-white rounded-2xl p-4 mb-4 shadow-sm">
                            Halo! Saya asisten bantuan Anda. Bagaimana saya bisa membantu?
                        </div>
                    </div>
                    <div id="chatOptions" class="flex flex-wrap gap-2">
                        <!-- Chat options will be dynamically generated here -->
                    </div>
                </div>
            </section>
        </main>

        <footer class="bg-gradient-to-r from-gray-800 to-gray-900 text-white text-center p-6 text-sm mt-auto">
            <div class="flex items-center justify-center mb-2">
                <i data-feather="heart" class="w-4 h-4 mr-2 text-red-400"></i>
                <span>&copy; 2025 by Adi Sudrajat. All rights reserved.</span>
            </div>
            <p class="text-gray-400">Dibuat dengan  untuk mengelola keuangan Anda</p>
        </footer>
    </div>

    <!-- Floating Action Button for Mobile -->
    <button class="fab md:hidden" onclick="showSection('transactionsSection')">
        <i data-feather="plus" class="w-6 h-6"></i>
    </button>

    <!-- Modal Components -->
    <div id="confirmationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideConfirmationModal()">
                <i data-feather="x" class="w-5 h-5"></i>
            </button>
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-feather="alert-triangle" class="w-8 h-8 text-red-600"></i>
                </div>
                <h3 class="text-xl font-bold mb-2" id="confirmationModalTitle">Konfirmasi</h3>
                <p id="confirmationModalMessage" class="text-gray-600">Apakah Anda yakin?</p>
            </div>
            <div class="flex gap-4">
                <button id="confirmNoBtn" class="flex-1 btn-secondary py-3">Tidak</button>
                <button id="confirmYesBtn" class="flex-1 btn-danger py-3">Ya</button>
            </div>
        </div>
    </div>

    <div id="editTransactionModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideEditTransactionModal()">
                <i data-feather="x" class="w-5 h-5"></i>
            </button>
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-feather="edit" class="w-8 h-8 text-purple-600"></i>
                </div>
                <h3 class="text-xl font-bold">Edit Transaksi</h3>
            </div>
            <form id="editTransactionForm" class="space-y-4">
                <input type="hidden" id="editTransactionId">
                <div>
                    <label for="editTransactionDate" class="block text-sm font-semibold text-gray-700 mb-2">Tanggal</label>
                    <input type="date" id="editTransactionDate" required class="block">
                </div>
                <div>
                    <label for="editTransactionDescription" class="block text-sm font-semibold text-gray-700 mb-2">Deskripsi</label>
                    <input type="text" id="editTransactionDescription" required class="block">
                </div>
                <div>
                    <label for="editTransactionAmount" class="block text-sm font-semibold text-gray-700 mb-2">Jumlah (Rp)</label>
                    <input type="number" id="editTransactionAmount" required min="1" class="block">
                </div>
                <div>
                    <label for="editTransactionType" class="block text-sm font-semibold text-gray-700 mb-2">Tipe</label>
                    <select id="editTransactionType" required class="block">
                        <option value="income">Pemasukan</option>
                        <option value="expense">Pengeluaran</option>
                    </select>
                </div>
                <div>
                    <label for="editTransactionCategory" class="block text-sm font-semibold text-gray-700 mb-2">Kategori</label>
                    <select id="editTransactionCategory" required class="block"></select>
                </div>
                <button type="submit" class="w-full btn-primary font-semibold py-3">
                    <i data-feather="save" class="inline-block w-4 h-4 mr-2"></i>
                    Simpan Perubahan
                </button>
            </form>
        </div>
    </div>

    <div id="jsonDisplayModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 90%; width: 700px;">
            <button class="modal-close-btn" onclick="hideJsonDisplayModal()">
                <i data-feather="x" class="w-5 h-5"></i>
            </button>
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-feather="code" class="w-8 h-8 text-blue-600"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">Ekspor Data JSON</h3>
                <p class="text-gray-600">Salin teks di bawah ini dan simpan sebagai file .json</p>
            </div>
            <textarea id="jsonOutput" readonly class="w-full h-80 bg-gray-50 border-2 border-gray-200 rounded-2xl p-4 font-mono text-sm resize-none"></textarea>
            <button id="copyJsonBtn" class="w-full btn-primary font-semibold mt-4 py-3">
                <i data-feather="copy" class="inline-block w-4 h-4 mr-2"></i>
                Salin ke Clipboard
            </button>
        </div>
    </div>

    <div id="forgotPasswordModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideForgotPasswordModal()">
                <i data-feather="x" class="w-5 h-5"></i>
            </button>
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-feather="key" class="w-8 h-8 text-yellow-600"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">Lupa Kata Sandi</h3>
                <p class="text-gray-600">Masukkan email Anda untuk reset password</p>
            </div>
            <form id="forgotPasswordForm" class="space-y-4">
                <div>
                    <label for="forgotPasswordEmail" class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                    <input type="email" id="forgotPasswordEmail" placeholder="Masukkan email Anda" required class="block">
                </div>
                <p id="forgotPasswordMessage" class="text-red-500 text-sm hidden"></p>
                <button type="submit" class="w-full btn-primary font-semibold py-3">
                    <i data-feather="send" class="inline-block w-4 h-4 mr-2"></i>
                    Kirim Link Reset
                </button>
            </form>
        </div>
    </div>

    <div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updatePassword,
            deleteUser as deleteFirebaseAuthUser,
            reauthenticateWithCredential,
            EmailAuthProvider,
            sendPasswordResetEmail,
            sendEmailVerification
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            addDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            getDocs,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDvf_Rg89uX9ODamiUjTCZ-ZTIYA2C7a7w",
            authDomain: "keuanganadi.firebaseapp.com",
            projectId: "keuanganadi",
            storageBucket: "keuanganadi.firebasestorage.app",
            messagingSenderId: "829317955644",
            appId: "1:829317955644:web:ecd350db338c02ab0fc339",
            measurementId: "G-WDNBRP6DB5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const menuBtn = document.getElementById('menuBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const authSection = document.getElementById('authSection');
        const authTitle = document.getElementById('authTitle');
        const authForm = document.getElementById('authForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const authSubmitBtn = document.getElementById('authSubmitBtn');
        const authMessage = document.getElementById('authMessage');
        const toggleAuthModeBtn = document.getElementById('toggleAuthMode');
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');

        const dashboardSection = document.getElementById('dashboardSection');
        const dashboardUsernameEl = document.getElementById('dashboardUsername');
        const currentBalanceEl = document.getElementById('currentBalance');
        const totalIncomeEl = document.getElementById('totalIncome');
        const totalExpenseEl = document.getElementById('totalExpense');
        const latestTransactionsEl = document.getElementById('latestTransactions');
        const incomeExpenseChart = document.getElementById('incomeExpenseChart');
        const expenseByCategorySummary = document.getElementById('expenseByCategorySummary');

        const transactionsSection = document.getElementById('transactionsSection');
        const transactionForm = document.getElementById('transactionForm');
        const transactionDateInput = document.getElementById('transactionDate');
        const transactionDescriptionInput = document.getElementById('transactionDescription');
        const transactionAmountInput = document.getElementById('transactionAmount');
        const transactionTypeInput = document.getElementById('transactionType');
        const transactionCategoryInput = document.getElementById('transactionCategory');
        const allTransactionsListEl = document.getElementById('allTransactionsList');
        const transactionSearchInput = document.getElementById('transactionSearchInput');
        const filterTypeSelect = document.getElementById('filterType');
        const filterStartDate = document.getElementById('filterStartDate');
        const filterEndDate = document.getElementById('filterEndDate');
        const sortBySelect = document.getElementById('sortBy');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const pageInfo = document.getElementById('pageInfo');

        // Budgeting Section Elements
        const budgetingSidebarItem = document.getElementById('budgetingSidebarItem');
        const budgetingSection = document.getElementById('budgetingSection');
        const budgetForm = document.getElementById('budgetForm');
        const budgetItemCategorySelect = document.getElementById('budgetItemCategory');
        const budgetAmountInput = document.getElementById('budgetAmount');
        const budgetStartDateInput = document.getElementById('budgetStartDate');
        const budgetEndDateInput = document.getElementById('budgetEndDate');
        const budgetListEl = document.getElementById('budgetList');
        const budgetMessageEl = document.getElementById('budgetMessage');

        const reportsSection = document.getElementById('reportsSection');
        const reportMonthSelect = document.getElementById('reportMonthSelect');
        const reportYearSelect = document.getElementById('reportYearSelect');
        const reportTotalIncomeEl = document.getElementById('reportTotalIncome');
        const reportTotalExpenseEl = document.getElementById('reportTotalExpense');
        const reportNetBalanceEl = document.getElementById('reportNetBalance');
        const reportExpenseByCategory = document.getElementById('reportExpenseByCategory');
        const reportIncomeByCategory = document.getElementById('reportIncomeByCategory');
        const reportTransactionsListEl = document.getElementById('reportTransactionsList');
        const generatePdfReportBtn = document.getElementById('generatePdfReportBtn');

        // Chart.js canvas elements
        const monthlySummaryChartCanvas = document.getElementById('monthlySummaryChart');
        const expenseByCategoryChartCanvas = document.getElementById('expenseByCategoryChart');
        const incomeByCategoryChartCanvas = document.getElementById('incomeByCategoryChart');

        let monthlySummaryChartInstance = null;
        let expenseByCategoryChartInstance = null;
        let incomeByCategoryChartInstance = null;

        // Analysis Section Elements
        const analysisSidebarItem = document.getElementById('analysisSidebarItem');
        const analysisSection = document.getElementById('analysisSection');
        const financialTrendsChartCanvas = document.getElementById('financialTrendsChart');
        const topExpenseCategoriesChartCanvas = document.getElementById('topExpenseCategoriesChart');
        const topIncomeCategoriesChartCanvas = document.getElementById('topIncomeCategoriesChart');
        const topExpenseCategoriesSummary = document.getElementById('topExpenseCategoriesSummary');
        const topIncomeCategoriesSummary = document.getElementById('topIncomeCategoriesSummary');

        let financialTrendsChartInstance = null;
        let topExpenseCategoriesChartInstance = null;
        let topIncomeCategoriesChartInstance = null;

        const settingsSection = document.getElementById('settingsSection');
        const changePasswordForm = document.getElementById('changePasswordForm');
        const currentPasswordInput = document.getElementById('currentPassword');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
        const passwordMessageEl = document.getElementById('passwordMessage');
        const addCategoryForm = document.getElementById('addCategoryForm');
        const newCategoryNameInput = document.getElementById('newCategoryName');
        const categoryListEl = document.getElementById('categoryList');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const deleteAccountBtn = document.getElementById('deleteAccountBtn');
        const darkModeToggle = document.getElementById('darkModeToggle');

        // WhatsApp Send Button
        const sendWhatsappSummaryBtn = document.getElementById('sendWhatsappSummaryBtn');

        // Sidebar items
        const dashboardSidebarItem = document.getElementById('dashboardSidebarItem');
        const transactionsSidebarItem = document.getElementById('transactionsSidebarItem');
        const reportsSidebarItem = document.getElementById('reportsSidebarItem');
        const settingsSidebarItem = document.getElementById('settingsSidebarItem');
        const helpSidebarItem = document.getElementById('helpSidebarItem');

        const sidebarItems = document.querySelectorAll('.sidebar-item');

        // Modal Elements
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationModalTitle = document.getElementById('confirmationModalTitle');
        const confirmationModalMessage = document.getElementById('confirmationModalMessage');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmNoBtn = document.getElementById('confirmNoBtn');

        const editTransactionModal = document.getElementById('editTransactionModal');
        const editTransactionForm = document.getElementById('editTransactionForm');
        const editTransactionIdInput = document.getElementById('editTransactionId');
        const editTransactionDateInput = document.getElementById('editTransactionDate');
        const editTransactionDescriptionInput = document.getElementById('editTransactionDescription');
        const editTransactionAmountInput = document.getElementById('editTransactionAmount');
        const editTransactionTypeInput = document.getElementById('editTransactionType');
        const editTransactionCategoryInput = document.getElementById('editTransactionCategory');

        // JSON Display Modal Elements
        const jsonDisplayModal = document.getElementById('jsonDisplayModal');
        const jsonOutput = document.getElementById('jsonOutput');
        const copyJsonBtn = document.getElementById('copyJsonBtn');

        // Forgot Password Modal Elements
        const forgotPasswordModal = document.getElementById('forgotPasswordModal');
        const forgotPasswordEmailInput = document.getElementById('forgotPasswordEmail');
        const forgotPasswordMessageEl = document.getElementById('forgotPasswordMessage');
        const forgotPasswordForm = document.getElementById('forgotPasswordForm');

        // Notification Container
        const notificationContainer = document.getElementById('notificationContainer');

        // Import/Export Buttons
        const exportAllDataBtn = document.getElementById('exportAllDataBtn');
        const importAllDataInput = document.getElementById('importAllDataInput');

        // Chatbot Elements
        const helpSection = document.getElementById('helpSection');
        const chatDisplay = document.getElementById('chatDisplay');
        const chatOptions = document.getElementById('chatOptions');

        // State Variables
        let isLoggedIn = false;
        let currentFirebaseUser = null;
        let authMode = 'login';

        // Pagination variables
        const transactionsPerPage = 10;
        let currentPage = 1;
        let filteredTransactions = [];

        // Firestore listeners
        let unsubscribeTransactions = null;
        let unsubscribeCategories = null;
        let unsubscribeBudgets = null;

        // --- Utility Functions ---

        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function showMessage(element, message, isError = true) {
            element.textContent = message;
            element.classList.remove('hidden');
            element.classList.toggle('text-red-500', isError);
            element.classList.toggle('text-green-500', !isError);
        }

        function showNotification(message, type = 'success', duration = 4000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i data-feather="${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info'}" class="w-5 h-5 mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            notificationContainer.appendChild(notification);

            // Initialize feather icons for the notification
            feather.replace();

            setTimeout(() => {
                notification.remove();
            }, duration);
        }

        // --- Dark Mode Functionality ---
        function enableDarkMode() {
            document.body.classList.add('dark-mode');
            localStorage.setItem('darkMode', 'enabled');
        }

        function disableDarkMode() {
            document.body.classList.remove('dark-mode');
            localStorage.setItem('darkMode', 'disabled');
        }

        function toggleDarkMode() {
            if (document.body.classList.contains('dark-mode')) {
                disableDarkMode();
            } else {
                enableDarkMode();
            }
        }

        // Initialize dark mode
        if (localStorage.getItem('darkMode') === 'enabled') {
            enableDarkMode();
            darkModeToggle.checked = true;
        } else {
            disableDarkMode();
            darkModeToggle.checked = false;
        }

        // --- Authentication Functions ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                if (user.emailVerified) {
                    isLoggedIn = true;
                    currentFirebaseUser = user;
                    showSection('dashboardSection');
                    dashboardUsernameEl.textContent = user.email;
                    sidebarUsername.textContent = user.email;
                    setupFirestoreListeners(user.uid);
                } else {
                    await signOut(auth);
                    isLoggedIn = false;
                    currentFirebaseUser = null;
                    showSection('authSection');
                    unsubscribeAllFirestoreListeners();
                    showMessage(authMessage, 'Email Anda belum diverifikasi. Silakan cek kotak masuk Anda untuk tautan verifikasi.', true);
                    showNotification('Email Anda belum diverifikasi. Silakan cek kotak masuk Anda untuk tautan verifikasi.', 'error', 5000);
                }
            } else {
                isLoggedIn = false;
                currentFirebaseUser = null;
                showSection('authSection');
                unsubscribeAllFirestoreListeners();
            }
            updateUIBasedOnAuth();
        });

        async function handleAuth(event) {
            event.preventDefault();
            authMessage.classList.add('hidden');
            const email = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                showMessage(authMessage, 'Email dan kata sandi tidak boleh kosong.', true);
                showNotification('Email dan kata sandi tidak boleh kosong.', 'error');
                return;
            }

            try {
                if (authMode === 'register') {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await sendEmailVerification(userCredential.user);

                    await setDoc(doc(db, `artifacts/${appId}/users/${userCredential.user.uid}/metadata`, 'categories'), {
                        list: ['Makanan', 'Transportasi', 'Gaji', 'Hiburan', 'Tagihan', 'Lain-lain']
                    });
                    await setDoc(doc(db, `artifacts/${appId}/users/${userCredential.user.uid}/metadata`, 'budgets'), {
                        list: []
                    });

                    showMessage(authMessage, 'Registrasi berhasil! Link verifikasi telah dikirim ke email Anda. Silakan verifikasi email Anda sebelum login.', false);
                    showNotification('Registrasi berhasil! Link verifikasi telah dikirim ke email Anda.', 'success', 5000);
                    
                    authMode = 'login';
                    authTitle.textContent = 'Login';
                    authSubmitBtn.textContent = 'Login';
                    toggleAuthModeBtn.textContent = 'Daftar di sini';
                    usernameInput.value = '';
                    passwordInput.value = '';

                } else {
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    if (!userCredential.user.emailVerified) {
                        await signOut(auth);
                        showMessage(authMessage, 'Email Anda belum diverifikasi. Silakan cek kotak masuk Anda untuk tautan verifikasi.', true);
                        showNotification('Email Anda belum diverifikasi.', 'error', 5000);
                        return;
                    }
                    showMessage(authMessage, 'Login berhasil!', false);
                    showNotification('Selamat datang kembali!', 'success');
                }
            } catch (error) {
                console.error("Authentication error:", error);
                let errorMessage = 'Terjadi kesalahan otentikasi.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Email sudah terdaftar. Silakan gunakan email lain atau login.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Format email tidak valid.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Kata sandi terlalu lemah (minimal 6 karakter).';
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = 'Email atau kata sandi salah.';
                }
                showMessage(authMessage, errorMessage, true);
                showNotification(errorMessage, 'error');
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                showNotification('Anda telah logout.', 'success');
            } catch (error) {
                console.error("Logout error:", error);
                showNotification('Gagal logout. Silakan coba lagi.', 'error');
            }
            usernameInput.value = '';
            passwordInput.value = '';
        }

        function updateUIBasedOnAuth() {
            if (isLoggedIn) {
                authSection.classList.add('hidden');
                sidebar.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                
                if (window.innerWidth < 768) {
                    sidebar.classList.remove('open');
                } else {
                    sidebar.classList.add('open');
                }

                dashboardSidebarItem.classList.remove('hidden');
                transactionsSidebarItem.classList.remove('hidden');
                budgetingSidebarItem.classList.remove('hidden');
                reportsSidebarItem.classList.remove('hidden');
                analysisSidebarItem.classList.remove('hidden');
                settingsSidebarItem.classList.remove('hidden');
                helpSidebarItem.classList.remove('hidden');
            } else {
                authSection.classList.remove('hidden');
                sidebar.classList.add('hidden');
                logoutBtn.classList.add('hidden');
                
                dashboardSidebarItem.classList.add('hidden');
                transactionsSidebarItem.classList.add('hidden');
                budgetingSidebarItem.classList.add('hidden');
                reportsSidebarItem.classList.add('hidden');
                analysisSidebarItem.classList.add('hidden');
                settingsSidebarItem.classList.add('hidden');
                helpSidebarItem.classList.add('hidden');

                document.querySelectorAll('main > section:not(#authSection)').forEach(section => {
                    section.classList.add('hidden');
                });
                sidebarUsername.textContent = '';
            }
        }

        // --- Firestore Data Management ---

        function setupFirestoreListeners(uid) {
            console.log("Setting up Firestore listeners for UID:", uid);
            unsubscribeAllFirestoreListeners();

            const transactionsRef = collection(db, `artifacts/${appId}/users/${uid}/transactions`);
            unsubscribeTransactions = onSnapshot(transactionsRef, (snapshot) => {
                const transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Firestore Transactions updated:", transactions);
                window._userTransactions = transactions;
                renderDashboard();
                renderTransactions();
                renderReports();
                renderAnalysis();
                renderBudgets();
            }, (error) => {
                console.error("Error fetching transactions:", error);
                showNotification('Gagal memuat transaksi. Silakan coba lagi.', 'error');
            });

            const categoriesDocRef = doc(db, `artifacts/${appId}/users/${uid}/metadata`, 'categories');
            unsubscribeCategories = onSnapshot(categoriesDocRef, (docSnap) => {
                const categories = docSnap.exists() ? docSnap.data().list : ['Makanan', 'Transportasi', 'Gaji', 'Hiburan', 'Tagihan', 'Lain-lain'];
                console.log("Firestore Categories updated:", categories);
                window._userCategories = categories;
                renderCategoryOptions(transactionCategoryInput);
                renderCategoryOptions(editTransactionCategoryInput);
                renderCategoryOptions(budgetItemCategorySelect);
                renderManageCategories();
            }, (error) => {
                console.error("Error fetching categories:", error);
                showNotification('Gagal memuat kategori. Silakan coba lagi.', 'error');
            });

            const budgetsDocRef = doc(db, `artifacts/${appId}/users/${uid}/metadata`, 'budgets');
            unsubscribeBudgets = onSnapshot(budgetsDocRef, (docSnap) => {
                const budgets = docSnap.exists() ? docSnap.data().list : [];
                console.log("Firestore Budgets updated:", budgets);
                window._userBudgets = budgets;
                renderBudgets();
            }, (error) => {
                console.error("Error fetching budgets:", error);
                showNotification('Gagal memuat anggaran. Silakan coba lagi.', 'error');
            });
        }

        function unsubscribeAllFirestoreListeners() {
            if (unsubscribeTransactions) unsubscribeTransactions();
            if (unsubscribeCategories) unsubscribeCategories();
            if (unsubscribeBudgets) unsubscribeBudgets();
            window._userTransactions = [];
            window._userCategories = [];
            window._userBudgets = [];
            console.log("All Firestore listeners unsubscribed.");
        }

        function getCurrentUserId() {
            return currentFirebaseUser ? currentFirebaseUser.uid : null;
        }

        function getUserTransactions() {
            return window._userTransactions || [];
        }

        async function addTransactionToFirestore(transaction) {
            const userId = getCurrentUserId();
            if (!userId) {
                showNotification('Anda harus login untuk menambahkan transaksi.', 'error');
                return;
            }
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/transactions`), transaction);
                console.log("Transaction added to Firestore:", transaction);
            } catch (error) {
                console.error("Error adding transaction:", error);
                showNotification('Gagal menambahkan transaksi. Silakan coba lagi.', 'error');
            }
        }

        async function updateTransactionInFirestore(id, updatedTransaction) {
            const userId = getCurrentUserId();
            if (!userId) {
                showNotification('Anda harus login untuk memperbarui transaksi.', 'error');
                return;
            }
            try {
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/transactions`, id), updatedTransaction);
                console.log("Transaction updated in Firestore:", id, updatedTransaction);
            } catch (error) {
                console.error("Error updating transaction:", error);
                showNotification('Gagal memperbarui transaksi. Silakan coba lagi.', 'error');
            }
        }

        async function deleteTransactionFromFirestore(id) {
            const userId = getCurrentUserId();
            if (!userId) {
                showNotification('Anda harus login untuk menghapus transaksi.', 'error');
                return;
            }
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/transactions`, id));
                console.log("Transaction deleted from Firestore:", id);
            } catch (error) {
                console.error("Error deleting transaction:", error);
                showNotification('Gagal menghapus transaksi. Silakan coba lagi.', 'error');
            }
        }

        function getUserCategories() {
            return window._userCategories || [];
        }

        async function saveUserCategoriesToFirestore(categories) {
            const userId = getCurrentUserId();
            if (!userId) {
                showNotification('Anda harus login untuk menyimpan kategori.', 'error');
                return;
            }
            try {
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'categories'), { list: categories });
                console.log("Categories saved to Firestore:", categories);
            } catch (error) {
                console.error("Error saving categories:", error);
                showNotification('Gagal menyimpan kategori. Silakan coba lagi.', 'error');
            }
        }

        function getUserBudgets() {
            return window._userBudgets || [];
        }

        async function saveUserBudgetsToFirestore(budgets) {
            const userId = getCurrentUserId();
            if (!userId) {
                showNotification('Anda harus login untuk menyimpan anggaran.', 'error');
                return;
            }
            try {
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'budgets'), { list: budgets });
                console.log("Budgets saved to Firestore:", budgets);
            } catch (error) {
                console.error("Error saving budgets:", error);
                showNotification('Gagal menyimpan anggaran. Silakan coba lagi.', 'error');
            }
        }

        // --- Section Management ---

        function showSection(sectionId) {
            document.querySelectorAll('main > section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            sidebarItems.forEach(item => {
                item.classList.remove('active');
                if (item.dataset.section + 'Section' === sectionId) {
                    item.classList.add('active');
                }
            });

            if (window.innerWidth < 768) {
                sidebar.classList.remove('open');
            }

            if (sectionId === 'dashboardSection') {
                renderDashboard();
            } else if (sectionId === 'transactionsSection') {
                renderCategoryOptions(transactionCategoryInput);
                currentPage = 1;
                renderTransactions();
            } else if (sectionId === 'budgetingSection') {
                renderCategoryOptions(budgetItemCategorySelect);
                renderBudgets();
            } else if (sectionId === 'reportsSection') {
                populateReportYears();
                renderReports();
            } else if (sectionId === 'analysisSection') {
                renderAnalysis();
            } else if (sectionId === 'settingsSection') {
                renderManageCategories();
            } else if (sectionId === 'helpSection') {
                startChatbot();
            }
        }

        // --- Transaction Management ---

        async function addTransaction(event) {
            event.preventDefault();
            const date = transactionDateInput.value;
            const description = transactionDescriptionInput.value.trim();
            const amount = parseFloat(transactionAmountInput.value);
            const type = transactionTypeInput.value;
            const category = transactionCategoryInput.value;

            if (!date || !description || isNaN(amount) || amount <= 0 || !category) {
                showMessage(authMessage, 'Semua field harus diisi dengan benar.');
                showNotification('Semua field harus diisi dengan benar.', 'error');
                return;
            }

            if (type === 'expense') {
                const budgets = getUserBudgets();
                const activeBudgets = budgets.filter(b => {
                    const budgetStart = new Date(b.startDate);
                    const budgetEnd = new Date(b.endDate);
                    const transactionDate = new Date(date);
                    return b.category === category && transactionDate >= budgetStart && transactionDate <= budgetEnd;
                });

                if (activeBudgets.length > 0) {
                    const currentExpensesForCategory = getUserTransactions().filter(t =>
                        t.type === 'expense' &&
                        t.category === category &&
                        new Date(t.date) >= new Date(activeBudgets[0].startDate) &&
                        new Date(t.date) <= new Date(activeBudgets[0].endDate)
                    ).reduce((sum, t) => sum + t.amount, 0);

                    const budgetLimit = activeBudgets[0].amount;
                    const remainingBudget = budgetLimit - currentExpensesForCategory;

                    if (amount > remainingBudget) {
                        const confirm = await new Promise(resolve => {
                            showConfirmationModal(`Transaksi ini (${formatRupiah(amount)}) akan melebihi anggaran Anda untuk kategori '${category}' (Sisa anggaran: ${formatRupiah(remainingBudget)}). Lanjutkan?`, () => resolve(true), () => resolve(false));
                        });
                        if (!confirm) {
                            showNotification('Transaksi dibatalkan karena melebihi anggaran.', 'info');
                            return;
                        }
                    }
                }
            }

            const newTransaction = {
                date: date,
                description: description,
                amount: amount,
                type: type,
                category: category
            };

            await addTransactionToFirestore(newTransaction);

            showMessage(authMessage, 'Transaksi berhasil ditambahkan!', false);
            showNotification('Transaksi berhasil ditambahkan!', 'success');
            transactionForm.reset();
            const today = new Date().toISOString().split('T')[0];
            transactionDateInput.value = today;
        }

        async function deleteTransaction(id) {
            confirmAction('Apakah Anda yakin ingin menghapus transaksi ini?', async () => {
                await deleteTransactionFromFirestore(id);
                showMessage(authMessage, 'Transaksi berhasil dihapus!', false);
                showNotification('Transaksi berhasil dihapus!', 'success');
            });
        }

        async function editTransaction(id) {
            const transactions = getUserTransactions();
            const transactionToEdit = transactions.find(t => t.id === id);

            if (transactionToEdit) {
                editTransactionIdInput.value = transactionToEdit.id;
                editTransactionDateInput.value = transactionToEdit.date;
                editTransactionDescriptionInput.value = transactionToEdit.description;
                editTransactionAmountInput.value = transactionToEdit.amount;
                editTransactionTypeInput.value = transactionToEdit.type;
                renderCategoryOptions(editTransactionCategoryInput);
                editTransactionCategoryInput.value = transactionToEdit.category;

                showEditTransactionModal();
            }
        }

        async function updateTransaction(event) {
            event.preventDefault();
            const id = editTransactionIdInput.value;
            const date = editTransactionDateInput.value;
            const description = editTransactionDescriptionInput.value.trim();
            const amount = parseFloat(editTransactionAmountInput.value);
            const type = editTransactionTypeInput.value;
            const category = editTransactionCategoryInput.value;

            if (!date || !description || isNaN(amount) || amount <= 0 || !category) {
                showMessage(authMessage, 'Semua field harus diisi dengan benar.');
                showNotification('Semua field harus diisi dengan benar.', 'error');
                return;
            }

            const updatedTransaction = { date, description, amount, type, category };

            await updateTransactionInFirestore(id, updatedTransaction);

            showMessage(authMessage, 'Transaksi berhasil diperbarui!', false);
            showNotification('Transaksi berhasil diperbarui!', 'success');
            hideEditTransactionModal();
        }

        // --- Category Management ---

        function renderCategoryOptions(selectElement) {
            const categories = getUserCategories();
            selectElement.innerHTML = '';
            if (categories.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Tidak ada kategori';
                selectElement.appendChild(option);
                selectElement.disabled = true;
                return;
            }
            selectElement.disabled = false;
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                selectElement.appendChild(option);
            });
        }

        async function addCategory(event) {
            event.preventDefault();
            const newCategory = newCategoryNameInput.value.trim();
            if (!newCategory) {
                showMessage(passwordMessageEl, 'Nama kategori tidak boleh kosong.', true);
                showNotification('Nama kategori tidak boleh kosong.', 'error');
                return;
            }

            let categories = getUserCategories();
            if (categories.includes(newCategory)) {
                showMessage(passwordMessageEl, 'Kategori ini sudah ada.', true);
                showNotification('Kategori ini sudah ada.', 'error');
                return;
            }

            categories.push(newCategory);
            await saveUserCategoriesToFirestore(categories);
            showMessage(passwordMessageEl, 'Kategori berhasil ditambahkan!', false);
            showNotification('Kategori berhasil ditambahkan!', 'success');
            newCategoryNameInput.value = '';
        }

        async function deleteCategory(categoryToDelete) {
            confirmAction(`Apakah Anda yakin ingin menghapus kategori "${categoryToDelete}"? Transaksi dan anggaran yang terkait tidak akan terhapus, tetapi kategorinya akan dialihkan ke 'Lain-lain'.`, async () => {
                let categories = getUserCategories();
                categories = categories.filter(cat => cat !== categoryToDelete);

                let transactions = getUserTransactions();
                const transactionUpdates = transactions.filter(t => t.category === categoryToDelete).map(t => {
                    const updatedT = { ...t, category: 'Lain-lain' };
                    return updateTransactionInFirestore(t.id, updatedT);
                });
                await Promise.all(transactionUpdates);

                let budgets = getUserBudgets();
                budgets.forEach(b => {
                    if (b.category === categoryToDelete) {
                        b.category = 'Lain-lain';
                    }
                });
                await saveUserBudgetsToFirestore(budgets);

                await saveUserCategoriesToFirestore(categories);

                showMessage(passwordMessageEl, 'Kategori berhasil dihapus!', false);
                showNotification('Kategori berhasil dihapus!', 'success');
            });
        }

        function renderManageCategories() {
            const categories = getUserCategories();
            categoryListEl.innerHTML = '';
            if (categories.length === 0) {
                categoryListEl.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada kategori.</p>';
            } else {
                categories.forEach(cat => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'flex items-center justify-between p-4 rounded-2xl bg-gray-50 border border-gray-200 hover:bg-gray-100 transition-all duration-300';
                    categoryDiv.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center mr-3">
                                <i data-feather="tag" class="w-5 h-5 text-purple-600"></i>
                            </div>
                            <span class="font-medium">${cat}</span>
                        </div>
                        <button class="btn-danger text-xs px-3 py-2" onclick="deleteCategory('${cat}')">
                            <i data-feather="trash-2" class="inline-block w-3 h-3 mr-1"></i>
                            Hapus
                        </button>
                    `;
                    categoryListEl.appendChild(categoryDiv);
                });
                feather.replace();
            }
        }

        // --- Budgeting Functions ---

        async function addBudget(event) {
            event.preventDefault();
            const category = budgetItemCategorySelect.value;
            const amount = parseFloat(budgetAmountInput.value);
            const startDate = budgetStartDateInput.value;
            const endDate = budgetEndDateInput.value;

            if (!category || isNaN(amount) || amount <= 0 || !startDate || !endDate) {
                showMessage(budgetMessageEl, 'Semua field harus diisi dengan benar.', true);
                showNotification('Semua field harus diisi dengan benar.', 'error');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showMessage(budgetMessageEl, 'Tanggal mulai tidak boleh lebih lambat dari tanggal akhir.', true);
                showNotification('Tanggal mulai tidak boleh lebih lambat dari tanggal akhir.', 'error');
                return;
            }

            let budgets = getUserBudgets();

            const overlappingBudget = budgets.find(b =>
                b.category === category &&
                ((new Date(startDate) <= new Date(b.endDate) && new Date(endDate) >= new Date(b.startDate)))
            );

            if (overlappingBudget) {
                showMessage(budgetMessageEl, `Sudah ada anggaran untuk kategori '${category}' yang tumpang tindih dengan periode ini.`, true);
                showNotification(`Anggaran untuk '${category}' tumpang tindih.`, 'error');
                return;
            }

            const newBudget = {
                id: Date.now(),
                category,
                amount,
                startDate,
                endDate
            };

            budgets.push(newBudget);
            await saveUserBudgetsToFirestore(budgets);
            showMessage(budgetMessageEl, 'Anggaran berhasil ditambahkan!', false);
            showNotification('Anggaran berhasil ditambahkan!', 'success');
            budgetForm.reset();
        }

        async function deleteBudget(id) {
            confirmAction('Apakah Anda yakin ingin menghapus anggaran ini?', async () => {
                let budgets = getUserBudgets();
                budgets = budgets.filter(b => b.id !== id);
                await saveUserBudgetsToFirestore(budgets);
                showNotification('Anggaran berhasil dihapus!', 'success');
            });
        }

        function renderBudgets() {
            const budgets = getUserBudgets();
            const transactions = getUserTransactions();
            budgetListEl.innerHTML = '';

            if (budgets.length === 0) {
                budgetListEl.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada anggaran yang ditetapkan.</p>';
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            budgets.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

            budgets.forEach(budget => {
                const budgetStart = new Date(budget.startDate);
                const budgetEnd = new Date(budget.endDate);
                budgetEnd.setHours(23, 59, 59, 999);

                const expensesForBudget = transactions.filter(t =>
                    t.type === 'expense' &&
                    t.category === budget.category &&
                    new Date(t.date) >= budgetStart &&
                    new Date(t.date) <= budgetEnd
                ).reduce((sum, t) => sum + t.amount, 0);

                const remainingAmount = budget.amount - expensesForBudget;
                const percentageUsed = (expensesForBudget / budget.amount) * 100;

                let statusText = '';
                let statusColor = 'text-gray-600';
                let progressClass = '';
                let cardClass = 'card';

                if (today > budgetEnd) {
                    statusText = 'Berakhir';
                    statusColor = 'text-gray-500';
                    progressClass = 'bg-gray-400';
                } else if (today < budgetStart) {
                    statusText = 'Mendatang';
                    statusColor = 'text-blue-500';
                    progressClass = 'bg-blue-400';
                } else if (remainingAmount <= 0) {
                    statusText = 'Anggaran Habis!';
                    statusColor = 'text-red-500 font-bold';
                    progressClass = 'danger';
                    cardClass = 'card border-2 border-red-200';
                } else if (percentageUsed >= 75) {
                    statusText = 'Hampir Habis!';
                    statusColor = 'text-orange-500 font-bold';
                    progressClass = 'warning';
                    cardClass = 'card border-2 border-orange-200';
                } else {
                    statusText = 'Aktif';
                    statusColor = 'text-green-500';
                    progressClass = '';
                }

                const budgetDiv = document.createElement('div');
                budgetDiv.className = cardClass + ' p-6 relative overflow-hidden';
                budgetDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-purple-100 rounded-2xl flex items-center justify-center mr-4">
                                <i data-feather="target" class="w-6 h-6 text-purple-600"></i>
                            </div>
                            <div>
                                <h4 class="text-xl font-bold">${budget.category}</h4>
                                <p class="text-sm text-gray-600">${budget.startDate} s/d ${budget.endDate}</p>
                            </div>
                        </div>
                        <button class="btn-danger text-xs px-3 py-2" onclick="deleteBudget(${budget.id})">
                            <i data-feather="trash-2" class="inline-block w-3 h-3 mr-1"></i>
                            Hapus
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="text-center p-3 bg-gray-50 rounded-xl">
                            <p class="text-sm text-gray-600 mb-1">Anggaran</p>
                            <p class="text-lg font-bold">${formatRupiah(budget.amount)}</p>
                        </div>
                        <div class="text-center p-3 bg-gray-50 rounded-xl">
                            <p class="text-sm text-gray-600 mb-1">Terpakai</p>
                            <p class="text-lg font-bold text-red-500">${formatRupiah(expensesForBudget)}</p>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium">Sisa: <span class="${remainingAmount <= 0 ? 'text-red-500' : 'text-green-500'}">${formatRupiah(remainingAmount)}</span></span>
                            <span class="text-sm ${statusColor}">${statusText}</span>
                        </div>
                        <div class="budget-progress">
                            <div class="budget-progress-fill ${progressClass}" style="width: ${Math.min(100, percentageUsed)}%;"></div>
                        </div>
                        <p class="text-xs text-gray-500 text-right mt-1">${percentageUsed.toFixed(1)}% Terpakai</p>
                    </div>
                `;
                budgetListEl.appendChild(budgetDiv);
            });
            feather.replace();
        }

        // --- Password Change ---

        async function handleChangePassword(event) {
            event.preventDefault();
            const currentPass = currentPasswordInput.value;
            const newPass = newPasswordInput.value;
            const confirmNewPass = confirmNewPasswordInput.value;

            if (!currentFirebaseUser) {
                showMessage(passwordMessageEl, 'Anda harus login untuk mengubah kata sandi.', true);
                showNotification('Anda harus login untuk mengubah kata sandi.', 'error');
                return;
            }

            if (!currentPass || !newPass || !confirmNewPass) {
                showMessage(passwordMessageEl, 'Semua field harus diisi.', true);
                showNotification('Semua field harus diisi.', 'error');
                return;
            }

            if (newPass !== confirmNewPass) {
                showMessage(passwordMessageEl, 'Kata sandi baru tidak cocok dengan konfirmasi.', true);
                showNotification('Kata sandi baru tidak cocok dengan konfirmasi.', 'error');
                return;
            }

            if (newPass.length < 6) {
                showMessage(passwordMessageEl, 'Kata sandi baru minimal 6 karakter.', true);
                showNotification('Kata sandi baru minimal 6 karakter.', 'error');
                return;
            }

            try {
                const credential = EmailAuthProvider.credential(currentFirebaseUser.email, currentPass);
                await reauthenticateWithCredential(currentFirebaseUser, credential);
                await updatePassword(currentFirebaseUser, newPass);
                showMessage(passwordMessageEl, 'Kata sandi berhasil diubah!', false);
                showNotification('Kata sandi berhasil diubah!', 'success');
                changePasswordForm.reset();
            } catch (error) {
                console.error("Error changing password:", error);
                let errorMessage = 'Gagal mengubah kata sandi.';
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Kata sandi saat ini salah.';
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'Untuk alasan keamanan, silakan login ulang dan coba lagi.';
                } else if (error.code === 'auth/invalid-credential') {
                    errorMessage = 'Kredensial saat ini tidak valid. Silakan login ulang.';
                }
                showMessage(passwordMessageEl, errorMessage, true);
                showNotification(errorMessage, 'error');
            }
        }

        // --- Local Data Import/Export ---

        async function exportAllData() {
            if (!currentFirebaseUser) {
                showNotification('Anda harus login untuk mengekspor data.', 'error');
                return;
            }

            const userId = currentFirebaseUser.uid;
            try {
                const transactionsSnapshot = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/transactions`));
                const transactions = transactionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const categoriesDoc = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'categories'));
                const categories = categoriesDoc.exists() ? categoriesDoc.data().list : [];

                const budgetsDoc = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'budgets'));
                const budgets = budgetsDoc.exists() ? budgetsDoc.data().list : [];

                const allData = {
                    transactions,
                    categories,
                    budgets,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };

                jsonOutput.value = JSON.stringify(allData, null, 2);
                showJsonDisplayModal();
            } catch (error) {
                console.error("Error exporting data:", error);
                showNotification('Gagal mengekspor data. Silakan coba lagi.', 'error');
            }
        }

        async function importAllData(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!currentFirebaseUser) {
                showNotification('Anda harus login untuk mengimpor data.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);

                    if (!importedData.transactions || !Array.isArray(importedData.transactions)) {
                        showNotification('Format file tidak valid. Pastikan file berisi data transaksi yang benar.', 'error');
                        return;
                    }

                    const confirm = await new Promise(resolve => {
                        showConfirmationModal('Impor data akan mengganti semua data yang ada. Apakah Anda yakin?', () => resolve(true), () => resolve(false));
                    });

                    if (!confirm) {
                        showNotification('Impor data dibatalkan.', 'info');
                        return;
                    }

                    const userId = currentFirebaseUser.uid;
                    const batch = writeBatch(db);

                    const existingTransactionsSnapshot = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/transactions`));
                    existingTransactionsSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    importedData.transactions.forEach(transaction => {
                        const { id, ...transactionData } = transaction;
                        const newDocRef = doc(collection(db, `artifacts/${appId}/users/${userId}/transactions`));
                        batch.set(newDocRef, transactionData);
                    });

                    if (importedData.categories && Array.isArray(importedData.categories)) {
                        const categoriesRef = doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'categories');
                        batch.set(categoriesRef, { list: importedData.categories });
                    }

                    if (importedData.budgets && Array.isArray(importedData.budgets)) {
                        const budgetsRef = doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'budgets');
                        batch.set(budgetsRef, { list: importedData.budgets });
                    }

                    await batch.commit();

                    showNotification('Data berhasil diimpor!', 'success');
                } catch (error) {
                    console.error("Error importing data:", error);
                    showNotification('Gagal mengimpor data. Pastikan format file benar.', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // --- CSV Export ---

        function exportToCSV() {
            const transactions = getUserTransactions();
            if (transactions.length === 0) {
                showNotification('Tidak ada transaksi untuk diekspor.', 'error');
                return;
            }

            const csvHeaders = ['Tanggal', 'Deskripsi', 'Jumlah', 'Tipe', 'Kategori'];
            const csvRows = transactions.map(t => [
                t.date,
                `"${t.description}"`,
                t.amount,
                t.type === 'income' ? 'Pemasukan' : 'Pengeluaran',
                t.category
            ]);

            const csvContent = [csvHeaders, ...csvRows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `transaksi_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('Data berhasil diekspor ke CSV!', 'success');
        }

        // --- WhatsApp Integration ---

        function sendWhatsappSummary() {
            const transactions = getUserTransactions();
            if (transactions.length === 0) {
                showNotification('Tidak ada transaksi untuk dikirim.', 'error');
                return;
            }

            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = totalIncome - totalExpense;

            let message = `*Ringkasan Keuangan AdiWallet*\n\n`;
            message += ` Total Pemasukan: ${formatRupiah(totalIncome)}\n`;
            message += ` Total Pengeluaran: ${formatRupiah(totalExpense)}\n`;
            message += ` Saldo: ${formatRupiah(balance)}\n\n`;

            message += ` *Transaksi Terbaru (5 terakhir):*\n`;
            const recentTransactions = transactions.slice(-5).reverse();
            recentTransactions.forEach(t => {
                const icon = t.type === 'income' ? '' : '';
                message += `${icon} ${t.description}: ${formatRupiah(t.amount)} (${t.date})\n`;
            });

            message += `\n Dibuat dengan AdiWallet`;

            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
            showNotification('Ringkasan siap dikirim via WhatsApp!', 'success');
        }

        // --- Account Deletion ---

        async function deleteAccount() {
            if (!currentFirebaseUser) {
                showNotification('Anda harus login untuk menghapus akun.', 'error');
                return;
            }

            const confirm = await new Promise(resolve => {
                showConfirmationModal('Apakah Anda yakin ingin menghapus akun Anda? Semua data akan hilang permanen dan tidak dapat dipulihkan.', () => resolve(true), () => resolve(false));
            });

            if (!confirm) {
                showNotification('Penghapusan akun dibatalkan.', 'info');
                return;
            }

            try {
                const userId = currentFirebaseUser.uid;
                const batch = writeBatch(db);

                const transactionsSnapshot = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/transactions`));
                transactionsSnapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });

                const categoriesRef = doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'categories');
                batch.delete(categoriesRef);

                const budgetsRef = doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'budgets');
                batch.delete(budgetsRef);

                await batch.commit();

                await deleteFirebaseAuthUser(currentFirebaseUser);

                showNotification('Akun Anda telah dihapus.', 'success');
            } catch (error) {
                console.error("Error deleting account:", error);
                let errorMessage = 'Gagal menghapus akun.';
                if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'Untuk alasan keamanan, silakan login ulang dan coba lagi.';
                }
                showNotification(errorMessage, 'error');
            }
        }

        // --- Forgot Password ---

        async function handleForgotPassword(event) {
            event.preventDefault();
            const email = forgotPasswordEmailInput.value.trim();

            if (!email) {
                showMessage(forgotPasswordMessageEl, 'Email tidak boleh kosong.', true);
                showNotification('Email tidak boleh kosong.', 'error');
                return;
            }

            try {
                await sendPasswordResetEmail(auth, email);
                showMessage(forgotPasswordMessageEl, 'Link reset password telah dikirim ke email Anda.', false);
                showNotification('Link reset password telah dikirim ke email Anda.', 'success');
                forgotPasswordEmailInput.value = '';
                setTimeout(() => {
                    hideForgotPasswordModal();
                }, 2000);
            } catch (error) {
                console.error("Error sending password reset email:", error);
                let errorMessage = 'Gagal mengirim email reset password.';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Email tidak terdaftar.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Format email tidak valid.';
                }
                showMessage(forgotPasswordMessageEl, errorMessage, true);
                showNotification(errorMessage, 'error');
            }
        }

        // --- Rendering Functions ---

        function renderDashboard() {
            const transactions = getUserTransactions();
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = totalIncome - totalExpense;

            currentBalanceEl.textContent = formatRupiah(balance);
            totalIncomeEl.textContent = formatRupiah(totalIncome);
            totalExpenseEl.textContent = formatRupiah(totalExpense);

            renderLatestTransactions();
            renderIncomeExpenseChart();
            renderExpenseByCategorySummary();
        }

        function renderLatestTransactions() {
            const transactions = getUserTransactions();
            const latestTransactions = transactions.slice(-5).reverse();

            latestTransactionsEl.innerHTML = '';
            if (latestTransactions.length === 0) {
                latestTransactionsEl.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada transaksi.</p>';
                return;
            }

            latestTransactions.forEach(transaction => {
                const transactionDiv = document.createElement('div');
                transactionDiv.className = `transaction-item ${transaction.type}`;
                transactionDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-12 h-12 rounded-2xl flex items-center justify-center mr-4 ${transaction.type === 'income' ? 'bg-green-100' : 'bg-red-100'}">
                                <i data-feather="${transaction.type === 'income' ? 'arrow-down-left' : 'arrow-up-right'}" class="w-6 h-6 ${transaction.type === 'income' ? 'text-green-600' : 'text-red-600'}"></i>
                            </div>
                            <div>
                                <p class="font-semibold">${transaction.description}</p>
                                <div class="flex items-center gap-2 text-sm text-gray-600">
                                    <span>${transaction.date}</span>
                                    <span class="category-badge">${transaction.category}</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="amount-display ${transaction.type === 'income' ? 'amount-income' : 'amount-expense'}">
                                ${transaction.type === 'income' ? '+' : '-'}${formatRupiah(transaction.amount)}
                            </p>
                        </div>
                    </div>
                `;
                latestTransactionsEl.appendChild(transactionDiv);
            });
            feather.replace();
        }

        function renderIncomeExpenseChart() {
            const transactions = getUserTransactions();
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);

            const maxAmount = Math.max(totalIncome, totalExpense, 1);
            const incomeHeight = (totalIncome / maxAmount) * 100;
            const expenseHeight = (totalExpense / maxAmount) * 100;

            incomeExpenseChart.innerHTML = `
                <div class="chart-bar chart-bar-income" style="height: ${incomeHeight}%;">
                    <span style="padding: 0.5rem;">${formatRupiah(totalIncome)}</span>
                </div>
                <div class="chart-bar chart-bar-expense" style="height: ${expenseHeight}%;">
                    <span style="padding: 0.5rem;">${formatRupiah(totalExpense)}</span>
                </div>
            `;

            setTimeout(() => {
                const incomeBars = incomeExpenseChart.querySelectorAll('.chart-bar-income');
                const expenseBars = incomeExpenseChart.querySelectorAll('.chart-bar-expense');
                incomeBars.forEach(bar => bar.style.height = `${incomeHeight}%`);
                expenseBars.forEach(bar => bar.style.height = `${expenseHeight}%`);
            }, 100);
        }

        function renderExpenseByCategorySummary() {
            const transactions = getUserTransactions();
            const expensesByCategory = {};

            transactions.filter(t => t.type === 'expense').forEach(t => {
                expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + t.amount;
            });

            const sortedCategories = Object.entries(expensesByCategory)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            expenseByCategorySummary.innerHTML = '';
            if (sortedCategories.length === 0) {
                expenseByCategorySummary.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada pengeluaran berdasarkan kategori.</p>';
                return;
            }

            const maxAmount = sortedCategories[0][1];

            sortedCategories.forEach(([category, amount]) => {
                const percentage = (amount / maxAmount) * 100;
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'space-y-2';
                categoryDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-medium">${category}</span>
                        <span class="font-bold text-red-500">${formatRupiah(amount)}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-gradient-to-r from-red-400 to-red-600 h-2 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                    </div>
                `;
                expenseByCategorySummary.appendChild(categoryDiv);
            });
        }

        function renderTransactions() {
            applyFiltersAndSort();
            renderPaginatedTransactions();
        }

        function applyFiltersAndSort() {
            const transactions = getUserTransactions();
            const searchTerm = transactionSearchInput.value.toLowerCase();
            const typeFilter = filterTypeSelect.value;
            const startDate = filterStartDate.value;
            const endDate = filterEndDate.value;
            const sortBy = sortBySelect.value;

            filteredTransactions = transactions.filter(t => {
                const matchesSearch = t.description.toLowerCase().includes(searchTerm);
                const matchesType = typeFilter === 'all' || t.type === typeFilter;
                const matchesStartDate = !startDate || t.date >= startDate;
                const matchesEndDate = !endDate || t.date <= endDate;
                return matchesSearch && matchesType && matchesStartDate && matchesEndDate;
            });

            filteredTransactions.sort((a, b) => {
                switch (sortBy) {
                    case 'dateDesc':
                        return new Date(b.date) - new Date(a.date);
                    case 'dateAsc':
                        return new Date(a.date) - new Date(b.date);
                    case 'amountDesc':
                        return b.amount - a.amount;
                    case 'amountAsc':
                        return a.amount - b.amount;
                    default:
                        return new Date(b.date) - new Date(a.date);
                }
            });
        }

        function renderPaginatedTransactions() {
            const startIndex = (currentPage - 1) * transactionsPerPage;
            const endIndex = startIndex + transactionsPerPage;
            const paginatedTransactions = filteredTransactions.slice(startIndex, endIndex);

            allTransactionsListEl.innerHTML = '';
            if (paginatedTransactions.length === 0) {
                allTransactionsListEl.innerHTML = '<p class="text-gray-500 text-center py-8">Tidak ada transaksi yang ditemukan.</p>';
            } else {
                paginatedTransactions.forEach(transaction => {
                    const transactionDiv = document.createElement('div');
                    transactionDiv.className = `transaction-item ${transaction.type}`;
                    transactionDiv.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-12 h-12 rounded-2xl flex items-center justify-center mr-4 ${transaction.type === 'income' ? 'bg-green-100' : 'bg-red-100'}">
                                    <i data-feather="${transaction.type === 'income' ? 'arrow-down-left' : 'arrow-up-right'}" class="w-6 h-6 ${transaction.type === 'income' ? 'text-green-600' : 'text-red-600'}"></i>
                                </div>
                                <div>
                                    <p class="font-semibold">${transaction.description}</p>
                                    <div class="flex items-center gap-2 text-sm text-gray-600">
                                        <span>${transaction.date}</span>
                                        <span class="category-badge">${transaction.category}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="text-right">
                                    <p class="amount-display ${transaction.type === 'income' ? 'amount-income' : 'amount-expense'}">
                                        ${transaction.type === 'income' ? '+' : '-'}${formatRupiah(transaction.amount)}
                                    </p>
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn-secondary text-xs px-3 py-2" onclick="editTransaction('${transaction.id}')">
                                        <i data-feather="edit" class="inline-block w-3 h-3 mr-1"></i>
                                        Edit
                                    </button>
                                    <button class="btn-danger text-xs px-3 py-2" onclick="deleteTransaction('${transaction.id}')">
                                        <i data-feather="trash-2" class="inline-block w-3 h-3 mr-1"></i>
                                        Hapus
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    allTransactionsListEl.appendChild(transactionDiv);
                });
                feather.replace();
            }

            updatePaginationControls();
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredTransactions.length / transactionsPerPage);
            pageInfo.textContent = `Halaman ${currentPage} dari ${totalPages}`;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
        }

        function populateReportYears() {
            const transactions = getUserTransactions();
            const years = [...new Set(transactions.map(t => new Date(t.date).getFullYear()))].sort((a, b) => b - a);
            reportYearSelect.innerHTML = '<option value="all">Semua Tahun</option>';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                reportYearSelect.appendChild(option);
            });
            if (years.length > 0) {
                reportYearSelect.value = years[0];
            }
        }

        function renderReports() {
            const month = reportMonthSelect.value;
            const year = reportYearSelect.value;
            const transactions = getUserTransactions();

            const filteredTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                const transactionMonth = String(transactionDate.getMonth() + 1).padStart(2, '0');
                const transactionYear = transactionDate.getFullYear();

                const matchesMonth = month === 'all' || transactionMonth === month;
                const matchesYear = year === 'all' || transactionYear == year;
                return matchesMonth && matchesYear;
            });

            const totalIncome = filteredTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = filteredTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const netBalance = totalIncome - totalExpense;

            reportTotalIncomeEl.textContent = formatRupiah(totalIncome);
            reportTotalExpenseEl.textContent = formatRupiah(totalExpense);
            reportNetBalanceEl.textContent = formatRupiah(netBalance);

            renderReportExpenseByCategory(filteredTransactions);
            renderReportIncomeByCategory(filteredTransactions);
            renderReportTransactionsList(filteredTransactions);
            renderMonthlySummaryChart(filteredTransactions);
            renderExpenseByCategoryChart(filteredTransactions);
            renderIncomeByCategoryChart(filteredTransactions);
        }

        function renderReportExpenseByCategory(transactions) {
            const expensesByCategory = {};
            transactions.filter(t => t.type === 'expense').forEach(t => {
                expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + t.amount;
            });

            const sortedCategories = Object.entries(expensesByCategory).sort(([,a], [,b]) => b - a);

            reportExpenseByCategory.innerHTML = '';
            if (sortedCategories.length === 0) {
                reportExpenseByCategory.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada data pengeluaran per kategori.</p>';
                return;
            }

            const totalExpense = sortedCategories.reduce((sum, [, amount]) => sum + amount, 0);

            sortedCategories.forEach(([category, amount]) => {
                const percentage = ((amount / totalExpense) * 100).toFixed(1);
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'flex justify-between items-center p-3 bg-red-50 rounded-xl border border-red-100';
                categoryDiv.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center mr-3">
                            <i data-feather="tag" class="w-4 h-4 text-red-600"></i>
                        </div>
                        <span class="font-medium">${category}</span>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-red-600">${formatRupiah(amount)}</p>
                        <p class="text-xs text-gray-600">${percentage}%</p>
                    </div>
                `;
                reportExpenseByCategory.appendChild(categoryDiv);
            });
            feather.replace();
        }

        function renderReportIncomeByCategory(transactions) {
            const incomeByCategory = {};
            transactions.filter(t => t.type === 'income').forEach(t => {
                incomeByCategory[t.category] = (incomeByCategory[t.category] || 0) + t.amount;
            });

            const sortedCategories = Object.entries(incomeByCategory).sort(([,a], [,b]) => b - a);

            reportIncomeByCategory.innerHTML = '';
            if (sortedCategories.length === 0) {
                reportIncomeByCategory.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada data pemasukan per kategori.</p>';
                return;
            }

            const totalIncome = sortedCategories.reduce((sum, [, amount]) => sum + amount, 0);

            sortedCategories.forEach(([category, amount]) => {
                const percentage = ((amount / totalIncome) * 100).toFixed(1);
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'flex justify-between items-center p-3 bg-green-50 rounded-xl border border-green-100';
                categoryDiv.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                            <i data-feather="tag" class="w-4 h-4 text-green-600"></i>
                        </div>
                        <span class="font-medium">${category}</span>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-green-600">${formatRupiah(amount)}</p>
                        <p class="text-xs text-gray-600">${percentage}%</p>
                    </div>
                `;
                reportIncomeByCategory.appendChild(categoryDiv);
            });
            feather.replace();
        }

        function renderReportTransactionsList(transactions) {
            reportTransactionsListEl.innerHTML = '';
            if (transactions.length === 0) {
                reportTransactionsListEl.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada transaksi untuk laporan.</p>';
                return;
            }

            const sortedTransactions = transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            const table = document.createElement('table');
            table.className = 'responsive-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Tanggal</th>
                        <th>Deskripsi</th>
                        <th>Kategori</th>
                        <th>Tipe</th>
                        <th>Jumlah</th>
                    </tr>
                </thead>
                <tbody>
                    ${sortedTransactions.map(t => `
                        <tr>
                            <td>${t.date}</td>
                            <td>${t.description}</td>
                            <td><span class="category-badge">${t.category}</span></td>
                            <td>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${t.type === 'income' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${t.type === 'income' ? 'Pemasukan' : 'Pengeluaran'}
                                </span>
                            </td>
                            <td class="font-bold ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                                ${t.type === 'income' ? '+' : '-'}${formatRupiah(t.amount)}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            reportTransactionsListEl.appendChild(table);
        }

        function renderMonthlySummaryChart(transactions) {
            const monthlyData = {};
            transactions.forEach(t => {
                const month = t.date.substring(0, 7);
                if (!monthlyData[month]) {
                    monthlyData[month] = { income: 0, expense: 0 };
                }
                monthlyData[month][t.type] += t.amount;
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const labels = sortedMonths.map(month => {
                const [year, monthNum] = month.split('-');
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
                return `${monthNames[parseInt(monthNum) - 1]} ${year}`;
            });

            const incomeData = sortedMonths.map(month => monthlyData[month].income);
            const expenseData = sortedMonths.map(month => monthlyData[month].expense);

            if (monthlySummaryChartInstance) {
                monthlySummaryChartInstance.destroy();
            }

            const ctx = monthlySummaryChartCanvas.getContext('2d');
            monthlySummaryChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Pemasukan',
                            data: incomeData,
                            borderColor: '#00d4aa',
                            backgroundColor: 'rgba(0, 212, 170, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Pengeluaran',
                            data: expenseData,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatRupiah(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderExpenseByCategoryChart(transactions) {
            const expensesByCategory = {};
            transactions.filter(t => t.type === 'expense').forEach(t => {
                expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + t.amount;
            });

            const labels = Object.keys(expensesByCategory);
            const data = Object.values(expensesByCategory);

            if (expenseByCategoryChartInstance) {
                expenseByCategoryChartInstance.destroy();
            }

            if (labels.length === 0) {
                expenseByCategoryChartCanvas.style.display = 'none';
                return;
            }

            expenseByCategoryChartCanvas.style.display = 'block';
            const ctx = expenseByCategoryChartCanvas.getContext('2d');
            expenseByCategoryChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57',
                            '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#ff9f43'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        function renderIncomeByCategoryChart(transactions) {
            const incomeByCategory = {};
            transactions.filter(t => t.type === 'income').forEach(t => {
                incomeByCategory[t.category] = (incomeByCategory[t.category] || 0) + t.amount;
            });

            const labels = Object.keys(incomeByCategory);
            const data = Object.values(incomeByCategory);

            if (incomeByCategoryChartInstance) {
                incomeByCategoryChartInstance.destroy();
            }

            if (labels.length === 0) {
                incomeByCategoryChartCanvas.style.display = 'none';
                return;
            }

            incomeByCategoryChartCanvas.style.display = 'block';
            const ctx = incomeByCategoryChartCanvas.getContext('2d');
            incomeByCategoryChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#00d4aa', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57',
                            '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#ff9f43'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        function renderAnalysis() {
            renderFinancialTrendsChart();
            renderTopExpenseCategoriesChart();
            renderTopIncomeCategoriesChart();
        }

        function renderFinancialTrendsChart() {
            const transactions = getUserTransactions();
            const monthlyData = {};

            transactions.forEach(t => {
                const month = t.date.substring(0, 7);
                if (!monthlyData[month]) {
                    monthlyData[month] = { income: 0, expense: 0 };
                }
                monthlyData[month][t.type] += t.amount;
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const labels = sortedMonths.map(month => {
                const [year, monthNum] = month.split('-');
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
                return `${monthNames[parseInt(monthNum) - 1]} ${year}`;
            });

            const incomeData = sortedMonths.map(month => monthlyData[month].income);
            const expenseData = sortedMonths.map(month => monthlyData[month].expense);
            const balanceData = sortedMonths.map(month => monthlyData[month].income - monthlyData[month].expense);

            if (financialTrendsChartInstance) {
                financialTrendsChartInstance.destroy();
            }

            const ctx = financialTrendsChartCanvas.getContext('2d');
            financialTrendsChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Pemasukan',
                            data: incomeData,
                            borderColor: '#00d4aa',
                            backgroundColor: 'rgba(0, 212, 170, 0.1)',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Pengeluaran',
                            data: expenseData,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Saldo Bersih',
                            data: balanceData,
                            borderColor: '#6c5ce7',
                            backgroundColor: 'rgba(108, 92, 231, 0.1)',
                            tension: 0.4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatRupiah(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderTopExpenseCategoriesChart() {
            const transactions = getUserTransactions();
            const expensesByCategory = {};

            transactions.filter(t => t.type === 'expense').forEach(t => {
                expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + t.amount;
            });

            const sortedCategories = Object.entries(expensesByCategory)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            const labels = sortedCategories.map(([category]) => category);
            const data = sortedCategories.map(([, amount]) => amount);

            if (topExpenseCategoriesChartInstance) {
                topExpenseCategoriesChartInstance.destroy();
            }

            if (labels.length === 0) {
                topExpenseCategoriesChartCanvas.style.display = 'none';
                topExpenseCategoriesSummary.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada data pengeluaran.</p>';
                return;
            }

            topExpenseCategoriesChartCanvas.style.display = 'block';
            const ctx = topExpenseCategoriesChartCanvas.getContext('2d');
            topExpenseCategoriesChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pengeluaran',
                        data: data,
                        backgroundColor: [
                            '#ff6b6b', '#ee5a52', '#ff7675', '#fd79a8', '#e84393'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatRupiah(value);
                                }
                            }
                        }
                    }
                }
            });

            topExpenseCategoriesSummary.innerHTML = '';
            const totalExpense = data.reduce((sum, amount) => sum + amount, 0);

            sortedCategories.forEach(([category, amount], index) => {
                const percentage = ((amount / totalExpense) * 100).toFixed(1);
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'flex justify-between items-center p-3 bg-red-50 rounded-xl border border-red-100';
                categoryDiv.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded mr-3" style="background-color: ${['#ff6b6b', '#ee5a52', '#ff7675', '#fd79a8', '#e84393'][index]}"></div>
                        <span class="font-medium">${category}</span>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-red-600">${formatRupiah(amount)}</p>
                        <p class="text-xs text-gray-600">${percentage}%</p>
                    </div>
                `;
                topExpenseCategoriesSummary.appendChild(categoryDiv);
            });
        }

        function renderTopIncomeCategoriesChart() {
            const transactions = getUserTransactions();
            const incomeByCategory = {};

            transactions.filter(t => t.type === 'income').forEach(t => {
                incomeByCategory[t.category] = (incomeByCategory[t.category] || 0) + t.amount;
            });

            const sortedCategories = Object.entries(incomeByCategory)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            const labels = sortedCategories.map(([category]) => category);
            const data = sortedCategories.map(([, amount]) => amount);

            if (topIncomeCategoriesChartInstance) {
                topIncomeCategoriesChartInstance.destroy();
            }

            if (labels.length === 0) {
                topIncomeCategoriesChartCanvas.style.display = 'none';
                topIncomeCategoriesSummary.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada data pemasukan.</p>';
                return;
            }

            topIncomeCategoriesChartCanvas.style.display = 'block';
            const ctx = topIncomeCategoriesChartCanvas.getContext('2d');
            topIncomeCategoriesChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pemasukan',
                        data: data,
                        backgroundColor: [
                            '#00d4aa', '#00a085', '#4ecdc4', '#45b7d1', '#96ceb4'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatRupiah(value);
                                }
                            }
                        }
                    }
                }
            });

            topIncomeCategoriesSummary.innerHTML = '';
            const totalIncome = data.reduce((sum, amount) => sum + amount, 0);

            sortedCategories.forEach(([category, amount], index) => {
                const percentage = ((amount / totalIncome) * 100).toFixed(1);
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'flex justify-between items-center p-3 bg-green-50 rounded-xl border border-green-100';
                categoryDiv.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded mr-3" style="background-color: ${['#00d4aa', '#00a085', '#4ecdc4', '#45b7d1', '#96ceb4'][index]}"></div>
                        <span class="font-medium">${category}</span>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-green-600">${formatRupiah(amount)}</p>
                        <p class="text-xs text-gray-600">${percentage}%</p>
                    </div>
                `;
                topIncomeCategoriesSummary.appendChild(categoryDiv);
            });
        }

        // --- PDF Report Generation ---

        function generatePdfReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const month = reportMonthSelect.value;
            const year = reportYearSelect.value;
            const transactions = getUserTransactions();

            const filteredTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                const transactionMonth = String(transactionDate.getMonth() + 1).padStart(2, '0');
                const transactionYear = transactionDate.getFullYear();

                const matchesMonth = month === 'all' || transactionMonth === month;
                const matchesYear = year === 'all' || transactionYear == year;
                return matchesMonth && matchesYear;
            });

            const totalIncome = filteredTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = filteredTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const netBalance = totalIncome - totalExpense;

            let periodText = 'Semua Periode';
            if (month !== 'all' && year !== 'all') {
                const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                periodText = `${monthNames[parseInt(month) - 1]} ${year}`;
            } else if (month !== 'all') {
                const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                periodText = `${monthNames[parseInt(month) - 1]} (Semua Tahun)`;
            } else if (year !== 'all') {
                periodText = `Tahun ${year}`;
            }

            doc.setFontSize(20);
            doc.text('Laporan Keuangan AdiWallet', 20, 30);
            doc.setFontSize(12);
            doc.text(`Periode: ${periodText}`, 20, 45);
            doc.text(`Tanggal Generate: ${new Date().toLocaleDateString('id-ID')}`, 20, 55);

            doc.setFontSize(14);
            doc.text('Ringkasan Keuangan:', 20, 75);
            doc.setFontSize(12);
            doc.text(`Total Pemasukan: ${formatRupiah(totalIncome)}`, 20, 90);
            doc.text(`Total Pengeluaran: ${formatRupiah(totalExpense)}`, 20, 105);
            doc.text(`Saldo Bersih: ${formatRupiah(netBalance)}`, 20, 120);

            if (filteredTransactions.length > 0) {
                const tableData = filteredTransactions.map(t => [
                    t.date,
                    t.description,
                    t.category,
                    t.type === 'income' ? 'Pemasukan' : 'Pengeluaran',
                    formatRupiah(t.amount)
                ]);

                doc.autoTable({
                    head: [['Tanggal', 'Deskripsi', 'Kategori', 'Tipe', 'Jumlah']],
                    body: tableData,
                    startY: 140,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [108, 92, 231] }
                });
            }

            doc.save(`laporan_keuangan_${periodText.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('Laporan PDF berhasil diunduh!', 'success');
        }

        // --- Modal Functions ---

        function showConfirmationModal(message, onConfirm, onCancel) {
            confirmationModalMessage.textContent = message;
            confirmationModal.classList.remove('hidden');

            confirmYesBtn.onclick = () => {
                hideConfirmationModal();
                if (onConfirm) onConfirm();
            };

            confirmNoBtn.onclick = () => {
                hideConfirmationModal();
                if (onCancel) onCancel();
            };
        }

        function hideConfirmationModal() {
            confirmationModal.classList.add('hidden');
        }

        function showEditTransactionModal() {
            editTransactionModal.classList.remove('hidden');
        }

        function hideEditTransactionModal() {
            editTransactionModal.classList.add('hidden');
        }

        function showJsonDisplayModal() {
            jsonDisplayModal.classList.remove('hidden');
        }

        function hideJsonDisplayModal() {
            jsonDisplayModal.classList.add('hidden');
        }

        function showForgotPasswordModal() {
            forgotPasswordModal.classList.remove('hidden');
        }

        function hideForgotPasswordModal() {
            forgotPasswordModal.classList.add('hidden');
        }

        function confirmAction(message, action) {
            showConfirmationModal(message, action);
        }

        // --- Chatbot Functions ---

        function startChatbot() {
            chatDisplay.innerHTML = `
                <div class="chat-message bot bg-white rounded-2xl p-4 mb-4 shadow-sm">
                    <div class="flex items-start">
                        <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                            <i data-feather="help-circle" class="w-4 h-4 text-purple-600"></i>
                        </div>
                        <div>
                            <p class="font-medium text-purple-600 mb-1">Asisten AdiWallet</p>
                            <p>Halo! Saya asisten bantuan Anda. Bagaimana saya bisa membantu?</p>
                        </div>
                    </div>
                </div>
            `;

            chatOptions.innerHTML = `
                <button class="bg-purple-100 hover:bg-purple-200 text-purple-700 px-4 py-2 rounded-xl text-sm font-medium transition-all duration-300" onclick="askChatbot('Bagaimana cara menambah transaksi?')">
                    Cara menambah transaksi
                </button>
                <button class="bg-purple-100 hover:bg-purple-200 text-purple-700 px-4 py-2 rounded-xl text-sm font-medium transition-all duration-300" onclick="askChatbot('Bagaimana cara membuat anggaran?')">
                    Cara membuat anggaran
                </button>
                <button class="bg-purple-100 hover:bg-purple-200 text-purple-700 px-4 py-2 rounded-xl text-sm font-medium transition-all duration-300" onclick="askChatbot('Bagaimana cara melihat laporan?')">
                    Cara melihat laporan
                </button>
                <button class="bg-purple-100 hover:bg-purple-200 text-purple-700 px-4 py-2 rounded-xl text-sm font-medium transition-all duration-300" onclick="askChatbot('Bagaimana cara ekspor data?')">
                    Cara ekspor data
                </button>
                <button class="bg-purple-100 hover:bg-purple-200 text-purple-700 px-4 py-2 rounded-xl text-sm font-medium transition-all duration-300" onclick="askChatbot('Fitur apa saja yang tersedia?')">
                    Fitur yang tersedia
                </button>
            `;
            feather.replace();
        }

        function askChatbot(question) {
            addChatMessage(question, 'user');

            setTimeout(() => {
                const answer = getChatbotResponse(question);
                addChatMessage(answer, 'bot');
            }, 1000);
        }

        function addChatMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender} bg-white rounded-2xl p-4 mb-4 shadow-sm`;

            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex items-start justify-end">
                        <div class="text-right mr-3">
                            <p class="font-medium text-blue-600 mb-1">Anda</p>
                            <p>${message}</p>
                        </div>
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                            <i data-feather="user" class="w-4 h-4 text-blue-600"></i>
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="flex items-start">
                        <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                            <i data-feather="help-circle" class="w-4 h-4 text-purple-600"></i>
                        </div>
                        <div>
                            <p class="font-medium text-purple-600 mb-1">Asisten AdiWallet</p>
                            <p>${message}</p>
                        </div>
                    </div>
                `;
            }

            chatDisplay.appendChild(messageDiv);
            chatDisplay.scrollTop = chatDisplay.scrollHeight;
            feather.replace();
        }

        function getChatbotResponse(question) {
            const responses = {
                'Bagaimana cara menambah transaksi?': 'Untuk menambah transaksi, buka menu "Transaksi", isi form dengan tanggal, deskripsi, jumlah, tipe (pemasukan/pengeluaran), dan kategori, lalu klik "Tambah Transaksi".',
                'Bagaimana cara membuat anggaran?': 'Buka menu "Rencana Anggaran", pilih kategori, masukkan jumlah anggaran, tentukan tanggal mulai dan akhir, lalu klik "Simpan Anggaran".',
                'Bagaimana cara melihat laporan?': 'Buka menu "Laporan", pilih bulan dan tahun yang diinginkan. Anda akan melihat ringkasan keuangan, grafik, dan detail transaksi. Anda juga bisa mengunduh laporan PDF.',
                'Bagaimana cara ekspor data?': 'Buka menu "Pengaturan", di bagian "Backup & Pulihkan Data" klik "Ekspor Data" untuk mendapatkan file JSON, atau klik "Ekspor ke CSV" untuk file CSV.',
                'Fitur apa saja yang tersedia?': 'AdiWallet memiliki fitur: Dashboard ringkasan, Manajemen transaksi, Rencana anggaran, Laporan keuangan, Analisis keuangan, Ekspor data, Kirim ke WhatsApp, Mode gelap, dan Manajemen kategori.'
            };

            return responses[question] || 'Maaf, saya belum bisa menjawab pertanyaan tersebut. Silakan pilih dari opsi yang tersedia atau hubungi dukungan teknis.';
        }

        // --- Event Listeners ---

        menuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        authForm.addEventListener('submit', handleAuth);
        logoutBtn.addEventListener('click', handleLogout);

        toggleAuthModeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (authMode === 'login') {
                authMode = 'register';
                authTitle.textContent = 'Daftar Akun Baru';
                authSubmitBtn.textContent = 'Daftar';
                toggleAuthModeBtn.textContent = 'Login di sini';
            } else {
                authMode = 'login';
                authTitle.textContent = 'Login';
                authSubmitBtn.textContent = 'Login';
                toggleAuthModeBtn.textContent = 'Daftar di sini';
            }
            authMessage.classList.add('hidden');
        });

        forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            showForgotPasswordModal();
        });

        forgotPasswordForm.addEventListener('submit', handleForgotPassword);

        sidebarItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const section = item.dataset.section + 'Section';
                showSection(section);
            });
        });

        transactionForm.addEventListener('submit', addTransaction);
        editTransactionForm.addEventListener('submit', updateTransaction);

        budgetForm.addEventListener('submit', addBudget);

        changePasswordForm.addEventListener('submit', handleChangePassword);
        addCategoryForm.addEventListener('submit', addCategory);

        darkModeToggle.addEventListener('change', toggleDarkMode);

        exportDataBtn.addEventListener('click', exportToCSV);
        sendWhatsappSummaryBtn.addEventListener('click', sendWhatsappSummary);
        deleteAccountBtn.addEventListener('click', deleteAccount);

        exportAllDataBtn.addEventListener('click', exportAllData);
        importAllDataInput.addEventListener('change', importAllData);

        copyJsonBtn.addEventListener('click', () => {
            jsonOutput.select();
            document.execCommand('copy');
            showNotification('Data berhasil disalin ke clipboard!', 'success');
        });

        reportMonthSelect.addEventListener('change', renderReports);
        reportYearSelect.addEventListener('change', renderReports);
        generatePdfReportBtn.addEventListener('click', generatePdfReport);

        transactionSearchInput.addEventListener('input', () => {
            currentPage = 1;
            renderTransactions();
        });

        filterTypeSelect.addEventListener('change', () => {
            currentPage = 1;
            renderTransactions();
        });

        filterStartDate.addEventListener('change', () => {
            currentPage = 1;
            renderTransactions();
        });

        filterEndDate.addEventListener('change', () => {
            currentPage = 1;
            renderTransactions();
        });

        sortBySelect.addEventListener('change', () => {
            currentPage = 1;
            renderTransactions();
        });

        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderPaginatedTransactions();
            }
        });

        nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredTransactions.length / transactionsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderPaginatedTransactions();
            }
        });

        // Close modals when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target === confirmationModal) {
                hideConfirmationModal();
            }
            if (e.target === editTransactionModal) {
                hideEditTransactionModal();
            }
            if (e.target === jsonDisplayModal) {
                hideJsonDisplayModal();
            }
            if (e.target === forgotPasswordModal) {
                hideForgotPasswordModal();
            }
        });

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            if (window.innerWidth < 768 && !sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
                sidebar.classList.remove('open');
            }
        });

        // Make functions globally available
        window.showSection = showSection;
        window.deleteTransaction = deleteTransaction;
        window.editTransaction = editTransaction;
        window.deleteCategory = deleteCategory;
        window.deleteBudget = deleteBudget;
        window.hideConfirmationModal = hideConfirmationModal;
        window.hideEditTransactionModal = hideEditTransactionModal;
        window.hideJsonDisplayModal = hideJsonDisplayModal;
        window.hideForgotPasswordModal = hideForgotPasswordModal;
        window.askChatbot = askChatbot;

        // Initialize the app
        const today = new Date().toISOString().split('T')[0];
        transactionDateInput.value = today;

        // Initialize feather icons
        feather.replace();

        console.log("AdiWallet app initialized successfully!");
    </script>
</body>
</html>
