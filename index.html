<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Catat Keuangan Pribadi</title>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Custom CSS untuk font dan warna */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Warna latar belakang umum */
            color: #333;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .sidebar {
            background-color: #2c3e50; /* Warna sidebar gelap */
            color: #ecf0f1; /* Warna teks sidebar */
            width: 250px;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out, background-color 0.3s ease, color 0.3s ease;
            z-index: 20;
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .sidebar-item {
            display: block;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem; /* rounded-md */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            transition: background-color 0.2s;
        }
        .sidebar-item:hover {
            background-color: #34495e; /* Warna hover untuk item sidebar */
        }
        .sidebar-item.active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            font-weight: 600; /* font-semibold */
        }
        .header {
            background-color: #ffffff; /* Warna header putih */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .main-content {
            background-color: #f9f9f9; /* Warna latar belakang konten utama */
            transition: background-color 0.3s ease;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        input[type="text"],
        input[type="password"],
        input[type="number"],
        input[type="date"],
        select {
            border-color: #d1d5db; /* gray-300 */
            border-width: 1px;
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.75rem 1rem;
            width: 100%;
            outline: none;
            transition: border-color 0.2s, background-color 0.3s ease, color 0.3s ease;
        }
        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus {
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); /* blue-500 with opacity */
        }
        .btn-primary {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* blue-600 */
        }
        .btn-danger {
            background-color: #ef4444; /* red-500 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.2s;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* red-600 */
        }
        .btn-secondary {
            background-color: #6b7280; /* gray-500 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #4b5563; /* gray-600 */
        }
        .text-income {
            color: #22c55e; /* green-500 */
        }
        .text-expense {
            color: #ef4444; /* red-500 */
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            width: 500px;
            position: relative;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }

        /* Chart Styles */
        .chart-bar-container {
            display: flex;
            align-items: flex-end;
            height: 150px; /* Fixed height for the chart area */
            background-color: #f0f2f5;
            border-radius: 0.5rem;
            overflow: hidden;
            position: relative;
            transition: background-color 0.3s ease;
        }
        .chart-bar {
            width: 50%;
            height: 0; /* Initial height */
            transition: height 0.5s ease-out;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.875rem; /* text-sm */
            position: relative;
        }
        .chart-bar span {
            position: absolute;
            bottom: -1.5rem; /* Label below the bar */
            color: #333;
            font-weight: normal;
            font-size: 0.75rem; /* text-xs */
        }
        .chart-bar-income {
            background-color: #22c55e; /* green-500 */
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        .chart-bar-expense {
            background-color: #ef4444; /* red-500 */
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }

        /* Responsive table for reports */
        .responsive-table {
            width: 100%;
            border-collapse: collapse;
        }
        .responsive-table th, .responsive-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb; /* gray-200 */
            text-align: left;
            transition: border-color 0.3s ease;
        }
        .responsive-table th {
            background-color: #f3f4f6; /* gray-100 */
            font-weight: 600;
            color: #4b5563;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        @media (max-width: 767px) {
            .responsive-table, .responsive-table thead, .responsive-table tbody, .responsive-table th, .responsive-table td, .responsive-table tr {
                display: block;
            }
            .responsive-table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            .responsive-table tr {
                margin-bottom: 1rem;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                overflow: hidden;
            }
            .responsive-table td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 50%;
                text-align: right;
            }
            .responsive-table td:before {
                position: absolute;
                top: 0;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: 600;
                color: #4b5563;
            }
            /* Label the data */
            .responsive-table td:nth-of-type(1):before { content: "Deskripsi"; }
            .responsive-table td:nth-of-type(2):before { content: "Tanggal"; }
            .responsive-table td:nth-of-type(3):before { content: "Jumlah"; }
            .responsive-table td:nth-of-type(4):before { content: "Tipe"; }
            .responsive-table td:nth-of-type(5):before { content: "Kategori"; }
        }

        /* Responsiveness */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0); /* Sidebar always visible on desktop */
            }
            .content-wrapper {
                margin-left: 250px; /* Make space for sidebar */
            }
            .menu-button {
                display: none; /* Hide menu button on desktop */
            }
        }

        /* Notification Styles */
        #notificationContainer {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            pointer-events: none; /* Allow clicks to pass through */
        }
        .notification {
            background-color: #333;
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(-20px);
            animation: fadeInOut 3s forwards;
            min-width: 200px;
            text-align: center;
            pointer-events: all; /* Re-enable pointer events for the notification itself */
        }
        .notification.success {
            background-color: #22c55e; /* green-500 */
        }
        .notification.error {
            background-color: #ef4444; /* red-500 */
        }
        .notification.info {
            background-color: #3b82f6; /* blue-500 */
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        /* New styles for JSON display modal */
        #jsonDisplayModal .modal-content {
            width: 90%;
            max-width: 700px;
        }
        #jsonOutput {
            width: 100%;
            height: 300px;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            padding: 1rem;
            font-family: monospace;
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            word-wrap: break-word; /* Break long words */
            overflow-y: scroll;
            resize: vertical; /* Allow vertical resizing */
            border-radius: 0.5rem;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        #copyJsonBtn {
            margin-top: 1rem;
            width: 100%;
        }

        /* Chatbot styles */
        #chatbotModal .modal-content {
            width: 90%;
            max-width: 600px;
            height: 80vh;
            display: flex;
            flex-direction: column;
        }
        #chatDisplay {
            flex-grow: 1;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            overflow-y: auto;
            margin-bottom: 1rem;
            background-color: #f9fafb;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .chat-message {
            margin-bottom: 0.75rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            max-width: 80%;
        }
        .chat-message.user {
            background-color: #dbeafe; /* blue-100 */
            align-self: flex-end;
            margin-left: auto;
            text-align: right;
        }
        .chat-message.bot {
            background-color: #e2e8f0; /* gray-200 */
            align-self: flex-start;
            margin-right: auto;
            text-align: left;
        }
        .chat-options button {
            background-color: #e0f2fe; /* light blue */
            color: #0369a1; /* dark blue */
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            margin: 0.25rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .chat-options button:hover {
            background-color: #bae6fd; /* lighter blue */
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #1a202c; /* dark gray */
            color: #e2e8f0; /* light gray */
        }
        body.dark-mode .sidebar {
            background-color: #2d3748; /* darker sidebar */
            color: #edf2f7; /* lighter text */
        }
        body.dark-mode .sidebar-item:hover {
            background-color: #4a5568; /* darker hover */
        }
        body.dark-mode .sidebar-item.active {
            background-color: #63b3ed; /* lighter blue for active */
            color: #1a202c;
        }
        body.dark-mode .header {
            background-color: #2d3748;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        body.dark-mode .main-content {
            background-color: #1a202c;
        }
        body.dark-mode .card {
            background-color: #2d3748;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        body.dark-mode input[type="text"],
        body.dark-mode input[type="password"],
        body.dark-mode input[type="number"],
        body.dark-mode input[type="date"],
        body.dark-mode select {
            background-color: #4a5568;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        body.dark-mode input::placeholder {
            color: #cbd5e0;
        }
        body.dark-mode .btn-secondary {
            background-color: #a0aec0;
            color: #2d3748;
        }
        body.dark-mode .btn-secondary:hover {
            background-color: #cbd5e0;
        }
        body.dark-mode .text-gray-700 {
            color: #cbd5e0;
        }
        body.dark-mode .text-gray-600 {
            color: #a0aec0;
        }
        body.dark-mode .text-gray-500 {
            color: #718096;
        }
        body.dark-mode .text-blue-500 {
            color: #63b3ed;
        }
        body.dark-mode .text-blue-600 {
            color: #4299e1;
        }
        body.dark-mode .text-red-600 {
            color: #fc8181;
        }
        body.dark-mode .modal-content {
            background-color: #2d3748;
            color: #e2e8f0;
            box-shadow: 0 10px 15px rgba(0,0,0,0.4);
        }
        body.dark-mode .modal-close-btn {
            color: #a0aec0;
        }
        body.dark-mode .chart-bar-container {
            background-color: #4a5568;
        }
        body.dark-mode .chart-bar span {
            color: #e2e8f0;
        }
        body.dark-mode .responsive-table th {
            background-color: #4a5568;
            color: #e2e8f0;
            border-bottom-color: #2d3748;
        }
        body.dark-mode .responsive-table td {
            border-bottom-color: #2d3748;
        }
        body.dark-mode .responsive-table tr {
            border-color: #2d3748;
        }
        body.dark-mode .responsive-table td:before {
            color: #a0aec0;
        }
        body.dark-mode .jsonDisplayModal #jsonOutput {
            background-color: #4a5568;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        body.dark-mode #chatDisplay {
            background-color: #4a5568;
            border-color: #63b3ed;
            color: #e2e8f0;
        }
        body.dark-mode .chat-message.user {
            background-color: #4299e1;
            color: white;
        }
        body.dark-mode .chat-message.bot {
            background-color: #a0aec0;
            color: #2d3748;
        }
        body.dark-mode .chat-options button {
            background-color: #63b3ed;
            color: #1a202c;
        }
        body.dark-mode .chat-options button:hover {
            background-color: #4299e1;
        }
        body.dark-mode .text-income {
            color: #68d391; /* lighter green for dark mode */
        }
        body.dark-mode .text-expense {
            color: #fc8181; /* lighter red for dark mode */
        }
        body.dark-mode .bg-green-50 {
            background-color: #2d3748;
        }
        body.dark-mode .bg-red-50 {
            background-color: #2d3748;
        }
        body.dark-mode .border-gray-200 {
            border-color: #4a5568;
        }
        body.dark-mode .bg-white {
            background-color: #2d3748;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <aside id="sidebar" class="sidebar fixed top-0 left-0 h-full p-4 flex flex-col md:relative md:flex-shrink-0">
       <div class="mb-4 text-center">
  <img src="logo.jpeg" alt="Logo Aplikasi" class="mx-auto w-16 h-16 mb-2 rounded-full">
  <div class="text-2xl font-bold">AdiWallet</div>
</div>

        <div class="flex flex-col items-center mb-8">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 text-gray-400 mb-2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
            </svg>
            <p id="sidebarUsername" class="text-lg font-semibold text-white mt-2"></p>
        </div>
        <nav class="flex-grow">
            <ul class="space-y-2">
              <li id="dashboardSidebarItem"><a href="#" class="sidebar-item" data-section="dashboard"><i data-feather="home" class="inline-block w-4 h-4 mr-2"></i> Dashboard </a></li>
              <li id="transactionsSidebarItem"><a href="#" class="sidebar-item" data-section="transactions"><i data-feather="file-text" class="inline-block w-4 h-4 mr-2"></i> Transaksi </a></li>
              <li id="budgetingSidebarItem"><a href="#" class="sidebar-item" data-section="budgeting"><i data-feather="credit-card" class="inline-block w-4 h-4 mr-2"></i> Rencana Anggaran </a></li> <!-- New Budgeting Item -->
              <li id="reportsSidebarItem"><a href="#" class="sidebar-item" data-section="reports"><i data-feather="bar-chart-2" class="inline-block w-4 h-4 mr-2"></i> Laporan </a></li>
              <li id="analysisSidebarItem"><a href="#" class="sidebar-item" data-section="analysis"><i data-feather="pie-chart" class="inline-block w-4 h-4 mr-2"></i> Analisis Keuangan </a></li>
              <li id="settingsSidebarItem"><a href="#" class="sidebar-item" data-section="settings"><i data-feather="settings" class="inline-block w-4 h-4 mr-2"></i> Pengaturan </a></li>
              <li id="helpSidebarItem"><a href="#" class="sidebar-item" data-section="help"><i data-feather="help-circle" class="inline-block w-4 h-4 mr-2"></i> Bantuan </a></li>
            </ul>
        </nav>
        <div class="mt-auto">
            <button id="logoutBtn" class="w-full btn-primary text-sm font-medium py-2 px-4 rounded-md">Logout</button>
        </div>
    </aside>

    <div class="flex-grow flex flex-col content-wrapper md:ml-0">
        <header class="header p-4 flex items-center justify-between sticky top-0 md:hidden">
            <button id="menuBtn" class="menu-button text-gray-600 focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <h1 class="text-xl font-semibold">Keuangan Pribadi</h1>
            <div class="w-6 h-6"></div> </header>

        <main class="flex-grow p-4 md:p-8 overflow-y-auto">
            <section id="authSection" class="flex items-center justify-center min-h-screen-minus-header">
                <div class="card p-8 w-full max-w-md">
                   <div class="flex flex-col items-center mb-6">
  <img src="logo.jpeg" alt="Logo Aplikasi" class="w-20 h-20 mb-2 rounded-full">
  <h2 class="text-2xl font-bold text-center" id="authTitle">Login</h2>
</div>
                    <form id="authForm" class="space-y-4">
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="username" name="username" required class="block">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="password" name="password" required class="block">
                        </div>
                        <p id="authMessage" class="text-red-500 text-sm hidden"></p>
                        <button type="submit" id="authSubmitBtn" class="w-full btn-primary font-semibold">Login</button>
                    </form>
                    <p class="text-center text-sm mt-4">
                        <a href="#" id="forgotPasswordLink" class="text-blue-500 hover:underline">Lupa Kata Sandi?</a> |
                        Belum punya akun? <a href="#" id="toggleAuthMode" class="text-blue-500 hover:underline">Daftar di sini</a>
                    </p>
                </div>
            </section>

            <section id="dashboardSection" class="hidden">
                <h2 class="text-3xl font-bold mb-6">Dashboard</h2>
                <div class="flex items-center gap-4 mb-6">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-gray-400">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                    </svg>
                    <p class="text-xl text-gray-700">Selamat datang, <span id="dashboardUsername" class="font-semibold text-blue-600"></span>!</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="card p-6 text-center flex flex-col items-center">
                        <i data-feather="credit-card" class="w-10 h-10 text-blue-500 mb-2"></i>
                        <h3 class="text-lg font-medium text-gray-600">Saldo Saat Ini</h3>
                        <p id="currentBalance" class="text-4xl font-bold mt-2">Rp 0</p>
                    </div>
                    <div class="card p-6 text-center flex flex-col items-center">
                        <i data-feather="arrow-down-left" class="w-10 h-10 text-green-500 mb-2"></i>
                        <h3 class="text-lg font-medium text-gray-600">Total Pemasukan</h3>
                        <p id="totalIncome" class="text-3xl font-bold text-income mt-2">Rp 0</p>
                    </div>
                    <div class="card p-6 text-center flex flex-col items-center">
                        <i data-feather="arrow-up-right" class="w-10 h-10 text-red-500 mb-2"></i>
                        <h3 class="text-lg font-medium text-gray-600">Total Pengeluaran</h3>
                        <p id="totalExpense" class="text-3xl font-bold text-expense mt-2">Rp 0</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold mb-4">Ringkasan Pemasukan & Pengeluaran</h3>
                        <div id="incomeExpenseChart" class="chart-bar-container">
                            </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold mb-4">Pengeluaran Berdasarkan Kategori</h3>
                        <div id="expenseByCategorySummary" class="space-y-3">
                            <p class="text-gray-500 text-center">Belum ada pengeluaran berdasarkan kategori.</p>
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-4">Transaksi Terbaru</h3>
                    <div id="latestTransactions" class="space-y-4">
                        <p class="text-gray-500 text-center">Belum ada transaksi.</p>
                    </div>
                </div>
            </section>

            <section id="transactionsSection" class="hidden">
                <h2 class="text-3xl font-bold mb-6">Transaksi</h2>
                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-4">Tambah Transaksi Baru</h3>
                    <form id="transactionForm" class="space-y-4">
                        <div>
                            <label for="transactionDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                            <input type="date" id="transactionDate" required class="block">
                        </div>
                        <div>
                            <label for="transactionDescription" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi</label>
                            <input type="text" id="transactionDescription" placeholder="Contoh: Beli Kopi" required class="block">
                        </div>
                        <div>
                            <label for="transactionAmount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah (Rp)</label>
                            <input type="number" id="transactionAmount" placeholder="Contoh: 25000" required min="1" class="block">
                        </div>
                        <div>
                            <label for="transactionType" class="block text-sm font-medium text-gray-700 mb-1">Tipe</label>
                            <select id="transactionType" required class="block">
                                <option value="income">Pemasukan</option>
                                <option value="expense">Pengeluaran</option>
                            </select>
                        </div>
                        <div>
                            <label for="transactionCategory" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                            <select id="transactionCategory" required class="block">
                                </select>
                        </div>
                        <button type="submit" class="w-full btn-primary font-semibold">Tambah Transaksi</button>
                    </form>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-4">Daftar Semua Transaksi</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div class="col-span-full lg:col-span-1">
                            <label for="transactionSearchInput" class="block text-sm font-medium text-gray-700 mb-1">Cari Deskripsi</label>
                            <input type="text" id="transactionSearchInput" placeholder="Cari transaksi..." class="block">
                        </div>
                        <div>
                            <label for="filterType" class="block text-sm font-medium text-gray-700 mb-1">Filter Tipe</label>
                            <select id="filterType" class="block">
                                <option value="all">Semua</option>
                                <option value="income">Pemasukan</option>
                                <option value="expense">Pengeluaran</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterStartDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Mulai</label>
                            <input type="date" id="filterStartDate" class="block">
                        </div>
                        <div>
                            <label for="filterEndDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Akhir</label>
                            <input type="date" id="filterEndDate" class="block">
                        </div>
                        <div class="col-span-full sm:col-span-2 lg:col-span-1">
                            <label for="sortBy" class="block text-sm font-medium text-gray-700 mb-1">Urutkan Berdasarkan</label>
                            <select id="sortBy" class="block">
                                <option value="dateDesc">Tanggal (Terbaru)</option>
                                <option value="dateAsc">Tanggal (Terlama)</option>
                                <option value="amountDesc">Jumlah (Terbesar)</option>
                                <option value="amountAsc">Jumlah (Terkecil)</option>
                            </select>
                        </div>
                    </div>
                    <div id="allTransactionsList" class="space-y-4">
                        <p class="text-gray-500 text-center">Belum ada transaksi.</p>
                    </div>
                    <div id="paginationControls" class="flex justify-center items-center gap-4 mt-6">
                        <button id="prevPageBtn" class="btn-secondary px-4 py-2 rounded-md" disabled>Sebelumnya</button>
                        <span id="pageInfo" class="text-gray-700">Halaman 1 dari 1</span>
                        <button id="nextPageBtn" class="btn-secondary px-4 py-2 rounded-md" disabled>Berikutnya</button>
                    </div>
                </div>
            </section>

            <!-- New Budgeting Section -->
            <section id="budgetingSection" class="hidden">
                <h2 class="text-3xl font-bold mb-6">Rencana Anggaran</h2>
                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-4">Tetapkan Anggaran Baru</h3>
                    <form id="budgetForm" class="space-y-4">
                        <div>
                            <label for="budgetItemCategory" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                            <select id="budgetItemCategory" required class="block">
                                <!-- Categories will be loaded here -->
                            </select>
                        </div>
                        <div>
                            <label for="budgetAmount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Anggaran (Rp)</label>
                            <input type="number" id="budgetAmount" placeholder="Contoh: 500000" required min="1" class="block">
                        </div>
                        <div>
                            <label for="budgetStartDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Mulai</label>
                            <input type="date" id="budgetStartDate" required class="block">
                        </div>
                        <div>
                            <label for="budgetEndDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Akhir</label>
                            <input type="date" id="budgetEndDate" required class="block">
                        </div>
                        <button type="submit" class="w-full btn-primary font-semibold">Simpan Anggaran</button>
                    </form>
                    <p id="budgetMessage" class="text-red-500 text-sm hidden mt-4"></p>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-4">Daftar Anggaran Anda</h3>
                    <div id="budgetList" class="space-y-4">
                        <p class="text-gray-500 text-center">Belum ada anggaran yang ditetapkan.</p>
                    </div>
                </div>
            </section>

            <section id="reportsSection" class="hidden">
                <h2 class="text-3xl font-bold mb-6">Laporan Keuangan</h2>
                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-4">Ringkasan Laporan</h3>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <div class="flex-1">
                            <label for="reportMonthSelect" class="block text-sm font-medium text-gray-700 mb-1">Bulan</label>
                            <select id="reportMonthSelect" class="block">
                                <option value="all">Semua Bulan</option>
                                <option value="01">Januari</option>
                                <option value="02">Februari</option>
                                <option value="03">Maret</option>
                                <option value="04">April</option>
                                <option value="05">Mei</option>
                                <option value="06">Juni</option>
                                <option value="07">Juli</option>
                                <option value="08">Agustus</option>
                                <option value="09">September</option>
                                <option value="10">Oktober</option>
                                <option value="11">November</option>
                                <option value="12">Desember</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label for="reportYearSelect" class="block text-sm font-medium text-gray-700 mb-1">Tahun</label>
                            <select id="reportYearSelect" class="block">
                                </select>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <p class="text-lg">Total Pemasukan: <span id="reportTotalIncome" class="font-semibold text-income">Rp 0</span></p>
                        <p class="text-lg">Total Pengeluaran: <span id="reportTotalExpense" class="font-semibold text-expense">Rp 0</span></p>
                        <p class="text-lg">Saldo Bersih: <span id="reportNetBalance" class="font-semibold">Rp 0</span></p>
                    </div>

                    <h4 class="text-xl font-bold mt-8 mb-4">Grafik Pemasukan dan Pengeluaran Bulanan</h4>
                    <div class="relative h-64">
                        <canvas id="monthlySummaryChart"></canvas>
                    </div>

                    <h4 class="text-xl font-bold mt-8 mb-4">Pengeluaran per Kategori (Grafik Lingkaran)</h4>
                    <div class="relative h-64">
                        <canvas id="expenseByCategoryChart"></canvas>
                    </div>

                    <h4 class="text-xl font-bold mt-8 mb-4">Pemasukan per Kategori (Grafik Lingkaran)</h4>
                    <div class="relative h-64">
                        <canvas id="incomeByCategoryChart"></canvas>
                    </div>

                    <h4 class="text-xl font-bold mt-8 mb-4">Pengeluaran per Kategori</h4>
                    <div id="reportExpenseByCategory" class="space-y-3">
                        <p class="text-gray-500 text-center">Belum ada data pengeluaran per kategori.</p>
                    </div>
                    <h4 class="text-xl font-bold mt-8 mb-4">Pemasukan per Kategori</h4>
                    <div id="reportIncomeByCategory" class="space-y-3">
                        <p class="text-gray-500 text-center">Belum ada data pemasukan per kategori.</p>
                    </div>
                    <h4 class="text-xl font-bold mt-8 mb-4">Detail Transaksi</h4>
                    <div id="reportTransactionsList" class="overflow-x-auto">
                        <p class="text-gray-500 text-center">Belum ada transaksi untuk laporan.</p>
                    </div>
                    <button id="generatePdfReportBtn" class="w-full btn-primary font-semibold mt-6">Generate Laporan PDF</button>
                </div>
            </section>

            <section id="analysisSection" class="hidden">
                <h2 class="text-3xl font-bold mb-6">Analisis Keuangan</h2>
                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-4">Tren Keuangan Bulanan</h3>
                    <p class="text-gray-700 mb-4">Lihat bagaimana pemasukan, pengeluaran, dan saldo Anda berkembang dari waktu ke waktu.</p>
                    <div class="relative h-80">
                        <canvas id="financialTrendsChart"></canvas>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold mb-4">5 Kategori Pengeluaran Teratas</h3>
                        <div class="relative h-64">
                            <canvas id="topExpenseCategoriesChart"></canvas>
                        </div>
                        <div id="topExpenseCategoriesSummary" class="space-y-2 mt-4">
                            <p class="text-gray-500 text-center">Belum ada data pengeluaran.</p>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold mb-4">5 Kategori Pemasukan Teratas</h3>
                        <div class="relative h-64">
                            <canvas id="topIncomeCategoriesChart"></canvas>
                        </div>
                        <div id="topIncomeCategoriesSummary" class="space-y-2 mt-4">
                            <p class="text-gray-500 text-center">Belum ada data pemasukan.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="settingsSection" class="hidden">
                <h2 class="text-3xl font-bold mb-6">Pengaturan</h2>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-4">Mode Tampilan</h3>
                    <div class="flex items-center space-x-2">
                        <label for="darkModeToggle" class="block text-sm font-medium text-gray-700">Mode Gelap</label>
                        <input type="checkbox" id="darkModeToggle" class="toggle toggle-primary">
                    </div>
                </div>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-4">Ubah Kata Sandi</h3>
                    <form id="changePasswordForm" class="space-y-4">
                        <div>
                            <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-1">Kata Sandi Saat Ini</label>
                            <input type="password" id="currentPassword" required class="block">
                        </div>
                        <div>
                            <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1">Kata Sandi Baru</label>
                            <input type="password" id="newPassword" required class="block">
                        </div>
                        <div>
                            <label for="confirmNewPassword" class="block text-sm font-medium text-gray-700 mb-1">Konfirmasi Kata Sandi Baru</label>
                            <input type="password" id="confirmNewPassword" required class="block">
                        </div>
                        <p id="passwordMessage" class="text-red-500 text-sm hidden"></p>
                        <button type="submit" class="w-full btn-primary font-semibold">Ubah Kata Sandi</button>
                    </form>
                </div>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-4">Kelola Kategori</h3>
                    <form id="addCategoryForm" class="flex flex-col sm:flex-row gap-4 mb-4">
                        <input type="text" id="newCategoryName" placeholder="Nama Kategori Baru" required class="flex-grow">
                        <button type="submit" class="btn-primary font-semibold">Tambah Kategori</button>
                    </form>
                    <div id="categoryList" class="space-y-2">
                        <p class="text-gray-500 text-center">Belum ada kategori.</p>
                    </div>
                </div>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-4">Backup & Pulihkan Data (Lokal)</h3>
                    <p class="text-gray-700 mb-4">Ekspor semua data Anda ke file atau impor dari file yang sudah ada.</p>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="exportAllDataBtn" class="w-full sm:w-1/2 btn-primary font-semibold">Ekspor Semua Data</button>
                        <input type="file" id="importAllDataInput" accept=".json" class="hidden">
                        <label for="importAllDataInput" class="w-full sm:w-1/2 btn-secondary cursor-pointer text-center font-semibold">Impor Semua Data</label>
                    </div>
                </div>

                <div class="card p-6 mb-8">
                    <h3 class="text-2xl font-bold mb-4">Kirim Semua Transaksi ke WhatsApp</h3>
                    <p class="text-gray-700 mb-4">Klik tombol di bawah untuk mengirim semua detail transaksi Anda ke nomor WhatsApp yang terdaftar di CallMeBot.</p>
                    <button id="sendWhatsappSummaryBtn" class="w-full btn-primary font-semibold">Kirim Semua Transaksi ke WhatsApp</button>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-4">Ekspor Data Transaksi (CSV)</h3>
                    <p class="text-gray-700 mb-4">Unduh semua transaksi Anda dalam format CSV.</p>
                    <button id="exportDataBtn" class="btn-primary font-semibold">Ekspor Transaksi ke CSV</button>
                </div>

                <div class="card p-6 mt-8">
                    <h3 class="text-2xl font-bold mb-4 text-red-600">Hapus Akun</h3>
                    <p class="text-gray-700 mb-4">Menghapus akun Anda akan menghapus semua data Anda secara permanen. Tindakan ini tidak dapat dibatalkan.</p>
                    <button id="deleteAccountBtn" class="w-full btn-danger font-semibold">Hapus Akun Saya</button>
                </div>
            </section>

            <section id="helpSection" class="hidden">
                <h2 class="text-3xl font-bold mb-6">Bantuan</h2>
                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-4">Asisten Bantuan</h3>
                    <div id="chatDisplay" class="flex flex-col">
                        <!-- Chat messages will be displayed here -->
                        <div class="chat-message bot">Halo! Saya asisten bantuan Anda. Bagaimana saya bisa membantu?</div>
                    </div>
                    <div id="chatOptions" class="flex flex-wrap justify-center gap-2">
                        <!-- Chat options will be dynamically generated here -->
                    </div>
                </div>
            </section>
            </main>

        <footer class="bg-gray-800 text-white text-center p-4 text-sm mt-auto">
            &copy; 2025 by Adi Sudrajat. All rights reserved.
        </footer>
    </div>

    <div id="confirmationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideConfirmationModal()">&times;</button>
            <h3 class="text-xl font-bold mb-4" id="confirmationModalTitle">Konfirmasi</h3>
            <p id="confirmationModalMessage" class="mb-6">Apakah Anda yakin?</p>
            <div class="flex justify-end gap-4">
                <button id="confirmNoBtn" class="btn-secondary">Tidak</button>
                <button id="confirmYesBtn" class="btn-danger">Ya</button>
            </div>
        </div>
    </div>

    <div id="editTransactionModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideEditTransactionModal()">&times;</button>
            <h3 class="text-xl font-bold mb-4">Edit Transaksi</h3>
            <form id="editTransactionForm" class="space-y-4">
                <input type="hidden" id="editTransactionId">
                <div>
                    <label for="editTransactionDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                    <input type="date" id="editTransactionDate" required class="block">
                </div>
                <div>
                    <label for="editTransactionDescription" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi</label>
                    <input type="text" id="editTransactionDescription" required class="block">
                </div>
                <div>
                    <label for="editTransactionAmount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah (Rp)</label>
                    <input type="number" id="editTransactionAmount" required min="1" class="block">
                </div>
                <div>
                    <label for="editTransactionType" class="block text-sm font-medium text-gray-700 mb-1">Tipe</label>
                    <select id="editTransactionType" required class="block">
                        <option value="income">Pemasukan</option>
                        <option value="expense">Pengeluaran</option>
                    </select>
                </div>
                <div>
                    <label for="editTransactionCategory" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                    <select id="editTransactionCategory" required class="block">
                        </select>
                </div>
                <button type="submit" class="w-full btn-primary font-semibold">Simpan Perubahan</button>
            </form>
        </div>
    </div>

    <div id="jsonDisplayModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideJsonDisplayModal()">&times;</button>
            <h3 class="text-xl font-bold mb-4">Ekspor Data JSON</h3>
            <p class="text-gray-700 mb-4">Salin teks di bawah ini dan tempelkan ke editor teks di perangkat Anda, lalu simpan sebagai file `.json`.</p>
            <textarea id="jsonOutput" readonly></textarea>
            <button id="copyJsonBtn" class="btn-primary font-semibold">Salin ke Clipboard</button>
        </div>
    </div>

    <!-- New Forgot Password Modal -->
    <div id="forgotPasswordModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideForgotPasswordModal()">&times;</button>
            <h3 class="text-xl font-bold mb-4">Lupa Kata Sandi</h3>
            <form id="forgotPasswordForm" class="space-y-4">
                <div>
                    <label for="forgotPasswordEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="forgotPasswordEmail" placeholder="Masukkan email Anda" required class="block">
                </div>
                <p id="forgotPasswordMessage" class="text-red-500 text-sm hidden"></p>
                <button type="submit" class="w-full btn-primary font-semibold">Kirim Link Reset Kata Sandi</button>
            </form>
        </div>
    </div>

    <div id="notificationContainer"></div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updatePassword,
            deleteUser as deleteFirebaseAuthUser,
            reauthenticateWithCredential,
            EmailAuthProvider,
            sendPasswordResetEmail,
            sendEmailVerification // Added for email verification
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            addDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            getDocs,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (provided by the environment)
        const firebaseConfig = {
            apiKey: "AIzaSyDvf_Rg89uX9ODamiUjTCZ-ZTIYA2C7a7w",
            authDomain: "keuanganadi.firebaseapp.com",
            projectId: "keuanganadi",
            storageBucket: "keuanganadi.firebasestorage.app",
            messagingSenderId: "829317955644",
            appId: "1:829317955644:web:ecd350db338c02ab0fc339",
            measurementId: "G-WDNBRP6DB5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables for Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        console.log("Using appId for Firestore paths:", appId);
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const menuBtn = document.getElementById('menuBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const authSection = document.getElementById('authSection');
        const authTitle = document.getElementById('authTitle');
        const authForm = document.getElementById('authForm');
        const usernameInput = document.getElementById('username'); // Now email input
        const passwordInput = document.getElementById('password');
        const authSubmitBtn = document.getElementById('authSubmitBtn');
        const authMessage = document.getElementById('authMessage');
        const toggleAuthModeBtn = document.getElementById('toggleAuthMode');
        const forgotPasswordLink = document.getElementById('forgotPasswordLink'); // New: Forgot Password Link

        const dashboardSection = document.getElementById('dashboardSection');
        const dashboardUsernameEl = document.getElementById('dashboardUsername');
        const currentBalanceEl = document.getElementById('currentBalance');
        const totalIncomeEl = document.getElementById('totalIncome');
        const totalExpenseEl = document.getElementById('totalExpense');
        const latestTransactionsEl = document.getElementById('latestTransactions');
        const incomeExpenseChart = document.getElementById('incomeExpenseChart');
        const expenseByCategorySummary = document.getElementById('expenseByCategorySummary');

        const transactionsSection = document.getElementById('transactionsSection');
        const transactionForm = document.getElementById('transactionForm');
        const transactionDateInput = document.getElementById('transactionDate');
        const transactionDescriptionInput = document.getElementById('transactionDescription');
        const transactionAmountInput = document.getElementById('transactionAmount');
        const transactionTypeInput = document.getElementById('transactionType');
        const transactionCategoryInput = document.getElementById('transactionCategory');
        const allTransactionsListEl = document.getElementById('allTransactionsList');
        const transactionSearchInput = document.getElementById('transactionSearchInput');
        const filterTypeSelect = document.getElementById('filterType');
        const filterStartDate = document.getElementById('filterStartDate');
        const filterEndDate = document.getElementById('filterEndDate');
        const sortBySelect = document.getElementById('sortBy');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const pageInfo = document.getElementById('pageInfo');

        // New Budgeting Section Elements
        const budgetingSidebarItem = document.getElementById('budgetingSidebarItem');
        const budgetingSection = document.getElementById('budgetingSection');
        const budgetForm = document.getElementById('budgetForm');
        const budgetItemCategorySelect = document.getElementById('budgetItemCategory');
        const budgetAmountInput = document.getElementById('budgetAmount');
        const budgetStartDateInput = document.getElementById('budgetStartDate');
        const budgetEndDateInput = document.getElementById('budgetEndDate');
        const budgetListEl = document.getElementById('budgetList');
        const budgetMessageEl = document.getElementById('budgetMessage');

        const reportsSection = document.getElementById('reportsSection');
        const reportMonthSelect = document.getElementById('reportMonthSelect');
        const reportYearSelect = document.getElementById('reportYearSelect');
        const reportTotalIncomeEl = document.getElementById('reportTotalIncome');
        const reportTotalExpenseEl = document.getElementById('reportTotalExpense');
        const reportNetBalanceEl = document.getElementById('reportNetBalance');
        const reportExpenseByCategory = document.getElementById('reportExpenseByCategory');
        const reportIncomeByCategory = document.getElementById('reportIncomeByCategory');
        const reportTransactionsListEl = document.getElementById('reportTransactionsList');
        const generatePdfReportBtn = document.getElementById('generatePdfReportBtn'); // New PDF button

        // New Chart.js canvas elements
        const monthlySummaryChartCanvas = document.getElementById('monthlySummaryChart');
        const expenseByCategoryChartCanvas = document.getElementById('expenseByCategoryChart');
        const incomeByCategoryChartCanvas = document.getElementById('incomeByCategoryChart');

        let monthlySummaryChartInstance = null; // To store Chart.js instance for monthly summary
        let expenseByCategoryChartInstance = null; // To store Chart.js instance for expense by category
        let incomeByCategoryChartInstance = null; // To store Chart.js instance for income by category

        // Analysis Section Elements
        const analysisSidebarItem = document.getElementById('analysisSidebarItem');
        const analysisSection = document.getElementById('analysisSection');
        const financialTrendsChartCanvas = document.getElementById('financialTrendsChart');
        const topExpenseCategoriesChartCanvas = document.getElementById('topExpenseCategoriesChart');
        const topIncomeCategoriesChartCanvas = document.getElementById('topIncomeCategoriesChart');
        const topExpenseCategoriesSummary = document.getElementById('topExpenseCategoriesSummary');
        const topIncomeCategoriesSummary = document.getElementById('topIncomeCategoriesSummary');

        let financialTrendsChartInstance = null;
        let topExpenseCategoriesChartInstance = null;
        let topIncomeCategoriesChartInstance = null;

        const settingsSection = document.getElementById('settingsSection');
        const changePasswordForm = document.getElementById('changePasswordForm');
        const currentPasswordInput = document.getElementById('currentPassword');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
        const passwordMessageEl = document.getElementById('passwordMessage');
        const addCategoryForm = document.getElementById('addCategoryForm');
        const newCategoryNameInput = document.getElementById('newCategoryName');
        const categoryListEl = document.getElementById('categoryList');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const deleteAccountBtn = document.getElementById('deleteAccountBtn'); // New delete account button
        const darkModeToggle = document.getElementById('darkModeToggle'); // New dark mode toggle

        // WhatsApp Send Button
        const sendWhatsappSummaryBtn = document.getElementById('sendWhatsappSummaryBtn');

        // Specific sidebar items to hide/show
        const dashboardSidebarItem = document.getElementById('dashboardSidebarItem');
        const transactionsSidebarItem = document.getElementById('transactionsSidebarItem');
        const reportsSidebarItem = document.getElementById('reportsSidebarItem');
        const settingsSidebarItem = document.getElementById('settingsSidebarItem');
        const helpSidebarItem = document.getElementById('helpSidebarItem'); // New help sidebar item

        const sidebarItems = document.querySelectorAll('.sidebar-item');

        // Modal Elements
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationModalTitle = document.getElementById('confirmationModalTitle');
        const confirmationModalMessage = document.getElementById('confirmationModalMessage');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmNoBtn = document.getElementById('confirmNoBtn');

        const editTransactionModal = document.getElementById('editTransactionModal');
        const editTransactionForm = document.getElementById('editTransactionForm');
        const editTransactionIdInput = document.getElementById('editTransactionId');
        const editTransactionDateInput = document.getElementById('editTransactionDate');
        const editTransactionDescriptionInput = document.getElementById('editTransactionDescription');
        const editTransactionAmountInput = document.getElementById('editTransactionAmount');
        const editTransactionTypeInput = document.getElementById('editTransactionType');
        const editTransactionCategoryInput = document.getElementById('editTransactionCategory');

        // New JSON Display Modal Elements
        const jsonDisplayModal = document.getElementById('jsonDisplayModal');
        const jsonOutput = document.getElementById('jsonOutput');
        const copyJsonBtn = document.getElementById('copyJsonBtn');

        // New Forgot Password Modal Elements
        const forgotPasswordModal = document.getElementById('forgotPasswordModal');
        const forgotPasswordEmailInput = document.getElementById('forgotPasswordEmail');
        const forgotPasswordMessageEl = document.getElementById('forgotPasswordMessage');
        const forgotPasswordForm = document.getElementById('forgotPasswordForm');

        // Notification Container
        const notificationContainer = document.getElementById('notificationContainer');

        // New Import/Export Buttons
        const exportAllDataBtn = document.getElementById('exportAllDataBtn');
        const importAllDataInput = document.getElementById('importAllDataInput');

        // Chatbot Elements
        const helpSection = document.getElementById('helpSection');
        const chatDisplay = document.getElementById('chatDisplay');
        const chatOptions = document.getElementById('chatOptions');

        // State Variables
        let isLoggedIn = false;
        let currentFirebaseUser = null; // Stores the Firebase User object (auth.currentUser)
        let authMode = 'login'; // 'login' or 'register'

        // Pagination variables
        const transactionsPerPage = 10;
        let currentPage = 1;
        let filteredTransactions = []; // To store transactions after search/filter for pagination

        // Listeners for Firestore data (unsubscribing when user logs out)
        let unsubscribeTransactions = null;
        let unsubscribeCategories = null;
        let unsubscribeBudgets = null;

        // --- Utility Functions ---

        // Function to format number as Rupiah
        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Function to show a message (e.g., error, success)
        function showMessage(element, message, isError = true) {
            element.textContent = message;
            element.classList.remove('hidden');
            element.classList.toggle('text-red-500', isError);
            element.classList.toggle('text-green-500', !isError);
        }

        // Function to show a notification
        function showNotification(message, type = 'success', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notificationContainer.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, duration);
        }

        // --- Dark Mode Functionality ---
        function enableDarkMode() {
            document.body.classList.add('dark-mode');
            localStorage.setItem('darkMode', 'enabled');
        }

        function disableDarkMode() {
            document.body.classList.remove('dark-mode');
            localStorage.setItem('darkMode', 'disabled');
        }

        function toggleDarkMode() {
            if (document.body.classList.contains('dark-mode')) {
                disableDarkMode();
            } else {
                enableDarkMode();
            }
        }

        // Initialize dark mode based on local storage
        if (localStorage.getItem('darkMode') === 'enabled') {
            enableDarkMode();
            darkModeToggle.checked = true;
        } else {
            disableDarkMode();
            darkModeToggle.checked = false;
        }

        // --- Authentication Functions ---

        // Firebase Auth State Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Check if email is verified
                if (user.emailVerified) {
                    isLoggedIn = true;
                    currentFirebaseUser = user;
                    showSection('dashboardSection');
                    dashboardUsernameEl.textContent = user.email; // Display email as username
                    sidebarUsername.textContent = user.email; // Display email as username
                    setupFirestoreListeners(user.uid); // Setup listeners for regular users
                } else {
                    // If email is not verified, sign out and show message
                    await signOut(auth);
                    isLoggedIn = false;
                    currentFirebaseUser = null;
                    showSection('authSection');
                    unsubscribeAllFirestoreListeners();
                    showMessage(authMessage, 'Email Anda belum diverifikasi. Silakan cek kotak masuk Anda untuk tautan verifikasi.', true);
                    showNotification('Email Anda belum diverifikasi. Silakan cek kotak masuk Anda untuk tautan verifikasi.', 'error', 5000);
                }
            } else {
                isLoggedIn = false;
                currentFirebaseUser = null;
                showSection('authSection');
                unsubscribeAllFirestoreListeners(); // Unsubscribe on logout
            }
            updateUIBasedOnAuth();
        });

        async function handleAuth(event) {
            event.preventDefault();
            authMessage.classList.add('hidden'); // Hide previous message immediately
            const email = usernameInput.value.trim(); // Now email
            const password = passwordInput.value.trim();

            if (!email || !password) {
                showMessage(authMessage, 'Email dan kata sandi tidak boleh kosong.', true);
                showNotification('Email dan kata sandi tidak boleh kosong.', 'error');
                return;
            }

            try {
                if (authMode === 'register') {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    // Send email verification
                    await sendEmailVerification(userCredential.user);

                    // Initialize user data in Firestore
                    await setDoc(doc(db, `artifacts/${appId}/users/${userCredential.user.uid}/metadata`, 'categories'), {
                        list: ['Makanan', 'Transportasi', 'Gaji', 'Hiburan', 'Tagihan', 'Lain-lain']
                    });
                    await setDoc(doc(db, `artifacts/${appId}/users/${userCredential.user.uid}/metadata`, 'budgets'), {
                        list: []
                    });

                    showMessage(authMessage, 'Registrasi berhasil! Link verifikasi telah dikirim ke email Anda. Silakan verifikasi email Anda sebelum login.', false);
                    showNotification('Registrasi berhasil! Link verifikasi telah dikirim ke email Anda. Silakan verifikasi email Anda sebelum login.', 'success', 5000);
                    // Switch to login mode after successful registration
                    authMode = 'login';
                    authTitle.textContent = 'Login';
                    authSubmitBtn.textContent = 'Login';
                    toggleAuthModeBtn.textContent = 'Daftar di sini';
                    usernameInput.value = ''; // Clear fields after successful registration
                    passwordInput.value = ''; // Clear fields after successful registration

                } else { // Login mode
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    // Check email verification status after successful login
                    if (!userCredential.user.emailVerified) {
                        await signOut(auth); // Sign out unverified user
                        showMessage(authMessage, 'Email Anda belum diverifikasi. Silakan cek kotak masuk Anda untuk tautan verifikasi.', true);
                        showNotification('Email Anda belum diverifikasi. Silakan cek kotak masuk Anda untuk tautan verifikasi.', 'error', 5000);
                        return; // Stop further execution
                    }
                    showMessage(authMessage, 'Login berhasil!', false);
                    showNotification('Login berhasil!', 'success');
                    // onAuthStateChanged will handle showing the correct section
                }
            } catch (error) {
                console.error("Authentication error:", error);
                let errorMessage = 'Terjadi kesalahan otentikasi.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Email sudah terdaftar. Silakan gunakan email lain atau login.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Format email tidak valid.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Kata sandi terlalu lemah (minimal 6 karakter).';
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = 'Email atau kata sandi salah.';
                }
                showMessage(authMessage, errorMessage, true);
                showNotification(errorMessage, 'error');
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                showNotification('Anda telah logout.', 'success');
                // onAuthStateChanged will handle showing the auth section
            } catch (error) {
                console.error("Logout error:", error);
                showNotification('Gagal logout. Silakan coba lagi.', 'error');
            }
            // Reset form fields
            usernameInput.value = '';
            passwordInput.value = '';
        }

        function updateUIBasedOnAuth() {
            if (isLoggedIn) {
                authSection.classList.add('hidden');
                sidebar.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                // Ensure sidebar is open on desktop, hidden on mobile initially
                if (window.innerWidth < 768) {
                    sidebar.classList.remove('open');
                } else {
                    sidebar.classList.add('open');
                }

                dashboardSidebarItem.classList.remove('hidden');
                transactionsSidebarItem.classList.remove('hidden');
                budgetingSidebarItem.classList.remove('hidden');
                reportsSidebarItem.classList.remove('hidden');
                analysisSidebarItem.classList.remove('hidden');
                settingsSidebarItem.classList.remove('hidden');
                helpSidebarItem.classList.remove('hidden');
            } else {
                authSection.classList.remove('hidden');
                sidebar.classList.add('hidden');
                logoutBtn.classList.add('hidden');
                // Hide all sidebar items on logout
                dashboardSidebarItem.classList.add('hidden');
                transactionsSidebarItem.classList.add('hidden');
                budgetingSidebarItem.classList.add('hidden');
                reportsSidebarItem.classList.add('hidden');
                analysisSidebarItem.classList.add('hidden');
                settingsSidebarItem.classList.add('hidden');
                helpSidebarItem.classList.add('hidden');

                // Hide all other sections
                document.querySelectorAll('main > section:not(#authSection)').forEach(section => {
                    section.classList.add('hidden');
                });
                sidebarUsername.textContent = ''; // Clear username in sidebar
            }
        }

        // --- Firestore Data Management ---

        // Setup real-time listeners for current user's data
        function setupFirestoreListeners(uid) {
            console.log("Setting up Firestore listeners for UID:", uid); // Log when listeners are set up
            // Unsubscribe existing listeners first
            unsubscribeAllFirestoreListeners();

            // Transactions listener
            const transactionsRef = collection(db, `artifacts/${appId}/users/${uid}/transactions`);
            unsubscribeTransactions = onSnapshot(transactionsRef, (snapshot) => {
                const transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Firestore Transactions updated:", transactions); // Log fetched transactions
                window._userTransactions = transactions; // Make it accessible globally for other functions
                renderDashboard();
                renderTransactions();
                renderReports();
                renderAnalysis();
                renderBudgets(); // Re-render budgets as they depend on transactions
            }, (error) => {
                console.error("Error fetching transactions:", error);
                showNotification('Gagal memuat transaksi. Silakan coba lagi.', 'error');
            });

            // Categories listener
            const categoriesDocRef = doc(db, `artifacts/${appId}/users/${uid}/metadata`, 'categories');
            unsubscribeCategories = onSnapshot(categoriesDocRef, (docSnap) => {
                const categories = docSnap.exists() ? docSnap.data().list : ['Makanan', 'Transportasi', 'Gaji', 'Hiburan', 'Tagihan', 'Lain-lain'];
                console.log("Firestore Categories updated:", categories); // Log fetched categories
                window._userCategories = categories;
                renderCategoryOptions(transactionCategoryInput);
                renderCategoryOptions(editTransactionCategoryInput);
                renderCategoryOptions(budgetItemCategorySelect);
                renderManageCategories();
            }, (error) => {
                console.error("Error fetching categories:", error);
                showNotification('Gagal memuat kategori. Silakan coba lagi.', 'error');
            });

            // Budgets listener
            const budgetsDocRef = doc(db, `artifacts/${appId}/users/${uid}/metadata`, 'budgets');
            unsubscribeBudgets = onSnapshot(budgetsDocRef, (docSnap) => {
                const budgets = docSnap.exists() ? docSnap.data().list : [];
                console.log("Firestore Budgets updated:", budgets); // Log fetched budgets
                window._userBudgets = budgets;
                renderBudgets();
            }, (error) => {
                console.error("Error fetching budgets:", error);
                showNotification('Gagal memuat anggaran. Silakan coba lagi.', 'error');
            });
        }

        // Unsubscribe all listeners (on logout)
        function unsubscribeAllFirestoreListeners() {
            if (unsubscribeTransactions) unsubscribeTransactions();
            if (unsubscribeCategories) unsubscribeCategories();
            if (unsubscribeBudgets) unsubscribeBudgets();
            window._userTransactions = [];
            window._userCategories = [];
            window._userBudgets = [];
            console.log("All Firestore listeners unsubscribed.");
        }

        // Helper to get current user's UID
        function getCurrentUserId() {
            return currentFirebaseUser ? currentFirebaseUser.uid : null;
        }

        // Functions to interact with Firestore data
        function getUserTransactions() {
            return window._userTransactions || [];
        }

        async function addTransactionToFirestore(transaction) {
            const userId = getCurrentUserId();
            if (!userId) {
                showNotification('Anda harus login untuk menambahkan transaksi.', 'error');
                return;
            }
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/transactions`), transaction);
                console.log("Transaction added to Firestore:", transaction);
            } catch (error) {
                console.error("Error adding transaction:", error);
                showNotification('Gagal menambahkan transaksi. Silakan coba lagi.', 'error');
            }
        }

        async function updateTransactionInFirestore(id, updatedTransaction) {
            const userId = getCurrentUserId();
            if (!userId) {
                showNotification('Anda harus login untuk memperbarui transaksi.', 'error');
                return;
            }
            try {
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/transactions`, id), updatedTransaction);
                console.log("Transaction updated in Firestore:", id, updatedTransaction);
            } catch (error) {
                console.error("Error updating transaction:", error);
                showNotification('Gagal memperbarui transaksi. Silakan coba lagi.', 'error');
            }
        }

        async function deleteTransactionFromFirestore(id) {
            const userId = getCurrentUserId();
            if (!userId) {
                showNotification('Anda harus login untuk menghapus transaksi.', 'error');
                return;
            }
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/transactions`, id));
                console.log("Transaction deleted from Firestore:", id);
            } catch (error) {
                console.error("Error deleting transaction:", error);
                showNotification('Gagal menghapus transaksi. Silakan coba lagi.', 'error');
            }
        }

        function getUserCategories() {
            return window._userCategories || [];
        }

        async function saveUserCategoriesToFirestore(categories) {
            const userId = getCurrentUserId();
            if (!userId) {
                showNotification('Anda harus login untuk menyimpan kategori.', 'error');
                return;
            }
            try {
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'categories'), { list: categories });
                console.log("Categories saved to Firestore:", categories);
            } catch (error) {
                console.error("Error saving categories:", error);
                showNotification('Gagal menyimpan kategori. Silakan coba lagi.', 'error');
            }
        }

        function getUserBudgets() {
            return window._userBudgets || [];
        }

        async function saveUserBudgetsToFirestore(budgets) {
            const userId = getCurrentUserId();
            if (!userId) {
                showNotification('Anda harus login untuk menyimpan anggaran.', 'error');
                return;
            }
            try {
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'budgets'), { list: budgets });
                console.log("Budgets saved to Firestore:", budgets);
            } catch (error) {
                console.error("Error saving budgets:", error);
                showNotification('Gagal menyimpan anggaran. Silakan coba lagi.', 'error');
            }
        }

        // --- Section Management ---

        function showSection(sectionId) {
            document.querySelectorAll('main > section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            // Update active sidebar item
            sidebarItems.forEach(item => {
                item.classList.remove('active');
                if (item.dataset.section + 'Section' === sectionId) {
                    item.classList.add('active');
                }
            });

            // Close sidebar on mobile after navigating
            if (window.innerWidth < 768) {
                sidebar.classList.remove('open');
            }

            // Update data for the displayed section
            if (sectionId === 'dashboardSection') {
                renderDashboard();
            } else if (sectionId === 'transactionsSection') {
                renderCategoryOptions(transactionCategoryInput);
                currentPage = 1; // Reset pagination
                renderTransactions();
            } else if (sectionId === 'budgetingSection') {
                renderCategoryOptions(budgetItemCategorySelect);
                renderBudgets();
            }
            else if (sectionId === 'reportsSection') {
                populateReportYears();
                renderReports();
            } else if (sectionId === 'analysisSection') {
                renderAnalysis();
            } else if (sectionId === 'settingsSection') {
                renderManageCategories();
            } else if (sectionId === 'helpSection') {
                startChatbot();
            }
        }

        // --- Transaction Management ---

        async function addTransaction(event) {
            event.preventDefault();
            const date = transactionDateInput.value;
            const description = transactionDescriptionInput.value.trim();
            const amount = parseFloat(transactionAmountInput.value);
            const type = transactionTypeInput.value;
            const category = transactionCategoryInput.value;

            if (!date || !description || isNaN(amount) || amount <= 0 || !category) {
                showMessage(authMessage, 'Semua field harus diisi dengan benar.');
                showNotification('Semua field harus diisi dengan benar.', 'error');
                return;
            }

            // Budgeting check for expense transactions
            if (type === 'expense') {
                const budgets = getUserBudgets();
                const activeBudgets = budgets.filter(b => {
                    const budgetStart = new Date(b.startDate);
                    const budgetEnd = new Date(b.endDate);
                    const transactionDate = new Date(date);
                    return b.category === category && transactionDate >= budgetStart && transactionDate <= budgetEnd;
                });

                if (activeBudgets.length > 0) {
                    const currentExpensesForCategory = getUserTransactions().filter(t =>
                        t.type === 'expense' &&
                        t.category === category &&
                        new Date(t.date) >= new Date(activeBudgets[0].startDate) &&
                        new Date(t.date) <= new Date(activeBudgets[0].endDate)
                    ).reduce((sum, t) => sum + t.amount, 0);

                    const budgetLimit = activeBudgets[0].amount;
                    const remainingBudget = budgetLimit - currentExpensesForCategory;

                    if (amount > remainingBudget) {
                        const confirm = await new Promise(resolve => {
                            showConfirmationModal(`Transaksi ini (${formatRupiah(amount)}) akan melebihi anggaran Anda untuk kategori '${category}' (Sisa anggaran: ${formatRupiah(remainingBudget)}). Lanjutkan?`, () => resolve(true), () => resolve(false));
                        });
                        if (!confirm) {
                            showNotification('Transaksi dibatalkan karena melebihi anggaran.', 'info');
                            return;
                        }
                    }
                }
            }

            const newTransaction = {
                date: date,
                description: description,
                amount: amount,
                type: type,
                category: category
            };

            await addTransactionToFirestore(newTransaction);

            showMessage(authMessage, 'Transaksi berhasil ditambahkan!', false);
            showNotification('Transaksi berhasil ditambahkan!', 'success');
            transactionForm.reset(); // Clear form
            const today = new Date().toISOString().split('T')[0];
            transactionDateInput.value = today; // Reset date to today
            // UI will update via Firestore listener (onSnapshot)
        }

        async function deleteTransaction(id) {
            confirmAction('Apakah Anda yakin ingin menghapus transaksi ini?', async () => {
                await deleteTransactionFromFirestore(id);
                showMessage(authMessage, 'Transaksi berhasil dihapus!', false);
                showNotification('Transaksi berhasil dihapus!', 'success');
                // UI will update via Firestore listener (onSnapshot)
            });
        }

        async function editTransaction(id) {
            const transactions = getUserTransactions();
            const transactionToEdit = transactions.find(t => t.id === id);

            if (transactionToEdit) {
                editTransactionIdInput.value = transactionToEdit.id;
                editTransactionDateInput.value = transactionToEdit.date;
                editTransactionDescriptionInput.value = transactionToEdit.description;
                editTransactionAmountInput.value = transactionToEdit.amount;
                editTransactionTypeInput.value = transactionToEdit.type;
                renderCategoryOptions(editTransactionCategoryInput); // Populate categories for edit form
                editTransactionCategoryInput.value = transactionToEdit.category;

                showEditTransactionModal();
            }
        }

        async function updateTransaction(event) {
            event.preventDefault();
            const id = editTransactionIdInput.value; // ID is string from Firestore
            const date = editTransactionDateInput.value;
            const description = editTransactionDescriptionInput.value.trim();
            const amount = parseFloat(editTransactionAmountInput.value);
            const type = editTransactionTypeInput.value;
            const category = editTransactionCategoryInput.value;

            if (!date || !description || isNaN(amount) || amount <= 0 || !category) {
                showMessage(authMessage, 'Semua field harus diisi dengan benar.');
                showNotification('Semua field harus diisi dengan benar.', 'error');
                return;
            }

            const updatedTransaction = { date, description, amount, type, category };

            await updateTransactionInFirestore(id, updatedTransaction);

            showMessage(authMessage, 'Transaksi berhasil diperbarui!', false);
            showNotification('Transaksi berhasil diperbarui!', 'success');
            hideEditTransactionModal();
            // UI will update via Firestore listener (onSnapshot)
        }

        // --- Category Management ---

        function renderCategoryOptions(selectElement) {
            const categories = getUserCategories();
            selectElement.innerHTML = ''; // Clear existing options
            if (categories.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Tidak ada kategori';
                selectElement.appendChild(option);
                selectElement.disabled = true;
                return;
            }
            selectElement.disabled = false;
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                selectElement.appendChild(option);
            });
        }

        async function addCategory(event) {
            event.preventDefault();
            const newCategory = newCategoryNameInput.value.trim();
            if (!newCategory) {
                showMessage(passwordMessageEl, 'Nama kategori tidak boleh kosong.', true);
                showNotification('Nama kategori tidak boleh kosong.', 'error');
                return;
            }

            let categories = getUserCategories();
            if (categories.includes(newCategory)) {
                showMessage(passwordMessageEl, 'Kategori ini sudah ada.', true);
                showNotification('Kategori ini sudah ada.', 'error');
                return;
            }

            categories.push(newCategory);
            await saveUserCategoriesToFirestore(categories);
            showMessage(passwordMessageEl, 'Kategori berhasil ditambahkan!', false);
            showNotification('Kategori berhasil ditambahkan!', 'success');
            newCategoryNameInput.value = '';
            // UI will update via Firestore listener (onSnapshot)
        }

        async function deleteCategory(categoryToDelete) {
            confirmAction(`Apakah Anda yakin ingin menghapus kategori "${categoryToDelete}"? Transaksi dan anggaran yang terkait tidak akan terhapus, tetapi kategorinya akan dialihkan ke 'Lain-lain'.`, async () => {
                let categories = getUserCategories();
                categories = categories.filter(cat => cat !== categoryToDelete);

                // Update transactions that used this category
                let transactions = getUserTransactions();
                const transactionUpdates = transactions.filter(t => t.category === categoryToDelete).map(t => {
                    const updatedT = { ...t, category: 'Lain-lain' };
                    return updateTransactionInFirestore(t.id, updatedT);
                });
                await Promise.all(transactionUpdates);

                // Update budgets that used this category
                let budgets = getUserBudgets();
                budgets.forEach(b => {
                    if (b.category === categoryToDelete) {
                        b.category = 'Lain-lain'; // Assign to a default or 'Uncategorized'
                    }
                });
                await saveUserBudgetsToFirestore(budgets);

                await saveUserCategoriesToFirestore(categories); // Save updated categories last

                showMessage(passwordMessageEl, 'Kategori berhasil dihapus!', false);
                showNotification('Kategori berhasil dihapus!', 'success');
                // UI will update via Firestore listener (onSnapshot)
            });
        }

        function renderManageCategories() {
            const categories = getUserCategories();
            categoryListEl.innerHTML = '';
            if (categories.length === 0) {
                categoryListEl.innerHTML = '<p class="text-gray-500 text-center">Belum ada kategori.</p>';
            } else {
                categories.forEach(cat => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'flex items-center justify-between p-2 rounded-md bg-gray-50 border border-gray-200';
                    categoryDiv.innerHTML = `
                        <span class="font-medium">${cat}</span>
                        <button class="btn-danger text-xs px-2 py-1" onclick="deleteCategory('${cat}')">Hapus</button>
                    `;
                    categoryListEl.appendChild(categoryDiv);
                });
            }
        }

        // --- Budgeting Functions ---

        async function addBudget(event) {
            event.preventDefault();
            const category = budgetItemCategorySelect.value;
            const amount = parseFloat(budgetAmountInput.value);
            const startDate = budgetStartDateInput.value;
            const endDate = budgetEndDateInput.value;

            if (!category || isNaN(amount) || amount <= 0 || !startDate || !endDate) {
                showMessage(budgetMessageEl, 'Semua field harus diisi dengan benar.', true);
                showNotification('Semua field harus diisi dengan benar.', 'error');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showMessage(budgetMessageEl, 'Tanggal mulai tidak boleh lebih lambat dari tanggal akhir.', true);
                showNotification('Tanggal mulai tidak boleh lebih lambat dari tanggal akhir.', 'error');
                return;
            }

            let budgets = getUserBudgets();

            // Check for overlapping budgets for the same category
            const overlappingBudget = budgets.find(b =>
                b.category === category &&
                ((new Date(startDate) <= new Date(b.endDate) && new Date(endDate) >= new Date(b.startDate)))
            );

            if (overlappingBudget) {
                showMessage(budgetMessageEl, `Sudah ada anggaran untuk kategori '${category}' yang tumpang tindih dengan periode ini.`, true);
                showNotification(`Anggaran untuk '${category}' tumpang tindih.`, 'error');
                return;
            }

            const newBudget = {
                id: Date.now(), // Use timestamp as ID for local uniqueness before saving
                category,
                amount,
                startDate,
                endDate
            };

            budgets.push(newBudget);
            await saveUserBudgetsToFirestore(budgets);
            showMessage(budgetMessageEl, 'Anggaran berhasil ditambahkan!', false);
            showNotification('Anggaran berhasil ditambahkan!', 'success');
            budgetForm.reset();
            // UI will update via Firestore listener (onSnapshot)
        }

        async function deleteBudget(id) {
            confirmAction('Apakah Anda yakin ingin menghapus anggaran ini?', async () => {
                let budgets = getUserBudgets();
                budgets = budgets.filter(b => b.id !== id);
                await saveUserBudgetsToFirestore(budgets);
                showNotification('Anggaran berhasil dihapus!', 'success');
                // UI will update via Firestore listener (onSnapshot)
            });
        }

        function renderBudgets() {
            const budgets = getUserBudgets();
            const transactions = getUserTransactions();
            budgetListEl.innerHTML = '';

            if (budgets.length === 0) {
                budgetListEl.innerHTML = '<p class="text-gray-500 text-center">Belum ada anggaran yang ditetapkan.</p>';
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize today's date to start of day

            budgets.sort((a, b) => new Date(a.startDate) - new Date(b.startDate)); // Sort by start date

            budgets.forEach(budget => {
                const budgetStart = new Date(budget.startDate);
                const budgetEnd = new Date(budget.endDate);
                budgetEnd.setHours(23, 59, 59, 999); // Normalize end date to end of day

                const expensesForBudget = transactions.filter(t =>
                    t.type === 'expense' &&
                    t.category === budget.category &&
                    new Date(t.date) >= budgetStart &&
                    new Date(t.date) <= budgetEnd
                ).reduce((sum, t) => sum + t.amount, 0);

                const remainingAmount = budget.amount - expensesForBudget;
                const percentageUsed = (expensesForBudget / budget.amount) * 100;

                let statusText = '';
                let statusColor = 'text-gray-600';
                let progressBarColor = 'bg-blue-400';

                if (today > budgetEnd) {
                    statusText = 'Berakhir';
                    statusColor = 'text-gray-500';
                    progressBarColor = 'bg-gray-400';
                } else if (today < budgetStart) {
                    statusText = 'Mendatang';
                    statusColor = 'text-blue-500';
                    progressBarColor = 'bg-blue-200';
                } else if (remainingAmount <= 0) {
                    statusText = 'Anggaran Habis!';
                    statusColor = 'text-red-500 font-bold';
                    progressBarColor = 'bg-red-500';
                } else if (percentageUsed >= 75) {
                    statusText = 'Hampir Habis!';
                    statusColor = 'text-orange-500 font-bold';
                    progressBarColor = 'bg-orange-400';
                } else {
                    statusText = 'Aktif';
                    statusColor = 'text-green-500';
                    progressBarColor = 'bg-green-400';
                }

                const budgetDiv = document.createElement('div');
                budgetDiv.className = 'card p-4 mb-4';
                budgetDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-xl font-semibold">${budget.category}</h4>
                        <button class="btn-danger text-xs px-2 py-1" onclick="deleteBudget(${budget.id})">Hapus</button>
                    </div>
                    <p class="text-gray-700">Periode: ${budget.startDate} s/d ${budget.endDate}</p>
                    <p class="text-lg font-medium">Anggaran: ${formatRupiah(budget.amount)}</p>
                    <p class="text-lg font-medium">Terpakai: <span class="text-expense">${formatRupiah(expensesForBudget)}</span></p>
                    <p class="text-lg font-medium">Sisa: <span class="${remainingAmount <= 0 ? 'text-red-500' : 'text-green-500'}">${formatRupiah(remainingAmount)}</span></p>
                    <p class="text-sm mt-1 ${statusColor}">Status: ${statusText}</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                        <div class="${progressBarColor} h-2.5 rounded-full" style="width: ${Math.min(100, percentageUsed)}%;"></div>
                    </div>
                    <p class="text-xs text-gray-500 text-right mt-1">${percentageUsed.toFixed(2)}% Terpakai</p>
                `;
                budgetListEl.appendChild(budgetDiv);
            });
        }


        // --- Password Change ---

        async function handleChangePassword(event) {
            event.preventDefault();
            const currentPass = currentPasswordInput.value;
            const newPass = newPasswordInput.value;
            const confirmNewPass = confirmNewPasswordInput.value;

            if (!currentFirebaseUser) {
                showMessage(passwordMessageEl, 'Anda harus login untuk mengubah kata sandi.', true);
                showNotification('Anda harus login untuk mengubah kata sandi.', 'error');
                return;
            }

            if (!currentPass || !newPass || !confirmNewPass) {
                showMessage(passwordMessageEl, 'Semua field harus diisi.', true);
                showNotification('Semua field harus diisi.', 'error');
                return;
            }

            if (newPass !== confirmNewPass) {
                showMessage(passwordMessageEl, 'Kata sandi baru tidak cocok dengan konfirmasi.', true);
                showNotification('Kata sandi baru tidak cocok dengan konfirmasi.', 'error');
                return;
            }

            if (newPass.length < 6) {
                showMessage(passwordMessageEl, 'Kata sandi baru minimal 6 karakter.', true);
                showNotification('Kata sandi baru minimal 6 karakter.', 'error');
                return;
            }

            try {
                // Re-authenticate user before updating password
                const credential = EmailAuthProvider.credential(currentFirebaseUser.email, currentPass);
                await reauthenticateWithCredential(currentFirebaseUser, credential);
                await updatePassword(currentFirebaseUser, newPass);
                showMessage(passwordMessageEl, 'Kata sandi berhasil diubah!', false);
                showNotification('Kata sandi berhasil diubah!', 'success');
                changePasswordForm.reset();
            } catch (error) {
                console.error("Error changing password:", error);
                let errorMessage = 'Gagal mengubah kata sandi.';
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Kata sandi saat ini salah.';
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'Untuk alasan keamanan, silakan login ulang dan coba lagi.';
                } else if (error.code === 'auth/invalid-credential') {
                    errorMessage = 'Kredensial saat ini tidak valid. Silakan login ulang.';
                }
                showMessage(passwordMessageEl, errorMessage, true);
                showNotification(errorMessage, 'error');
            }
        }

        // --- Local Data Import/Export ---

        async function exportAllData() {
            if (!currentFirebaseUser) {
                showNotification('Anda harus login untuk mengekspor data.', 'error');
                return;
            }

            const userId = currentFirebaseUser.uid;
            try {
                const transactionsSnapshot = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/transactions`));
                const transactions = transactionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const categoriesDoc = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'categories'));
                const categories = categoriesDoc.exists() ? categoriesDoc.data().list : [];

                const budgetsDoc = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'budgets'));
                const budgets = budgetsDoc.exists() ? budgetsDoc.data().list : [];

                const dataToExport = {
                    transactions,
                    categories,
                    budgets
                };

                const dataStr = JSON.stringify(dataToExport, null, 2); // Pretty print JSON

                jsonOutput.value = dataStr;
                showJsonDisplayModal();
                showNotification('Salin data JSON dari jendela yang muncul dan simpan secara manual.', 'info', 5000);

            } catch (error) {
                console.error("Error exporting data:", error);
                showNotification('Gagal mengekspor data. Silakan coba lagi.', 'error');
            }
        }

        async function importAllData(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            if (!currentFirebaseUser) {
                showNotification('Anda harus login untuk mengimpor data.', 'error');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.json')) {
                showNotification('Hanya file JSON yang diizinkan.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);

                    if (!importedData || !Array.isArray(importedData.transactions) || !Array.isArray(importedData.categories)) {
                        showNotification('Format file JSON tidak valid. Data transaksi atau kategori tidak ditemukan.', 'error');
                        return;
                    }

                    const confirmImport = await new Promise(resolve => {
                        showConfirmationModal('Apakah Anda yakin ingin mengimpor data ini? Ini akan menimpa semua data Anda saat ini.', () => resolve(true), () => resolve(false));
                    });

                    if (!confirmImport) {
                        showNotification('Impor data dibatalkan.', 'info');
                        return;
                    }

                    const userId = currentFirebaseUser.uid;
                    const batch = writeBatch(db);

                    // Delete existing transactions in a batch
                    const existingTransactionsSnapshot = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/transactions`));
                    existingTransactionsSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    // Add new transactions in a batch
                    for (const t of importedData.transactions) {
                        const newDocRef = doc(collection(db, `artifacts/${appId}/users/${userId}/transactions`)); // Let Firestore generate ID
                        batch.set(newDocRef, {
                            date: t.date,
                            description: t.description,
                            amount: t.amount,
                            type: t.type,
                            category: t.category
                        });
                    }

                    // Import categories
                    batch.set(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'categories'), {
                        list: importedData.categories || ['Makanan', 'Transportasi', 'Gaji', 'Hiburan', 'Tagihan', 'Lain-lain']
                    });

                    // Import budgets
                    batch.set(doc(db, `artifacts/${appId}/users/${userId}/metadata`, 'budgets'), {
                        list: importedData.budgets || []
                    });

                    await batch.commit(); // Commit all batch operations

                    showNotification('Data berhasil diimpor dan dipulihkan!', 'success');
                    // UI will update automatically via Firestore listeners
                } catch (error) {
                    console.error("Error parsing or importing JSON:", error);
                    showNotification('Gagal membaca atau mengurai file JSON. Pastikan formatnya benar dan tidak rusak.', 'error');
                }
            };
            reader.onerror = function() {
                showNotification('Gagal membaca file.', 'error');
            };
            reader.readAsText(file);
            event.target.value = ''; // Clear the file input value to allow selecting the same file again if needed
        }

        // --- Send All Data to WhatsApp (CallMeBot API) ---
        async function sendTransactionsToWhatsApp() {
            // CallMeBot API key
            const apiKey = '1133504';
            const callmebotApiUrl = `https://api.callmebot.com/whatsapp.php?phone=YOUR_PHONE_NUMBER&text=YOUR_MESSAGE&apikey=${apiKey}`;

            // Ensure currentFirebaseUser is available
            if (!currentFirebaseUser) {
                showNotification('Anda harus login untuk mengirim ringkasan transaksi.', 'error');
                return;
            }

            // Prompt user for their WhatsApp number
            const userPhoneNumber = prompt("Masukkan nomor WhatsApp Anda (dengan kode negara, contoh: 62812xxxxxxxxx):");
            if (!userPhoneNumber || userPhoneNumber.trim() === '') {
                showNotification('Pengiriman dibatalkan. Nomor WhatsApp tidak boleh kosong.', 'info');
                return;
            }
            // Basic validation for phone number (optional, but good practice)
            if (!/^\d+$/.test(userPhoneNumber)) {
                showNotification('Nomor WhatsApp tidak valid. Hanya angka yang diizinkan.', 'error');
                return;
            }

            const transactions = getUserTransactions();
            let totalIncome = 0;
            let totalExpense = 0;

            transactions.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                } else {
                    totalExpense += t.amount;
                }
            });

            const currentBalance = totalIncome - totalExpense;

            // Prepare summary message
            let message = `Ringkasan Keuangan AdiWallet Anda:\n`;
            message += `Saldo Saat Ini: ${formatRupiah(currentBalance)}\n`;
            message += `Total Pemasukan: ${formatRupiah(totalIncome)}\n`;
            message += `Total Pengeluaran: ${formatRupiah(totalExpense)}\n\n`;

            // Add all transactions
            if (transactions.length > 0) {
                message += `Detail Semua Transaksi:\n`;
                // Sort transactions by date (newest first) for better readability
                transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                transactions.forEach(t => {
                    const typeLabel = t.type === 'income' ? 'Pemasukan' : 'Pengeluaran';
                    message += `- ${t.date} | ${typeLabel} | ${t.category} | ${formatRupiah(t.amount)} | ${t.description}\n`;
                });
            } else {
                message += `Belum ada transaksi tercatat.\n`;
            }

            // Encode the message for URL
            const encodedMessage = encodeURIComponent(message);
            const finalApiUrl = `https://api.callmebot.com/whatsapp.php?phone=${userPhoneNumber}&text=${encodedMessage}&apikey=${apiKey}`;

            try {
                const response = await fetch(finalApiUrl);
                const result = await response.text();

                if (response.ok && result.includes('OK')) {
                    showNotificatio
